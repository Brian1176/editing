<!DOCTYPE html><meta charset=utf-8>
<title>HTML Editing Commands</title>
<link href=http://www.whatwg.org/style/specification rel=stylesheet>
<style>
  pre, code, xmp { font-family:monospace, sans-serif; }
  h2 code, h3 code, h3 code,
  h2 :link, h3 :link, h3 :link,
  h2 :visited, h3 :visited, h3 :visited
  { font:inherit; color:inherit; font-style:italic; }
  @media print {
    :not([data-anolis-spec]) > [data-anolis-spec]::after {
      content: "[" attr(data-anolis-spec) "]";
      font-size: 0.6em;
      vertical-align: super;
      text-transform: uppercase;
    }
  }
  xmp {
    font-size: inherit;
    font-variant: normal;
    margin-left: 2em;
    white-space: pre-wrap;
  }
  div.note > p:first-child::before { content: 'Note: '; }
  .XXX > :last-child { margin-bottom: 0 }
  .XXX li {
    margin-top: 0;
    margin-bottom: 0;
  }
  dd .XXX p { margin: 1em 0 }
  ol li { margin: 1em 0 }
  li li { margin: 0 }
  table { margin: 1em 0 }
  /* Overwrite the underline so it's orange instead of blue, thus looks less
   * silly */
  a code { text-decoration: underline }
</style>
<body class=draft>
<div class=head id=head>
<h1>HTML Editing Commands</h1>
<h2 class="no-num no-toc" id=work-in-progress-&mdash;-last-update-19-june-2011>Work in Progress &mdash; Last Update 19 June 2011</h2>
<dl>
 <dt>Editor
 <dd>Aryeh Gregor &lt;ayg+spec@aryeh.name&gt;

 <dt>Version history
 <dd><a href="http://aryeh.name/gitweb.cgi?p=editcommands">http://aryeh.name/gitweb.cgi?p=editcommands</a>
</dl>
</div>


<h2 class=no-num id=status-of-this-document>Status of this Document</h2>

<p>This document is an early draft of a specification for HTML editing APIs,
defining <code><a href=#execcommand()>execCommand()</a></code> and related functions.  It will eventually
be merged into the main <a href=http://www.whatwg.org/html>HTML</a>
specification, replacing the <a href=http://www.whatwg.org/specs/web-apps/current-work/multipage/dnd.html#editing-apis>Editing
APIs</a> section.  Although this spec is still very incomplete and will likely
be changed heavily before it's finished, feedback to <a href=http://lists.whatwg.org/listinfo.cgi/whatwg-whatwg.org>the WHATWG list</a>
is encouraged, particularly from implementers and particularly from authors who
have experience using this feature.


<h2 class=no-num id=table-of-contents>Table of contents</h2>

<!--begin-toc-->
<ol class=toc>
 <li><a class=no-num href=#status-of-this-document>Status of this Document</a></li>
 <li><a class=no-num href=#table-of-contents>Table of contents</a></li>
 <li><a href=#introduction><span class=secno>1 </span>Introduction</a></li>
 <li><a href=#issues><span class=secno>2 </span>Issues</a></li>
 <li><a href=#methods-of-the-htmldocument-interface><span class=secno>3 </span>Methods of the <code class=external data-anolis-spec=html>HTMLDocument</code> interface</a></li>
 <li><a href=#common-definitions><span class=secno>4 </span>Common definitions</a></li>
 <li><a href=#common-algorithms><span class=secno>5 </span>Common algorithms</a>
  <ol>
   <li><a href=#assorted-common-algorithms><span class=secno>5.1 </span>Assorted common algorithms</a></li>
   <li><a href=#wrapping-a-list-of-nodes><span class=secno>5.2 </span>Wrapping a list of nodes</a></ol></li>
 <li><a href=#inline-formatting-commands><span class=secno>6 </span>Inline formatting commands</a>
  <ol>
   <li><a href=#inline-formatting-command-definitions><span class=secno>6.1 </span>Inline formatting command definitions</a></li>
   <li><a href=#assorted-inline-formatting-command-algorithms><span class=secno>6.2 </span>Assorted inline formatting command algorithms</a></li>
   <li><a href=#decomposing-a-range-into-nodes><span class=secno>6.3 </span>Decomposing a range into nodes</a></li>
   <li><a href="#clearing-an-element's-value"><span class=secno>6.4 </span>Clearing an element's value</a></li>
   <li><a href=#pushing-down-values><span class=secno>6.5 </span>Pushing down values</a></li>
   <li><a href=#forcing-the-value-of-a-node><span class=secno>6.6 </span>Forcing the value of a node</a></li>
   <li><a href=#setting-the-value-of-a-node><span class=secno>6.7 </span>Setting the value of a node</a></li>
   <li><a href=#the-backcolor-command><span class=secno>6.8 </span>The <code title="">backColor</code> command</a></li>
   <li><a href=#the-bold-command><span class=secno>6.9 </span>The <code title="">bold</code> command</a></li>
   <li><a href=#the-createlink-command><span class=secno>6.10 </span>The <code title="">createLink</code> command</a></li>
   <li><a href=#the-fontname-command><span class=secno>6.11 </span>The <code title="">fontName</code> command</a></li>
   <li><a href=#the-fontsize-command><span class=secno>6.12 </span>The <code title="">fontSize</code> command</a></li>
   <li><a href=#the-forecolor-command><span class=secno>6.13 </span>The <code title="">foreColor</code> command</a></li>
   <li><a href=#the-hilitecolor-command><span class=secno>6.14 </span>The <code title="">hiliteColor</code> command</a></li>
   <li><a href=#the-italic-command><span class=secno>6.15 </span>The <code title="">italic</code> command</a></li>
   <li><a href=#the-removeformat-command><span class=secno>6.16 </span>The <code title="">removeFormat</code> command</a></li>
   <li><a href=#the-strikethrough-command><span class=secno>6.17 </span>The <code title="">strikethrough</code> command</a></li>
   <li><a href=#the-subscript-command><span class=secno>6.18 </span>The <code title="">subscript</code> command</a></li>
   <li><a href=#the-superscript-command><span class=secno>6.19 </span>The <code title="">superscript</code> command</a></li>
   <li><a href=#the-underline-command><span class=secno>6.20 </span>The <code title="">underline</code> command</a></li>
   <li><a href=#the-unlink-command><span class=secno>6.21 </span>The <code title="">unlink</code> command</a></ol></li>
 <li><a href=#block-formatting-commands><span class=secno>7 </span>Block formatting commands</a>
  <ol>
   <li><a href=#block-formatting-command-definitions><span class=secno>7.1 </span>Block formatting command definitions</a></li>
   <li><a href=#assorted-block-formatting-command-algorithms><span class=secno>7.2 </span>Assorted block formatting command algorithms</a></li>
   <li><a href=#allowed-children><span class=secno>7.3 </span>Allowed children</a></li>
   <li><a href=#block-extending-a-range><span class=secno>7.4 </span>Block-extending a range</a></li>
   <li><a href=#deleting-the-contents-of-a-range><span class=secno>7.5 </span>Deleting the contents of a range</a></li>
   <li><a href=#outdenting-a-node><span class=secno>7.6 </span>Outdenting a node</a></li>
   <li><a href=#toggling-lists><span class=secno>7.7 </span>Toggling lists</a></li>
   <li><a href=#justifying-the-selection><span class=secno>7.8 </span>Justifying the selection</a></li>
   <li><a href=#the-delete-command><span class=secno>7.9 </span>The <code title="">delete</code> command</a></li>
   <li><a href=#the-formatblock-command><span class=secno>7.10 </span>The <code title="">formatBlock</code> command</a></li>
   <li><a href=#the-forwarddelete-command><span class=secno>7.11 </span>The <code title="">forwardDelete</code> command</a></li>
   <li><a href=#the-indent-command><span class=secno>7.12 </span>The <code title="">indent</code> command</a></li>
   <li><a href=#the-inserthtml-command><span class=secno>7.13 </span>The <code title="">insertHTML</code> command</a></li>
   <li><a href=#the-insertimage-command><span class=secno>7.14 </span>The <code title="">insertImage</code> command</a></li>
   <li><a href=#the-inserthorizontalrule-command><span class=secno>7.15 </span>The <code title="">insertHorizontalRule</code> command</a></li>
   <li><a href=#the-insertlinebreak-command><span class=secno>7.16 </span>The <code title="">insertLineBreak</code> command</a></li>
   <li><a href=#the-insertorderedlist-command><span class=secno>7.17 </span>The <code title="">insertOrderedList</code> command</a></li>
   <li><a href=#the-insertparagraph-command><span class=secno>7.18 </span>The <code title="">insertParagraph</code> command</a></li>
   <li><a href=#the-inserttext-command><span class=secno>7.19 </span>The <code title="">insertText</code> command</a></li>
   <li><a href=#the-insertunorderedlist-command><span class=secno>7.20 </span>The <code title="">insertUnorderedList</code> command</a></li>
   <li><a href=#the-justifycenter-command><span class=secno>7.21 </span>The <code title="">justifyCenter</code> command</a></li>
   <li><a href=#the-justifyfull-command><span class=secno>7.22 </span>The <code title="">justifyFull</code> command</a></li>
   <li><a href=#the-justifyleft-command><span class=secno>7.23 </span>The <code title="">justifyLeft</code> command</a></li>
   <li><a href=#the-justifyright-command><span class=secno>7.24 </span>The <code title="">justifyRight</code> command</a></li>
   <li><a href=#the-outdent-command><span class=secno>7.25 </span>The <code title="">outdent</code> command</a></ol></li>
 <li><a href=#miscellaneous-commands><span class=secno>8 </span>Miscellaneous commands</a>
  <ol>
   <li><a href=#the-selectall-command><span class=secno>8.1 </span>The <code title="">selectAll</code> command</a></li>
   <li><a href=#the-stylewithcss-command><span class=secno>8.2 </span>The <code title="">styleWithCSS</code> command</a></li>
   <li><a href=#the-usecss-command><span class=secno>8.3 </span>The <code title="">useCSS</code> command</a></ol></li>
 <li><a href=#additional-requirements><span class=secno>9 </span>Additional requirements</a></li>
 <li><a class=no-num href=#acknowledgements>Acknowledgements</a></ol>
<!--end-toc-->

<!--
Things that are only implemented by a couple of browsers and may or may not be
useful to spec:

* decreaseFontSize, increaseFontSize: Only implemented in Gecko and Opera.
* contentReadOnly, enableInlineTableEditing, enableObjectResizing, heading,
  insertBrOnReturn: MDC docs say not implemented in IE (didn't test).
* readOnly: MDC docs say it's a deprecated equivalent of contentReadOnly, so
  presumably like useCSS but less popular.
* 2D-Position, absolutePosition, clearAuthenticationCache, createBookmark,
  insertButton, insertFieldset, insertIframe, insertInput*, insertMarquee,
  insertSelectDropdown, insertSelectListbox, insertTextarea, liveResize,
  multipleSelection, overwrite, print, refresh, saveAs, unbookmark: Mentioned
  in MSDN docs but not MDC, so presumably IE-only.  Some of these seem
  inappropriate or useless, others will bear investigation.
* findString, fontSizeDelta, insertNewlineInQuotedContent, justifyNone, print,
  transpose: There's code for these in WebKit,
  Source/WebCore/editing/EditorCommand.cpp, but I didn't see them mentioned
  elsewhere.  Some might be worth adding.
* unselect: Seems to not be implemented by Gecko or Opera, and IE behaves
  oddly: it seems to collapse the selection instead of removing it.  Will only
  implement if there seems to be demand; it's redundant to
  Selection.removeAllRanges() anyway.

Things I haven't looked at that multiple browsers implement:

* copy, cut, paste: Needs attention to security.
* redo, undo: Needs review of the Google work on this; will probably be
  quite complicated.
-->

<h2 id=introduction><span class=secno>1 </span>Introduction</h2>

<p>This specification defines commands to edit HTML documents programmatically.
The APIs specified here were originally introduced in Microsoft's Internet
Explorer, but have subsequently been copied by other browsers in a haphazard
and imprecise fashion.  Although the behavior specified here does not exactly
match any browser at the time of writing, it can serve as a target to converge
to in the future.

<p>Where the reasoning behind the specification is of interest, such as when
major preexisting rendering engines are known not to match it, the reasoning is
included in HTML comments so as not to distract the reader.

<p>The principles I've used for writing this specification so far are:

<ul>
  <li>If all browsers that implement a particular feature agree on some detail
  of how it works, match them unless there's very good reason not to.  When
  it's not clear what behavior is best, try to follow the implementations with
  the most market share.  But if one browser's behavior is clearly better than
  the others', go with the better behavior.

  <li>If a command is issued to format some text in a particular way, we will
  format the text that way no matter what.  If the user clicks the "bold"
  button, they don't care that the text didn't become bold because of an
  external CSS rule or for any other reason, they only care that it didn't
  work.  The only exception (beyond where it's simply impossible, like
  propagated text-decorations we can't remove) is that we don't try to override
  !important rules from external stylesheets, although we also don't go out of
  our way to respect them.

  <li>When we're given a presentational command like "bold", don't modify
  anything other than presentational markup related to that command.  If an
  element has non-presentational attributes like id or class, don't split it up
  or remove it or anything.  At most convert it to a span, if it's some type of
  presentational element (where "presentational" here really means "browsers
  produce it in response to execCommand() so we need to treat it as
  presentational", so it includes things like <code class=external data-anolis-spec=html title="the strong element"><a href=http://www.whatwg.org/html/#the-strong-element>strong</a></code> and <code class=external data-anolis-spec=html title="the em element"><a href=http://www.whatwg.org/html/#the-em-element>em</a></code>).

  <li>Don't interfere with more markup than necessary.  If the user modifies
  only a small run of text, don't go around simplifying ancestors or siblings
  or whatever unless it's necessary to produce simpler markup in the place that
  was actually modified.

  <li>But if we are already changing around something's style, convert existing
  styles to the preferred format.  For instance, we use <code class=external data-anolis-spec=html title="the b element"><a href=http://www.whatwg.org/html/#the-b-element>b</a></code> for bold, and
  convert <code class=external data-anolis-spec=html title="the strong element"><a href=http://www.whatwg.org/html/#the-strong-element>strong</a></code> and &lt;<code class=external data-anolis-spec=html title="the span element"><a href=http://www.whatwg.org/html/#the-span-element>span</a></code> <code class=external data-anolis-spec=html title="the style attribute"><a href=http://www.whatwg.org/html/#the-style-attribute>style</a></code>="font-weight: bold"&gt; if we
  happen to be modifying that node anyway.

  <li>Try not to make the document less conforming than it originally was.  If
  we happen to make it more conforming, good, although we don't have to go out
  of our way to do that.  In some cases we do make the document less
  conforming, generally because there's some clear use-case that requires it or
  because it matches existing browsers behavior.  (For instance, see the
  styleWithCSS = false mode, and the fact that insertImage doesn't add an
  alt attribute, and how list-related commands can make list elements nested in
  one another directly without intervening &lt;li&gt;, etc.)

  <li>Keep the markup as concise as possible.  (I've received feedback that
  this is very important to authors.)  Ideally, the markup should look as
  simple and neat as what a human would have produced by hand-editing.  We do
  complicated manipulation to pull styles down from ancestors rather than
  having to use inline CSS, and make sure to tidy up any styles on elements
  that we happen to be modifying anyway.  Previous principles take precedence
  over this one, however.

  <li>I'm generally ignoring the existence of processing instructions, so
  they'll be treated more or less randomly.  (I'm ensuring that behavior is
  well-defined, I just don't care what it is.)  Comments are also unlikely to
  occur much for our purposes, but I try a little harder to make them behave
  not too unreasonably.
</ul>


<h2 id=issues><span class=secno>2 </span>Issues</h2>

<p>This specification is very preliminary and is undergoing constant change.
It should not be used for anything other than review, comment, and experimental
implementations that you don't intend to inflict on unwitting users without
their informed consent.  It should definitely be used for review and comment,
especially in the form of specific test-cases where the current spec produces
bad results.  As noted, feedback should be sent to <a href=http://lists.whatwg.org/listinfo.cgi/whatwg-whatwg.org>the WHATWG
list</a>.

<ul>
  <li>Need to make CSS terminology more precise, about setting/unsetting CSS
  properties.  The intent is to modify the style attribute, CSSOM-style.
  Likewise, CSS value comparisons need to be done after serializing both
  values, so "bold" == "700" and "red" == "#f00" and so on.

  <li>Also not sure about computed style.  There are differences between
  "computed" and "used" and things like that, what do we actually want here?

  <li>The wording I use for DOM stuff is not maximally precise.  Really I want
  DOM Core to define nice concepts that I can xref, like "insert a node".  I
  don't want to have to explicitly refer to DOM methods like insertBefore()
  every time I want to move things.

  <li>Some more thought needs to go into what happens to the selection when you
  mutate the DOM.  In some cases the results are pretty arbitrary.  It might
  make sense to do some kind of normalization.

  <li>JavaScript can modify the DOM synchronously in some cases, such as DOM
  mutation events and onunload when moving around iframes and objects.  This
  has to be dealt with somehow.  (Pointed out by Ryosuke Niwa of WebKit: <a href=http://lists.whatwg.org/pipermail/whatwg-whatwg.org/2011-March/030730.html>1</a>
  <a href=http://lists.whatwg.org/pipermail/whatwg-whatwg.org/2011-March/030751.html>2</a>)

  <li>I'm sloppy about handling things like nodes that don't descend from a
  Document, comments that are children of a Document, that sort of thing.  Not
  essential for prototyping, but needs to be cleaned up eventually.  Mostly we
  should be able to avoid the problems by requiring that everything be
  editable, since that immediately means it has to descend from an element or
  Document (and cannot be parentless itself).

  <li>I haven't paid much attention to performance.  The algorithms here aren't
  performance-critical in most cases, but I might have accidentally included
  some algorithms that are too slow anyway on large pages.  Generally I haven't
  worried about throwing nodes away and recreating them multiple times or
  things like that, as long as it produces the correct result.

  <li>I need to pay more attention to whitespace-only nodes.  In most cases
  these will have no visual effect, but they'll make many algorithms behave
  differently: decomposing a range, block-extending, etc.  In at least some
  cases, it's not even possible for the cursor to wind up in them, so maybe we
  don't need to bother marking them up or anything.

  <li>Tim Down <a href=http://lists.whatwg.org/pipermail/whatwg-whatwg.org/2011-May/031655.html>points
  out</a> that browsers have special behavior for formatting commands when the
  selection is collapsed.  Needs investigation.

  <li>What should be used as a line separator?  See <a href=http://lists.whatwg.org/htdig.cgi/whatwg-whatwg.org/2011-May/031577.html>lengthy
  discussion</a>.  This affects not only what happens when the user hits Enter,
  but also what happens when we need to separate lines for other reasons (e.g.,
  outdenting a list).  We likely want switches to allow authors to control this
  behavior, like Gecko's insertBrOnReturn and Opera's opera-defaultblock.
  Previously the spec assumed <code class=external data-anolis-spec=html title="the br element"><a href=http://www.whatwg.org/html/#the-br-element>br</a></code> should separate lines, which is like Gecko
  and sometimes WebKit, but I'm moving it to use <code class=external data-anolis-spec=html title="the p element"><a href=http://www.whatwg.org/html/#the-p-element>p</a></code> instead.

  <li><code class=external data-anolis-spec=html title="the br element"><a href=http://www.whatwg.org/html/#the-br-element>br</a></code>s are a nightmare.  I have tons of hacks all over the place which
  are totally wrong, mostly to account for the fact that sometimes <code class=external data-anolis-spec=html title="the br element"><a href=http://www.whatwg.org/html/#the-br-element>br</a></code>s do
  nothing and we need to treat that case magically.  I don't know what a good
  way is to fix this.

  <li>What happens if you do something like delete a selection or insert text
  or whatnot in the middle of a surrogate pair?  This could make the content
  not serialize through a character encoding change.
</ul>

<p class=XXX>A variety of other issues are also noted in the text, formatted
like this.


<h2 id=methods-of-the-htmldocument-interface><span class=secno>3 </span>Methods of the <code class=external data-anolis-spec=html><a href=http://www.whatwg.org/html/#htmldocument>HTMLDocument</a></code> interface</h2>

<p>The <dfn id=execcommand() title=execCommand()><code>execCommand(<var title="">command</var>,
<var title="">showUI</var>, <var title="">value</var>)</code></dfn> method on the
<code class=external data-anolis-spec=html><a href=http://www.whatwg.org/html/#htmldocument>HTMLDocument</a></code> interface allows scripts to
perform actions on the current selection or at the current caret position.
Generally, these commands would be used to implement editor UI, for example
having a "delete" button on a toolbar.  There are three variants to this
method, with one, two, and three arguments respectively. The <var title="">showUI</var>
and <var title="">value</var> parameters, even if specified, are ignored except where
otherwise stated.

<p>The <dfn id=querycommandstate() title=queryCommandState()><code>queryCommandState(<var title="">command</var>)</code></dfn>
method on the <code class=external data-anolis-spec=html><a href=http://www.whatwg.org/html/#htmldocument>HTMLDocument</a></code> interface allows
scripts to ask true-or-false status questions about the current selection, such
as whether it is bold or not.

<p>The <dfn id=querycommandvalue() title=queryCommandValue()><code>queryCommandValue(<var title="">command</var>)</code></dfn>
method on the <code class=external data-anolis-spec=html><a href=http://www.whatwg.org/html/#htmldocument>HTMLDocument</a></code> interface allows
scripts to get the value of some property of the current selection in string
form, such as what color it is.

<p>All three of these methods operate using particular <dfn id=command title=command>commands</dfn>, identified by a string <var title="">command</var> passed
as the first argument.  The <var title="">command</var> argument of all three methods
must be treated in an <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#ascii-case-insensitive>ASCII
case-insensitive</a> manner.  Each <a href=#command>command</a> is defined in its
own section of this specification.

<p><a href=#command title=command>Commands</a> may have an associated
<dfn id=action>action</dfn>, <dfn id=state>state</dfn>, <dfn id=value>value</dfn>, and/or <dfn id=relevant-css-property>relevant
CSS property</dfn>.  If not otherwise specified, the <a href=#action>action</a> for a
command is to do nothing, the <a href=#state>state</a> is false, the
<a href=#value>value</a> is the empty string, and the <a href=#relevant-css-property>relevant CSS
property</a> is null.
<!-- Requesting the state of an unknown command throws an exception in IE 9 RC
and Firefox 4b11, and returns boolean false in Chrome 10 and Opera 11.

Requesting the value of an unknown command throws an exception in IE 9 RC and
in Firefox 4b11.  It returns boolean false in Chrome 10, and the empty string
in Opera 11. -->

<!-- We have lots of options for the default value of commands.  Using bold as
an example, IE 9 RC returns the boolean false, Firefox 4b11 and Opera 11 both
return the empty string, Chrome 10 returns the string "false".  The HTML5 spec
as of February 2011 mandates WebKit's behavior.  It makes sense to always
return a string, a majority of string-returners return the empty string, and
three out of the four return something that evaluates to false as a boolean, so
I'll go with Firefox and Opera. -->

<p>When <code><a href=#execcommand()>execCommand()</a></code> is invoked, the user agent must follow the
<a href=#action>action</a> instructions given in this specification for
<var title="">command</var>, with <var title="">showUI</var> and <var title="">value</var> passed to the
instructions as arguments.  When <code><a href=#querycommandstate()>queryCommandState()</a></code> is invoked,
the user agent must return the <a href=#state>state</a> for <var title="">command</var>.  When
<code><a href=#querycommandvalue()>queryCommandValue()</a></code> is invoked, the user agent must return the
<a href=#value>value</a> for <var title="">command</var>.

<p>Most <a href=#command title=command>commands</a> act on the <dfn id=active-range>active range</dfn>.
This is defined to be the first <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range title=concept-range>range</a> in the <code class=external data-anolis-spec=domrange><a href=http://html5.org/specs/dom-range.html#selection>Selection</a></code> given by calling
<code class=external data-anolis-spec=domrange title=dom-Document-getSelection><a href=http://html5.org/specs/dom-range.html#dom-document-getselection>getSelection()</a></code> on the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#context-object>context object</a>, or null if there is no such
<a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range title=concept-range>range</a>.  If the <a href=#active-range>active range</a> is null, all <a href=#command title=command>commands</a> must behave as though they were not defined
except those in the <a href=#miscellaneous-commands>miscellaneous commands</a>
section.

<p class=XXX>Querying the value or state of an unrecognized command throws an
exception in IE and Firefox.  Need to consider changing to that behavior.

<p class=XXX>I say "first range" because I think that's what Gecko actually
does, and Gecko is the only one that allows multiple ranges in a selection.
This is keeping in mind that it stores ranges sorted by start, not by the order
the user added them, and silently removes or shortens existing ranges to avoid
overlap.  It probably makes the most sense in the long term to have the command
affect all ranges.  But I'll leave this for later.


<h2 id=common-definitions><span class=secno>4 </span>Common definitions</h2>

<p>An <dfn id=html-element>HTML element</dfn> is an <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element>Element</a></code> whose <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-element-namespace title=concept-element-namespace>namespace</a> is the
<a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#html-namespace>HTML namespace</a>.

<p>An <dfn id=inline-node>inline node</dfn> is either a <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#text>Text</a></code> node, or an <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element>Element</a></code> whose
"display" property computes to "inline", "inline-block", or "inline-table".

<p class=XXX>We might not want this to key off CSS; perhaps we should be
listing elements instead?  Needs testing.

<p>An <dfn id=editing-host>editing host</dfn> is a <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>node</a> that is either an <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element>Element</a></code> with
a <code class=external data-anolis-spec=html title=attr-contenteditable><a href=http://www.whatwg.org/html/#attr-contenteditable>contenteditable</a></code>
attribute set to the true state, or the <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element>Element</a></code> child of a <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#document>Document</a></code>
whose <code class=external data-anolis-spec=html><a href=http://www.whatwg.org/html/#designmode>designMode</a></code> is enabled.

<p>Something is <dfn id=editable>editable</dfn> if it is a <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>node</a> which is not an
<a href=#editing-host>editing host</a>, does not have a <code class=external data-anolis-spec=html title=attr-contenteditable><a href=http://www.whatwg.org/html/#attr-contenteditable>contenteditable</a></code> attribute set to the false
state, and whose <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> is an <a href=#editing-host>editing host</a> or
<a href=#editable>editable</a>.

<p class=note>An <a href=#editable>editable</a> node cannot be a <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#document>Document</a></code> or
<code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#documentfragment>DocumentFragment</a></code>, its <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> cannot be null, and it must descend from
either an <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element>Element</a></code> or a <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#document>Document</a></code>.

<p>The <dfn id=editing-host-of>editing host of</dfn> <var title="">node</var> is null if <var title="">node</var> is
neither <a href=#editable>editable</a> nor an <a href=#editing-host>editing host</a>; <var title="">node</var>
itself, if <var title="">node</var> is an <a href=#editing-host>editing host</a>; or the nearest
<a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-ancestor title=concept-tree-ancestor>ancestor</a> of <var title="">node</var> that is an <a href=#editing-host>editing host</a>, if
<var title="">node</var> is <a href=#editable>editable</a>.

<p>Two <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>nodes</a> are <dfn id=in-the-same-editing-host>in the same editing host</dfn> if the <a href=#editing-host-of>editing
host of</a> the first is non-null and the same as the <a href=#editing-host-of>editing host
of</a> the second.

<p class=note>Barring bugs, the algorithms here will not alter the attributes
of a non-editable element; will not remove a non-editable node from its parent
(except to immediately give it a new parent in the same editing host); and will
not add, remove, or reorder children of a node unless it is either editable or
an editing host.  An editing host is never editable, so authors are assured
that editing commands will only modify the editing host's contents and not the
editing host itself.

<!-- I don't remember why I wrote this.  Keeping it around just in case it
turns out to be useful.

<p><var title>node</var> is an <dfn>extraneous line break</dfn> if the following
algorithm returns true:

<p class=XXX>This is positively horrible.  It attempts to move complicated CSS
logic into DOM methods, and does so badly.  Can we somehow make this less evil,
preferably much less evil?

<ol>
  <li>If <var title>node</var> is not a <code data-anolis-spec=html title="the br element">br</code>, return false.

  <li>Let <var title>ancestor block</var> be <var title>node</var>.

  <li>While <var title>ancestor block</var> is an <span>inline node</span>, set
  <var title>ancestor block</var> to its <span data-anolis-spec=domcore title=concept-tree-parent>parent</span>.

  <li>Let <var title>previous box</var> be <var title>node</var>.

  <li>While <var title>previous box</var> is equal to or an <span data-anolis-spec=domcore title=concept-tree-ancestor>ancestor</span> of
  <var title>node</var>, set <var title>previous box</var> to the <span data-anolis-spec=domcore title=concept-node>node</span> immediately
  before it in <span data-anolis-spec=domcore>tree order</span>, or null if there is no such <span data-anolis-spec=domcore title=concept-node>node</span>.

  <li>Let <var title>next box</var> be the <span data-anolis-spec=domcore title=concept-node>node</span> immediately after <var title>node</var>
  in <span data-anolis-spec=domcore>tree order</span>, or null if there is such <span data-anolis-spec=domcore title=concept-node>node</span>.

  <li>If <var title>previous box</var> is null, or is not a <span data-anolis-spec=domcore title=concept-tree-descendant>descendant</span> of
  <var title>ancestor block</var>, or is not an <span>inline node</span>, or is a
  <code data-anolis-spec=html title="the br element">br</code>, return false.
  <!- -
  This means br either is the first thing in its block container that generates
  an inline box, or it's the first thing after another block container, or the
  first thing after a br.  In any case, the line break will be visible.

  Otherwise, it will be invisible as long as it immediately precedes a block
  box boundary.
  - ->

  <li>If <var title>ancestor block</var> is not null and <var title>node</var> is the last
  <span data-anolis-spec=domcore title=concept-tree-descendant>descendant</span> of <var title>ancestor block</var>, return true.
  <!- - Precedes the end of ancestor block's box. - ->

  <li>If <var title>next box</var> is not null and not an <span>inline node</span>,
  return true.
  <!- - Precedes the start of next box's box. - ->

  <li>Return false.
</ol>
-->

<p>Each <code class=external data-anolis-spec=html><a href=http://www.whatwg.org/html/#htmldocument>HTMLDocument</a></code> has a boolean <dfn id=css-styling-flag>CSS styling flag</dfn> associated
with it, which must initially be false.  (<a href=#the-stylewithcss-command>The <code title="">styleWithCSS</code> command</a> can be used to modify or query it, by
means of the <code><a href=#execcommand()>execCommand()</a></code> and <code><a href=#querycommandstate()>queryCommandState()</a></code>
methods.)

<p>When the user agent is instructed to run a particular method, it must follow
the steps defined for that method in the appropriate specification, not act as
though the method had actually been called from JavaScript.  In particular,
if the author has overridden the method with a custom method, the standard
method must be run rather than the custom one.

<p>When a list or set of <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>nodes</a> is assigned to a variable without specifying
the order, they must be initially in <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#tree-order>tree order</a>, if they share a root.
(If they don't share a root, the order will be specified.)  When the user agent
is instructed to run particular steps for each member of a list, it must do so
sequentially in the list's order.


<h2 id=common-algorithms><span class=secno>5 </span>Common algorithms</h2>

<h3 id=assorted-common-algorithms><span class=secno>5.1 </span>Assorted common algorithms</h3>

<p>To move a <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>node</a> to a new location, <dfn id=preserving-ranges>preserving ranges</dfn>, remove
the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>node</a> from its original <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> (if any), then insert it in the new
location.  In doing so, however, ignore the regular <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#range-mutation-rules>range mutation rules</a>, and
instead follow these rules:

<ol>
  <li>Let <var title="">node</var> be the moved <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>node</a>, <var title="">old parent</var> and
  <var title="">old index</var> be the old <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> (which may be null) and <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-indexof title=concept-indexof>index</a>,
  and <var title="">new parent</var> and <var title="">new index</var> be the new <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> and
  <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-indexof title=concept-indexof>index</a>.

  <li>If a <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point title=concept-boundary-point>boundary point</a>'s <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a> is the same as or a <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-descendant title=concept-tree-descendant>descendant</a> of
  <var title="">node</var>, leave it unchanged, so it moves to the new location.  <!--
  This is actually implicit, but I state it anyway for completeness. -->

  <li>If a <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point title=concept-boundary-point>boundary point</a>'s <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a> is <var title="">new parent</var> and its
  <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-offset title=concept-boundary-point-offset>offset</a> is greater than <var title="">new index</var>, add one to its
  <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-offset title=concept-boundary-point-offset>offset</a>.

  <li>If a <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point title=concept-boundary-point>boundary point</a>'s <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a> is <var title="">old parent</var> and its
  <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-offset title=concept-boundary-point-offset>offset</a> is <var title="">old index</var> or <var title="">old index</var> + 1, set its
  <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a> to <var title="">new parent</var> and add <var title="">new index</var> &minus;
  <var title="">old index</var> to its <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-offset title=concept-boundary-point-offset>offset</a>.

  <li>If a <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point title=concept-boundary-point>boundary point</a>'s <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a> is <var title="">old parent</var> and its
  <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-offset title=concept-boundary-point-offset>offset</a> is greater than <var title="">old index</var> + 1, subtract one from its
  <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-offset title=concept-boundary-point-offset>offset</a>.
</ol>

<p>To <dfn id=set-the-tag-name>set the tag name</dfn> of an <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element>Element</a></code> <var title="">element</var> to
<var title="">new name</var>:

<p class=XXX>Do we want to get rid of attributes that are no longer allowed
here?

<ol>
  <li>If <var title="">element</var> is an <a href=#html-element>HTML element</a> with <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-element-local-name title=concept-element-local-name>local name</a>
  equal to <var title="">new name</var>, return <var title="">element</var>.

  <li>If <var title="">element</var>'s <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> is null, return <var title="">element</var>.

  <li>Let <var title="">replacement element</var> be the result of calling <code class=external data-anolis-spec=domcore title=dom-Document-createElement><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-document-createelement>createElement(<var title="">new name</var>)</a></code> on
  the <code class=external data-anolis-spec=domcore title=dom-Node-ownerDocument><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-ownerdocument>ownerDocument</a></code> of <var title="">element</var>.

  <li>Insert <var title="">replacement element</var> into <var title="">element</var>'s
  <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> immediately before <var title="">element</var>.

  <li>Copy all attributes of <var title="">element</var> to <var title="">replacement
  element</var>, in order.

  <li>While <var title="">element</var> has <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>children</a>, append the first <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> of
  <var title="">element</var> as the last <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> of <var title="">replacement element</var>,
  <a href=#preserving-ranges>preserving ranges</a>.

  <li>Remove <var title="">element</var> from its <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a>.

  <li>Return <var title="">replacement element</var>.
</ol>

<p>To <dfn id=remove-extraneous-line-breaks-before>remove extraneous line breaks before</dfn> a <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>node</a>
<var title="">node</var>:

<ol>
  <li>If <var title="">node</var> is not an <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element>Element</a></code>, or it is an <a href=#inline-node>inline
  node</a>, do nothing and abort these steps.

  <li>If the <code class=external data-anolis-spec=domcore title=dom-Node-previousSibling><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-previoussibling>previousSibling</a></code> of <var title="">node</var> is a <code class=external data-anolis-spec=html title="the br element"><a href=http://www.whatwg.org/html/#the-br-element>br</a></code>, and the
  <code class=external data-anolis-spec=domcore title=dom-Node-previousSibling><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-previoussibling>previousSibling</a></code> of the <code class=external data-anolis-spec=domcore title=dom-Node-previousSibling><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-previoussibling>previousSibling</a></code> of <var title="">node</var> is an
  <a href=#inline-node>inline node</a> that is not a <code class=external data-anolis-spec=html title="the br element"><a href=http://www.whatwg.org/html/#the-br-element>br</a></code>, remove the <code class=external data-anolis-spec=domcore title=dom-Node-previousSibling><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-previoussibling>previousSibling</a></code>
  of <var title="">node</var> from its <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a>.
</ol>

<p>To <dfn id=remove-extraneous-line-breaks-at-the-end-of>remove extraneous line breaks at the end of</dfn> a <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>node</a>
<var title="">node</var>:

<ol>
  <li>If <var title="">node</var> is not an <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element>Element</a></code>, or it is an <a href=#inline-node>inline
  node</a>, do nothing and abort these steps.

  <li>If <var title="">node</var> has at least two <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>children</a>, and its last <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a>
  is a <code class=external data-anolis-spec=html title="the br element"><a href=http://www.whatwg.org/html/#the-br-element>br</a></code>, and its second-to-last <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> is an <a href=#inline-node>inline node</a>
  that is not a <code class=external data-anolis-spec=html title="the br element"><a href=http://www.whatwg.org/html/#the-br-element>br</a></code>, remove the last <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> of <var title="">node</var> from
  <var title="">node</var>.
</ol>

<p>To <dfn id=remove-extraneous-line-breaks-from>remove extraneous line breaks from</dfn> a <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>node</a>, first
<a href=#remove-extraneous-line-breaks-before>remove extraneous line breaks before</a> it, then <a href=#remove-extraneous-line-breaks-at-the-end-of>remove
extraneous line breaks at the end of</a> it.

<p>To <dfn id=split-the-parent>split the parent</dfn> of a list <var title="">node list</var> of consecutive
<a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-sibling title=concept-tree-sibling>sibling</a> <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>nodes</a>:

<p class=XXX>Pretty much any time we call this algorithm, it can cause trouble
if the parent had styles, classes, etc.  There's not going to be any general
way to handle this, but we should at least try to handle the special case of
inline styles, because Firefox does actually add them to arbitrary elements.
Also, when splitting out of an inline parent, it might be good to wrap all the
inline descendants in a clone of the former parent.

<ol>
  <li>Let <var title="">original parent</var> be the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> of the first member of
  <var title="">node list</var>.

  <li>If <var title="">original parent</var> is not <a href=#editable>editable</a> or its
  <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> is null, do nothing and abort these steps.

  <li>If the first <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> of <var title="">original parent</var> is in <var title="">node
  list</var>, <a href=#remove-extraneous-line-breaks-before>remove extraneous line breaks before</a> <var title="">original
  parent</var>.

  <li>If <var title="">original parent</var> is not an <a href=#inline-node>inline node</a>, and the
  last <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> of <var title="">original parent</var> is in <var title="">node list</var>, and
  <var title="">original parent</var>'s last <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> and <code class=external data-anolis-spec=domcore title=dom-Node-nextSibling><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-nextsibling>nextSibling</a></code> are both
  <a href=#inline-node title="inline node">inline nodes</a>, and <var title="">original
  parent</var>'s last <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> is not a <code class=external data-anolis-spec=html title="the br element"><a href=http://www.whatwg.org/html/#the-br-element>br</a></code>, call <code class=external data-anolis-spec=domcore title=dom-Document-createElement><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-document-createelement>createElement("br")</a></code> on the
  <code class=external data-anolis-spec=domcore title=dom-Node-ownerDocument><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-ownerdocument>ownerDocument</a></code> of <var title="">original parent</var>, then insert the result into
  the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> of <var title="">original parent</var> immediately after <var title="">original
  parent</var>.

  <li>If the first <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> of <var title="">original parent</var> is not in <var title="">node
  list</var>, but its last <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> is:

  <div class=XXX>
  <p>We insert things after the parent.  This is bad, because it will cause
  them to become part of any ranges that immediately follow.  For instance, if
  we're hitting "bar" in

  </p><xmp><div><p>foo<p>bar</div>{<p>baz}</xmp>

  <p>it becomes

  </p><xmp><div><p>foo</div>{<p>bar<p>baz}</xmp>

  <p>instead of

  </p><xmp><div><p>foo</div><p>bar{<p>baz}</xmp>

  <p>because of how range mutation rules work.  This doesn't happen if we
  insert before.  Probably this isn't important enough to try working around,
  though.
  </div>

  <ol>
    <li>For each <var title="">node</var> in <var title="">node list</var>, <em>in reverse
    order</em>, insert <var title="">node</var> into the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> of <var title="">original
    parent</var> immediately after <var title="">original parent</var>, <a href=#preserving-ranges>preserving
    ranges</a>.

    <li><a href=#remove-extraneous-line-breaks-at-the-end-of>Remove extraneous line breaks at the end of</a> <var title="">original
    parent</var>.

    <li>Abort these steps.
  </ol>

  <li>If the first <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> of <var title="">original parent</var> is not in <var title="">node
  list</var>:

  <ol>
    <li>Let <var title="">cloned parent</var> be the result of calling <code class=external data-anolis-spec=domcore title=dom-Node-cloneNode><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-clonenode>cloneNode(false)</a></code>
    on <var title="">original parent</var>.

    <p class=XXX>This will duplicate id's, as well as other bad things.  Do we
    care?  We don't want to not copy attributes at all, because that wouldn't
    copy style attributes, and Firefox in CSS mode will actually add style
    attributes to any elements it feels like.  If we do exclude id's, even
    though they'd only occur if someone manually added them, do we want to
    exclude other things like itemid or accesskey or . . .

    <li>Insert <var title="">cloned parent</var> into the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> of <var title="">original
    parent</var> immediately before <var title="">original parent</var>.

    <li>While the <code class=external data-anolis-spec=domcore title=dom-Node-previousSibling><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-previoussibling>previousSibling</a></code> of the first member of <var title="">node
    list</var> is not null, append the first <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> of <var title="">original
    parent</var> as the last <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> of <var title="">cloned parent</var>,
    <a href=#preserving-ranges>preserving ranges</a>.
  </ol>

  <li>If the first member of <var title="">node list</var> is an <a href=#inline-node>inline
  node</a>, and <var title="">original parent</var>'s <code class=external data-anolis-spec=domcore title=dom-Node-previousSibling><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-previoussibling>previousSibling</a></code> is an
  <a href=#inline-node>inline node</a> other than a <code class=external data-anolis-spec=html title="the br element"><a href=http://www.whatwg.org/html/#the-br-element>br</a></code>, and <var title="">original parent</var>
  is not an <a href=#inline-node>inline node</a>, call <code class=external data-anolis-spec=domcore title=dom-Document-createElement><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-document-createelement>createElement("br")</a></code> on the
  <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#context-object>context object</a>, then insert the result into the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> of
  <var title="">original parent</var> immediately before <var title="">original parent</var>.

  <li>For each <var title="">node</var> in <var title="">node list</var>, insert <var title="">node</var>
  into the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> of <var title="">original parent</var> immediately before
  <var title="">original parent</var>, <a href=#preserving-ranges>preserving ranges</a>.
  <!-- Notice that a boundary point that was immediately before the element
  will now be immediately before its children, just because of the regular
  range mutation rules, without needing to worry about preserving ranges.
  Likewise for boundary points immediately after the element, if we wind up
  removing the element in the final step.  Preserving ranges is only necessary
  for the sake of boundary points in the element or its descendants. -->

  <li>If the last member of <var title="">node list</var> is an <a href=#inline-node>inline node</a>
  other than a <code class=external data-anolis-spec=html title="the br element"><a href=http://www.whatwg.org/html/#the-br-element>br</a></code>, and the first <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> of <var title="">original parent</var> is
  a <code class=external data-anolis-spec=html title="the br element"><a href=http://www.whatwg.org/html/#the-br-element>br</a></code>, and <var title="">original parent</var> is not an <a href=#inline-node>inline node</a>,
  remove the first <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> of <var title="">original parent</var> from <var title="">original
  parent</var>.

  <li>If <var title="">original parent</var> has no <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>children</a>, remove it from its
  <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a>.

  <li>Otherwise, <a href=#remove-extraneous-line-breaks-before>remove extraneous line breaks before</a>
  <var title="">original parent</var>.

  <li>If <var title="">node list</var>'s last member's <code class=external data-anolis-spec=domcore title=dom-Node-nextSibling><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-nextsibling>nextSibling</a></code> is null,
  <a href=#remove-extraneous-line-breaks-at-the-end-of>remove extraneous line breaks at the end of</a> <var title="">node
  list</var>'s last member's <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a>.
</ol>

<p>To remove a <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>node</a> <var title="">node</var> while <dfn id=preserving-its-descendants>preserving its
descendants</dfn>, <a href=#split-the-parent>split the parent</a> of <var title="">node</var>'s
<a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>children</a>.


<h3 id=wrapping-a-list-of-nodes><span class=secno>5.2 </span>Wrapping a list of nodes</h3>

<p>To <dfn id=wrap>wrap</dfn> a list <var title="">node list</var> of consecutive <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-sibling title=concept-tree-sibling>sibling</a>
<a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>nodes</a>, given <dfn id=sibling-criteria>sibling criteria</dfn> and <dfn id=new-parent-instructions>new parent
instructions</dfn>:

<ol>
  <li>If <var title="">node list</var> is empty, or the first member of <var title="">node
  list</var> is not <a href=#editable>editable</a>, return null and abort these steps.

  <li>If <var title="">node list</var>'s last member is an <a href=#inline-node>inline node</a>
  that's not a <code class=external data-anolis-spec=html title="the br element"><a href=http://www.whatwg.org/html/#the-br-element>br</a></code>, and <var title="">node list</var>'s last member's <code class=external data-anolis-spec=domcore title=dom-Node-nextSibling><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-nextsibling>nextSibling</a></code>
  is a <code class=external data-anolis-spec=html title="the br element"><a href=http://www.whatwg.org/html/#the-br-element>br</a></code>, append that <code class=external data-anolis-spec=html title="the br element"><a href=http://www.whatwg.org/html/#the-br-element>br</a></code> to <var title="">node list</var>.
  <!-- Trailing br's like this always need to go along with their line.
  Otherwise they'll create an extra line if we wrap in a block element, instead
  of vanishing as they should. -->

  <li>If the <code class=external data-anolis-spec=domcore title=dom-Node-previousSibling><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-previoussibling>previousSibling</a></code> of the first member of <var title="">node list</var>
  is <a href=#editable>editable</a> and meets the <a href=#sibling-criteria>sibling criteria</a>, let
  <var title="">new parent</var> be the <code class=external data-anolis-spec=domcore title=dom-Node-previousSibling><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-previoussibling>previousSibling</a></code> of the first member of
  <var title="">node list</var>.

  <li>Otherwise, if the <code class=external data-anolis-spec=domcore title=dom-Node-nextSibling><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-nextsibling>nextSibling</a></code> of the last member of <var title="">node
  list</var> is <a href=#editable>editable</a> and meets the <a href=#sibling-criteria>sibling
  criteria</a>, let <var title="">new parent</var> be the <code class=external data-anolis-spec=domcore title=dom-Node-nextSibling><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-nextsibling>nextSibling</a></code> of the last
  member of <var title="">node list</var>.

  <li>Otherwise, run the <a href=#new-parent-instructions>new parent instructions</a>, and let <var title="">new
  parent</var> be the result.

  <li>If <var title="">new parent</var> is null, abort these steps and return null.
  <!-- This can only happen if the new parent instructions are run and they
  return null.  This can be used to only merge with adjacent siblings, in case
  you don't want to create a new parent if that fails. -->

  <li>If <var title="">new parent</var>'s <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> is null:

  <ol>
    <li>Insert <var title="">new parent</var> into the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> of the first member of
    <var title="">node list</var> immediately before the first member of <var title="">node
    list</var>.

    <li>If any <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range title=concept-range>range</a> has a <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point title=concept-boundary-point>boundary point</a> with <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a> equal to the
    <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> of <var title="">new parent</var> and <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-offset title=concept-boundary-point-offset>offset</a> equal to the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-indexof title=concept-indexof>index</a>
    of <var title="">new parent</var>, add one to that <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point title=concept-boundary-point>boundary point</a>'s <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-offset title=concept-boundary-point-offset>offset</a>.
    <!--
    Basically, we want any boundary points around the wrapped nodes to go
    inside the wrapper.  Without this step, wrapping "{}<br>" in a blockquote
    would go like

      {}<br>
      -> {}<blockquote></blockquote><br>
      -> {}<blockquote></blockquote><br>.

    The second line is due to range mutation rules: a boundary point with an
    offset equal to the index of a newly-inserted node stays put, so it remains
    before it.  With this step, it goes like

      {}<br>
      -> {}<blockquote></blockquote><br>
      -> <blockquote></blockquote>{}<br>
      -> <blockquote>{}<br></blockquote>.

    The difference in the final step is because we move the <br> "preserving
    ranges".  This means that adjacent boundary points get swept along with it.
    Previously, the <blockquote> intervened, so a boundary point after it would
    get taken along but one before it would not.

    Another solution that one might be tempted to consider would be to just put
    the wrapper after the wrapped elements.  Then the boundary points would
    stay put, before the wrapper, so they'd still be adjacent to the nodes to
    be wrapped, like:

      {<p>foo</p>}
      -> {<p>foo</p>}<blockquote></blockquote>
      -> <blockquote>{<p>foo</p>}</blockquote>.

    The problem is that this completely breaks if you're wrapping multiple
    things and not all are selected.  It would go like this:

      <p>foo</p>{<p>bar</p>}
      -> <p>foo</p>{<p>bar</p>}<blockquote></blockquote>
      -> <p>foo</p><blockquote>{<p>bar</p>}</blockquote>
      -> <blockquote>{<p>foo</p><p>bar</p>}</blockquote>.

    The last step is again because of the range mutation rules: the boundary
    point stays put when a new node is inserted.  They're fundamentally
    asymmetric.

    An alternative solution would be to define the concept of moving a list of
    adjacent sibling nodes while preserving ranges, and handle this explicitly
    at a more abstract level.
    -->

    <p class=XXX>Not clear this is the best solution.  See comment.
  </ol>

  <li>Let <var title="">original parent</var> be the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> of the first member of
  <var title="">node list</var>.

  <li>If <var title="">new parent</var> is before the first member of <var title="">node
  list</var> in <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#tree-order>tree order</a>:

  <ol>
    <li>If <var title="">new parent</var> is not an <a href=#inline-node>inline node</a>, but the
    last <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> of <var title="">new parent</var> and the first member of <var title="">node
    list</var> are both <a href=#inline-node title="inline node">inline nodes</a>, and the
    last <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> of <var title="">new parent</var> is not a <code class=external data-anolis-spec=html title="the br element"><a href=http://www.whatwg.org/html/#the-br-element>br</a></code>, call <code class=external data-anolis-spec=domcore title=dom-Document-createElement><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-document-createelement>createElement("br")</a></code> on the
    <code class=external data-anolis-spec=domcore title=dom-Node-ownerDocument><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-ownerdocument>ownerDocument</a></code> of <var title="">new parent</var> and append the result as the
    last <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> of <var title="">new parent</var>.

    <li>For each <var title="">node</var> in <var title="">node list</var>, append
    <var title="">node</var> as the last <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> of <var title="">new parent</var>,
    <a href=#preserving-ranges>preserving ranges</a>.
  </ol>

  <li>Otherwise:

  <ol>
    <li>If <var title="">new parent</var> is not an <a href=#inline-node>inline node</a>, but the
    first <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> of <var title="">new parent</var> and the last member of <var title="">node
    list</var> are both <a href=#inline-node title="inline node">inline nodes</a>, and the
    last member of <var title="">node list</var> is not a <code class=external data-anolis-spec=html title="the br element"><a href=http://www.whatwg.org/html/#the-br-element>br</a></code>, call <code class=external data-anolis-spec=domcore title=dom-Document-createElement><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-document-createelement>createElement("br")</a></code> on the
    <code class=external data-anolis-spec=domcore title=dom-Node-ownerDocument><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-ownerdocument>ownerDocument</a></code> of <var title="">new parent</var> and insert the result as the
    first <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> of <var title="">new parent</var>.

    <li>For each <var title="">node</var> in <var title="">node list</var>, <em>in reverse
    order</em>, insert <var title="">node</var> as the first <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> of <var title="">new
    parent</var>, <a href=#preserving-ranges>preserving ranges</a>.
  </ol>

  <li>If <var title="">original parent</var> is <a href=#editable>editable</a> and has no
  <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>children</a>, remove it from its <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a>.
  <!-- This could happen if the new parent instructions returned a node whose
  parent wasn't null. -->

  <li>If <var title="">new parent</var>'s <code class=external data-anolis-spec=domcore title=dom-Node-nextSibling><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-nextsibling>nextSibling</a></code> is <a href=#editable>editable</a> and
  meets the <a href=#sibling-criteria>sibling criteria</a>:
  <!-- Probably because both the previous and next sibling met them.  We want
  to merge them in this case. -->

  <ol>
    <li>If <var title="">new parent</var> is not an <a href=#inline-node>inline node</a>, but
    <var title="">new parent</var>'s last <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> and <var title="">new parent</var>'s
    <code class=external data-anolis-spec=domcore title=dom-Node-nextSibling><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-nextsibling>nextSibling</a></code>'s first <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> are both <a href=#inline-node title="inline node">inline
    nodes</a>, and <var title="">new parent</var>'s last <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> is not a <code class=external data-anolis-spec=html title="the br element"><a href=http://www.whatwg.org/html/#the-br-element>br</a></code>,
    call <code class=external data-anolis-spec=domcore title=dom-Document-createElement><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-document-createelement>createElement("br")</a></code> on the
    <code class=external data-anolis-spec=domcore title=dom-Node-ownerDocument><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-ownerdocument>ownerDocument</a></code> of <var title="">new parent</var> and append the result as the
    last <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> of <var title="">new parent</var>.

    <li>While <var title="">new parent</var>'s <code class=external data-anolis-spec=domcore title=dom-Node-nextSibling><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-nextsibling>nextSibling</a></code> has <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>children</a>, append
    its first <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> as the last <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> of <var title="">new parent</var>,
    <a href=#preserving-ranges>preserving ranges</a>.

    <li>Remove <var title="">new parent</var>'s <code class=external data-anolis-spec=domcore title=dom-Node-nextSibling><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-nextsibling>nextSibling</a></code> from its <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a>.
  </ol>

  <li><a href=#remove-extraneous-line-breaks-from>Remove extraneous line breaks from</a> <var title="">new parent</var>.

  <li>Return <var title="">new parent</var>.
</ol>


<h2 id=inline-formatting-commands><span class=secno>6 </span>Inline formatting commands</h2>

<h3 id=inline-formatting-command-definitions><span class=secno>6.1 </span>Inline formatting command definitions</h3>

<p>A <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>node</a> is <dfn id=effectively-contained>effectively contained</dfn> in a <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range title=concept-range>range</a> if either it
is <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#contained>contained</a> in the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range title=concept-range>range</a>; or it is the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range title=concept-range>range</a>'s <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a>
<a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a>, it is a <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#text>Text</a></code> node, and its <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-node-length title=concept-node-length>length</a> is different from the
<a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range title=concept-range>range</a>'s <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-offset title=concept-boundary-point-offset>offset</a>; or it is the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range title=concept-range>range</a>'s <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-end title=concept-range-end>end</a>
<a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a>, it is a <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#text>Text</a></code> node, and the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range title=concept-range>range</a>'s <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-end title=concept-range-end>end</a>
<a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-offset title=concept-boundary-point-offset>offset</a> is not 0; or it has at least one <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a>, and all its
<a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>children</a> are <a href=#effectively-contained>effectively contained</a> in the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range title=concept-range>range</a>.
<!-- Logically, the effectively contained nodes are supposed to be the ones
returned by decomposing the range, or their descendants.  We can't actually
define it that way, because decomposing the range has side effects (calling
splitText()), and anyway text nodes might not be returned by decomposing even
if they're effectively contained: it might be that the new node created by
splitText() is returned. -->

<p>An <dfn id=unwrappable-node>unwrappable node</dfn> is an <a href=#html-element>HTML element</a> which may not
be used where only <a class=external data-anolis-spec=html href=http://www.whatwg.org/html/#phrasing-content>phrasing content</a> is expected (not counting unknown or
obsolete elements, which cannot be used at all); or any <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element>Element</a></code> whose
display property computes to something other than "inline", "inline-block", or
"inline-table"; or any <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>node</a> that is not <a href=#editable>editable</a>.

<p class=XXX>Probably want to redefine unwrappable node in terms of allowed
children or something.

<p>A <dfn id=modifiable-element>modifiable element</dfn> is a <code class=external data-anolis-spec=html title="the b element"><a href=http://www.whatwg.org/html/#the-b-element>b</a></code>, <code class=external data-anolis-spec=html title="the em element"><a href=http://www.whatwg.org/html/#the-em-element>em</a></code>, <code class=external data-anolis-spec=html title="the i element"><a href=http://www.whatwg.org/html/#the-i-element>i</a></code>, <code class=external data-anolis-spec=html title="the s element"><a href=http://www.whatwg.org/html/#the-s-element>s</a></code>, <code class=external data-anolis-spec=html title="the span element"><a href=http://www.whatwg.org/html/#the-span-element>span</a></code>,
<code class=external data-anolis-spec=html title="the strike element"><a href=http://www.whatwg.org/html/#the-strike-element>strike</a></code>, <code class=external data-anolis-spec=html title="the strong element"><a href=http://www.whatwg.org/html/#the-strong-element>strong</a></code>, <code class=external data-anolis-spec=html title="the sub and sup elements"><a href=http://www.whatwg.org/html/#the-sub-and-sup-elements>sub</a></code>, <code class=external data-anolis-spec=html title="the sub and sup elements"><a href=http://www.whatwg.org/html/#the-sub-and-sup-elements>sup</a></code>, or <code class=external data-anolis-spec=html title="the u element"><a href=http://www.whatwg.org/html/#the-u-element>u</a></code> element with no attributes
except possibly <code class=external data-anolis-spec=html title="the style attribute"><a href=http://www.whatwg.org/html/#the-style-attribute>style</a></code>; or a <code class=external data-anolis-spec=html title=font><a href=http://www.whatwg.org/html/#font>font</a></code> element with no attributes except
possibly <code class=external data-anolis-spec=html title="the style attribute"><a href=http://www.whatwg.org/html/#the-style-attribute>style</a></code>, <code class=external data-anolis-spec=html title=dom-font-color><a href=http://www.whatwg.org/html/#dom-font-color>color</a></code>, <code class=external data-anolis-spec=html title=dom-font-face><a href=http://www.whatwg.org/html/#dom-font-face>face</a></code>, and/or <code class=external data-anolis-spec=html title=dom-font-size><a href=http://www.whatwg.org/html/#dom-font-size>size</a></code>; or an
<code class=external data-anolis-spec=html title="the a element"><a href=http://www.whatwg.org/html/#the-a-element>a</a></code> element with no attributes except possibly <code class=external data-anolis-spec=html title="the style attribute"><a href=http://www.whatwg.org/html/#the-style-attribute>style</a></code> and/or <code class=external data-anolis-spec=html title=attr-hyperlink-href><a href=http://www.whatwg.org/html/#attr-hyperlink-href>href</a></code>.

<p>A <dfn id=simple-modifiable-element>simple modifiable element</dfn> is an <a href=#html-element>HTML element</a> for
which at least one of the following holds:

<ul>
  <li>It is an <code class=external data-anolis-spec=html title="the a element"><a href=http://www.whatwg.org/html/#the-a-element>a</a></code>, <code class=external data-anolis-spec=html title="the b element"><a href=http://www.whatwg.org/html/#the-b-element>b</a></code>, <code class=external data-anolis-spec=html title="the em element"><a href=http://www.whatwg.org/html/#the-em-element>em</a></code>, <code class=external data-anolis-spec=html title=font><a href=http://www.whatwg.org/html/#font>font</a></code>, <code class=external data-anolis-spec=html title="the i element"><a href=http://www.whatwg.org/html/#the-i-element>i</a></code>, <code class=external data-anolis-spec=html title="the s element"><a href=http://www.whatwg.org/html/#the-s-element>s</a></code>, <code class=external data-anolis-spec=html title="the span element"><a href=http://www.whatwg.org/html/#the-span-element>span</a></code>,
  <code class=external data-anolis-spec=html title="the strike element"><a href=http://www.whatwg.org/html/#the-strike-element>strike</a></code>, <code class=external data-anolis-spec=html title="the strong element"><a href=http://www.whatwg.org/html/#the-strong-element>strong</a></code>, <code class=external data-anolis-spec=html title="the sub and sup elements"><a href=http://www.whatwg.org/html/#the-sub-and-sup-elements>sub</a></code>, <code class=external data-anolis-spec=html title="the sub and sup elements"><a href=http://www.whatwg.org/html/#the-sub-and-sup-elements>sup</a></code>, or <code class=external data-anolis-spec=html title="the u element"><a href=http://www.whatwg.org/html/#the-u-element>u</a></code> element with no
  attributes.

  <li>It is an <code class=external data-anolis-spec=html title="the a element"><a href=http://www.whatwg.org/html/#the-a-element>a</a></code>, <code class=external data-anolis-spec=html title="the b element"><a href=http://www.whatwg.org/html/#the-b-element>b</a></code>, <code class=external data-anolis-spec=html title="the em element"><a href=http://www.whatwg.org/html/#the-em-element>em</a></code>, <code class=external data-anolis-spec=html title=font><a href=http://www.whatwg.org/html/#font>font</a></code>, <code class=external data-anolis-spec=html title="the i element"><a href=http://www.whatwg.org/html/#the-i-element>i</a></code>, <code class=external data-anolis-spec=html title="the s element"><a href=http://www.whatwg.org/html/#the-s-element>s</a></code>, <code class=external data-anolis-spec=html title="the span element"><a href=http://www.whatwg.org/html/#the-span-element>span</a></code>,
  <code class=external data-anolis-spec=html title="the strike element"><a href=http://www.whatwg.org/html/#the-strike-element>strike</a></code>, <code class=external data-anolis-spec=html title="the strong element"><a href=http://www.whatwg.org/html/#the-strong-element>strong</a></code>, <code class=external data-anolis-spec=html title="the sub and sup elements"><a href=http://www.whatwg.org/html/#the-sub-and-sup-elements>sub</a></code>, <code class=external data-anolis-spec=html title="the sub and sup elements"><a href=http://www.whatwg.org/html/#the-sub-and-sup-elements>sup</a></code>, or <code class=external data-anolis-spec=html title="the u element"><a href=http://www.whatwg.org/html/#the-u-element>u</a></code> element with exactly one
  attribute, which is <code class=external data-anolis-spec=html title="the style attribute"><a href=http://www.whatwg.org/html/#the-style-attribute>style</a></code>, which sets no CSS properties (including
  invalid or unrecognized properties).

  <li>It is an <code class=external data-anolis-spec=html title="the a element"><a href=http://www.whatwg.org/html/#the-a-element>a</a></code> element with exactly one attribute, which is <code class=external data-anolis-spec=html title=attr-hyperlink-href><a href=http://www.whatwg.org/html/#attr-hyperlink-href>href</a></code>.

  <li>It is a <code class=external data-anolis-spec=html title=font><a href=http://www.whatwg.org/html/#font>font</a></code> element with exactly one attribute, which is either
  <code class=external data-anolis-spec=html title=dom-font-color><a href=http://www.whatwg.org/html/#dom-font-color>color</a></code>, <code class=external data-anolis-spec=html title=dom-font-face><a href=http://www.whatwg.org/html/#dom-font-face>face</a></code>, or <code class=external data-anolis-spec=html title=dom-font-size><a href=http://www.whatwg.org/html/#dom-font-size>size</a></code>.

  <li>It is a <code class=external data-anolis-spec=html title="the b element"><a href=http://www.whatwg.org/html/#the-b-element>b</a></code> or <code class=external data-anolis-spec=html title="the strong element"><a href=http://www.whatwg.org/html/#the-strong-element>strong</a></code> element with exactly one attribute, which is
  <code class=external data-anolis-spec=html title="the style attribute"><a href=http://www.whatwg.org/html/#the-style-attribute>style</a></code>, and the <code class=external data-anolis-spec=html title="the style attribute"><a href=http://www.whatwg.org/html/#the-style-attribute>style</a></code> attribute sets exactly one CSS property
  (including invalid or unrecognized properties), which is "font-weight".

  <li>It is an <code class=external data-anolis-spec=html title="the i element"><a href=http://www.whatwg.org/html/#the-i-element>i</a></code> or <code class=external data-anolis-spec=html title="the em element"><a href=http://www.whatwg.org/html/#the-em-element>em</a></code> element with exactly one attribute, which is
  <code class=external data-anolis-spec=html title="the style attribute"><a href=http://www.whatwg.org/html/#the-style-attribute>style</a></code>, and the <code class=external data-anolis-spec=html title="the style attribute"><a href=http://www.whatwg.org/html/#the-style-attribute>style</a></code> attribute sets exactly one CSS property
  (including invalid or unrecognized properties), which is "font-style".

  <li>It is a <code class=external data-anolis-spec=html title="the sub and sup elements"><a href=http://www.whatwg.org/html/#the-sub-and-sup-elements>sub</a></code> or <code class=external data-anolis-spec=html title="the sub and sup elements"><a href=http://www.whatwg.org/html/#the-sub-and-sup-elements>sup</a></code> element with exactly one attribute, which is
  <code class=external data-anolis-spec=html title="the style attribute"><a href=http://www.whatwg.org/html/#the-style-attribute>style</a></code>, and the <code class=external data-anolis-spec=html title="the style attribute"><a href=http://www.whatwg.org/html/#the-style-attribute>style</a></code> attribute sets exactly one CSS property
  (including invalid or unrecognized properties), which is "vertical-align".

  <li>It is an <code class=external data-anolis-spec=html title="the a element"><a href=http://www.whatwg.org/html/#the-a-element>a</a></code>, <code class=external data-anolis-spec=html title=font><a href=http://www.whatwg.org/html/#font>font</a></code>, or <code class=external data-anolis-spec=html title="the span element"><a href=http://www.whatwg.org/html/#the-span-element>span</a></code> element with exactly one attribute,
  which is <code class=external data-anolis-spec=html title="the style attribute"><a href=http://www.whatwg.org/html/#the-style-attribute>style</a></code>, and the <code class=external data-anolis-spec=html title="the style attribute"><a href=http://www.whatwg.org/html/#the-style-attribute>style</a></code> attribute sets exactly one CSS property
  (including invalid or unrecognized properties), and that property is not
  "text-decoration".

  <li>It is an <code class=external data-anolis-spec=html title="the a element"><a href=http://www.whatwg.org/html/#the-a-element>a</a></code>, <code class=external data-anolis-spec=html title=font><a href=http://www.whatwg.org/html/#font>font</a></code>, <code class=external data-anolis-spec=html title="the s element"><a href=http://www.whatwg.org/html/#the-s-element>s</a></code>, <code class=external data-anolis-spec=html title="the span element"><a href=http://www.whatwg.org/html/#the-span-element>span</a></code>, <code class=external data-anolis-spec=html title="the strike element"><a href=http://www.whatwg.org/html/#the-strike-element>strike</a></code>, or <code class=external data-anolis-spec=html title="the u element"><a href=http://www.whatwg.org/html/#the-u-element>u</a></code> element
  with exactly one attribute, which is <code class=external data-anolis-spec=html title="the style attribute"><a href=http://www.whatwg.org/html/#the-style-attribute>style</a></code>, and the <code class=external data-anolis-spec=html title="the style attribute"><a href=http://www.whatwg.org/html/#the-style-attribute>style</a></code> attribute
  sets exactly one CSS property (including invalid or unrecognized properties),
  which is "text-decoration", which is set to "line-through" or "underline" or
  "overline" or "none".
</ul>

<p class=note>Conceptually, a simple modifiable element is a modifiable element
which <a href=#specified-value title="specified value">specifies</a> a value for at most one
command.


<h3 id=assorted-inline-formatting-command-algorithms><span class=secno>6.2 </span>Assorted inline formatting command algorithms</h3>

<p>The <dfn id=effective-value>effective value</dfn> of a <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>node</a> <var title="">node</var> for a given
<var title="">command</var> is returned by the following algorithm, which will return
either a string or null:

<ol>
  <li>If neither <var title="">node</var> nor its <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> is an <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element>Element</a></code>, return
  null.

  <li>If <var title="">node</var> is not an <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element>Element</a></code>, return the <a href=#effective-value>effective
  value</a> of its <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> for <var title="">command</var>.

  <li>If <var title="">command</var> is "createLink" or "unlink":

  <ol>
    <li>While <var title="">node</var> is not null, and is not an <code class=external data-anolis-spec=html title="the a element"><a href=http://www.whatwg.org/html/#the-a-element>a</a></code> element that has
    an <code class=external data-anolis-spec=html title=attr-hyperlink-href><a href=http://www.whatwg.org/html/#attr-hyperlink-href>href</a></code> attribute, set <var title="">node</var> to its <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a>.

    <li>If <var title="">node</var> is null, return null.

    <li>Return the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-attr-value title=concept-attr-value>value</a> of <var title="">node</var>'s <code class=external data-anolis-spec=html title=attr-hyperlink-href><a href=http://www.whatwg.org/html/#attr-hyperlink-href>href</a></code> attribute.
  </ol>

  <li>If <var title="">command</var> is "hiliteColor":

  <ol>
    <li>While the computed style of "background-color" on <var title="">node</var> is
    any fully transparent value, and <var title="">node</var>'s <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> is an
    <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element>Element</a></code>, set <var title="">node</var> to its <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a>.

    <li>If the computed style of "background-color" on <var title="">node</var> is
    a fully transparent value, return "rgb(255, 255, 255)".

    <li>Otherwise, return the computed style of "background-color" for
    <var title="">node</var>.
  </ol>

  <li>If <var title="">command</var> is "subscript" or "superscript":

  <ol>
    <li>Let <var title="">affected by subscript</var> and <var title="">affected by
    superscript</var> be two boolean variables, both initially false.

    <li>While <var title="">node</var> is an <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element>Element</a></code> whose "display" property
    computes to "inline":

    <ol>
      <li>If <var title="">node</var>'s "vertical-align" property computes to "sub", set
      <var title="">affected by subscript</var> to true.

      <li>Otherwise, if <var title="">node</var>'s "vertical-align" property computes to
      "super", set <var title="">affected by superscript</var> to true.

      <li>Otherwise, if <var title="">node</var>'s "vertical-align" property computes to
      some value other than "baseline", return the string "mixed".

      <li>Set <var title="">node</var> to its <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a>.
    </ol>

    <li>If <var title="">affected by subscript</var> and <var title="">affected by
    superscript</var> are both true, return the string "mixed".

    <li>If <var title="">affected by subscript</var> is true, return "sub".

    <li>If <var title="">affected by superscript</var> is true, return "super".

    <li>Return "baseline".
  </ol>

  <li>If <var title="">command</var> is "strikethrough", and the "text-decoration"
  property of <var title="">node</var> or any of its <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-ancestor title=concept-tree-ancestor>ancestors</a> computes to
  a value containing "line-through", return "line-through".  Otherwise, return
  null.

  <li>If <var title="">command</var> is "underline", and the "text-decoration"
  property of <var title="">node</var> or any of its <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-ancestor title=concept-tree-ancestor>ancestors</a> computes to
  a value containing "underline", return "underline".  Otherwise, return
  null.

  <li>Return the computed style for <var title="">node</var> of the <a href=#relevant-css-property>relevant CSS
  property</a> for <var title="">command</var>.
</ol>

<p>The <dfn id=specified-value>specified value</dfn> of an <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element>Element</a></code> <var title="">element</var> for a
given <var title="">command</var> is returned by the following algorithm, which will
return either a string or null:

<p class=XXX>"Specified value" already means something in CSS, I need to find a
different name.

<ol>
  <li>If <var title="">command</var> is "hiliteColor" and the <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element>Element</a></code>'s
  display property does not compute to "inline", return null.

  <li>If <var title="">command</var> is "createLink" or "unlink":

  <ol>
    <li>If <var title="">element</var> is an <code class=external data-anolis-spec=html title="the a element"><a href=http://www.whatwg.org/html/#the-a-element>a</a></code> element and has an <code class=external data-anolis-spec=html title=attr-hyperlink-href><a href=http://www.whatwg.org/html/#attr-hyperlink-href>href</a></code>
    attribute, return the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-attr-value title=concept-attr-value>value</a> of that attribute.

    <li>Return null.
  </ol>

  <li>If <var title="">command</var> is "subscript" or "superscript":

  <ol>
    <li>If the computed value of <var title="">element</var>'s "display" property is
    neither "inline" nor "inline-block" nor "inline-table", return null.

    <li>If <var title="">element</var> has a <code class=external data-anolis-spec=html title="the style attribute"><a href=http://www.whatwg.org/html/#the-style-attribute>style</a></code> attribute set, and that attribute
    has the effect of setting "vertical-align", return the value that it sets
    "vertical-align" to.

    <li>If <var title="">element</var> is a <code class=external data-anolis-spec=html title="the sub and sup elements"><a href=http://www.whatwg.org/html/#the-sub-and-sup-elements>sup</a></code>, return "super".

    <li>If <var title="">element</var> is a <code class=external data-anolis-spec=html title="the sub and sup elements"><a href=http://www.whatwg.org/html/#the-sub-and-sup-elements>sub</a></code>, return "sub".

    <li>Return null.
  </ol>

  <li>If <var title="">command</var> is "strikethrough", and <var title="">element</var> has a
  <code class=external data-anolis-spec=html title="the style attribute"><a href=http://www.whatwg.org/html/#the-style-attribute>style</a></code> attribute set, and that attribute sets "text-decoration":

  <ol>
    <li>If <var title="">element</var>'s <code class=external data-anolis-spec=html title="the style attribute"><a href=http://www.whatwg.org/html/#the-style-attribute>style</a></code> attribute sets "text-decoration" to a
    value containing "line-through", return "line-through".

    <li>Return null.
  </ol>

  <li>If <var title="">command</var> is "strikethrough" and <var title="">element</var> is an
  <code class=external data-anolis-spec=html title="the s element"><a href=http://www.whatwg.org/html/#the-s-element>s</a></code> or <code class=external data-anolis-spec=html title="the strike element"><a href=http://www.whatwg.org/html/#the-strike-element>strike</a></code> element, return "line-through".

  <li>If <var title="">command</var> is "underline", and <var title="">element</var> has a
  <code class=external data-anolis-spec=html title="the style attribute"><a href=http://www.whatwg.org/html/#the-style-attribute>style</a></code> attribute set, and that attribute sets "text-decoration":

  <ol>
    <li>If <var title="">element</var>'s <code class=external data-anolis-spec=html title="the style attribute"><a href=http://www.whatwg.org/html/#the-style-attribute>style</a></code> attribute sets "text-decoration" to a
    value containing "underline", return "underline".

    <li>Return null.
  </ol>

  <li>If <var title="">command</var> is "underline" and <var title="">element</var> is a <code class=external data-anolis-spec=html title="the u element"><a href=http://www.whatwg.org/html/#the-u-element>u</a></code>
  element, return "underline".

  <li>Let <var title="">property</var> be the <a href=#relevant-css-property>relevant CSS property</a> for
  <var title="">command</var>.

  <li>If <var title="">property</var> is null, return null.

  <li>If <var title="">element</var> has a <code class=external data-anolis-spec=html title="the style attribute"><a href=http://www.whatwg.org/html/#the-style-attribute>style</a></code> attribute set, and that attribute has
  the effect of setting <var title="">property</var>, return the value that it sets
  <var title="">property</var> to.

  <li>If <var title="">element</var> is a <code class=external data-anolis-spec=html title=font><a href=http://www.whatwg.org/html/#font>font</a></code> element that has an attribute whose
  effect is to create a <a class=external data-anolis-spec=html href=http://www.whatwg.org/html/#presentational-hints title="presentational hints">presentational hint</a> for <var title="">property</var>, return
  the value that the hint sets <var title="">property</var> to.  (For a <code class=external data-anolis-spec=html title=dom-font-size><a href=http://www.whatwg.org/html/#dom-font-size>size</a></code> of
  7, this will be the non-CSS value "xxx-large".)

  <li>If <var title="">element</var> is in the following list, and <var title="">property</var> is
  equal to the CSS property name listed for it, return the string listed for
  it.

  <dl class=switch>
    <dt><code class=external data-anolis-spec=html title="the b element"><a href=http://www.whatwg.org/html/#the-b-element>b</a></code>
    <dt><code class=external data-anolis-spec=html title="the strong element"><a href=http://www.whatwg.org/html/#the-strong-element>strong</a></code>
    <dd>font-weight: "bold"

    <dt><code class=external data-anolis-spec=html title="the i element"><a href=http://www.whatwg.org/html/#the-i-element>i</a></code>
    <dt><code class=external data-anolis-spec=html title="the em element"><a href=http://www.whatwg.org/html/#the-em-element>em</a></code>
    <dd>font-style: "italic"
  </dl>

  <li>Return null.
</ol>

<p>To <dfn id=reorder-modifiable-descendants>reorder modifiable descendants</dfn> of a <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>node</a> <var title="">node</var>,
given a <a href=#command>command</a> <var title="">command</var> and a value <var title="">new
value</var>:

<ol>
  <li>Let <var title="">candidate</var> equal <var title="">node</var>.

  <li>While <var title="">candidate</var> is a <a href=#modifiable-element>modifiable element</a>, and
  <var title="">candidate</var> has exactly one <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a>, and that <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> is also a
  <a href=#modifiable-element>modifiable element</a>, and <var title="">candidate</var> is not a
  <a href=#simple-modifiable-element>simple modifiable element</a> or <var title="">candidate</var>'s
  <a href=#specified-value>specified value</a> for <var title="">command</var> is not <var title="">new
  value</var>, set <var title="">candidate</var> to its <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a>.

  <li>If <var title="">candidate</var> is <var title="">node</var>, or is not a <a href=#simple-modifiable-element>simple
  modifiable element</a>, or its <a href=#specified-value>specified value</a> and
  <a href=#effective-value>effective value</a> for <var title="">command</var> are not both <var title="">new
  value</var>, abort these steps.

  <li>While <var title="">candidate</var> has <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>children</a>, insert the first <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a>
  of <var title="">candidate</var> into <var title="">candidate</var>'s <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> immediately
  before <var title="">candidate</var>, <a href=#preserving-ranges>preserving ranges</a>.

  <li>Insert <var title="">candidate</var> into <var title="">node</var>'s <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> immediately
  after <var title="">node</var>.
  <!--
  If candidate had no children, any boundary point inside it will get moved to
  its parent here, which is okay.  We don't want to preserve ranges, because
  that would move boundary points that originally were in candidate but were
  moved to its parent by the last step to move to node's parent.

  We move to after node so that boundary points before and after node wind up
  consistently inside candidate when we move preserving ranges.  If we had
    {<node>foo<candidate></candidate></node>}
  it thus becomes
    {<node>foo</node>}<candidate></candidate>
  by the range mutation rules, and then when we move preserving ranges, it
  becomes
    <candidate>{<node>foo</node>}</candidate>
  which is reasonable.

  If we had inserted candidate before node, instead it would go
    {<candidate></candidate><node>foo</node>}
    {<candidate><node>foo</node>}</candidate>
  because of the interaction of regular range mutation rules with
  preserving-ranges rules.
  -->

  <li>Append the <var title="">node</var> as the last <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> of <var title="">candidate</var>,
  <a href=#preserving-ranges>preserving ranges</a>.
</ol>


<h3 id=decomposing-a-range-into-nodes><span class=secno>6.3 </span>Decomposing a range into nodes</h3>

<p>To <dfn id=decompose>decompose</dfn> a <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range title=concept-range>range</a> <var title="">range</var>:

<p class=note>For this algorithm to be correct, it is essential that user
agents follow the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#range-mutation-rules>range mutation rules</a>, particularly those for <code title="">splitText()</code>.

<ol>
  <li>If <var title="">range</var>'s <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> and <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-end title=concept-range-end>end</a> are the same,
  return an empty list.

  <li>If <var title="">range</var>'s <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a> is a <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#text>Text</a></code> node and
  its <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-offset title=concept-boundary-point-offset>offset</a> is neither 0 nor the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-node-length title=concept-node-length>length</a> of its
  <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a>, run <code class=external data-anolis-spec=domcore title=dom-Text-splitText><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-text-splittext>splitText()</a></code> on its <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a>
  with argument equal to its <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-offset title=concept-boundary-point-offset>offset</a>.

  <li>If <var title="">range</var>'s <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-end title=concept-range-end>end</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a> is a <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#text>Text</a></code> node and
  its <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-end title=concept-range-end>end</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-offset title=concept-boundary-point-offset>offset</a> is neither 0 nor the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-node-length title=concept-node-length>length</a> of its
  <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-end title=concept-range-end>end</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a>, run <code class=external data-anolis-spec=domcore title=dom-Text-splitText><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-text-splittext>splitText()</a></code> on its <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-end title=concept-range-end>end</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a>
  with argument equal to its <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-end title=concept-range-end>end</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-offset title=concept-boundary-point-offset>offset</a>.

  <!-- Now we want to make sure our range contains as many nodes as possible,
  such as by changing <tag>[foo]</tag> to {<tag>foo</tag>}. -->
  <li>Let <var title="">cloned range</var> be the result of calling <code class=external data-anolis-spec=domrange title=dom-Range-cloneRange><a href=http://html5.org/specs/dom-range.html#dom-range-clonerange>cloneRange()</a></code> on
  <var title="">range</var>.

  <li>While the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-offset title=concept-boundary-point-offset>offset</a> of <var title="">cloned range</var> is 0,
  and the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> of <var title="">cloned range</var>'s <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a> is
  not null, set the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> of <var title="">cloned range</var> to (<a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> of
  <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a>, <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-indexof title=concept-indexof>index</a> of <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a>).

  <li>While the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-end title=concept-range-end>end</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-offset title=concept-boundary-point-offset>offset</a> of <var title="">cloned range</var> equals the
  <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-node-length title=concept-node-length>length</a> of its <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-end title=concept-range-end>end</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a>, and the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> of
  <var title="">cloned range</var>'s <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-end title=concept-range-end>end</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a> is not null, set the
  <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-end title=concept-range-end>end</a> of <var title="">cloned range</var> to (<a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> of <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-end title=concept-range-end>end</a>
  <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a>, 1 + <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-indexof title=concept-indexof>index</a> of <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-end title=concept-range-end>end</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a>).

  <li>Return a list consisting of every <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>node</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#contained>contained</a> in <var title="">cloned
  range</var> in <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#tree-order>tree order</a>, omitting any whose <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> is also
  <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#contained>contained</a> in <var title="">cloned range</var>.
</ol>


<h3 id="clearing-an-element's-value"><span class=secno>6.4 </span>Clearing an element's value</h3>

<p>To <dfn id=clear-the-value>clear the value</dfn> of an <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element>Element</a></code> <var title="">element</var>:

<p class=note>Clearing the value of an element can remove it from its parent
and put other nodes in its place.  When implementations do something like clear
the value of all children of an element, they should take care not to assume
that the set of children won't change as they're cleared.  If the element is
removed, the algorithm will return the list of nodes inserted in its place.

<!-- If we wanted to be extra-pedantic, we could convert, e.g., <font color=red
id=foo> into <span id=foo> instead of <font id=foo>, but probably not worth it.
-->

<ol>
  <li>Let <var title="">command</var> be the current <a href=#command>command</a>.

  <li>If <var title="">element</var>'s <a href=#specified-value>specified value</a> for
  <var title="">command</var> is null, return the empty list.  <!-- We want to abort
  early so that we don't try unsetting background-color on a non-inline
  element. -->

  <li>If <var title="">element</var> is a <a href=#simple-modifiable-element>simple modifiable element</a>:

  <ol>
    <li>Let <var title="">children</var> be the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>children</a> of <var title="">element</var>.

    <li>Remove <var title="">element</var>, <a href=#preserving-its-descendants>preserving its descendants</a>.

    <li>Return <var title="">children</var>.
  </ol>

  <li>If <var title="">command</var> is "strikethrough", and <var title="">element</var> has a
  <code class=external data-anolis-spec=html title="the style attribute"><a href=http://www.whatwg.org/html/#the-style-attribute>style</a></code> attribute that sets "text-decoration" to some value containing
  "line-through", delete "line-through" from the value.

  <li>If <var title="">command</var> is "underline", and <var title="">element</var> has a
  <code class=external data-anolis-spec=html title="the style attribute"><a href=http://www.whatwg.org/html/#the-style-attribute>style</a></code> attribute that sets "text-decoration" to some value containing
  "underline", delete "underline" from the value.

  <li>If the <a href=#relevant-css-property>relevant CSS property</a> for <var title="">command</var> is not
  null, unset that property of <var title="">element</var>.

  <li>If <var title="">element</var> is a <code class=external data-anolis-spec=html title=font><a href=http://www.whatwg.org/html/#font>font</a></code> element:

  <ol>
    <li>If <var title="">command</var> is "foreColor", unset <var title="">element</var>'s
    <code class=external data-anolis-spec=html title=dom-font-color><a href=http://www.whatwg.org/html/#dom-font-color>color</a></code> attribute, if set.

    <li>If <var title="">command</var> is "fontName", unset <var title="">element</var>'s
    <code class=external data-anolis-spec=html title=dom-font-face><a href=http://www.whatwg.org/html/#dom-font-face>face</a></code> attribute, if set.

    <li>If <var title="">command</var> is "fontSize", unset <var title="">element</var>'s
    <code class=external data-anolis-spec=html title=dom-font-size><a href=http://www.whatwg.org/html/#dom-font-size>size</a></code> attribute, if set.
  </ol>

  <li>If <var title="">element</var> is an <code class=external data-anolis-spec=html title="the a element"><a href=http://www.whatwg.org/html/#the-a-element>a</a></code> element and <var title="">command</var> is
  "createLink" or "unlink", unset the <code class=external data-anolis-spec=html title=attr-hyperlink-href><a href=http://www.whatwg.org/html/#attr-hyperlink-href>href</a></code> property of <var title="">element</var>.

  <li>If <var title="">element</var>'s <a href=#specified-value>specified value</a> for
  <var title="">command</var> is null, return the empty list.
  <!-- If we get past this step, we're something like <b class=foo> where we
  want to keep the extra attributes, so we stick them on a span. -->

  <li>Let <var title="">new element</var> be a new <a href=#html-element>HTML element</a> with
  <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-element-local-name title=concept-element-local-name>local name</a> "span", with the same attributes and <code class=external data-anolis-spec=domcore title=dom-Node-ownerDocument><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-ownerdocument>ownerDocument</a></code> as
  <var title="">element</var>.

  <li>Insert <var title="">new element</var> into the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> of <var title="">element</var>
  immediately before it.
  <!-- This means that the boundary point immediately before the element goes
  before the new element, and after we remove the old element, the boundary
  point immediately after the old element will be immediately after the new
  element, because of the regular range mutation rules. -->

  <li>While <var title="">element</var> has <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>children</a>, append its first <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> as
  the last <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> of <var title="">new element</var>, <a href=#preserving-ranges>preserving ranges</a>.

  <li>Remove <var title="">element</var> from its <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a>.

  <li>Return the one-<a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>node</a> list consisting of <var title="">new element</var>.
</ol>


<h3 id=pushing-down-values><span class=secno>6.5 </span>Pushing down values</h3>

<p>To <dfn id=push-down-values>push down values</dfn> to a <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>node</a> <var title="">node</var>, given a new
value <var title="">new value</var>:

<div class=XXX>
<p>This algorithm goes up to just below the nearest ancestor with the right
style, then re-applies the bad styles repeatedly going down, omitting the
things we want to have the new style.  This is basically what WebKit does,
although WebKit sometimes starts higher up and therefore makes more intrusive
changes, often creating more markup.  IE follows the same general approach too.

<p>Gecko instead seems to start breaking up elements from the bottom, so that the
range consists of a few consecutive siblings, and it can then break up the
problematic element into a maximum of two pieces.  The spec's approach seems to
create fewer elements and simpler markup (or at least markup that's no more
complex) in most cases I throw at it.

<p>Gecko's approach does have the major advantage that it gets underlines right in
many cases for free.  E.g.,

</p><xmp>  <u>foo<font color=red>[bar]baz</font></u>
  -> <u>foo</u><font color=red>bar<u>baz</u></font> (spec)
  -> <u>foo</u><font color=red>bar</font><u><font color=red>baz</font></u> (Gecko)</xmp>

<p>The spec's markup here is much shorter and contains fewer elements, but is
wrong: the underline under "baz" has changed color from black to red.  It might
be worth trying to copy Gecko's results in such cases, but that won't solve all
underline problems, so perhaps it's not worth it.

<p>Opera also seems to break up the markup surrounding the range, but even more
aggressively: even if it doesn't need to pull down styles.  In some cases this
does actually result in shorter markup, specifically if the existing tags are
short (like <code class=external data-anolis-spec=html title="the i element"><a href=http://www.whatwg.org/html/#the-i-element>i</a></code> or <code class=external data-anolis-spec=html title="the b element"><a href=http://www.whatwg.org/html/#the-b-element>b</a></code>) and we're adding tags that are long (like <code class=external data-anolis-spec=html title="the span element"><a href=http://www.whatwg.org/html/#the-span-element>span</a></code>
with a <code class=external data-anolis-spec=html title="the style attribute"><a href=http://www.whatwg.org/html/#the-style-attribute>style</a></code> attribute).
</div>

<ol>
  <li>Let <var title="">command</var> be the current <a href=#command>command</a>.

  <li>If <var title="">node</var>'s <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> is not an <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element>Element</a></code>, abort this
  algorithm. <!-- E.g., a text node child of a document fragment. -->

  <li>If the <a href=#effective-value>effective value</a> of <var title="">command</var> is <var title="">new
  value</var> on <var title="">node</var>, abort this algorithm.

  <li>Let <var title="">current ancestor</var> be <var title="">node</var>'s <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a>.

  <li>Let <var title="">ancestor list</var> be a list of <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>nodes</a>, initially empty.

  <li>While <var title="">current ancestor</var> is an <a href=#editable>editable</a> <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element>Element</a></code>
  and the <a href=#effective-value>effective value</a> of <var title="">command</var> is not <var title="">new
  value</var> on it, append <var title="">current ancestor</var> to <var title="">ancestor
  list</var>, then set <var title="">current ancestor</var> to its <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a>.

  <li>If <var title="">ancestor list</var> is empty, abort this algorithm.

  <li>Let <var title="">propagated value</var> be the <a href=#specified-value>specified value</a> of
  <var title="">command</var> on the last member of <var title="">ancestor list</var>.

  <!-- We can only remove specified values, so if the value isn't specified,
  give up.  Unless we're actually trying to push down a null specified value,
  like for unlink. -->
  <li>If <var title="">propagated value</var> is null and is not equal to <var title="">new
  value</var>, abort this algorithm.

  <!-- If we go all the way up to the root and still don't have the desired
  value, pushing down values is pointless.  It will create extra markup for no
  purpose.  Except if the value is null, which basically just means "try to get
  rid of anything affecting the current element but don't aim for any specific
  value". -->
  <li>If the <a href=#effective-value>effective value</a> of <var title="">command</var> is not
  <var title="">new value</var> on the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> of the last member of <var title="">ancestor
  list</var>, and <var title="">new value</var> is not null, abort this algorithm.

  <li>While <var title="">ancestor list</var> is not empty:

  <ol>
    <li>Let <var title="">current ancestor</var> be the last member of <var title="">ancestor
    list</var>.

    <li>Remove the last member from <var title="">ancestor list</var>.

    <li>If the <a href=#specified-value>specified value</a> of <var title="">current ancestor</var> for
    <var title="">command</var> is not null, set <var title="">propagated value</var> to that
    value.

    <li>Let <var title="">children</var> be the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>children</a> of <var title="">current
    ancestor</var>.

    <li>If the <a href=#specified-value>specified value</a> of <var title="">current ancestor</var> for
    <var title="">command</var> is not null, <a href=#clear-the-value>clear the value</a> of
    <var title="">current ancestor</var>.

    <li>For every <var title="">child</var> in <var title="">children</var>:

    <ol>
      <li>If <var title="">child</var> is <var title="">node</var>, continue with the next
      <var title="">child</var>.

      <li>If <var title="">child</var> is an <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element>Element</a></code> whose <a href=#specified-value>specified
      value</a> for <var title="">command</var> is neither null nor equal to
      <var title="">propagated value</var>, continue with the next <var title="">child</var>.

      <p class=XXX>This will be incorrect for relative font sizes.  If the font
      size on the parent was removed and the font size on the child is in ems
      or percents or something, it will now change value.  This isn't likely to
      come up, so we'll ignore it for now.

      <li>If <var title="">child</var> is the last member of <var title="">ancestor list</var>,
      continue with the next <var title="">child</var>.

      <li><a href=#force-the-value>Force the value</a> of <var title="">child</var>, with
      <var title="">command</var> as in this algorithm and <var title="">new value</var> equal
      to <var title="">propagated value</var>.
    </ol>
  </ol>
</ol>


<h3 id=forcing-the-value-of-a-node><span class=secno>6.6 </span>Forcing the value of a node</h3>

<p>To <dfn id=force-the-value>force the value</dfn> of a <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>node</a> <var title="">node</var> to <var title="">new
value</var>:

<p class=note>This algorithm checks if the node has the desired value, and if
not, it wraps the node (or, if that's not possible, its descendants) in a
<a href=#simple-modifiable-element>simple modifiable element</a>.  This is only used as a last resort
after <a href=#clear-the-value title="clear the value">clearing the value</a> and <a href=#push-down-values title="push down values">pushing down values</a> don't work to achieve the
desired value.  After forcing the value, descendants might still have a
different value.

<ol>
  <li>Let <var title="">command</var> be the current <a href=#command>command</a>.

  <li>If <var title="">node</var>'s <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> is null, abort this algorithm.

  <li>If <var title="">new value</var> is null, abort this algorithm.

  <li>If <var title="">node</var> is an <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element>Element</a></code>, <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#text>Text</a></code>, or <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#comment>Comment</a></code> node, and
  is not an <a href=#unwrappable-node>unwrappable node</a>:

  <ol>
    <!-- Even if the value matches, we stick it in a preceding sibling if
    possible.  This ensures "a<cite>b</cite>c" -> "<i>a<cite>b</cite>c</i>"
    instead of "<i>a</i><cite>b</cite><i>c</i>".  While we're at it, we also
    handle more elaborate cases like <b>foo</b>[bar]<b>baz</b> and even
    <i><b>foo</b></i>[bar]<i><b>baz</b></i> (the latter becomes
    <b><i>foo</i>bar<i>baz</i></b>).

    Theoretically this algorithm could pointlessly reorganize the DOM in the
    event of unreasonable style rules, but it's not a big enough deal for us to
    care, since the resulting style will still be right. -->
    <li><a href=#reorder-modifiable-descendants>Reorder modifiable descendants</a> of <var title="">node</var>'s
    <code class=external data-anolis-spec=domcore title=dom-Node-previousSibling><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-previoussibling>previousSibling</a></code>.

    <li><a href=#reorder-modifiable-descendants>Reorder modifiable descendants</a> of <var title="">node</var>'s
    <code class=external data-anolis-spec=domcore title=dom-Node-nextSibling><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-nextsibling>nextSibling</a></code>.

    <li><a href=#wrap>Wrap</a> the one-<a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>node</a> list consisting of <var title="">node</var>,
    with <a href=#sibling-criteria>sibling criteria</a> matching a <a href=#simple-modifiable-element>simple modifiable
    element</a> whose <a href=#specified-value>specified value</a> and <a href=#effective-value>effective
    value</a> for <var title="">command</var> are both <var title="">new value</var>, and with
    <a href=#new-parent-instructions>new parent instructions</a> returning null.
    <!-- The new parent instructions are too complicated to reasonably feed
    into the wrap algorithm. -->
  </ol>

  <li>If the <a href=#effective-value>effective value</a> of <var title="">command</var> is <var title="">new
  value</var> on <var title="">node</var>, abort this algorithm.

  <li>If <var title="">node</var> is an <a href=#unwrappable-node>unwrappable node</a>:

  <ol>
    <li>Let <var title="">children</var> be all <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>children</a> of <var title="">node</var>,
    omitting any that are <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element>Element</a></code>s whose <a href=#specified-value>specified value</a> for
    <var title="">command</var> is neither null nor equal to <var title="">new value</var>.

    <li><a href=#force-the-value>Force the value</a> of each <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>node</a> in <var title="">children</var>,
    with <var title="">command</var> and <var title="">new value</var> as in this invocation of
    the algorithm.
    <!-- This means that if it has no children, we do nothing.  IE9 inserts an
    empty wrapper element in that case, but I'm not sure what the point is, and
    no one else does, so I don't.  WebKit seems to ignore the node if its only
    child consists solely of whitespace, but I don't see any grounds for that
    and no one else does, so I don't. -->

    <li>Abort this algorithm.
  </ol>

  <!-- At this point we have to make a new element as a wrapper.  This isn't
  worth the effort for comments, so abort in that case. -->
  <li>If <var title="">node</var> is a <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#comment>Comment</a></code>, abort this algorithm.

  <li>If the <a href=#effective-value>effective value</a> of <var title="">command</var> is <var title="">new
  value</var> on <var title="">node</var>, abort this algorithm.

  <li>Let <var title="">new parent</var> be null.

  <li>If the <a href=#css-styling-flag>CSS styling flag</a> is false:

  <ol>
    <li>If <var title="">command</var> is "bold" and <var title="">new value</var> is
    "bold", let <var title="">new parent</var> be the result of calling <code class=external data-anolis-spec=domcore title=dom-Document-createElement><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-document-createelement>createElement("b")</a></code> on the
    <code class=external data-anolis-spec=domcore title=dom-Node-ownerDocument><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-ownerdocument>ownerDocument</a></code> of <var title="">node</var>.

    <li>If <var title="">command</var> is "italic" and <var title="">new value</var> is
    "italic", let <var title="">new parent</var> be the result of calling <code class=external data-anolis-spec=domcore title=dom-Document-createElement><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-document-createelement>createElement("i")</a></code> on the
    <code class=external data-anolis-spec=domcore title=dom-Node-ownerDocument><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-ownerdocument>ownerDocument</a></code> of <var title="">node</var>.

    <li>If <var title="">command</var> is "strikethrough" and <var title="">new value</var> is
    "line-through", let <var title="">new parent</var> be the result of calling <code class=external data-anolis-spec=domcore title=dom-Document-createElement><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-document-createelement>createElement("s")</a></code> on the
    <code class=external data-anolis-spec=domcore title=dom-Node-ownerDocument><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-ownerdocument>ownerDocument</a></code> of <var title="">node</var>.

    <p class=XXX>Actual UAs use strike, not s, but s is shorter and HTML5 makes
    strike invalid.  I've gone with s for now, but maybe we want to change the
    spec to require strike.

    <li>If <var title="">command</var> is "underline" and <var title="">new value</var> is
    "underline", let <var title="">new parent</var> be the result of calling <code class=external data-anolis-spec=domcore title=dom-Document-createElement><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-document-createelement>createElement("u")</a></code> on the
    <code class=external data-anolis-spec=domcore title=dom-Node-ownerDocument><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-ownerdocument>ownerDocument</a></code> of <var title="">node</var>.

    <li>If <var title="">command</var> is "foreColor", and <var title="">new value</var> is fully
    opaque with red, green, and blue components in the range 0 to 255:

    <ol>
      <li>Let <var title="">new parent</var> be the result of calling <code class=external data-anolis-spec=domcore title=dom-Document-createElement><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-document-createelement>createElement("font")</a></code> on the
      <code class=external data-anolis-spec=domcore title=dom-Node-ownerDocument><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-ownerdocument>ownerDocument</a></code> of <var title="">node</var>.

      <li>If <var title="">new value</var> is one of the colors listed in the SVG color
      keywords section of CSS3 Color, set the <code class=external data-anolis-spec=html title=dom-font-color><a href=http://www.whatwg.org/html/#dom-font-color>color</a></code> attribute of
      <var title="">new parent</var> to <var title="">new value</var>.

      <li>Otherwise, set the <code class=external data-anolis-spec=html title=dom-font-color><a href=http://www.whatwg.org/html/#dom-font-color>color</a></code> attribute of <var title="">new parent</var>
      to the result of applying the <a class=external data-anolis-spec=html href=http://www.whatwg.org/html/#rules-for-serializing-simple-color-values>rules for
      serializing simple color values</a> to <var title="">new value</var>
      (interpreted as a <a class=external data-anolis-spec=html href=http://www.whatwg.org/html/#simple-color>simple color</a>).
    </ol>

    <li>If <var title="">command</var> is "fontName", let <var title="">new parent</var> be
    the result of calling <code class=external data-anolis-spec=domcore title=dom-Document-createElement><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-document-createelement>createElement("font")</a></code> on the
    <code class=external data-anolis-spec=domcore title=dom-Node-ownerDocument><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-ownerdocument>ownerDocument</a></code> of <var title="">node</var>, then set the <code class=external data-anolis-spec=html title=dom-font-face><a href=http://www.whatwg.org/html/#dom-font-face>face</a></code> attribute
    of <var title="">new parent</var> to <var title="">new value</var>.
  </ol>

  <li>If <var title="">command</var> is "createLink" or "unlink":

  <ol>
    <li>Let <var title="">new parent</var> be the result of calling <code class=external data-anolis-spec=domcore title=dom-Document-createElement><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-document-createelement>createElement("a")</a></code> on the
    <code class=external data-anolis-spec=domcore title=dom-Node-ownerDocument><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-ownerdocument>ownerDocument</a></code> of <var title="">node</var>.

    <li>Set the <code class=external data-anolis-spec=html title=attr-hyperlink-href><a href=http://www.whatwg.org/html/#attr-hyperlink-href>href</a></code> attribute of <var title="">new parent</var> to <var title="">new
    value</var>.

    <!-- Nested a elements are bad, because they can't be serialized to
    text/html.  hrefs should already have been cleared in a previous step, but
    we might have <a name> or such lurking about. -->
    <li>Let <var title="">ancestor</var> be <var title="">node</var>'s <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a>.

    <li>While <var title="">ancestor</var> is not null:

    <ol>
      <li>If <var title="">ancestor</var> is an <code class=external data-anolis-spec=html title="the a element"><a href=http://www.whatwg.org/html/#the-a-element>a</a></code>, <a href=#set-the-tag-name>set the tag name</a> of
      <var title="">ancestor</var> to "span", and let <var title="">ancestor</var> be the
      result.

      <p class=XXX>This will mean any link-specific attributes will be
      transferred, which makes them both invalid and useless.  Is that okay?  I
      don't really want to list them all, because that sort of list is prone to
      bitrot.

      <li>Set <var title="">ancestor</var> to its <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a>.
    </ol>
  </ol>

  <!-- WebKit is the only engine that ever outputs anything but font tags for
  fontSize.  For size=7, it uses font-size: -webkit-xxx-large.  We just output
  a font tag no matter what. -->
  <li>If <var title="">command</var> is "fontSize"; and <var title="">new value</var> is one of
  "xx-small", "small", "medium", "large", "x-large", "xx-large", or
  "xxx-large"; and either the <a href=#css-styling-flag>CSS styling flag</a> is false, or
  <var title="">new value</var> is "xxx-large": let <var title="">new parent</var> be the result
  of calling <code class=external data-anolis-spec=domcore title=dom-Document-createElement><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-document-createelement>createElement("font")</a></code> on the
  <code class=external data-anolis-spec=domcore title=dom-Node-ownerDocument><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-ownerdocument>ownerDocument</a></code> of <var title="">node</var>, then set the <code class=external data-anolis-spec=html title=dom-font-size><a href=http://www.whatwg.org/html/#dom-font-size>size</a></code> attribute of
  <var title="">new parent</var> to the number from the following table based on
  <var title="">new value</var>:

  <dl class=switch>
    <dt>xx-small <dd>1
    <dt>small <dd>2
    <dt>normal <dd>3
    <dt>large <dd>4
    <dt>x-large <dd>5
    <dt>xx-large <dd>6
    <dt>xxx-large <dd>7
  </dl>

  <!-- We always use sup/sub elements, even in CSS mode, following Gecko and
  contradicting WebKit.  This is because <span value="vertical-align:
  sub/super">, the obvious equivalent (and what WebKit uses), behaves quite
  differently: it doesn't reduce font-size, which is ugly. -->
  <li>If <var title="">command</var> is "subscript" or "superscript" and <var title="">new
  value</var> is "sub", let <var title="">new parent</var> be the result of calling
  <code class=external data-anolis-spec=domcore title=dom-Document-createElement><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-document-createelement>createElement("sub")</a></code> on the
  <code class=external data-anolis-spec=domcore title=dom-Node-ownerDocument><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-ownerdocument>ownerDocument</a></code> of <var title="">node</var>.

  <li>If <var title="">command</var> is "subscript" or "superscript" and <var title="">new
  value</var> is "super", let <var title="">new parent</var> be the result of calling
  <code class=external data-anolis-spec=domcore title=dom-Document-createElement><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-document-createelement>createElement("sup")</a></code> on the
  <code class=external data-anolis-spec=domcore title=dom-Node-ownerDocument><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-ownerdocument>ownerDocument</a></code> of <var title="">node</var>.

  <li>If <var title="">new parent</var> is null, let <var title="">new parent</var> be the result
  of calling <code class=external data-anolis-spec=domcore title=dom-Document-createElement><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-document-createelement>createElement("span")</a></code> on the
  <code class=external data-anolis-spec=domcore title=dom-Node-ownerDocument><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-ownerdocument>ownerDocument</a></code> of <var title="">node</var>.

  <li>Insert <var title="">new parent</var> in <var title="">node</var>'s <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> before
  <var title="">node</var>.  <!-- This preserves boundary points correctly, as usual.
  -->

  <li>If the <a href=#effective-value>effective value</a> of <var title="">command</var> for <var title="">new
  parent</var> is not <var title="">new value</var>, and the <a href=#relevant-css-property>relevant CSS
  property</a> for <var title="">command</var> is not null, set that CSS property of
  <var title="">new parent</var> to <var title="">new value</var> (if the new value would be
  valid).

  <li>If <var title="">command</var> is "strikethrough", and <var title="">new value</var> is
  "line-through", and the <a href=#effective-value>effective value</a> of "strikethrough" for
  <var title="">new parent</var> is not "line-through", set the "text-decoration"
  property of <var title="">new parent</var> to "line-through".

  <li>If <var title="">command</var> is "underline", and <var title="">new value</var> is
  "underline", and the <a href=#effective-value>effective value</a> of "underline" for <var title="">new
  parent</var> is not "underline", set the "text-decoration" property of
  <var title="">new parent</var> to "underline".

  <li>Append <var title="">node</var> to <var title="">new parent</var> as its last <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a>,
  <a href=#preserving-ranges>preserving ranges</a>.

  <li>If <var title="">node</var> is an <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element>Element</a></code> and the <a href=#effective-value>effective value</a>
  of <var title="">command</var> for <var title="">node</var> is not <var title="">new value</var>:

  <ol>
    <li>Insert <var title="">node</var> into the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> of <var title="">new parent</var>
    before <var title="">new parent</var>, <a href=#preserving-ranges>preserving ranges</a>.

    <li>Remove <var title="">new parent</var> from its <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a>.

    <li>If <var title="">new parent</var> is a <code class=external data-anolis-spec=html title="the span element"><a href=http://www.whatwg.org/html/#the-span-element>span</a></code>, and either a)
    <var title="">command</var> is "underline" or "strikethrough", or b)
    <var title="">command</var> is "fontSize" and <var title="">new value</var> is not
    "xxx-large", or c) <var title="">command</var> is not "fontSize" and the
    <a href=#relevant-css-property>relevant CSS property</a> for <var title="">command</var> is not null:

    <ol>
      <li>If the <a href=#relevant-css-property>relevant CSS property</a> for <var title="">command</var> is
      not null, set that CSS property of <var title="">node</var> to <var title="">new
      value</var>.

      <li>If <var title="">command</var> is "strikethrough" and <var title="">new value</var> is
      "line-through", alter the "text-decoration" property of <var title="">node</var>
      to include "line-through" (preserving "overline" or "underline" if
      present).

      <li>If <var title="">command</var> is "underline" and <var title="">new value</var> is
      "underline", alter the "text-decoration" property of <var title="">node</var> to
      include "underline" (preserving "overline" or "line-through" if present).
    </ol>

    <li>Otherwise:

    <ol>
      <li>Let <var title="">children</var> be all <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>children</a> of <var title="">node</var>,
      omitting any that are <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element>Element</a></code>s whose <a href=#specified-value>specified value</a> for
      <var title="">command</var> is neither null nor equal to <var title="">new value</var>.

      <li><a href=#force-the-value>Force the value</a> of each <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>node</a> in <var title="">children</var>,
      with <var title="">command</var> and <var title="">new value</var> as in this invocation
      of the algorithm.
    </ol>
  </ol>
</ol>


<h3 id=setting-the-value-of-a-node><span class=secno>6.7 </span>Setting the value of a node</h3>

<p>To <dfn id=set-the-value>set the value</dfn> of a <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>node</a> <var title="">node</var> to <var title="">new
value</var>:

<div class=note>
<p>The effect of this algorithm is to ensure that the node and all its
descendants have the style requested, no matter what, producing the simplest
markup possible to achieve that effect.  It's inspired by the approach WebKit
takes.  The only places where the algorithm should fail are when there's an
!important CSS rule that conflicts with the requested style (which we don't try
to override because we assume it's !important for a reason), or when it's
literally impossible to succeed (such as when a text-decoration is propagated
from an ancestor we can't reach).  Any other failures are bugs.

<p>First, if the node is an element with an inline style rule for this
property, we unset it ("clearing styles").  This step also removes <a href=#simple-modifiable-element title="simple modifiable element">simple modifiable elements</a> entirely, and
replaces elements like <code class=external data-anolis-spec=html title="the b element"><a href=http://www.whatwg.org/html/#the-b-element>b</a></code> or <code class=external data-anolis-spec=html title=font><a href=http://www.whatwg.org/html/#font>font</a></code> with <code class=external data-anolis-spec=html title="the span element"><a href=http://www.whatwg.org/html/#the-span-element>span</a></code>s if they aren't simple
styling elements.  This will be sufficient if the desired style is inherited
from an ancestor, or if it's the default (like font-style: normal) and no
conflicting style is inherited from an ancestor.  Even if clearing styles
doesn't actually fix the style of the node we're dealing with, we do it anyway
to simplify the generated markup.

<p>If clearing styles didn't work, and it looks like an ancestor has inline
style that we're inheriting, we push the style down from that ancestor.  Thus
if we're unbolding the letter "r" in

</p><xmp><b>foo <i>bar</i> baz</b>,</xmp>

<p>we get

</p><xmp><b>foo </b><i><b>ba</b>r</i><b> baz</b>.</xmp>

<p>If we didn't push down styles, the final step (forcing styles) would instead
give us

</p><xmp><b>foo <i>ba<span style="font-weight: normal">r</span></i> baz</b>,</xmp>

<p>which is much longer and uglier.  We take care not to disturb the style or
semantics of anything but the node we're dealing with.

<p>We'll only push down styles if some ancestor actually has the style we want,
so we can inherit it.  Otherwise, it will just create useless markup.

<p>Finally, if neither of the above strategies worked, we have to add new
markup to get the desired style ("forcing styles").  First we try just sticking
it into its previous or next sibling, if that's a <a href=#simple-modifiable-element>simple modifiable
element</a> (so it won't add any styles or semantics we don't want).
Otherwise, we create a new simple styling element and wrap it in that.  It's
common that a previous sibling is the simple styling element we want, because
often we'll style several consecutive siblings in succession.  In that case,
the element created for the first can be reused for the later ones.

<p>This last step works a bit differently if the node is an <a href=#unwrappable-node>unwrappable
node</a>.  In that case, wrapping it in a simple styling element would
make the document less conforming than it already was.  Instead, we recursively
force style on its children.  The recursion will terminate when we hit a node
that's wrappable, or when there are no further descendants.

<p>After all this, the node is guaranteed to have the style we want, barring
bugs in the algorithm or the two exceptions noted earlier (!important style
rules, and impossible cases).  We then re-run the algorithm on each child
recursively.  Typically this means just clearing the style of each descendant,
because it should then inherit the style we just set on its ancestor.  In the
unusual case that a descendant's style is wrong even after we clear style on
it, such as because of a non-inline style rule (like trying to unbold a
heading), we'll repeat the above steps to ensure that the style really gets set
as desired.
</div>

<ol>
  <li>Let <var title="">command</var> be the current <a href=#command>command</a>.

  <li>If <var title="">node</var> is not <a href=#editable>editable</a>:
  <!--
  IE9: Allows everything to be modified by execCommand(), regardless of whether
    it's editable.
  Firefox 4.0: Ignores execCommand() if the start and end of the selection are
    not both editable.  If the start and end are editable but something in the
    middle is not, seems to relocate the non-editable part in the middle or
    something like that.
  Chrome 12 dev: Ignores execCommand() if the start and end of the selection
    are not both editable.  If the start and end are editable but something in
    the middle is not, applies the given command but skips the non-editable
    parts.  But the state doesn't ignore the non-editable parts, so if you bold
    such a selection you can't unbold it, for instance, since the middle part
    will remain bold (so it will keep on trying to bold it instead of switching
    to unbold).
  Opera 11.00: Ignores execCommand() if the start and end of the selection are
    not both editable.  If the start and end are editable but something in the
    middle is not, applies the command to everything, even the non-editable
    part.

  I chose to go with the non-IE behavior, per this discussion:
  http://lists.whatwg.org/htdig.cgi/whatwg-whatwg.org/2011-April/031147.html
  Ignoring non-editable things is convenient for the common use-case of an
  editor, where you don't want the user to bold random parts of the UI when
  they hit the bold button.  For cases where it's not desired, you can always
  turn designMode on briefly before using execCommand(), so the non-IE behavior
  is a lot easier to work around than the IE behavior.

  I don't see the value in ever just ignoring execCommand().  If the start and
  end are not editable, I'm going to say you should still style any editable
  nodes in between.  I'm also going to ignore non-editable nodes for the
  purposes of determining state, so (for instance) if all the editable nodes
  are bolded, it will unbold instead of bolding.
  -->

  <ol>
    <li>Let <var title="">children</var> be the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>children</a> of <var title="">node</var>.

    <li><a href=#set-the-value>Set the value</a> of each member of <var title="">children</var>.

    <li>Abort this algorithm.
  </ol>

  <li>If <var title="">node</var> is an <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element>Element</a></code>:

  <ol>
    <li><a href=#clear-the-value>Clear the value</a> of <var title="">node</var>, and let <var title="">new
    nodes</var> be the result.

    <li>For each <var title="">new node</var> in <var title="">new nodes</var>,
    <a href=#set-the-value>set the value</a> of <var title="">new node</var>.

    <li>If <var title="">node</var>'s <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> is null, abort this algorithm.
  </ol>

  <li><a href=#push-down-values>Push down values</a> on <var title="">node</var>.

  <li><a href=#force-the-value>Force the value</a> of <var title="">node</var>.

  <li>Let <var title="">children</var> be the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>children</a> of <var title="">node</var>.

  <li><a href=#set-the-value>Set the value</a> of each member of <var title="">children</var>.

  <p class=note>Styling a node involves clearing its styles, which can remove
  it from the tree.  Implementers should be careful to compute the list of
  children in full before they begin styling.
</ol>


<h3 id=the-backcolor-command><span class=secno>6.8 </span><dfn>The <code title="">backColor</code> command</dfn></h3>

<p><a href=#action>Action</a>:

<div class=XXX>
<p>We have three behaviors to choose from for this one:

<ol>
  <li>Chrome 11 dev and IE 9 RC treat it the same as hiliteColor (although IE 9
  RC doesn't support hiliteColor itself).

  <li>Firefox 4 in non-CSS mode sets the bgcolor of the nearest td or body, or
  something like that.  In testing, it seems to jump out of contenteditable
  elements to style non-editable ancestors, which is alarming.

  <li>Firefox 4 in CSS mode and Opera 11 set the background of the nearest
  block container, although it doesn't seem to be very dependable (probably I
  just don't get what exactlyit's doing).
</ol>

<p>(1) is obviously redundant, but has plurality support, so we could spec it
that way if the other ways were useless.

<p>(3) is incoherent from a user perspective.  For instance, if you try it on
paragraphs the background will have big gaps where the margins are.  If you try
it on an inline element that's a child of the editing host, it will do nothing
or apply the background to everything or such, even though such an inline
element is visually indistinguishable from one sitting inside a div.  This
would only make sense if we take considerable effort to ensure that block
elements all have no margins, or if we wrap things in a div if they have
margins, or something like that.

<p>That leaves (2).  That might be useful if it actually set the document's
background color, but it seems like it sets table cell backgrounds sometimes
instead, which is really confusing.

<p>The path of least resistance seems to be to standardize this as meaning the
same thing as hiliteColor, and make up new commands if we want to do things
like set the document background color.  Feedback appreciated on this point.
</div>



<h3 id=the-bold-command><span class=secno>6.9 </span><dfn>The <code title="">bold</code> command</dfn></h3>

<!-- If the selection is collapsed (but not if it contains nothing but is not
collapsed), IE9 wraps the whole line in a <strong>.  This seems bizarre and no
one else does it, so I don't do it.  It's a similar story for similar commands
(fontName, italic, etc.).  Except not for strikethrough, where it just does
nothing if the selection is empty.  Why strikethrough?  I don't know. -->

<p><a href=#action>Action</a>: <a href=#decompose>Decompose</a> the <a href=#active-range>active range</a>.
If the <a href=#state>state</a> is then false, <a href=#set-the-value>set the value</a> of each
returned <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>node</a> to "bold", otherwise <a href=#set-the-value>set the value</a> to "normal".

<p><a href=#state>State</a>: True if every <a href=#editable>editable</a> <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#text>Text</a></code> node that
is <a href=#effectively-contained>effectively contained</a> in the <a href=#active-range>active range</a> has
<a href=#effective-value>effective value</a> at least 700.  Otherwise false.
<!-- For bold and similar commands, IE 9 RC seems to consider the state true or
false depending on the first element.  All other browsers follow the same
general idea as the spec, considering a range bold only if all text in it is
bold, and this seems to match at least OpenOffice.org's bold feature. -->

<p><a href=#relevant-css-property>Relevant CSS property</a>: "font-weight"


<h3 id=the-createlink-command><span class=secno>6.10 </span><dfn>The <code title="">createLink</code> command</dfn></h3>

<p><a href=#action>Action</a>:

<!-- If the selection doesn't contain anything (meaning, e.g., deleteContents()
doesn't change anything), then Chrome 12 dev inserts a link at the selection
start, with the text equal to the link URL.  Other browsers don't do it, so I
don't either. -->
<ol>
  <li>If <var title="">value</var> is the empty string, abort these steps and do
  nothing.
  <!-- This matches Firefox 4b11 and Chrome 11 dev.  IE 9 RC and Opera 11 both
  treat the request literally.  Gecko and WebKit probably have it right here:
  users who enter no URL are very unlikely to want to link to a relative URL
  resolving to the current document.  If they really want to, they can always
  specify "#" for the value, or the author can rewrite it, so it's not like
  this makes the API less useful. -->

  <li><a href=#decompose>Decompose</a> the <a href=#active-range>active range</a>, and let <var title="">node
  list</var> be the result.

  <li>For each <code class=external data-anolis-spec=html title="the a element"><a href=http://www.whatwg.org/html/#the-a-element>a</a></code> element that has an <code class=external data-anolis-spec=html title=attr-hyperlink-href><a href=http://www.whatwg.org/html/#attr-hyperlink-href>href</a></code> attribute and is an
  <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-ancestor title=concept-tree-ancestor>ancestor</a> of some <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>node</a> in <var title="">node list</var>, set that element's
  <code class=external data-anolis-spec=html title=attr-hyperlink-href><a href=http://www.whatwg.org/html/#attr-hyperlink-href>href</a></code> attribute to <var title="">value</var>.
  <!-- There are three approaches here.  For instance, if you ask browsers to
  create a link to "http://example.org" on the "b" here:

    <a href=http://example.com><b>Abc</b></a>

  Chrome 10 dev produces:

    <b><a href=http://example.com>A</a><a href=http://example.org>b</a>
    <a href=http://example.com>c</a></b>

  Firefox 4b11 produces (roughly):

    <a href=http://example.com><b>A<a href=http://example.org>b</a>c</b></a>

  (This doesn't round-trip through text/html serialization.)  IE 9 RC and Opera
  11 produce simply:

    <a href=http://example.org><b>Abc</b></a>

  The last behavior probably best matches user expectations.  If you happen to
  miss out a character when selecting the link you want to change, do you
  really intend to only change the link of part of it?
  -->

  <li><a href=#set-the-value>Set the value</a> of each <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>node</a> in <var title="">node list</var> to
  <var title="">value</var>.
</ol>

<!-- I'd have expected the value to be the URL, but guess not: it's always
false. -->


<h3 id=the-fontname-command><span class=secno>6.11 </span><dfn>The <code title="">fontName</code> command</dfn></h3>

<p><a href=#action>Action</a>: <a href=#decompose>Decompose</a> the <a href=#active-range>active range</a>,
then <a href=#set-the-value>set the value</a> of each returned <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>node</a> to <var title="">value</var>.
<!-- UAs differ a bit in the details here:

IE 9 RC: Empty string sets <font face="">
Firefox 4b11: Empty string does nothing
Chrome 11 dev: Empty string does nothing, '"monospace"' same as 'monospace'
  (i.e., cannot escape font-family keywords because quotes are stripped,
  clearly wrong)
Opera 11: Empty string sets <font face="">

Setting an empty font-family has the effect of inheriting the font from the
parent (although I don't see where the February 24, 2011 CSS 3 Fonts draft says
that).  Thus it makes sense that if we special-case this, it should be to unset
the font somehow.

Special-casing the empty string to do nothing doesn't make sense to me.  With
createLink we'd expect the user to enter the URL themselves, so it makes sense
to special-case clicking OK without entering anything.  But here it's very
likely that the font list will be fixed by the author (how many users will
understand CSS font-family syntax?), so I don't think such usability concerns
apply. -->

<p><a href=#value>Value</a>: The computed value of the CSS property "font-family" for
. . .
<!-- Complicated.

IE 9 RC: Always the empty string.  Not very useful.
Firefox 4b11: Confusing.  Sometimes it returns generic family names, like
  "sans-serif".  Sometimes it gives specific font names, like "tt" when the
  font is specified as "monospace".  Sometimes it gives the literal font-family
  string.  Not sure what it's doing here.
Chrome 11 dev: Gives the literal value of font-family, except if it's inherited
  from default values (no explicit style declarations anywhere), when it seems
  to return the exact font name.
Opera 11: Returns the literal value of font-family, except if it's inherited
  from default values, when it returns the empty string.

I'm just going to punt on this and say it should be the computed value of
font-family.  I'll leave CSSOM to decide what that means if there are no
applicable style rules. -->

<p><a href=#relevant-css-property>Relevant CSS property</a>: "font-family"


<h3 id=the-fontsize-command><span class=secno>6.12 </span><dfn>The <code title="">fontSize</code> command</dfn></h3>

<p><a href=#action>Action</a>:

<!--
IE 9: Parses the value as a number (allowing floating-point), rounds to the
  nearest integer, then clamps to the range 1 to 7.  If the value is not a
  valid number, including if it has trailing characters (like "2em"), does
  nothing.  Normalizes relative sizes, so "+0" is the same as "+3", etc.
  Treats empty string the same as "1".
Firefox 4.0: Passes the value through literally to <font size=>, so "2em" gets
  you <font size="2em">.  Always uses <font>, even with styleWithCss true.
  Ignores the command if the value is the empty string.
Chrome 12 dev: Parses the value as a legacy font size, so "2em" becomes "2",
  then outputs a <font> with the resulting number.  If there is no resulting
  number, like for a value of "xx-small", does nothing.  In styleWithCss mode,
  outputs a span with corresponding CSS keywords: 1 = x-small, 2 = small,
  . . ., 6 = xx-large, 7 = -webkit-xxx-large.  Normalizes relative sizes, so
  "+0" is the same as "3", etc.  Ignores the command if the value is the empty
  string.
Opera 11: Parses the value as an integer (ignoring floating-point as trailing
  characters), then outputs that.  This means that "+0" becomes <font size=0>
  instead of <font size=+0> or <font size=3>.  Non-numeric values get
  interpreted as 0.  Does not clamp, and is willing to output negative numbers.
  Treats empty string as "0".

What all of these have in common is that they force the author to deal with
legacy font values and don't let them use CSS.  This is undesirable, so I
ignore how implementations behave.  Practically any value that did the same
thing in IE and Firefox should still do the same thing here, so I'm only
respecifying non-interoperable behavior anyway.
-->
<ol>
  <li>If <var title="">value</var> is the empty string, do nothing and abort these
  steps.

  <li><a class=external data-anolis-spec=html href=http://www.whatwg.org/html/#strip-leading-and-trailing-whitespace>Strip leading and trailing whitespace</a>
  from <var title="">value</var>.

  <li>If <var title="">value</var> is a <a class=external data-anolis-spec=html href=http://www.whatwg.org/html/#valid-floating-point-number>valid floating point
  number</a>, or would be a <a class=external data-anolis-spec=html href=http://www.whatwg.org/html/#valid-floating-point-number>valid floating point
  number</a> if a single leading "+" character were stripped:

  <ol>
    <li>If the first character of <var title="">value</var> is "+", delete the character
    and let <var title="">mode</var> be "relative-plus".

    <li>Otherwise, if the first character of <var title="">value</var> is "-", delete
    the character and let <var title="">mode</var> be "relative-minus".

    <li>Otherwise, let <var title="">mode</var> be "absolute".

    <li>Apply the <a class=external data-anolis-spec=html href=http://www.whatwg.org/html/#rules-for-parsing-non-negative-integers>rules for parsing non-negative
    integers</a> to <var title="">value</var>, and let <var title="">number</var> be the
    result.

    <li>If <var title="">mode</var> is "relative-plus", add three to <var title="">number</var>.

    <li>If <var title="">mode</var> is "relative-minus", negate <var title="">number</var>, then
    add three to it.

    <li>If <var title="">number</var> is less than one, let <var title="">number</var> equal 1.

    <li>If <var title="">number</var> is greater than seven, let <var title="">number</var> equal
    7.

    <li>Set <var title="">value</var> to the string here corresponding to
    <var title="">number</var>:

    <dl class=switch>
      <dt>1 <dd>xx-small
      <dt>2 <dd>small
      <dt>3 <dd>medium
      <dt>4 <dd>large
      <dt>5 <dd>x-large
      <dt>6 <dd>xx-large
      <dt>7 <dd>xxx-large
    </dl>

    <p class=XXX>The entry for 7 here is an issue: there's no CSS value that
    corresponds to it.  Even if we got one added to the drafts, it wouldn't be
    backward-compatible to use it.  WebKit is the only engine that supports CSS
    output for fontSize, and it uses -webkit-xxx-large in this case, which is
    unworkable.  Instead, we just always output a font tag for size 7.  If
    authors want conforming markup, they'll need to give CSS sizes above size
    7, not legacy sizes.
  </ol>

  <li>If <var title="">value</var> is not one of the strings "xx-small", "x-small",
  "small", "medium", "large", "x-large", "xx-large", "xxx-large", and is not a
  valid CSS absolute length, then do nothing and abort these steps.

  <p class=XXX>Not sure this is the best way to do it.  We don't want to allow
  relative lengths, because those can have very weird user-visible behavior.
  For instance, a size of 2em would sometimes double the text size, but if you
  applied it a second time it would do nothing, but if you deselected one
  character it would suddenly double the size again.  Current UAs just only
  allow numeric values.  There's no harm in allowing "x-small" and absolute
  sizes, I don't think.

  <li><a href=#decompose>Decompose</a> the <a href=#active-range>active range</a>, then <a href=#set-the-value>set the
  value</a> of each returned <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>node</a> to <var title="">value</var>.
</ol>

<p><a href=#relevant-css-property>Relevant CSS property</a>: "font-size"


<h3 id=the-forecolor-command><span class=secno>6.13 </span><dfn>The <code title="">foreColor</code> command</dfn></h3>

<p><a href=#action>Action</a>:

<!-- Color interpretations (wide screen recommended):

                        IE9           Firefox 4.0              Chrome 12 dev            Opera 11.00
red                     red           red                      #ff0000                  #ff0000
f                       #f            -                        -                        #f00000
#f                      #f            -                        -                        #f00000
f00                     #f00          -                        #ff0000                  #0f0000
#f00                    #f00          rgb(255, 0, 0)           #ff0000                  #0f0000
ff0000                  #ff0000       -                        #ff0000                  #ff0000
#ff0000                 #ff0000       rgb(255, 0, 0)           #ff0000                  #ff0000
fff000000               #ff0000       -                        -                        #fff000
#fff000000              #ff0000       -                        -                        #fff000
rgb(255, 0, 0)          rgb(255,0,0)  rgb(255, 0, 0)           #ff0000                  #00b025
rgb(100%, 0, 0)         rgb(255,0,0)  -                        -                        #00b010
rgb( 255 ,0 ,0)         rgb(255,0,0)  rgb(255, 0, 0)           #ff0000                  #00b025
rgba(255, 0, 0, 0.0)    #005000       rgba(255, 0, 0, 0)       rgba(255, 0, 0, 0.0)     #00ba02
rgb(375, -10, 15)       rgb(255,0,15) rgb(255, 0, 15)          #ff000f                  #00b037
rgba(0, 0, 0, 1)        #ba0010       rgb(0, 0, 0)             -                        #00ba00
rgba(255, 255, 255, 1)  #000055       rgb(255, 255, 255)       #ffffff                  #00ba02
rgba(255, 0, 0, 0.5)    #005000       rgba(255, 255, 255, 0.5) rgba(255, 0, 0, 0.49804) #00ba02
hsl(0%, 100%, 50%)      #001050       -                        -                        -
cornsilk                cornsilk      cornsilk                 #fff8dc                  #fff8dc
potato quiche           #0000c0       -                        -                        #000a00
transparent             transparent   -                        rgba(0, 0, 0.0)          #00a000
currentColor            #c0e000       currentcolor             rgba(0, 0, 0.0)          #c000e0

The interpretations given for Firefox are only in styleWithCSS mode.  In
non-styleWithCSS mode, it just outputs the string literally as the <font color>
attribute value, which can lead to different results.  The given output for
Chrome is for <font>; the output in styleWithCSS mode is the same, but rgb() is
used instead of hex notation, and "transparent" and "currentcolor" are passed
through under those names.  IE and Opera only support <font> to begin with.

Conclusions:

* Everyone accepts simple color keywords and #xxxxxx notation.
* Opera mangles #xxx, but everyone else handles it fine.
* The leading # is optional in all browsers but Gecko.
* rgb() is accepted by everyone but Opera.
* rgba() is accepted by Gecko and WebKit, but rejected by IE and Opera.
* hsl() isn't accepted by anyone.
* IE and Opera mangle unrecognized stuff, Gecko and WebKit ignore.
* Browsers will happily output stuff like "transparent" and "rgba()" into <font
  color> even though it won't be uniformly accepted there.
* Opera and WebKit normalize the output color very aggressively, Gecko leaves
  keywords intact but otherwise normalizes for CSS output (but doesn't
  normalize at all for <font>), and IE normalizes inconsistently.

What I'm going to say is that it either has to be a valid CSS color, or
prefixing it with # must result in a valid CSS color.  For <font>, I'll say
that the output color should be normalized to #xxxxxx form unless it's an SVG
color keyword, in which case it's passed through intact.  If the color is not a
simple color (fully opaque with all channels between 0 and 255), I'll force
style="" even if styleWithCSS mode is off.  Some of this disagrees with all
browsers, but it's unlikely to hurt and it makes sense.
-->
<ol>
  <li>If <var title="">value</var> is not a valid CSS color, prepend "#" to it.

  <li>If <var title="">value</var> is still not a valid CSS color, or if it is
  currentColor, do nothing and abort these steps.
  <!-- currentColor is bad for the same reason as relative font sizes.  It will
  confuse the algorithm, and doesn't seem very useful anyway. -->

  <li><a href=#decompose>Decompose</a> the <a href=#active-range>active range</a>, then <a href=#set-the-value>set the
  value</a> of each returned <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>node</a> to <var title="">value</var>.
</ol>

<!-- The state is undefined, thus always false.  This matches IE 9 RC and
Chrome 10.  Opera 11 seems to return true if there's some color style applied,
false otherwise, which seems fairly useless; authors want to use value here,
not state.  Firefox 4b11 throws an exception, which is an interesting approach,
but I'll go with IE/WebKit, which makes at least as much sense. -->

<p><a href=#value>Value</a>: ?
<!-- IE 9 RC returns the number 0 always, which makes no sense at all. -->

<p><a href=#relevant-css-property>Relevant CSS property</a>: "color"


<h3 id=the-hilitecolor-command><span class=secno>6.14 </span><dfn>The <code title="">hiliteColor</code> command</dfn></h3>

<!-- IE 9 RC doesn't support this.  It uses backColor instead, but Gecko and
Opera treat that differently, while all non-IE browsers treat hiliteColor the
same, so I'm standardizing hiliteColor as the way to highlight text.

This is slightly tricky, because background-color does different things on
block and inline elements.  Given the name ("hiliteColor"), we really only want
to apply it to inline elements.  This is how everyone but Gecko behaves, but
Gecko sometimes applies it to blocks too.  WebKit doesn't set it on non-inline
elements, but does clear it and push it down from them.

The spec doesn't do any of these: background-color on non-inline elements is
not touched by hiliteColor, neither created nor removed.  If users want to
remove the style, they need to use removeFormat.  Adding it usually makes no
sense; see the comment for backColor.

For color parsing, see the comment for foreColor. -->

<p><a href=#action>Action</a>:

<ol>
  <li>If <var title="">value</var> is not a valid CSS color, prepend "#" to it.

  <li>If <var title="">value</var> is still not a valid CSS color, or if it is
  currentColor, do nothing and abort these steps.
  <!-- currentColor is bad for the same reason as relative font sizes.  It will
  confuse the algorithm, and doesn't seem very useful anyway.  For hiliteColor
  you could conceive of it being useful, but it will still confuse the
  algorithm, so ban it for now anyway. -->

  <li><a href=#decompose>Decompose</a> the <a href=#active-range>active range</a>, then <a href=#set-the-value>set the
  value</a> of each returned <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>node</a> to <var title="">value</var>.
</ol>

<p><a href=#relevant-css-property>Relevant CSS property</a>: "background-color"


<h3 id=the-italic-command><span class=secno>6.15 </span><dfn>The <code title="">italic</code> command</dfn></h3>

<p><a href=#action>Action</a>: <a href=#decompose>Decompose</a> the <a href=#active-range>active range</a>.
If the <a href=#state>state</a> is then false, <a href=#set-the-value>set the value</a> of each
returned <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>node</a> to "italic", otherwise <a href=#set-the-value>set the value</a> to
"normal".

<p><a href=#state>State</a>: True if every <a href=#editable>editable</a> <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#text>Text</a></code> node that
is <a href=#effectively-contained>effectively contained</a> in the <a href=#active-range>active range</a> has
<a href=#effective-value>effective value</a> either "italic" or "oblique".  Otherwise false.

<p><a href=#relevant-css-property>Relevant CSS property</a>: "font-style"


<h3 id=the-removeformat-command><span class=secno>6.16 </span><dfn>The <code title="">removeFormat</code> command</dfn></h3>

<!--
Tested in IE 9, Firefox 4.0, Chrome 12 dev, Opera 11.00.

Tags stripped by everyone: b big cite code dfn em font i ins kbd samp s small
  strike strong sub sup tt u var
Tags left alone by everyone: br hr img

Unrecognized elements: stripped by Firefox and Opera, left alone by IE and
  Chrome.

blink: stripped only by IE
abbr: stripped only by Firefox
a, wbr: stripped only by Opera

nobr: left alone only by Firefox
acronym, bdo, q: left alone only by Opera

bdi, del, mark, span, svg: treated the same as unknown elements

All elements whose default rendering is display: block are left untouched by
all browsers (although IE seems to throw an exception on <marquee> for some
reason).

It's not clear to me why we should leave <a> alone, but everyone but Opera
does.  In OpenOffice.org 3.2.1, doing "Default Formatting (Ctrl+M)" doesn't
remove links.  In Microsoft Word 2007, doing "Clear Formatting" also doesn't
remove links.  Verdict: don't remove links.  Apparently they don't logically
qualify as "formatting".

Conclusion: leave alone a, br, hr, img, wbr.  Strip everything else, including
unrecognized elements, although of course not block elements.  Also we should
probably treat all replaced elements the same as <img>, although I didn't test
that (somehow I doubt it will come up much).  <video> behaves the same as
<img>, although Firefox adds tabindex=0 (???), so I'm assuming the rest are
similar.  Also, I'll keep all foreign elements and form elements.


Browsers will split up all these inline elements if the selection is contained
within them.  Opera does strip unrecognized elements with display: block if
they're within the selection, but doesn't split them up if they contain the
selection.

Upon consideration, I've decided to go for something for now that's totally
different from what any browser does: get rid of all elements actually
contained in the selection (pretty much matching browsers), but for elements
containing the selection, I'll just run all the other styling commands in a
fashion that will reset the style in normal cases.  This avoids having to
create a lot of new logic to decide exactly what we can split up or not, and
should be able to correctly remove anything that can actually be created by
these algorithms.

This approach currently results in incorrect behavior in some cases for
non-modifiable elements with default styling, like <code>.  The correct
approach is probably to declare these elements modifiable; this would roughly
match what browsers do.  I'm ignoring the issue for now, because such elements
cannot actually be created by implementations of execCommand(), so they're not
likely to be common.  Also, the way pushing down styles works right now is that
the element is destroyed and the style is recreated, which isn't going to work
for elements like <code> or <tt> or <mark> that we don't normally create.
-->

<p><a href=#action>Action</a>:

<ol>
  <li><a href=#decompose>Decompose</a> the <a href=#active-range>active range</a>, and let <var title="">node
  list</var> be the result.

  <li>For each <var title="">node</var> in <var title="">node list</var>, unset the <code class=external data-anolis-spec=html title="the style attribute"><a href=http://www.whatwg.org/html/#the-style-attribute>style</a></code>
  attribute of <var title="">node</var> (if it's an <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element>Element</a></code>) and then all its
  <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element>Element</a></code> <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-descendant title=concept-tree-descendant>descendants</a>.

  <li>Let <var title="">elements to remove</var> be a list of all <a href=#html-element title="HTML
  element">HTML elements</a> that are the same as or <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-descendant title=concept-tree-descendant>descendants</a> of some
  member of <var title="">node list</var> and have non-null <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parents</a> and satisfy
  (insert conditions here).

  <p class=XXX>The conditions are not so simple to define, because we want to
  include non-conforming elements, which HTML doesn't give content models.  If
  everything had categories, we'd want something like "either it's
  unrecognized, or it's phrasing content that's not also embedded or
  interactive".  Except this has weird corner-cases like ins and del that are
  sometimes phrasing and sometimes flow.

  <li>For each <var title="">element</var> in <var title="">elements to remove</var>:

  <ol>
    <li>While <var title="">element</var> has <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>children</a>, insert the first <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a>
    of <var title="">element</var> into the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> of <var title="">element</var> immediately
    before <var title="">element</var>, <a href=#preserving-ranges>preserving ranges</a>.

    <li>Remove <var title="">element</var> from its <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a>.
  </ol>

  <li>For each of the entries in the following table, in the given order:
  <a href=#decompose>decompose</a> the <a href=#active-range>active range</a> again; then <a href=#set-the-value>set
  the value</a> of the resulting <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>nodes</a>, with <var title="">command</var> and
  <var title="">new value</var> as given.

  <p class=XXX>This has no relationship to what browsers actually do, although
  it mostly works okay.  If I don't throw it out and replace it with something
  more like what browsers do, it still probably needs refinement to handle some
  elements that it doesn't deal with yet.

  <table>
    <tr><th><var title="">command</var> <th><var title="">new value</var>
    <tr><td>subscript <td>"baseline"
    <!-- superscript not needed, subscript does the same thing.  We run this
    first so <sub>/<sup> won't upset fontSize. -->
    <tr><td>bold <td>"normal"
    <tr><td>fontName <td>null
    <tr><td>fontSize <td>null
    <tr><td>foreColor <td>null
    <tr><td>hiliteColor <td>null
    <tr><td>italic <td>"normal"
    <tr><td>strikethrough <td>null
    <tr><td>underline <td>null
  </table>
</ol>


<h3 id=the-strikethrough-command><span class=secno>6.17 </span><dfn>The <code title="">strikethrough</code> command</dfn></h3>

<p><a href=#action>Action</a>: <a href=#decompose>Decompose</a> the <a href=#active-range>active range</a>.
If the <a href=#state>state</a> is then false, <a href=#set-the-value>set the value</a> of each
returned <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>node</a> to "line-through", otherwise <a href=#set-the-value>set the value</a> to
null.

<p class=XXX>Has all the same problems as <a href=#the-underline-command>the <code title="">underline</code> command</a>.

<p><a href=#state>State</a>: True if every <a href=#editable>editable</a> <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#text>Text</a></code> node that
is <a href=#effectively-contained>effectively contained</a> in the <a href=#active-range>active range</a> has
<a href=#effective-value>effective value</a> "line-through".  Otherwise false.


<h3 id=the-subscript-command><span class=secno>6.18 </span><dfn>The <code title="">subscript</code> command</dfn></h3>

<p><a href=#action>Action</a>:

<ol>
  <li><a href=#decompose>Decompose</a> the <a href=#active-range>active range</a>, and let <var title="">node
  list</var> be the result.

  <li>Let <var title="">state</var> be the <a href=#state>state</a>.

  <li><a href=#set-the-value>Set the value</a> of each <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>node</a> in <var title="">node list</var> to
  "baseline".

  <li>If <var title="">state</var> is false, <a href=#decompose>decompose</a> the <a href=#active-range>active
  range</a> again and <a href=#set-the-value>set the value</a> of each returned <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>node</a>
  to "sub".
</ol>

<p><a href=#state>State</a>: True if every <a href=#editable>editable</a> <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#text>Text</a></code> node that
is <a href=#effectively-contained>effectively contained</a> in the <a href=#active-range>active range</a> has
<a href=#effective-value>effective value</a> "sub".  Otherwise false.

<p><a href=#relevant-css-property>Relevant CSS property</a>: "vertical-align"


<h3 id=the-superscript-command><span class=secno>6.19 </span><dfn>The <code title="">superscript</code> command</dfn></h3>

<p><a href=#action>Action</a>:

<ol>
  <li><a href=#decompose>Decompose</a> the <a href=#active-range>active range</a>, and let <var title="">node
  list</var> be the result.

  <li>Let <var title="">state</var> be the <a href=#state>state</a>.

  <li><a href=#set-the-value>Set the value</a> of each <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>node</a> in <var title="">node list</var> to
  "baseline".

  <li>If <var title="">state</var> is false, <a href=#decompose>decompose</a> the <a href=#active-range>active
  range</a> again and <a href=#set-the-value>set the value</a> of each returned <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>node</a>
  to "super".
</ol>

<p><a href=#state>State</a>: True if every <a href=#editable>editable</a> <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#text>Text</a></code> node that
is <a href=#effectively-contained>effectively contained</a> in the <a href=#active-range>active range</a> has
<a href=#effective-value>effective value</a> "super".  Otherwise false.

<p><a href=#relevant-css-property>Relevant CSS property</a>: "vertical-align"


<h3 id=the-underline-command><span class=secno>6.20 </span><dfn>The <code title="">underline</code> command</dfn></h3>

<p><a href=#action>Action</a>: <a href=#decompose>Decompose</a> the <a href=#active-range>active range</a>.
If the <a href=#state>state</a> is then false, <a href=#set-the-value>set the value</a> of each
returned <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>node</a> to "underline", otherwise <a href=#set-the-value>set the value</a> to null.

<div class=XXX>
<p>There are a lot of problems with underline color and thickness, because
text-decoration in CSS is horrible:

<ul>
  <li>Pushing down underlines can change their color, since the color of an
  underline follows the color of the element where it's declared instead of the
  text it's drawn under.  This could be fixed by adding a special case for this
  condition and inserting extra color rules, such as by setting a color on the
  underlining element and then having another element inside it that resets the
  color.  Horrible, but that's text-decoration for you.  Alternatively, the new
  text-decoration-color property in the CSS 3 Text draft could come in handy
  here, in which case we'd degrade pretty gracefully in legacy UAs.

  <li>Underline thickness depends on font-size in all rendering engines but
  WebKit, so pushing them down creates thickness problems as well as color
  problems.  Working around this is a similar story to the previous, except we
  have no text-decoration-width property yet (see <a href=http://lists.w3.org/Archives/Public/www-style/2011Mar/0593.html>feedback
  to www-style</a>).

  <li>The preceding two points can't be avoided, because the only way to remove
  underlines in CSS is to push down styles (unlike most other things where you
  could override it).  Recent (February 2011) CSS 3 Text drafts have added
  support for a "text-decoration-line: cancel-underline" property, but we can
  only use that if there's no other possibility, since it won't work in legacy
  browsers.  (Although we should use it once there's no other possibility.)

  <li>More generally, from a user's perspective, color and thickness of
  underlines is going to be more or less random if they're applying them to
  text with varying size or color.  If they underline a bunch of text all at
  once, it will all get the same color/thickness, probably.  But if they
  underline letter-by-letter, it probably will vary.  But sometimes when they
  underline a bunch of text at once it will also vary, if the algorithm decides
  to create multiple elements for whatever reason (like an intervening
  unwrappable node).  This is unlikely to match user expectations.  There's
  not much we can do about this without entirely revamping text-decoration, so
  we'll have to live with it.

  <li>Currently we don't treat non-underline text-decorations properly, because
  we have no way to set (or cancel) underlines independently of other
  text-decorations from within CSS.  I've sent <a href=http://lists.w3.org/Archives/Public/www-style/2011Mar/0591.html>feedback
  to www-style</a>.
</ul>

<p>I'll revisit some of these issues when I get feedback on www-style, either
using the newly-specced features or working around their absence as the case
may be.
</div>

<p><a href=#state>State</a>: True if every <a href=#editable>editable</a> <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#text>Text</a></code> node that
is <a href=#effectively-contained>effectively contained</a> in the <a href=#active-range>active range</a> has
<a href=#effective-value>effective value</a> "underline".  Otherwise false.


<h3 id=the-unlink-command><span class=secno>6.21 </span><dfn>The <code title="">unlink</code> command</dfn></h3>

<p><a href=#action>Action</a>:

<!--
IE 9 RC unlinks the whole link you're pointing at, while others only
unlink the current text.  The latter behavior seems less expected, as with
createLink, although I can't articulate precisely why.  Word 2007 and
OpenOffice.org 3.2.1 (Ubuntu) seem to give an option to remove the whole link
or none of it, which backs the spec's requirement.  See also #whatwg logs
starting at 2011-05-13 at 16:53 EDT (UTC-0400).
-->
<ol>
  <li>Let <var title="">hyperlinks</var> be a list of every <code class=external data-anolis-spec=html title="the a element"><a href=http://www.whatwg.org/html/#the-a-element>a</a></code> element that has an
  <code class=external data-anolis-spec=html title=attr-hyperlink-href><a href=http://www.whatwg.org/html/#attr-hyperlink-href>href</a></code> attribute and is <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#contained>contained</a> in the <a href=#active-range>active range</a> or
  is an <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-ancestor title=concept-tree-ancestor>ancestor</a> of one of its <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point title=concept-boundary-point>boundary points</a>.

  <li><a href=#clear-the-value>Clear the value</a> of each member of <var title="">hyperlinks</var>.
</ol>


<h2 id=block-formatting-commands><span class=secno>7 </span>Block formatting commands</h2>

<h3 id=block-formatting-command-definitions><span class=secno>7.1 </span>Block formatting command definitions</h3>

<p>A <dfn id=prohibited-paragraph-child-name>prohibited paragraph child name</dfn> is "address", "article",
"aside", "blockquote", "caption", "center", "col", "colgroup", "details", "dd",
"dir", "div", "dl", "dt", "fieldset", "figcaption", "figure", "footer", "form",
"h1", "h2", "h3", "h4", "h5", "h6", "header", "hgroup", "hr", "li", "listing",
"menu", "nav", "ol", "p", "plaintext", "pre", "section", "summary", "table",
"tbody", "td", "tfoot", "th", "thead", "tr", "ul", or "xmp".

<p>A <dfn id=prohibited-paragraph-child>prohibited paragraph child</dfn> is an <a href=#html-element>HTML element</a>
whose <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-element-local-name title=concept-element-local-name>local name</a> is a <a href=#prohibited-paragraph-child-name>prohibited paragraph child name</a>.
<!-- These are all the things that will close a <p> if found as a descendant.
I think.  Plus table stuff, since that can't be a descendant of a p either,
although it won't auto-close it. -->

<p>A <dfn id=name-of-an-element-with-inline-contents>name of an element with inline contents</dfn> is "a", "abbr", "b",
"bdi", "bdo", "cite", "code", "dfn", "em", "h1", "h2", "h3", "h4", "h5", "h6",
"i", "kbd", "mark", "pre", "q", "rp", "rt", "ruby", "s", "samp", "small",
"span", "strong", "sub", "sup", "u", "var", "acronym", "listing", "strike",
"xmp", "big", "blink", "font", "marquee", "nobr", or "tt".

<p class=XXX>This deliberately omits "dt", because I don't like the fact that
including it will cause various commands to break apart lists rather than put
bad things inside dt.

<p>An <dfn id=element-with-inline-contents>element with inline contents</dfn> is an <a href=#html-element>HTML element</a>
whose <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-element-local-name title=concept-element-local-name>local name</a> is a <a href=#name-of-an-element-with-inline-contents>name of an element with inline contents</a>.
<!-- List is mostly based on current HTML5, together with obsolete elements.  I
mostly got the obsolete element list by testing what Firefox 5.0a2 splits when
you do insertHorizontalRule. -->

<p class=XXX>The definitions of prohibited paragraph children and elements with
inline contents should be in the HTML spec (possibly under a different name) so
they don't fall out of sync.  They'll do for now.  Also, I might want to rename
"prohibited paragraph child" given how I'm using it; I have to decide whether I
want to key off CSS (like "inline node" does) or HTML (like "prohibited
paragraph child") when deciding what to treat as a block and what not.

<p>A <dfn id=potential-indentation-element>potential indentation element</dfn> is either a <code class=external data-anolis-spec=html title="the blockquote element"><a href=http://www.whatwg.org/html/#the-blockquote-element>blockquote</a></code>, or a
<code class=external data-anolis-spec=html title="the div element"><a href=http://www.whatwg.org/html/#the-div-element>div</a></code> that has a <code class=external data-anolis-spec=html title="the style attribute"><a href=http://www.whatwg.org/html/#the-style-attribute>style</a></code> attribute that sets "margin" or some subproperty
of it.

<p class=XXX>Terminology is inconsistent with "modifiable" etc. used for inline
styles.

<p>An <dfn id=indentation-element>indentation element</dfn> is an <a href=#potential-indentation-element>potential indentation
element</a> that has no attributes other than one or more of

<ul>
  <li>a <code class=external data-anolis-spec=html title="the style attribute"><a href=http://www.whatwg.org/html/#the-style-attribute>style</a></code> attribute that sets no properties other than "margin",
  "border", "padding", or subproperties of those;

  <li>a <code class=external data-anolis-spec=html title=classes><a href=http://www.whatwg.org/html/#classes>class</a></code> attribute;

  <li>a <code class=external data-anolis-spec=html title="the dir attribute"><a href=http://www.whatwg.org/html/#the-dir-attribute>dir</a></code>
  attribute.
</ul>

<p>A <dfn id=non-list-single-line-container>non-list single-line container</dfn> is an <a href=#html-element>HTML element</a>
with <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-element-local-name title=concept-element-local-name>local name</a> "address", "div", "h1", "h2", "h3", "h4", "h5", "h6", "p",
or "pre".

<p>A <dfn id=single-line-container>single-line container</dfn> is either a <a href=#non-list-single-line-container>non-list single-line
container</a>, or an <a href=#html-element>HTML element</a> with <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-element-local-name title=concept-element-local-name>local name</a> "li",
"dt", or "dd".

<p>The <dfn id=default-single-line-container-name>default single-line container name</dfn> is "p".
<!-- Possibly to be made configurable later. -->

<p>A <dfn id=visible-node>visible node</dfn> is a <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>node</a> that either is a <a href=#prohibited-paragraph-child>prohibited
paragraph child</a>, or a <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#text>Text</a></code> node whose <code class=external data-anolis-spec=domcore title=dom-CharacterData-data><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-characterdata-data>data</a></code> is not empty, or a
<code class=external data-anolis-spec=html title="the br element"><a href=http://www.whatwg.org/html/#the-br-element>br</a></code> or <code class=external data-anolis-spec=html title="the img element"><a href=http://www.whatwg.org/html/#the-img-element>img</a></code>, or any <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>node</a> with a <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-descendant title=concept-tree-descendant>descendant</a> that is a
<a href=#visible-node>visible node</a>.

<p>An <dfn id=invisible-node>invisible node</dfn> is a <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>node</a> that is not a <a href=#visible-node>visible
node</a>.

<p class=XXX>I don't know if the visible/invisible node definitions are really
the way we want to do things.  If they are, they need some adjustment, like to
handle collapsed whitespace nodes and collapsed br's.


<h3 id=assorted-block-formatting-command-algorithms><span class=secno>7.2 </span>Assorted block formatting command algorithms</h3>

<p>To <dfn id=fix-disallowed-ancestors>fix disallowed ancestors</dfn> of a <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>node</a> <var title="">node</var>:

<p class=XXX>Do we want to get rid of attributes that are no longer allowed
here?

<ol>
  <li>If <var title="">node</var> is not an <a href=#allowed-child>allowed child</a> of any of its
  <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-ancestor title=concept-tree-ancestor>ancestors</a> <a href=#in-the-same-editing-host>in the same editing host</a>:

  <ol>
    <li>If <var title="">node</var> is not a <a href=#prohibited-paragraph-child>prohibited paragraph child</a>,
    abort these steps.

    <li><a href=#set-the-tag-name>Set the tag name</a> of <var title="">node</var> to the <a href=#default-single-line-container-name>default
    single-line container name</a>, and let <var title="">node</var> be the result.

    <li><a href=#fix-disallowed-ancestors>Fix disallowed ancestors</a> of <var title="">node</var>.
    <!-- Because maybe it somehow wound up as the child of a p, like via
    insertHTML. -->

    <li>Let <var title="">descendants</var> be all <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-descendant title=concept-tree-descendant>descendants</a> of <var title="">node</var>.

    <li><a href=#fix-disallowed-ancestors>Fix disallowed ancestors</a> of each member of
    <var title="">descendants</var>.

    <li>Abort these steps.
  </ol>

  <li>While <var title="">node</var> is not an <a href=#allowed-child>allowed child</a> of its
  <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a>, <a href=#split-the-parent>split the parent</a> of the one-<a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>node</a> list consisting
  of <var title="">node</var>.
</ol>

<p>To <dfn id=fix-prohibited-paragraph-descendants>fix prohibited paragraph descendants</dfn> of a <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>node</a>
<var title="">node</var>:

<p class=note>This will fix any case where a descendant of node is a prohibited
paragraph child.  The function returns a list consisting of <var title="">node</var> and
any new siblings this algorithm might give it, if some of its children are
split out of it.

<p class=XXX>Possibly can be converted to just fix disallowed ancestors of all
descendant nodes.  The only reason this is nontrivial is because the caller
needs the list of returned nodes.  (It's only used by formatBlock, but it
currently has to be a separate function because it's recursive.)

<ol>
  <li>If <var title="">node</var> has no <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>children</a>, return the one-<a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>node</a> list
  consisting of <var title="">node</var>.

  <li>Let <var title="">children</var> be the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>children</a> of <var title="">node</var>.

  <li><a href=#fix-prohibited-paragraph-descendants>Fix prohibited paragraph descendants</a> of each member of
  <var title="">children</var>.

  <!-- When we split the parent of a node, three things can happen.  Either the
  node gets stuck before its parent, or after its parent, or the parent gets
  copied and the copy gets stuck before it.  So the nodes we want to return are
  consecutive siblings; the first is either the original first child of node or
  its parent, and the last is either the last child of node or node itself. -->
  <li>Let <var title="">children</var> be the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>children</a> of <var title="">node</var>.

  <li>For each <var title="">child</var> in <var title="">children</var>, if <var title="">child</var> is
  a <a href=#prohibited-paragraph-child>prohibited paragraph child</a>, <a href=#split-the-parent>split the parent</a> of
  the one-<a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>node</a> list consisting of <var title="">child</var>.

  <li>If <var title="">node</var>'s <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> is null, let <var title="">node</var> equal the
  last member of <var title="">children</var>.

  <li>Let <var title="">node list</var> be a list of <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>nodes</a>, initially empty.

  <li>Repeat these steps:

  <ol>
    <li>Prepend <var title="">node</var> to <var title="">node list</var>.

    <li>If <var title="">node</var> is <var title="">children</var>'s first member, or
    <var title="">children</var>'s first member's <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a>, break from this loop.

    <li>Set <var title="">node</var> to its <code class=external data-anolis-spec=domcore title=dom-Node-previousSibling><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-previoussibling>previousSibling</a></code>.
  </ol>

  <li>Return <var title="">node list</var>.
</ol>

<p>To <dfn id=indent>indent</dfn> a list <var title="">node list</var> of consecutive <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-sibling title=concept-tree-sibling>sibling</a>
<a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>nodes</a>:
<!--
We have to handle entire lists of siblings at once, or else we'd wind up doing
something like

  <ol>
    {<li>foo</li>
    <ol><li>bar</li></ol>}
  </ol>
  ->
  <ol><ol>
    <li>foo</li>
    <li>bar</li>
  </ol></ol>
  ->
  <ol><ol><ol>
    <li>foo</li>
    <li>bar</li>
  </ol></ol></ol>

since by the time we got to doing the <ol> that originally contained "bar", we
won't remember that we aren't supposed to indent "foo" a second time.
-->

<ol>
  <li>If <var title="">node list</var> is empty, do nothing and abort these steps.

  <li>Let <var title="">first node</var> be the first member of <var title="">node list</var>.

  <li>If <var title="">first node</var>'s <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> is an <code class=external data-anolis-spec=html title="the ol element"><a href=http://www.whatwg.org/html/#the-ol-element>ol</a></code> or <code class=external data-anolis-spec=html title="the ul element"><a href=http://www.whatwg.org/html/#the-ul-element>ul</a></code>:

  <ol>
    <li>Let <var title="">tag</var> be the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-element-local-name title=concept-element-local-name>local name</a> of the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> of
    <var title="">first node</var>.

    <li><a href=#wrap>Wrap</a> <var title="">node list</var>, with <a href=#sibling-criteria>sibling
    criteria</a> matching only <a href=#html-element title="HTML element">HTML
    elements</a> with <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-element-local-name title=concept-element-local-name>local name</a> <var title="">tag</var> and <a href=#new-parent-instructions>new parent
    instructions</a> returning the result of calling <code class=external data-anolis-spec=domcore title=dom-Document-createElement><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-document-createelement>createElement(<var title="">tag</var>)</a></code> on
    the <code class=external data-anolis-spec=domcore title=dom-Node-ownerDocument><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-ownerdocument>ownerDocument</a></code> of <var title="">first node</var>.
    <!--
    This matches IE9, Firefox 4.0, and Chrome 12 dev.  If there's a preceding
    <li>, Opera 11.10 instead adds the new parent to the end of that <li>, so
    it's not the child of another list, which is invalid.  But the other
    browsers' way of doing things makes things simpler.  E.g., if we want to
    indent an <li> and it has <ol>/<ul> children, we have to distinguish
    between the case where we want to indent the whole <li> or only the first
    part.  It also allows things like

      <ol><li>
        foo
        <ol><li>bar</li></ol>
        baz
      </li></ol>

    in which case it's unclear what we should do if the user selects "foo" and
    indents.  I've filed a bug on HTML5:

    http://www.w3.org/Bugs/Public/show_bug.cgi?id=12609
    -->

    <li>Abort these steps.
  </ol>

  <!--
  Firefox 4.0 respects the CSS styling flag for indent, but Chrome 12 dev does
  not.  I always produce blockquotes, even if CSS styling is on, for two
  reasons.  One, IE9 handles inline margin attributes badly: when outdenting,
  it propagates the margin to the parent, which doesn't actually remove it.
  Two, in CSS mode I'd want to use <div style="margin: 1em 40px"> to match
  non-CSS mode, but authors are very likely to want to remove the top/bottom
  margin, which they can't do if it's not a special tag.  Authors who really
  want divs for indentation could always convert the blockquotes to divs
  themselves.  But if people really want it, I could respect CSS styling mode
  here too.

  The top/bottom margins might be undesirable here, but no more so than for
  <ol>/<ul>/<p>/etc.  Here as there, authors can remove them with CSS if they
  want.
  -->

  <li><a href=#wrap>Wrap</a> <var title="">node list</var>, with <a href=#sibling-criteria>sibling
  criteria</a> matching any <a href=#indentation-element>indentation element</a>, and <a href=#new-parent-instructions>new
  parent instructions</a> to return the result of calling <code class=external data-anolis-spec=domcore title=dom-Document-createElement><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-document-createelement>createElement("blockquote")</a></code> on the
  <code class=external data-anolis-spec=domcore title=dom-Node-ownerDocument><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-ownerdocument>ownerDocument</a></code> of <var title="">first node</var>.  Let <var title="">new parent</var> be the
  result.

  <p class=XXX>This indents on both sides, so we don't have to worry about
  directionality.  Preferably we should indent only on the start side, but
  that requires care to get right in mixed-direction cases.  Even once
  browsers start to support margin-start and so on, we can't use them because
  a) we have to work okay in legacy browsers and b) it doesn't help if a
  descendant block has different direction (so should be indented the other
  way).  It's not clear to me that we should worry about it: most browsers
  don't, and the ones that do get it wrong.

  <li><a href=#fix-disallowed-ancestors>Fix disallowed ancestors</a> of <var title="">new parent</var>.
</ol>

<p>To <dfn id=normalize-sublists>normalize sublists</dfn> in a <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>node</a> <var title="">item</var>:
<!--
This algorithm implies that we don't support a sublist in the middle of an
item, only at the end.  For instance,

  <li>foo<ol>...</ol>bar</li>

gets transformed to

  <li>foo</li><ol>...</ol><li>bar</li>

which in particular creates an extra list marker for "bar".  This is okay; we
don't need to expose all of HTML's markup abilities through execCommand().
Similarly, the superscript and subscript commands don't allow nesting.  I
didn't see any way to get a sublist in the middle of an item in Word 2007 or in
OpenOffice.org 3.2.1 Ubuntu package, nor in  any browser using just
execCommand(), so it should be no big problem if we require that such nesting
not occur.  (Existing browsers behave weirdly and inconsistently when
confronted with this kind of nesting.)
-->

<ol>
  <li>If <var title="">item</var> is not an <code class=external data-anolis-spec=html title="the li element"><a href=http://www.whatwg.org/html/#the-li-element>li</a></code> or it is not <a href=#editable>editable</a> or
  its <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> is not <a href=#editable>editable</a>, abort these steps.

  <li>Let <var title="">new item</var> be null.

  <li>While <var title="">item</var> has an <code class=external data-anolis-spec=html title="the ol element"><a href=http://www.whatwg.org/html/#the-ol-element>ol</a></code> or <code class=external data-anolis-spec=html title="the ul element"><a href=http://www.whatwg.org/html/#the-ul-element>ul</a></code> <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a>:

  <ol>
    <li>Let <var title="">child</var> be the last <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> of <var title="">item</var>.

    <li>If <var title="">child</var> is an <code class=external data-anolis-spec=html title="the ol element"><a href=http://www.whatwg.org/html/#the-ol-element>ol</a></code> or <code class=external data-anolis-spec=html title="the ul element"><a href=http://www.whatwg.org/html/#the-ul-element>ul</a></code>, or <var title="">new item</var> is
    null and <var title="">child</var> is a <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#text>Text</a></code> node whose <code class=external data-anolis-spec=domcore title=dom-CharacterData-data><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-characterdata-data>data</a></code>
    consists of zero of more <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#space-character title="space
    character">space characters</a>:

    <ol>
      <li>Set <var title="">new item</var> to null.

      <li>Insert <var title="">child</var> into the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> of <var title="">item</var>
      immediately following <var title="">item</var>, <a href=#preserving-ranges>preserving ranges</a>.
    </ol>

    <li>Otherwise:

    <ol>
      <li>If <var title="">new item</var> is null, let <var title="">new item</var> be the
      result of calling <code class=external data-anolis-spec=domcore title=dom-Document-createElement><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-document-createelement>createElement("li")</a></code> on the
      <code class=external data-anolis-spec=domcore title=dom-Node-ownerDocument><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-ownerdocument>ownerDocument</a></code> of <var title="">item</var>, then insert <var title="">new item</var>
      into the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> of <var title="">item</var> immediately after
      <var title="">item</var>.

      <li>Insert <var title="">child</var> into <var title="">new item</var> as its first
      <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a>, <a href=#preserving-ranges>preserving ranges</a>.
    </ol>
  </ol>
</ol>


<h3 id=allowed-children><span class=secno>7.3 </span>Allowed children</h3>

<p>A <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>node</a> or string <var title="">child</var> is an <dfn id=allowed-child>allowed child</dfn> of a
<a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>node</a> or string <var title="">parent</var> if the following algorithm returns true:

<div class=XXX>
<p>This list doesn't currently match HTML's validity requirements for a few
reasons:

<ol>
  <li>We need to handle invalid elements, which have no conformance
  requirements but should be treated properly.  In particular, they can
  interfere with serialization (e.g., center cannot descend from p).

  <li>Sometimes users give instructions that have to produce invalid DOMs to
  get the expected effect, like indenting the first item of a list.

  <li>The HTML validity requirements are sometimes quite complicated.

  <li>I just haven't had bothered to be systematic about it yet&nbsp;&ndash;
  I've only covered what's come up in my tests.
</ol>
</div>

<ol>
  <li>If <var title="">parent</var> is "colgroup", "table", "tbody", "tfoot", "thead",
  "tr", or an <a href=#html-element>HTML element</a> with <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-element-local-name title=concept-element-local-name>local name</a> equal to one of
  those, and <var title="">child</var> is a <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#text>Text</a></code> node whose <code class=external data-anolis-spec=domcore title=dom-CharacterData-data><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-characterdata-data>data</a></code> does not
  consist solely of <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#space-character title="space character">space characters</a>, return false.

  <li>If <var title="">parent</var> is "script", "style", "plaintext", or "xmp", or an
  <a href=#html-element>HTML element</a> with <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-element-local-name title=concept-element-local-name>local name</a> equal to one of those, and
  <var title="">child</var> is not a <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#text>Text</a></code> node, return false.
  <!-- Actually, no node can occur in the DOM after plaintext, generally.  But
  let's not get too carried away. -->

  <li>If <var title="">child</var> is a <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#document>Document</a></code>, <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#documentfragment>DocumentFragment</a></code>, or
  <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#documenttype>DocumentType</a></code>, return false.

  <li>If <var title="">child</var> is an <a href=#html-element>HTML element</a>, set <var title="">child</var>
  to the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-element-local-name title=concept-element-local-name>local name</a> of <var title="">child</var>.

  <li>If <var title="">child</var> is not a string, return true.

  <li>If <var title="">parent</var> is an <a href=#html-element>HTML element</a>:

  <ol>
    <li>If <var title="">child</var> is "a", and <var title="">parent</var> or some <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-ancestor title=concept-tree-ancestor>ancestor</a>
    of <var title="">parent</var> is an <code class=external data-anolis-spec=html title="the a element"><a href=http://www.whatwg.org/html/#the-a-element>a</a></code>, return false.
    <!-- Cannot be serialized as text/html.  In some cases it can, like
    <a>foo<table><td><a>bar</a></td></table>baz</a>, but it's invalid in those
    cases too, so no need for complication. -->

    <li>If <var title="">child</var> is a <a href=#prohibited-paragraph-child-name>prohibited paragraph child name</a>
    and <var title="">parent</var> or some <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-ancestor title=concept-tree-ancestor>ancestor</a> of <var title="">parent</var> is a <code class=external data-anolis-spec=html title="the p element"><a href=http://www.whatwg.org/html/#the-p-element>p</a></code>
    or <a href=#element-with-inline-contents>element with inline contents</a>, return false.
    <!-- This generally cannot be serialized either, for p.  For elements with
    inline contents, this serves to prevent things like
    <span><p>foo</p></span>, which will parse fine but aren't supposed to
    happen anyway. -->

    <li>If <var title="">child</var> is "h1", "h2", "h3", "h4", "h5", or "h6", and
    <var title="">parent</var> or some <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-ancestor title=concept-tree-ancestor>ancestor</a> of <var title="">parent</var> is an
    <a href=#html-element>HTML element</a> with <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-element-local-name title=concept-element-local-name>local name</a> "h1", "h2", "h3", "h4", "h5",
    or "h6", return false.
    <!-- Nor this. -->

    <li>Let <var title="">parent</var> be the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-element-local-name title=concept-element-local-name>local name</a> of <var title="">parent</var>.
    <!-- Further requirements only care about the parent itself, not ancestors,
    so we don't need to know the node itself. -->
  </ol>

  <li>If <var title="">parent</var> is an <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element>Element</a></code> or <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#documentfragment>DocumentFragment</a></code>, return
  true.

  <li>If <var title="">parent</var> is not a string, return false.

  <li>If <var title="">parent</var> is in the following table, then return true if
  <var title="">child</var> is listed as an allowed child, and false otherwise.
  <!-- We allow children even where some intervening nodes will be inserted,
  like tr as a child of table. -->

  <table>
    <tr><th>Parent <th>Allowed children
    <tr><td>colgroup <td>col
    <tr><td>table <td>caption, col, colgroup, tbody, td, tfoot, th, thead, tr
    <tr><td>tbody, tfoot, thead <td>td, th, tr
    <tr><td>tr <td>td, th
    <tr><td>dl <td>dt, dd
    <tr><td>dir, ol, ul <td>dir, li, ol, ul
    <tr><td>hgroup <td>h1, h2, h3, h4, h5, h6
  </table>

  <li>If <var title="">child</var> is "body", "caption", "col", "colgroup", "frame",
  "frameset", "head", "html", "tbody", "td", "tfoot", "th", "thead", or "tr",
  return false.

  <!-- dd/dt/li will serialize fine as the child of random stuff, but it makes
  no sense at all, so we want to avoid it anyway. -->
  <li>If <var title="">child</var> is "dd" or "dt" and <var title="">parent</var> is not "dl",
  return false.

  <li>If <var title="">child</var> is "li" and <var title="">parent</var> is not "ol" or "ul",
  return false.

  <li>If <var title="">parent</var> is in the following table and <var title="">child</var> is
  listed as a prohibited child, return false.

  <table>
    <tr><th>Parent <th>Prohibited children
    <tr><td>a <td>a
    <tr><td>dd, dt <td>dd, dt
    <tr><td>h1, h2, h3, h4, h5, h6 <td>h1, h2, h3, h4, h5, h6
    <tr><td>li <td>li
    <tr><td>nobr <td>nobr
    <tr><td>p, all <a href=#name-of-an-element-with-inline-contents title="name of an element with inline contents">names
          of an element with inline contents</a>
        <td>All <a href=#prohibited-paragraph-child-name title="prohibited paragraph child name">prohibited
          paragraph child names</a>
    <tr><td>td, th <td>caption, col, colgroup, tbody, td, tfoot, th, thead, tr
  </table>

  <li>Return true.
</ol>


<h3 id=block-extending-a-range><span class=secno>7.4 </span>Block-extending a range</h3>

<p>When a user agent is to <dfn id=block-extend>block-extend</dfn> a <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range title=concept-range>range</a>
<var title="">range</var>, it must run the following steps:

<ol>
  <li>Let <var title="">start node</var>, <var title="">start offset</var>, <var title="">end node</var>,
  and <var title="">end offset</var> be the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> and <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-end title=concept-range-end>end</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>nodes</a>
  and <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-offset title=concept-boundary-point-offset>offsets</a> of <var title="">range</var>.

  <li>If some <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#ancestor-container title="ancestor container">ancestor container</a> of <var title="">start node</var> is an <code class=external data-anolis-spec=html title="the li element"><a href=http://www.whatwg.org/html/#the-li-element>li</a></code>, set
  <var title="">start offset</var> to the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-indexof title=concept-indexof>index</a> of the last such <code class=external data-anolis-spec=html title="the li element"><a href=http://www.whatwg.org/html/#the-li-element>li</a></code> in
  <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#tree-order>tree order</a>, and set <var title="">start node</var> to that <code class=external data-anolis-spec=html title="the li element"><a href=http://www.whatwg.org/html/#the-li-element>li</a></code>'s <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a>.

  <li>Repeat the following steps:

  <ol>
    <li>If <var title="">start node</var> is a <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#text>Text</a></code> or <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#comment>Comment</a></code> node or
    <var title="">start offset</var> is 0, set <var title="">start offset</var> to the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-indexof title=concept-indexof>index</a>
    of <var title="">start node</var> and then set <var title="">start node</var> to its
    <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a>.

    <li>Otherwise, if <var title="">start offset</var> is <var title="">start node</var>'s
    <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-node-length title=concept-node-length>length</a> and <var title="">start node</var>'s last <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> is an
    <a href=#inline-node>inline node</a> that's not a <code class=external data-anolis-spec=html title="the br element"><a href=http://www.whatwg.org/html/#the-br-element>br</a></code>, subtract one from <var title="">start
    offset</var>.
    <!-- So if you have a collapsed selection at the end of a block, for
    instance, it will extend backwards into a block. -->

    <li>Otherwise, if <var title="">start node</var> has a <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> with <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-indexof title=concept-indexof>index</a>
    <var title="">start offset</var>, and that <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> and its <code class=external data-anolis-spec=domcore title=dom-Node-previousSibling><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-previoussibling>previousSibling</a></code> are
    both <a href=#inline-node title="inline node">inline nodes</a> and the
    <code class=external data-anolis-spec=domcore title=dom-Node-previousSibling><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-previoussibling>previousSibling</a></code> isn't a <code class=external data-anolis-spec=html title="the br element"><a href=http://www.whatwg.org/html/#the-br-element>br</a></code>, subtract one from <var title="">start
    offset</var>.
    <!-- IE also includes <br> (at least for the purposes of the indent
    command), but this is unlikely to match user expectations. -->

    <p class=XXX>This is wrong in the presence of comments or display: none or
    probably other things.  Do we care?

    <li>Otherwise, break from this loop.
  </ol>

  <li>If some <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#ancestor-container title="ancestor container">ancestor container</a> of <var title="">end node</var> is an <code class=external data-anolis-spec=html title="the li element"><a href=http://www.whatwg.org/html/#the-li-element>li</a></code>, set
  <var title="">end offset</var> to one plus the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-indexof title=concept-indexof>index</a> of the last such <code class=external data-anolis-spec=html title="the li element"><a href=http://www.whatwg.org/html/#the-li-element>li</a></code> in
  <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#tree-order>tree order</a>, and set <var title="">end node</var> to that <code class=external data-anolis-spec=html title="the li element"><a href=http://www.whatwg.org/html/#the-li-element>li</a></code>'s <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a>.

  <li>Repeat the following steps:

  <ol>
    <li>If <var title="">end node</var> is a <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#text>Text</a></code> or <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#comment>Comment</a></code> node or <var title="">end
    offset</var> is equal to the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-node-length title=concept-node-length>length</a> of <var title="">end node</var>, set
    <var title="">end offset</var> to one plus the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-indexof title=concept-indexof>index</a> of <var title="">end node</var> and
    then set <var title="">end node</var> to its <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a>.

    <li>Otherwise, if <var title="">end offset</var> is 0 and <var title="">end node</var>'s
    first <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> is an <a href=#inline-node>inline node</a> that's not a <code class=external data-anolis-spec=html title="the br element"><a href=http://www.whatwg.org/html/#the-br-element>br</a></code>, add one
    to <var title="">end offset</var>.

    <li>Otherwise, if <var title="">end node</var> has a <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> with <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-indexof title=concept-indexof>index</a>
    <var title="">end offset</var>, and that <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> and its <code class=external data-anolis-spec=domcore title=dom-Node-previousSibling><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-previoussibling>previousSibling</a></code> are
    both <a href=#inline-node title="inline node">inline nodes</a>, and the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> of
    <var title="">end node</var> with <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-indexof title=concept-indexof>index</a> <var title="">end offset</var> isn't a <code class=external data-anolis-spec=html title="the br element"><a href=http://www.whatwg.org/html/#the-br-element>br</a></code>,
    add one to <var title="">end offset</var>.

    <li>Otherwise, break from this loop.
  </ol>

  <li>If the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> of <var title="">end node</var> with <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-indexof title=concept-indexof>index</a> <var title="">end
  offset</var> is a <code class=external data-anolis-spec=html title="the br element"><a href=http://www.whatwg.org/html/#the-br-element>br</a></code>, add one to <var title="">end offset</var>.

  <li>While <var title="">end offset</var> is equal to the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-node-length title=concept-node-length>length</a> of <var title="">end
  node</var>, set <var title="">end offset</var> to one plus the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-indexof title=concept-indexof>index</a> of <var title="">end
  node</var> and then set <var title="">end node</var> to its <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a>.

  <li>Let <var title="">new range</var> be a new <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range title=concept-range>range</a> whose <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> and
  <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-end title=concept-range-end>end</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>nodes</a> and <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-offset title=concept-boundary-point-offset>offsets</a> are <var title="">start node</var>,
  <var title="">start offset</var>, <var title="">end node</var>, and <var title="">end offset</var>.

  <li>Return <var title="">new range</var>.
</ol>


<h3 id=deleting-the-contents-of-a-range><span class=secno>7.5 </span>Deleting the contents of a range</h3>

<p>To <dfn id=delete-the-contents>delete the contents</dfn> of a <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range title=concept-range>range</a> <var title="">range</var>:

<p class=XXX>I'm uncertain about the use of prohibited paragraph children here.
I'm using it mostly because it's convenient and seems relatively sensible.  If
we really want to use it, we probably want to change its name.

<ol>
  <li>If <var title="">range</var> is null, abort these steps and do nothing.

  <li>Let <var title="">start node</var>, <var title="">start offset</var>, <var title="">end node</var>,
  and <var title="">end offset</var> be <var title="">range</var>'s <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> and
  <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-end title=concept-range-end>end</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>nodes</a> and <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-offset title=concept-boundary-point-offset>offsets</a>.

  <!-- Drill the range down to the lowest possible level, so we don't delete
  more elements than necessary. -->
  <li>While <var title="">start node</var> has at least one <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a>:
  <!--
  We don't want to keep going when we hit an element with no children, because
  then we'd do something like

    foo{<br />bar]
    -> foo<br>{</br>bar]
    -> foo<br />{bar]
    -> foo<br />[bar]

  and we deselected the <br>.
  -->

  <ol>
    <li>If <var title="">start offset</var> is <var title="">start node</var>'s
    <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-node-length title=concept-node-length>length</a>, and <var title="">start node</var>'s <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> is <a href=#in-the-same-editing-host>in the same
    editing host</a>, and <var title="">start node</var> is not a <a href=#prohibited-paragraph-child>prohibited
    paragraph child</a>, set <var title="">start offset</var> to one plus the
    <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-indexof title=concept-indexof>index</a> of <var title="">start node</var>, then set <var title="">start node</var> to its
    <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> and continue this loop from the beginning.
    <!--
    For instance:

      <b>foo[</b><i>bar]</i>
      -> <b>foo{</b><i>bar]</i>
      -> <b>foo</b>{<i>bar]</i>

    Then the next step will make it <b>foo</b><i>[bar]</i>.

    We don't want to do this for prohibited paragraph children, because that
    would lead to something like

      <p>foo[</p><p>]bar<p>

    ultimately collapsing, which is wrong.  Once we do the deletion, it needs
    to wind up <p>foo[]bar</p>, whereas an actually collapsed selection should
    do nothing.
    -->

    <li>If <var title="">start offset</var> is <var title="">start node</var>'s <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-node-length title=concept-node-length>length</a>,
    break from this loop.
    <!-- This happens if the first step brought us all the way up to the root.
    The step immediately after this loop will bring us back down again.  -->

    <li>Let <var title="">reference node</var> be the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> of <var title="">start node</var>
    with <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-indexof title=concept-indexof>index</a> equal to <var title="">start offset</var>.

    <li>If <var title="">reference node</var> is a <a href=#prohibited-paragraph-child>prohibited paragraph
    child</a> or an <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element>Element</a></code> with no <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>children</a>, break from this loop.
    <!--
    Don't descend into an element with no children, since then it won't get
    deleted even if it's selected.  Don't descend into a prohibited paragraph
    child, because then we might wind up not mergings blocks when we should,
    e.g.

      foo{<p>}bar</p>
      -> foo<p>{}bar</p>

    and nothing gets changed.
    -->

    <li>Set <var title="">start node</var> to <var title="">reference node</var> and <var title="">start
    offset</var> to 0.
  </ol>

  <li>While <var title="">end node</var> has at least one <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a>:

  <ol>
    <li>If <var title="">end offset</var> is 0, and <var title="">end node</var>'s
    <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> is <a href=#in-the-same-editing-host>in the same editing host</a>, and <var title="">end
    node</var> is not a <a href=#prohibited-paragraph-child>prohibited paragraph child</a>, set <var title="">end
    offset</var> to the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-indexof title=concept-indexof>index</a> of <var title="">end node</var>, then set <var title="">end
    node</var> to its <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> and continue this loop from the beginning.

    <li>If <var title="">end offset</var> is 0, break from this loop.

    <li>Let <var title="">reference node</var> be the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> of <var title="">end node</var>
    with <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-indexof title=concept-indexof>index</a> equal to <var title="">end offset</var> minus one.

    <li>If <var title="">reference node</var> is a <a href=#prohibited-paragraph-child>prohibited paragraph
    child</a> or an <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element>Element</a></code> with no <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>children</a>, break from this loop.

    <li>Set <var title="">end node</var> to <var title="">reference node</var> and <var title="">end
    offset</var> to the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-node-length title=concept-node-length>length</a> of <var title="">reference node</var>.
  </ol>

  <li>If (<var title="">end node</var>, <var title="">end offset</var>) is <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-bp-before title=concept-bp-before>before</a> (<var title="">start
  node</var>, <var title="">start offset</var>), set <var title="">range</var>'s <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-end title=concept-range-end>end</a> to
  its <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> and abort these steps.

  <li>If <var title="">start node</var> is a <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#text>Text</a></code> or <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#comment>Comment</a></code> node and <var title="">start
  offset</var> is 0, set <var title="">start offset</var> to the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-indexof title=concept-indexof>index</a> of <var title="">start
  node</var>, then set <var title="">start node</var> to its <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a>.

  <li>If <var title="">end node</var> is a <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#text>Text</a></code> or <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#comment>Comment</a></code> node and <var title="">end
  offset</var> is its <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-node-length title=concept-node-length>length</a>, set <var title="">end offset</var> to one plus the
  <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-indexof title=concept-indexof>index</a> of <var title="">end node</var>, then set <var title="">end node</var> to its
  <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a>.

  <li>Set <var title="">range</var>'s <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> to (<var title="">start node</var>,
  <var title="">start offset</var>) and its <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-end title=concept-range-end>end</a> to (<var title="">end node</var>,
  <var title="">end offset</var>).

  <!--
  When we delete a selection that spans multiple blocks, we merge the end
  block's contents into the start block, like

    <p>fo[o</p><pre>b]ar</pre>
    -> <p>fo[]ar</p>.

  Figure out what the start and end blocks are before we start deleting
  anything.
  -->
  <li>Let <var title="">start block</var> be the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a> of
  <var title="">range</var>.

  <li>While <var title="">start block</var>'s <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> is <a href=#in-the-same-editing-host>in the same editing
  host</a> and <var title="">start block</var> is not a <a href=#prohibited-paragraph-child>prohibited paragraph
  child</a>, set <var title="">start block</var> to its <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a>.

  <li>If <var title="">start block</var> is neither a <a href=#prohibited-paragraph-child>prohibited paragraph
  child</a> nor an <a href=#editing-host>editing host</a>, or "span" is not an
  <a href=#allowed-child>allowed child</a> of <var title="">start block</var>, or <var title="">start
  block</var> is a <code class=external data-anolis-spec=html title="the td element"><a href=http://www.whatwg.org/html/#the-td-element>td</a></code> or <code class=external data-anolis-spec=html title="the th element"><a href=http://www.whatwg.org/html/#the-th-element>th</a></code>, set <var title="">start block</var> to null.
  <!--
  We only merge to or from prohibited paragraph children or editing hosts.
  (This is just in case someone makes a span into an editing host and sticks
  paragraphs inside it or something . . . we could probably drop that proviso.)
  Anything else is presumed to be an inline element, basically.  This might not
  be ideal.

  If span isn't an allowed child, it's probably something unpleasant like a
  table row or a list or such.  We don't want to merge to or from something
  like that, because we'd most likely wind up with the wrong type of child
  somewhere.  It should be pretty hard for this to happen given the
  normalization we do on the selection; I'm not actually sure how it could
  happen at all, actually, unless you start out with a DOM that has non-allowed
  children someplace.  So it's basically a sanity check.

  We don't let either start block or end block be a td or th.  This means we'll
  never merge to or from a td or th.  This matches Firefox 5.0a2, and
  reportedly Word as well.  Chrome 13 dev and Opera 11.11 allow merging from a
  non-table cell end block to a table cell start block, but not vice versa.  In
  IE9 the delete key just does nothing.
  -->

  <li>Let <var title="">end block</var> be the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-end title=concept-range-end>end</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a> of
  <var title="">range</var>.

  <li>While <var title="">end block</var>'s <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> is <a href=#in-the-same-editing-host>in the same editing
  host</a> and <var title="">end block</var> is not a <a href=#prohibited-paragraph-child>prohibited paragraph
  child</a>, set <var title="">end block</var> to its <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a>.

  <li>If <var title="">end block</var> is neither a <a href=#prohibited-paragraph-child>prohibited paragraph
  child</a> nor an <a href=#editing-host>editing host</a>, or "span" is not an
  <a href=#allowed-child>allowed child</a> of <var title="">end block</var>, or <var title="">end block</var>
  is a <code class=external data-anolis-spec=html title="the td element"><a href=http://www.whatwg.org/html/#the-td-element>td</a></code> or <code class=external data-anolis-spec=html title="the th element"><a href=http://www.whatwg.org/html/#the-th-element>th</a></code>, set <var title="">end block</var> to null.

  <!-- This is based on deleteData() in DOM Range. -->
  <li>If <var title="">start node</var> and <var title="">end node</var> are the same, and
  <var title="">start node</var> is an <a href=#editable>editable</a> <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#text>Text</a></code> or <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#comment>Comment</a></code>
  node, call <code class=external data-anolis-spec=domcore title=dom-CharacterData-deleteData><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-characterdata-deletedata>deleteData(<var title="">start offset</var>, <var title="">end offset</var>
  &minus; <var title="">start offset</var>)</a></code> on <var title="">start node</var>.

  <li>Otherwise:

  <ol>
    <li>If <var title="">start node</var> is an <a href=#editable>editable</a> <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#text>Text</a></code> or
    <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#comment>Comment</a></code> node, call <code class=external data-anolis-spec=domcore title=dom-CharacterData-deleteData><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-characterdata-deletedata>deleteData()</a></code> on it, with <var title="">start offset</var>
    as the first argument and (<a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-node-length title=concept-node-length>length</a> of <var title="">start node</var> &minus;
    <var title="">start offset</var>) as the second argument.

    <li>Let <var title="">node list</var> be a list of <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>nodes</a>, initially empty.

    <li>For each <var title="">node</var> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#contained>contained</a> in <var title="">range</var>, append
    <var title="">node</var> to <var title="">node list</var> if the last member of <var title="">node
    list</var> (if any) is not an <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-ancestor title=concept-tree-ancestor>ancestor</a> of <var title="">node</var>;
    <var title="">node</var> is <a href=#editable>editable</a>; and <var title="">node</var> is not a
    <code class=external data-anolis-spec=html title="the thead element"><a href=http://www.whatwg.org/html/#the-thead-element>thead</a></code>, <code class=external data-anolis-spec=html title="the tbody element"><a href=http://www.whatwg.org/html/#the-tbody-element>tbody</a></code>, <code class=external data-anolis-spec=html title="the tfoot element"><a href=http://www.whatwg.org/html/#the-tfoot-element>tfoot</a></code>, <code class=external data-anolis-spec=html title="the tr element"><a href=http://www.whatwg.org/html/#the-tr-element>tr</a></code>, <code class=external data-anolis-spec=html title="the th element"><a href=http://www.whatwg.org/html/#the-th-element>th</a></code>, or <code class=external data-anolis-spec=html title="the td element"><a href=http://www.whatwg.org/html/#the-td-element>td</a></code>.
    <!--
    IE9 doesn't seem to let you do any intercell deletions: the delete key does
    nothing if you select across multiple cells.  Firefox 5.0a2 and Opera 11.11
    behave as the spec says, not removing any table things.  Chrome 13 dev will
    remove entire rows if selected.  Note that IE, Firefox, Word 2007, and
    OpenOffice.org 3.2.1 Ubuntu all switch to a magic cell-selection mode when
    you try to select between cells, at least in some cases, instead of
    selecting letter-by-letter.
    -->

    <li>For each <var title="">node</var> in <var title="">node list</var>:

    <ol>
      <li>Let <var title="">parent</var> be the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> of <var title="">node</var>.

      <li>Remove <var title="">node</var> from <var title="">parent</var>.

      <li>While <var title="">parent</var> is an <a href=#editable>editable</a> <a href=#inline-node>inline
      node</a> with <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-node-length title=concept-node-length>length</a> 0, let <var title="">grandparent</var> be the
      <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> of <var title="">parent</var>, then remove <var title="">parent</var> from
      <var title="">grandparent</var>, then set <var title="">parent</var> to
      <var title="">grandparent</var>.

      <li>If <var title="">parent</var> is <a href=#editable>editable</a> or an <a href=#editing-host>editing
      host</a>, is not an <a href=#inline-node>inline node</a>, and has no <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>children</a>,
      call <code class=external data-anolis-spec=domcore title=dom-Document-createElement><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-document-createelement>createElement("br")</a></code> on the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#context-object>context object</a> and append the
      result as the last <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> of <var title="">parent</var>.
    </ol>

    <li>If <var title="">end node</var> is an <a href=#editable>editable</a> <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#text>Text</a></code> or
    <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#comment>Comment</a></code> node, call <code class=external data-anolis-spec=domcore title=dom-CharacterData-deleteData><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-characterdata-deletedata>deleteData(0, <var title="">end offset</var>)</a></code> on it.
  </ol>

  <!--
  Now we need to merge blocks.  The simplest case is something like

    <p>fo[o</p><p>bar</p><p>b]az</p>
    -> <p>fo</p>{}<p>az</p>
    -> <p>fo{}az</p>

  where neither block descends from the other.  More complicated is something
  like

    foo[<p>]bar</p>
    -> foo[]bar

  or

    <p>foo[</p>]bar
    -> <p>foo[]bar</p>

  where one descends from the other.
  -->

  <li>If <var title="">start block</var> or <var title="">end block</var> is null, or <var title="">start
  block</var> is not <a href=#in-the-same-editing-host>in the same editing host</a> as <var title="">end
  block</var>, or <var title="">start block</var> and <var title="">end block</var> are the same,
  set <var title="">range</var>'s <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-end title=concept-range-end>end</a> to its <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> and then abort
  these steps.

  <!--
  We might have added a br to the start/end block in an earlier step.  Now
  we're about to merge the blocks, and we don't want the br's to get in the
  way.  The end block is being destroyed no matter what.  If the start block
  winds up empty after merging, we'll add a new br child at the end so it
  doesn't collapse.
  -->
  <li>If <var title="">start block</var> has one <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a>, which is a <code class=external data-anolis-spec=html title="the br element"><a href=http://www.whatwg.org/html/#the-br-element>br</a></code>, remove
  its <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> from it.

  <li>If <var title="">end block</var> has one <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a>, which is a <code class=external data-anolis-spec=html title="the br element"><a href=http://www.whatwg.org/html/#the-br-element>br</a></code>, remove its
  <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> from it.

  <li>If <var title="">start block</var> is an <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-ancestor title=concept-tree-ancestor>ancestor</a> of <var title="">end block</var>:
  <!-- Just repeatedly blow up the end block. -->

  <ol>
    <li>Let <var title="">reference node</var> be <var title="">end block</var>.

    <li>While <var title="">reference node</var> is not a <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> of <var title="">start
    block</var>, set <var title="">reference node</var> to its <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a>.

    <li>Set the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> and <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-end title=concept-range-end>end</a> of <var title="">range</var> to
    (<var title="">start block</var>, <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-indexof title=concept-indexof>index</a> of <var title="">reference node</var>).

    <li>If <var title="">end block</var> has no <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>children</a>:

    <ol>
      <li>While <var title="">end block</var> is <a href=#editable>editable</a> and is the only
      <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> of its <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> and is not a <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> of <var title="">start
      block</var>, let <var title="">parent</var> equal <var title="">end block</var>, then
      remove <var title="">end block</var> from <var title="">parent</var>, then set <var title="">end
      block</var> to <var title="">parent</var>.

      <li>If <var title="">end block</var> is <a href=#editable>editable</a> and is not an
      <a href=#inline-node>inline node</a>, and its <code class=external data-anolis-spec=domcore title=dom-Node-previousSibling><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-previoussibling>previousSibling</a></code> and <code class=external data-anolis-spec=domcore title=dom-Node-nextSibling><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-nextsibling>nextSibling</a></code>
      are both <a href=#inline-node title="inline node">inline nodes</a>, call
      <code class=external data-anolis-spec=domcore title=dom-Document-createElement><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-document-createelement>createElement("br")</a></code> on the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#context-object>context object</a> and insert it into
      <var title="">end block</var>'s <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> immediately after <var title="">end block</var>.

      <li>If <var title="">end block</var> is <a href=#editable>editable</a>, remove it from its
      <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a>.

      <li>Abort these steps.
    </ol>

    <li>If <var title="">end block</var>'s <code class=external data-anolis-spec=domcore title=dom-Node-firstChild><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-firstchild>firstChild</a></code> is not an <a href=#inline-node>inline
    node</a>, abort these steps.

    <li>Let <var title="">children</var> be an array of <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>nodes</a>, initially empty.

    <li>Append the first <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> of <var title="">end block</var> to
    <var title="">children</var>.

    <li>While <var title="">children</var>'s last member is not a <code class=external data-anolis-spec=html title="the br element"><a href=http://www.whatwg.org/html/#the-br-element>br</a></code>, and
    <var title="">children</var>'s last member's <code class=external data-anolis-spec=domcore title=dom-Node-nextSibling><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-nextsibling>nextSibling</a></code> is an <a href=#inline-node>inline
    node</a>, append <var title="">children</var>'s last member's <code class=external data-anolis-spec=domcore title=dom-Node-nextSibling><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-nextsibling>nextSibling</a></code> to
    <var title="">children</var>.

    <li>While <var title="">children</var>'s first member's <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> is not <var title="">start
    block</var>, <a href=#split-the-parent>split the parent</a> of <var title="">children</var>.

    <li>If <var title="">children</var>'s first member's <code class=external data-anolis-spec=domcore title=dom-Node-previousSibling><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-previoussibling>previousSibling</a></code> is an
    <a href=#editable>editable</a> <code class=external data-anolis-spec=html title="the br element"><a href=http://www.whatwg.org/html/#the-br-element>br</a></code>, remove that <code class=external data-anolis-spec=html title="the br element"><a href=http://www.whatwg.org/html/#the-br-element>br</a></code> from its <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a>.
  </ol>

  <li>Otherwise, if <var title="">start block</var> is a <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-descendant title=concept-tree-descendant>descendant</a> of <var title="">end
  block</var>:
  <!-- Pull in everything that comes after <var title>start block</var>, until we hit
  a br or prohibited paragraph child. -->

  <ol>
    <li>Set the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> and <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-end title=concept-range-end>end</a> of <var title="">range</var> to
    (<var title="">start block</var>, <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-node-length title=concept-node-length>length</a> of <var title="">start block</var>).

    <li>Let <var title="">reference node</var> be <var title="">start block</var>.

    <li>While <var title="">reference node</var> is not a <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> of <var title="">end
    block</var>, set <var title="">reference node</var> to its <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a>.

    <li>If <var title="">reference node</var>'s <code class=external data-anolis-spec=domcore title=dom-Node-nextSibling><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-nextsibling>nextSibling</a></code> is an <a href=#inline-node>inline
    node</a> and <var title="">start block</var>'s <code class=external data-anolis-spec=domcore title=dom-Node-lastChild><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-lastchild>lastChild</a></code> is a <code class=external data-anolis-spec=html title="the br element"><a href=http://www.whatwg.org/html/#the-br-element>br</a></code>, remove
    <var title="">start block</var>'s <code class=external data-anolis-spec=domcore title=dom-Node-lastChild><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-lastchild>lastChild</a></code> from it.

    <li>While the <code class=external data-anolis-spec=domcore title=dom-Node-nextSibling><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-nextsibling>nextSibling</a></code> of <var title="">reference node</var> is neither null
    nor a <code class=external data-anolis-spec=html title="the br element"><a href=http://www.whatwg.org/html/#the-br-element>br</a></code> nor a <a href=#prohibited-paragraph-child>prohibited paragraph child</a>, append the
    <code class=external data-anolis-spec=domcore title=dom-Node-nextSibling><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-nextsibling>nextSibling</a></code> of <var title="">reference node</var> as the last <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> of
    <var title="">start block</var>, <a href=#preserving-ranges>preserving ranges</a>.

    <li>If the <code class=external data-anolis-spec=domcore title=dom-Node-nextSibling><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-nextsibling>nextSibling</a></code> of <var title="">reference node</var> is a <code class=external data-anolis-spec=html title="the br element"><a href=http://www.whatwg.org/html/#the-br-element>br</a></code>, remove
    it from its <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a>.
  </ol>

  <li>Otherwise:
  <!-- In the last case, just move all the children of the end block to the
  start block, and then get rid of any elements we emptied that way. -->

  <ol>
    <li>Set the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> and <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-end title=concept-range-end>end</a> of <var title="">range</var> to
    (<var title="">start block</var>, <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-node-length title=concept-node-length>length</a> of <var title="">start block</var>).

    <li>If <var title="">end block</var>'s <code class=external data-anolis-spec=domcore title=dom-Node-firstChild><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-firstchild>firstChild</a></code> is an <a href=#inline-node>inline node</a>
    and <var title="">start block</var>'s <code class=external data-anolis-spec=domcore title=dom-Node-lastChild><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-lastchild>lastChild</a></code> is a <code class=external data-anolis-spec=html title="the br element"><a href=http://www.whatwg.org/html/#the-br-element>br</a></code>, remove <var title="">start
    block</var>'s <code class=external data-anolis-spec=domcore title=dom-Node-lastChild><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-lastchild>lastChild</a></code> from it.

    <li>While <var title="">end block</var> has <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>children</a>, append the first <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a>
    of <var title="">end block</var> to <var title="">start block</var>, <a href=#preserving-ranges>preserving
    ranges</a>.

    <li>While <var title="">end block</var> has no <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>children</a>, let <var title="">parent</var> be
    the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> of <var title="">end block</var>, then remove <var title="">end block</var> from
    <var title="">parent</var>, then set <var title="">end block</var> to <var title="">parent</var>.
  </ol>

  <li>If <var title="">start block</var> has no <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>children</a>, call
  <code class=external data-anolis-spec=domcore title=dom-Document-createElement><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-document-createelement>createElement("br")</a></code> on the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#context-object>context object</a> and append the result as the
  last <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> of <var title="">start block</var>.
</ol>


<h3 id=outdenting-a-node><span class=secno>7.6 </span>Outdenting a node</h3>

<p>To <dfn id=outdent>outdent</dfn> a <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>node</a> <var title="">node</var>:

<!--
Things that are produced for indentation that we need to consider removing:

* Plain <blockquote> (produced by spec, Firefox 4.0 non-CSS, Opera 11.00)
* <blockquote style="margin-right: 0" dir="ltr"> and <blockquote
  style="margin-left: 0" dir="rtl"> (IE9)
* <blockquote class="webkit-indent-blockquote" style="margin: 0 0 0 40px;
  border: none; padding: 0px"> (Chrome 12 dev)
* <div style="margin-left: 40px"> and <div style="margin-right: 40px">
  (Firefox 4.0 CSS if no other element available)
* Other random things with display: block whose left or right margin was
  increased by 40px (Firefox 4.0 CSS)

For discussion on the list-related stuff, see the comment for
insertOrderedList.
-->
<ol>
  <li>If <var title="">node</var> is not <a href=#editable>editable</a>, abort these steps.

  <!-- The easy case is when the whole element is indented.  In this case we
  remove the whole thing indiscriminately.  In the case of blockquotes
  created by IE, this might change the direction of some children, but then
  their direction was probably changed incorrectly in the first place, so no
  harm. -->
  <li>If <var title="">node</var> is an <a href=#indentation-element>indentation element</a>, remove
  <var title="">node</var>, <a href=#preserving-its-descendants>preserving its descendants</a>.  Then abort these
  steps.

  <!-- No browser handles the case of Firefox 4.0 in CSS mode, where it adds a
  margin attribute to an existing element, including Firefox itself.  So let's
  just skip it. -->

  <li>If <var title="">node</var> is a <a href=#potential-indentation-element>potential indentation element</a>:
  <!-- This might be an indentation element that had style added to it by
  Firefox in CSS mode, for instance (color, font-family, etc.). -->

  <ol>
    <li>Unset the <code class=external data-anolis-spec=html title=classes><a href=http://www.whatwg.org/html/#classes>class</a></code> and
    <code class=external data-anolis-spec=html title="the dir attribute"><a href=http://www.whatwg.org/html/#the-dir-attribute>dir</a></code>
    attributes of <var title="">node</var>, if any.

    <li>Unset the margin, padding, and border CSS properties of
    <var title="">node</var>.

    <li><a href=#set-the-tag-name>Set the tag name</a> of <var title="">node</var> to "div".

    <li>Abort these steps.
  </ol>

  <!-- Approximate algorithms when an ancestor is causing the indentation
  appear to be:

  IE9: Go to the innermost element causing indentation.  If the stuff to be
    outdented includes all the contents of that element, get rid of it, but
    if it has any attributes, change it to a <p> with those same attributes.
    This is an excellent idea in general, but unfortunately it preserves
    explicitly-specified margins in style attributes, which isn't great.  In
    other cases, it moves the stuff to be outdented outside.  Not clear on
    all the details, seems to be pretty confusing.  Also does a bunch of
    seemingly arbitrary normalization like removing divs and some attributes
    from some things . . .
  Firefox 4.0: Go to the innermost element causing indentation.  If the stuff
    to be outdented includes all the contents of that element, get rid of it,
    even if it has arbitrary attributes.  Otherwise, move the stuff to be
    outdented outside the indenting element.  If there are any intervening
    elements that include stuff not to be outdented, wrap the outdented stuff
    in copies (which can duplicate id's, etc.).
  Chrome 12 dev: Go to the outermost element causing indentation (even if the
    current element is itself causing indentation).  Move the text to be
    outdented outside that outermost element, without regard to any
    intervening elements.  Then recreate the original styles on the moved
    text, in some fashion.  Something like that; it confuses me and doesn't
    seem to be reasonable.
  Opera 11.00: Like Firefox, except it goes to the outermost element, not the
    innermost.  Also seems to special-case to avoid duplicate id's, and has a
    few other quirks.

  Overall, all flawed, so I'll make up my own, patterned after pushing down
  styles.  First we search ancestors for an indentation element, which we stand
  a chance of completely removing.  Failing that, we look for a potential
  indentation element, which we cannot completely remove. -->
  <li>Let <var title="">current ancestor</var> be <var title="">node</var>'s <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a>.

  <li>Let <var title="">ancestor list</var> be a list of <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>nodes</a>, initially empty.

  <li>While <var title="">current ancestor</var> is an <a href=#editable>editable</a> <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element>Element</a></code>
  that is not an <a href=#indentation-element>indentation element</a>, append <var title="">current
  ancestor</var> to <var title="">ancestor list</var> and then set <var title="">current
  ancestor</var> to its <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a>.

  <li>If <var title="">current ancestor</var> is not an <a href=#editable>editable</a>
  <a href=#indentation-element>indentation element</a>:

  <ol>
    <li>Let <var title="">current ancestor</var> be <var title="">node</var>'s <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a>.

    <li>Let <var title="">ancestor list</var> be the empty list.

    <li>While <var title="">current ancestor</var> is an <a href=#editable>editable</a>
    <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element>Element</a></code> that is not a <a href=#potential-indentation-element>potential indentation element</a>,
    append <var title="">current ancestor</var> to <var title="">ancestor list</var> and then set
    <var title="">current ancestor</var> to its <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a>.
  </ol>

  <li>If <var title="">node</var> is an <code class=external data-anolis-spec=html title="the ol element"><a href=http://www.whatwg.org/html/#the-ol-element>ol</a></code> or <code class=external data-anolis-spec=html title="the ul element"><a href=http://www.whatwg.org/html/#the-ul-element>ul</a></code>, and either <var title="">current
  ancestor</var> is not an <a href=#editable>editable</a> <a href=#potential-indentation-element>potential indentation
  element</a> or <var title="">node</var>'s <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> is an <code class=external data-anolis-spec=html title="the ol element"><a href=http://www.whatwg.org/html/#the-ol-element>ol</a></code> or <code class=external data-anolis-spec=html title="the ul element"><a href=http://www.whatwg.org/html/#the-ul-element>ul</a></code>:
  <!--
  When asked to outdent a list wrapped in an indentation element, Chrome 12 dev
  removes the list instead of the indentation element.  Opera 11.10 seems to
  remove both.  IE9 and Firefox 4.0 remove the indentation element, as does the
  spec.
  -->

  <div class=XXX>
  <p>We don't handle a case like

  </p><xmp><ol><ol style="color: red"><li>foo<li>bar</ol><li>baz</ol></xmp>

  <p>If the inner <code class=external data-anolis-spec=html title="the ol element"><a href=http://www.whatwg.org/html/#the-ol-element>ol</a></code> is selected to be outdented, "foo" and "bar" will stop
  being red.  It seems nontrivial to handle this case in general, since we
  can't group <code class=external data-anolis-spec=html title="the li element"><a href=http://www.whatwg.org/html/#the-li-element>li</a></code>s.  If the list we're outdenting is a child of a non-list,
  then we can just change it to a div.
  </div>
  <!--
  Chrome 12 dev seems to special-case style attributes by converting them to
  the corresponding inline markup elements (at least in easy cases like color).
  For other attributes and non-WebKit browsers (IE9/FF4/O11.10), it looks like
  all the attributes are just removed.  Maybe we should try to copy WebKit
  here.
  -->

  <p class=XXX>What about if node isn't a child of a list, but there's a list
  ancestor below current ancestor?  Is that even possible given how the
  block-extend algorithm works?

  <ol>
    <li>Unset the <code class=external data-anolis-spec=html title=attr-ol-reversed><a href=http://www.whatwg.org/html/#attr-ol-reversed>reversed</a></code>, <code class=external data-anolis-spec=html title=attr-ol-start><a href=http://www.whatwg.org/html/#attr-ol-start>start</a></code>, and <code class=external data-anolis-spec=html title=attr-ol-type><a href=http://www.whatwg.org/html/#attr-ol-type>type</a></code> attributes of <var title="">node</var>, if any are
    set.

    <li>Let <var title="">children</var> be the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>children</a> of <var title="">node</var>.

    <li>If <var title="">node</var> has attributes, and its <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> or not an <code class=external data-anolis-spec=html title="the ol element"><a href=http://www.whatwg.org/html/#the-ol-element>ol</a></code>
    or <code class=external data-anolis-spec=html title="the ul element"><a href=http://www.whatwg.org/html/#the-ul-element>ul</a></code>, <a href=#set-the-tag-name>set the tag name</a> of <var title="">node</var> to "div".

    <li>Otherwise remove <var title="">node</var>, <a href=#preserving-its-descendants>preserving its descendants</a>.

    <li><a href=#fix-disallowed-ancestors>Fix disallowed ancestors</a> of each member of
    <var title="">children</var>.

    <li>Abort these steps.
  </ol>

  <li>If <var title="">current ancestor</var> is not an <a href=#editable>editable</a>
  <a href=#potential-indentation-element>potential indentation element</a>, abort these steps.

  <!-- At this point, we have an ancestor to split up. -->
  <li>Append <var title="">current ancestor</var> to <var title="">ancestor list</var>.

  <li>Let <var title="">original ancestor</var> be <var title="">current ancestor</var>.
  <!-- We can't outdent it yet, because we need its children to remain intact
  for the loop. -->

  <li>While <var title="">ancestor list</var> is not empty:

  <ol>
    <li>Let <var title="">current ancestor</var> be the last member of <var title="">ancestor
    list</var>.

    <li>Remove the last member from <var title="">ancestor list</var>.

    <li>Let <var title="">target</var> be the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> of <var title="">current ancestor</var>
    that is equal to either <var title="">node</var> or the last member of <var title="">ancestor
    list</var>.

    <li>If <var title="">target</var> is an <a href=#inline-node>inline node</a> that is not a
    <code class=external data-anolis-spec=html title="the br element"><a href=http://www.whatwg.org/html/#the-br-element>br</a></code>, and its <code class=external data-anolis-spec=domcore title=dom-Node-nextSibling><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-nextsibling>nextSibling</a></code> is a <code class=external data-anolis-spec=html title="the br element"><a href=http://www.whatwg.org/html/#the-br-element>br</a></code>, remove <var title="">target</var>'s
    <code class=external data-anolis-spec=domcore title=dom-Node-nextSibling><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-nextsibling>nextSibling</a></code> from its <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a>.

    <li>Let <var title="">preceding siblings</var> be the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-preceding-sibling title=concept-tree-preceding-sibling>preceding siblings</a> of
    <var title="">target</var>, and let <var title="">following siblings</var> be the
    <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-following-sibling title=concept-tree-following-sibling>following siblings</a> of <var title="">target</var>.

    <li><a href=#indent>Indent</a> <var title="">preceding siblings</var>.

    <li><a href=#indent>Indent</a> <var title="">following siblings</var>.
  </ol>

  <li><a href=#outdent>Outdent</a> <var title="">original ancestor</var>.
</ol>


<h3 id=toggling-lists><span class=secno>7.7 </span>Toggling lists</h3>

<!--
Research for insertOrderedList/insertUnorderedList: tested the following
command sequences in IE9, Firefox 4.0, Chrome 12 dev, Opera 11.10,
OpenOffice.org 3.2.1 Ubuntu package, Microsoft Office Word 2007.  The commands
"ol", "ul", "indent", "outdent" correspond in browsers to "insertOrderedList",
"insertUnorderedList", "indent", and "outdent"; in OO.org to "Numbering
On/Off", "Bullets On/Off", "Increase Indent", "Decrease Indent"; and in Word to
"Numbering", "Bullets", "Increase Indent", "Decrease Indent".

Note: OO has a bunch of extra options, like "Promote One Level", "Demote One
Level", "Promote One Level With Subpoints", "Demote One Level With Subpoints",
"Insert Unnumbered Entry", "Restart Numbering".  The regular "Increase/Decrease
Indent" commands work oddly, and I assume they're not really meant to be used
inside lists.  Thus I also tested with "Promote One Level" and "Demote One
Level".  These are denoted by OO' instead of OO.

Assume that there are style rules in effect like

ol ol { list-style-type: lower-alpha }
ol ol ol { list-style-type: lower-roman }

This is the default appearance in Word, and I set OO to something similar with
Bullets and Numbering -> Outline in the list editing toolbox.  I'm ignoring
bullet style throughout, for no particular reason.

* In an existing ordered list equivalent to <ol><li>foo<li>bar<li>baz</ol>quz:
  * Select "bar", do "ol":
    * Word/OO: Remove indent and number "2", change "3" to "2".
    * Browsers: Remove indent and number "2", change "3" to "1".
    * Spec: Same as browsers.
  * Select "bar", do "ul":
    * Word: Leave indent the same, change "2" to a bullet, change "3" to "2".
    * OO: Increase indent, change "2" to a bullet, change "3" to "2".
    * IE: Change all numbers to bullets.
    * Firefox/Chrome/Opera: Leave indent the same, change "2" to a bullet, change "3" to "1".
    * Spec: Same as Firefox/Chrome/Opera.
  * Select "bar", do "indent":
    * Word/OO'/Browsers: Increase indent, change "2" to "a", change "3" to "2".
    * OO: Increase indent, do not change any numbers.
    * Spec: Same as Word/OO'/Browsers.
  * Select "bar", do "outdent":
    * Word: Do nothing.
    * OO: Leave indent the same, de-indent "2" so it goes past the left margin (?!), do not change any numbers.
    * OO': Option grayed out.
    * Browsers: Remove indent and the number "2", change "3" to "1".
    * Spec: Same as browsers.
  * Select "quz", do "ol":
    * Word/OO/IE/Chrome: Add as fourth item to existing list, numbered "4".
    * Firefox/Opera: Create new list, number the item "1".
    * Spec: Same as OO/Word/IE/Chrome.
* In an existing ordered list equivalent to <ol><li>foo<br>bar<li>baz</ol>:
  * Select "foo", do "ol":
    * Word/OO/IE/Chrome/Opera: Remove indent from both "foo" and "bar", change "2" -> "1".
    * Firefox: Increase indent for "foo" only, add additional "a" marker after "1" and before "foo".
    * Spec: Same as Word/OO/IE/Chrome/Opera.
  * Select "foo", do "ul":
    * Word/Opera: Change "1" -> bullet, "2" -> "1".
    * OO: Increase indent for both "foo" and "bar", change "1" -> bullet, "2" -> "1".
    * IE: Change all numbers to bullets.
    * Firefox: Increase indent for "foo" only, add additional bullet marker after "1" and before "foo".
    * Chrome: Remove indent from "bar", change "1" -> bullet, "2" -> "1".
    * Spec: Same as Word/Opera.
  * Select "foo", do "indent":
    * Word: Increase indent for whole list.
    * OO: Increase indent for both "foo" and "bar".
    * OO': Increase indent for "foo", change "1" -> "a".
    * IE/Firefox non-CSS/Opera: Increase indent for both "foo" and "bar", change "1" -> "a", "2" -> "1".
    * Firefox CSS: Increase indent for "foo" only (<div style="margin-left: 40px">).
    * Chrome: Increase indent for "foo" only, add "a" before "foo", move "1" to be before "bar".
    * Spec: Same as IE/Firefox non-CSS/Opera.
  * Select "foo", do "outdent":
    * Word: Decrease indent for whole list, so it goes past the left margin.
    * OO: Decrease indent for "bar" and "1." (so "1." goes past the left margin), but not "foo".
    * OO': Option grayed out.
    * IE/Chrome/Opera: Remove indent from both "foo" and "bar", remove "1", change "2" -> "1".
    * Firefox: Do nothing.
    * Spec: Same as IE/Chrome/Opera.
  * Select "bar", do "ol":
    * Word/OO/IE/Chrome/Opera: Remove indent from both "foo" and "bar", change "2" -> "1".
    * Firefox: Increase indent for "bar" only, add "a" marker before it.
    * Spec: Same as Word/OO/IE/Chrome/Opera.
  * Select "bar", do "ul":
    * Word/Opera: Change "1" -> bullet, "2" -> "1".
    * OO: Increase indent for both "foo" and "bar", change "1" -> bullet, "2" -> "1".
    * IE: Change all numbers to bullets.
    * Firefox: Increase indent for "bar" only, add bullet marker before it.
    * Chrome: Remove indent from "foo", change "1" -> bullet and move it before "bar", change "2" -> "1".
    * Spec: Same as Word/Opera.
  * Select "bar", do "indent":
    * Word: Increase indent for whole list.
    * OO: Increase indent for both "foo" and "bar".
    * OO': Increase indent for "foo", change "1" -> "a".
    * IE/Firefox non-CSS/Opera: Increase indent for both "foo" and "bar", change "1" -> "a", "2" -> "1".
    * Firefox CSS: Increase indent for "bar" only (<div style="margin-left: 40px">).
    * Chrome: Increase indent for "bar" only, add "a" before "bar", move "bar" above "foo" (?!).
    * Spec: Same as IE/Firefox non-CSS/Opera.
  * Select "bar", do "outdent":
    * Word: Decrease indent for whole list, so it goes past the left margin.
    * OO: Decrease indent for "bar" and "1." (so "1." goes past the left margin), but not "foo".
    * OO': Option grayed out.
    * IE/Chrome/Opera: Remove indent from both "foo" and "bar", remove "1", change "2" -> "1".
    * Firefox: Do nothing.
    * Spec: Same as IE/Chrome/Opera.
* In an existing nested ordered list equivalent to <ol><li>foo<ol><li>bar<li>baz</ol><li>quz</ol>:
  * Select "bar", do "ol":
    * Word/IE/Firefox: Decrease indent, remove "a" ("bar" is aligned with "foo" with no marker of its own), change "b" -> "a".
    * OO: Remove all indent, change "b" -> "a".
    * Chrome: Decrease indent, change "a" -> "2", "b" -> "a", "2" -> "3".
    * Opera: Decrease indent, change "a" -> "2", "b" -> "a", "2" -> "4", insert extra "3" list marker before new "a".
    * Spec: Same as Chrome.
  * Select "bar", do "ul":
    * Word/Firefox/Chrome: Change "a" -> bullet, "b" -> "a".
    * OO: Increase indent, change "a" -> bullet, "b" -> "a".
    * IE: Change "a" and "b" to bullets.
    * Opera: Change "a" -> bullet, "b" -> "a", "2" -> "4", insert extra list markers "2" and "3" before new bullet and "a".
    * Spec: Same as Word/Firefox/Chrome.
  * Select "bar", do "indent":
    * Word/OO'/IE: Increase indent, change "a" -> "i", leave "b" alone.
    * OO: Increase indent, do not change numbers.
    * Firefox/Chrome/Opera: Increase indent, change "a" -> "i", "b" -> "a".
    * Spec: Same as Firefox/Chrome/Opera.
  * Select "bar", do "outdent":
    * Word/OO'/IE/Chrome: Decrease indent, change "a" -> "2", "b" -> "a", "2" -> "3".
    * OO: Leave indent the same, de-indent "a" so it goes past the left margin (?!).
    * Firefox: Decrease indent, remove "a" ("bar" is aligned with "foo" with no marker of its own), change "b" -> "a".
    * Opera: Decrease indent, change "a" -> "2", "b" -> "a", "2" -> "4", insert extra list marker "3" before new "a".
    * Spec: Same as Word/OO'/IE/Chrome.
* In existing nested lists equivalent to <ol><li>foo<ul><li>bar<li>baz</ul><li>quz</ol>:
  * Select "bar", do "ol":
    * Word: Change all bullets to numbers.  (Not letters, even though indented!)
    * OO: Decrease indent, change first bullet -> "2", "2" -> "3".
    * IE: Change all bullets to letters.
    * Firefox/Chrome: Change first bullet to "a".
    * Opera: Change first bullet -> "a", "2" -> "4", insert extra list markers "2" and "3" before new "a" and bullet.
    * Spec: Same as Firefox/Chrome.
  * Select "bar", do "ul":
    * Word/IE/Firefox: Decrease indent, remove first bullet ("bar" is aligned with "foo" with no marker of its own).
    * OO: Remove all indent, remove first bullet, leave all else the same.
    * Chrome: Decrease indent, change first bullet -> "2", "2" -> "3".
    * Opera: Decrease indent, change first bullet -> "2", "2" -> "4", insert extra list marker "3" before old bullet.
    * Spec: Same as Chrome.
  * Select "bar", do "indent":
    * Word: Increase indent, change first bullet to "i" (?!).
    * OO/OO'/Firefox/Chrome/Opera: Increase indent.
    * IE: Increase indent, change "2" -> "3" (?!?!).  (I don't see from the markup why the 2 actually changes to a 3.  The markup seems to be as other browsers.)
    * Spec: Same as OO/OO'/Firefox/Chrome/Opera.
  * Select "bar", do "outdent":
    * Word/IE/Chrome: Decrease indent, change first bullet -> "2", "2" -> "3".
    * OO: Usual crazy stuff, move bullet left but leave text alone.
    * OO': Option grayed out.  (Interesting.)
    * Firefox: Decrease indent, remove first bullet ("bar" is aligned with "foo" with no marker of its own).
    * Opera: Decrease indent, change first bullet -> "2", "2" -> "4", insert extra list marker "3" before old bullet.
    * Spec: Same as Word/IE/Chrome.
* In an existing nested ordered list equivalent to <ol><li>foo<li>bar<ol><li>baz</ol><li>quz</ol>:
  * Select "bar", do "ol":
    * Word/OO: Remove indent and "2", change "3" -> "2".
    * IE/Chrome/Opera: Remove indent and "2", decrease indent of "baz", change "2" and "3" -> "1".
    * Firefox: Increase indent, add extra "a" marker between "2" and "bar".
    * Spec: Different from all of them: remove indent and "2", change "3" -> "1".
  * Select "bar", do "ul":
    * Word: Change "2" -> bullet.
    * OO: Increase indent, change "2" -> bullet, "3" -> "2".
    * IE: Change "1", "2", "3" -> bullets (and "a" to "1").
    * Firefox: Increase indent, add extra bullet marker between "2" and "bar".
    * Chrome: Decrease indent of "baz", change "2" -> bullet, "a" and "3" -> "1".
    * Opera: Change "2" -> bullet, "a" and "3" -> "1".
    * Spec: Different from all of them: change "2" -> bullet, "3" -> "1".
  * Select "bar", do "indent":
    * Word/OO': Increase indent, change "2" -> "a", "a" -> "b", "3" -> "2".
    * OO: Increase indent (double amount, past "baz").
    * Firefox non-CSS/Opera: Increase indent of both "bar" and "baz", change "2" -> "a", "a" -> "i", "3" -> "2".
    * Firefox CSS: Increase indent.
    * Chrome: Increase indent, add "a" marker before "bar", move "2" marker to before the "a" marker of "baz".
    * Spec: Same as Word/OO'.
  * Select "bar", do "outdent":
    * Word/Firefox: Do nothing.
    * OO: Decrease indent on "2", leave "bar" alone.
    * OO': Option grayed out.
    * IE: Decrease indent of "baz", change "2" and "3" -> "1", "a" -> "2".
    * Chrome/Opera: Decrease indent of "bar" and "baz", remove "2", change "a" and "3" -> "1".
    * Spec: Different from all of them: remove indent and "2", change "3" -> "1".
* In an existing nested ordered list equivalent to <ol><li>foo<li>bar<ol><li>baz</ol>quz<li>qoz</ol>:
  * Does not appear to be possible in Word or OO.
  * Also might be impossible to actually make such a list using execCommand() in browsers.
  * Suffice it to say that there's a lot of variation.
* In an existing indented region equivalent to foo<blockquote>bar</blockquote>baz:
  * Select "bar", do "ol":
    * Word/OO/Firefox/Chrome: Increase indent, add "1".
    * IE: Increase indent, add "a".
    * Opera: Add "1" (but do not increase indent).
  * Select "foobar", do "ol":
    * Word/IE: Increase indent of both, add "1" before "foo" and "a" before
      "bar".
    * OO: Increase indent of "bar" one step, increase indent of "foo" two steps
      so it's aligned with "bar", add "1" before "foo" and "2" before "bar".
    * Firefox: Increase indent of both, add "1" before foo", add "2" before
      "bar" aligned with the "1" of "foo" (so large gap between "2" and "bar").
    * Chrome: Increase indent of "foo", add "1" before "foo" and "2" before
      "bar".
    * Opera: Mash everything together on one line.  But if you do
      <p>foo</p><blockquote>bar</blockquote><p>baz</p> instead, same as Chrome.
  * Select "foo" and do "ol", then select "bar" and do "ol":
    * Word/OO/Firefox/Opera: Different than doing both at once (often in
      exciting ways).
    * IE/Chrome: Same as doing both at once.
* <p>foo</p><blockquote><p>bar</p><p>baz</p></blockquote>
  * Select "foobar" and do "ol":
    * Word: One-item list with sublist.
    * OO/Firefox/Chrome/Opera: One two-item list, unindented.
    * IE9: Two one-item lists.
  * Select "foo", do "ol", then select "bar" and do "ol":
    * Word/OO/Chrome: One two-item list, unindented.
    * IE9/Firefox: Two one-item lists.
    * Opera: Two one-item lists, both unindented.
  * Desired behavior: One-item list with sublist in both cases.
* In an existing multi-line indented region equivalent to <blockquote>foo<br>bar<br>baz</blockquote>:
  * Select "bar", do "ol":
    * Word/OO/Firefox/Chrome: Increase indent, add "1".
    * IE: Increase indent of everything, add "a" before "foo".  If you do
      <blockquote><p>foo<p>bar<p>baz</blockquote>, same as
      Word/OO/Firefox/Chrome.
    * Opera: Don't increase indent of anything, add "1" before "bar".
* In an existing multi-line indented region equivalent to <blockquote>foo<br>bar</blockquote>baz:
  * Select "barbaz", do "ol":
    * Word: Indent both, add "a" before "bar" and "2" before "baz".
    * OO: Indent "baz", add "1" before "bar" and "2" before "baz".
    * IE: Indent everything, add "a" before "foo" and "1" before "baz".  If you
      do <blockquote><p>foo<p>bar</blockquote><p>baz, indent "bar" and "baz"
      and put "1" before each.
    * Firefox: Indent "bar" and put "1" before it, put "baz" after "bar" on the
      same line.  If you do <blockquote><p>foo<p>bar</blockquote><p>baz, same
      as Chrome.
    * Chrome: Indent "bar" once and "baz" twice, put "1" before "bar" and "2"
      before "baz".
    * Opera: Put a "1" before "bar" and move "baz" to the same line.  If you do
      <blockquote><p>foo<p>bar</blockquote><p>baz, indent "baz", put a "1"
      before "bar" and a "2" before "baz".
  * Select "bar", do "ol", then select "baz" and do "ol":
    * Word/OO/Opera: Different from if you do both together.
    * IE: Different with <br>, same with <p>.
    * Firefox: Three behaviors, depending on whether you do it in one step with
      <br>, one step with <p>, or two steps with either (same behavior
      regardless with two steps).
    * Chrome: Same behavior in all four cases.
* <blockquote>foo<ol><li>bar</ol></blockquote>baz:
  * Select "baz", do "ol":
    * Word/OO/Chrome: Add "baz" as a new item to existing list.
    * IE/Firefox/Opera: Make "baz" its own new list.
* <ul><li>foo</li><ol><li>bar</li></ol></ul>baz:
  * Select "baz", do "ol":
    * IE/Firefox/Chrome/Opera: Separate list.

Ignoring the conceptual model of HTML, which users won't understand, here's the
conceptual model I've developed for lists: text is divided up into blocks.
Each block has an indentation level and a list marker type.  The list marker
type can be either nothing, ordered, or unordered.  A list block cannot have
indentation level less than one.  Any given piece of text is part of only one
block.  A block may be visually non-contiguous, such as if a single list block
is interrupted by a further-indented block.

To find the right number (or letter) for an ordered-list block, look at the
immediately preceding block, but skip over any blocks of higher indentation
level.  If there is no immediately preceding block, or it's not an ordered-list
block, or it has a lower indentation level, the number is 1 (or a, i, etc.).
Otherwise, it's the number of the preceding block plus one.

ol/ul commands change the selected block to that list marker type, or remove
the list marker type if it's already the chosen type.  If the block has
indentation level zero, it increases to one.

indent/outdent commands change the selected block's indentation level.  If a
list block's indentation level is reduced to zero, it's converted to a regular
block.

What this means from an HTML perspective, roughly:

* A list block is the entire contents of an <li> element, ignoring any nested
  list elements or indentation elements.  A non-list block is a line box.
* Indentation level is equal to the number of ancestor elements that are either
  <li>s or indentation elements (blockquotes or indenting divs).
* To find the list marker type, go to the first ancestor that's either an <li>
  or indentation element.
* Correct numbering should automatically follow from the way <ol> works in HTML
  (which is one of the reasons I use this model).
* An ol command in an ordered-list block removes the surrounding <li>,
  migrating its contents into the parent of the <ol>.  This splits up the <ol> if
  it's not the first or last child, and wraps the contents in a new <li> if
  necessary.  If there's another list or indentation element nested in the <li>
  we're removing, it will get re-wrapped in a new <ol>, outside the
  newly-created <li>, so that it maintains its indentation.  This might cause
  the new <li> to wind up in multiple pieces, if the original block was not
  contiguous, which means the non-contiguous block is split into several blocks
  (with different numbers).
* An ol command in an unordered-list block breaks up the parent <ul> and puts a
  new <ol> in between the two pieces, moving the parent <li> into it.  If the
  <li> was the first or last child, we merge with an existing adjacent <ol> if
  possible.  All children stay as they are.
* An ol command in a non-list block with indentation zero wraps it in a new
  <ol><li>, or merges with an adjacent <ol> if possible.
* An ol command in a non-list block with nonzero indentation converts the
  parent to an <ol><li>, breaking it up if necessary.
* The ul command works similarly to ol.
* indent in a non-list block wraps in an indentation element.  In a list block,
  it wraps the <li> in an extra <ol> or <ul> as appropriate.  With merging.
  Whatever.  Let me just write the spec.
* outdent in a non-list block strips an indentation element, if one is present.
  In a list block, it breaks apart the parent <ol> or <ul> and makes the
  affected block a sibling in between the newly-split list elements.  Will
  create new <li>s, etc. etc.

Sheesh, lists are complicated.
-->
<p>To <dfn id=toggle-lists>toggle lists</dfn>, given a string <var title="">tag name</var> (either "ol"
or "ul"):

<ol>
  <li>Let <var title="">other tag name</var> be "ol" if <var title="">tag name</var> is "ul", and
  "ul" if <var title="">tag name</var> is "ol".

  <li>Let <var title="">items</var> be a list of all <code class=external data-anolis-spec=html title="the li element"><a href=http://www.whatwg.org/html/#the-li-element>li</a></code>s that are
  <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#ancestor-container title="ancestor container">ancestor containers</a> of the <a href=#active-range>active range</a>'s <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a>
  and/or <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-end title=concept-range-end>end</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a>.

  <li>For each <var title="">item</var> in <var title="">items</var>, <a href=#normalize-sublists>normalize
  sublists</a> of <var title="">item</var>.
  <!-- This overnormalizes, but it seems like the simplest solution for now.
  -->

  <li><a href=#block-extend>Block-extend</a> the <a href=#active-range>active range</a>, and let <var title="">new
  range</var> be the result.

  <li>Let <var title="">node list</var> be a list of <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>nodes</a>, initially empty.

  <li>For each <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>node</a> <var title="">node</var> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#contained>contained</a> in <var title="">new range</var>,
  if <var title="">node</var> is <a href=#editable>editable</a>; the last member of <var title="">node
  list</var> (if any) is not an <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-ancestor title=concept-tree-ancestor>ancestor</a> of <var title="">node</var>;
  <var title="">node</var> is not a <a href=#potential-indentation-element>potential indentation element</a>; and
  either <var title="">node</var> is an <code class=external data-anolis-spec=html title="the ol element"><a href=http://www.whatwg.org/html/#the-ol-element>ol</a></code> or <code class=external data-anolis-spec=html title="the ul element"><a href=http://www.whatwg.org/html/#the-ul-element>ul</a></code>, or its <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> is an <code class=external data-anolis-spec=html title="the ol element"><a href=http://www.whatwg.org/html/#the-ol-element>ol</a></code>
  or <code class=external data-anolis-spec=html title="the ul element"><a href=http://www.whatwg.org/html/#the-ul-element>ul</a></code>, or it is an <a href=#allowed-child>allowed child</a> of "li"; then append
  <var title="">node</var> to <var title="">node list</var>.
  <!--
  We exclude potential indentation elements so that selecting some random text
  and doing indent followed by insertOrderedList will have the same result as
  the reverse.  Specifically,

    <blockquote>[foo]</blockquote> ->
    <blockquote><ol><li>[foo]</li></ol></blockquote>

  per spec and Firefox 4.0 and (more or less) Chrome 12 dev.  Opera 11.10
  instead does <ol><li>foo</li></ol>, so the indentation vanishes.  IE9 does
  <ol><ol><li>foo</li></ol></ol>, but that doesn't make semantic sense and is
  different from how it would work if you reversed the commands.
  OpenOffice.org 3.2.1 (Ubuntu) and Word 2007 both agree with the spec in this
  case.
  -->

  <li>If every member of <var title="">node list</var> is equal to or the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> of
  an <a href=#html-element>HTML element</a> with <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-element-local-name title=concept-element-local-name>local name</a> <var title="">tag name</var>, and no
  member of <var title="">node list</var> is equal to or the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-ancestor title=concept-tree-ancestor>ancestor</a> of an
  <a href=#html-element>HTML element</a> with <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-element-local-name title=concept-element-local-name>local name</a> <var title="">other tag name</var>, then
  while <var title="">node list</var> is not empty:

  <ol>
    <li>Let <var title="">sublist</var> be an empty list of <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>nodes</a>.

    <li>Remove the first member from <var title="">node list</var> and append it to
    <var title="">sublist</var>.

    <li>If the first member of <var title="">sublist</var> is an <a href=#html-element>HTML
    element</a> with <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-element-local-name title=concept-element-local-name>local name</a> <var title="">tag name</var>, <a href=#outdent>outdent</a>
    it and continue this loop from the beginning.

    <li>While <var title="">node list</var> is not empty, and the first member of
    <var title="">node list</var> is the <code class=external data-anolis-spec=domcore title=dom-Node-nextSibling><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-nextsibling>nextSibling</a></code> of the last member of
    <var title="">sublist</var> and is not an <a href=#html-element>HTML element</a> with
    <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-element-local-name title=concept-element-local-name>local name</a> <var title="">tag name</var>, remove the first member from <var title="">node
    list</var> and append it to <var title="">sublist</var>.

    <li><a href=#split-the-parent>Split the parent</a> of <var title="">sublist</var>.

    <li><a href=#fix-disallowed-ancestors>Fix disallowed ancestors</a> of each member of
    <var title="">sublist</var>.
  </ol>

  <li>Otherwise, while <var title="">node list</var> is not empty:

  <ol>
    <li>Let <var title="">sublist</var> be an empty list of <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>nodes</a>.

    <li>Remove the first member from <var title="">node list</var> and append it to
    <var title="">sublist</var>.

    <li>While <var title="">node list</var> is not empty, and the first member of
    <var title="">node list</var> is the <code class=external data-anolis-spec=domcore title=dom-Node-nextSibling><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-nextsibling>nextSibling</a></code> of the last member of
    <var title="">sublist</var>, and the last member of <var title="">sublist</var> and first
    member of <var title="">node list</var> are both <a href=#inline-node title="inline node">inline
    nodes</a>, and the last member of <var title="">sublist</var> is not a <code class=external data-anolis-spec=html title="the br element"><a href=http://www.whatwg.org/html/#the-br-element>br</a></code>,
    remove the first member from <var title="">node list</var> and append it to
    <var title="">sublist</var>.

    <li>If <var title="">sublist</var> contains more than one member, <a href=#wrap>wrap</a>
    <var title="">sublist</var>, with <a href=#sibling-criteria>sibling criteria</a> matching nothing and
    <a href=#new-parent-instructions>new parent instructions</a> returning the result of calling <code class=external data-anolis-spec=domcore title=dom-Document-createElement><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-document-createelement>createElement("li")</a></code> on the
    <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#context-object>context object</a>.  Let <var title="">node</var> be the result.

    <li>Otherwise, let <var title="">node</var> be the sole member of
    <var title="">sublist</var>.

    <li>If <var title="">node</var> is an <a href=#html-element>HTML element</a> with <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-element-local-name title=concept-element-local-name>local name</a>
    <var title="">other tag name</var>:

    <ol>
      <li>Let <var title="">children</var> be the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>children</a> of <var title="">node</var>.

      <li>Remove <var title="">node</var>, <a href=#preserving-its-descendants>preserving its descendants</a>.

      <li><a href=#wrap>Wrap</a> <var title="">children</var>, with <a href=#sibling-criteria>sibling
      criteria</a> matching any <a href=#html-element>HTML element</a> with <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-element-local-name title=concept-element-local-name>local name</a>
      <var title="">tag name</var> and <a href=#new-parent-instructions>new parent
      instructions</a> returning the result of calling <code class=external data-anolis-spec=domcore title=dom-Document-createElement><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-document-createelement>createElement(<var title="">tag
      name</var>)</a></code> on the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#context-object>context object</a>.  Let <var title="">node</var> be the
      result.

      <li>Prepend the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-descendant title=concept-tree-descendant>descendants</a> of <var title="">node</var> that are <a href=#html-element title="HTML element">HTML elements</a> with <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-element-local-name title=concept-element-local-name>local name</a> <var title="">other
      tag name</var> (if any) to <var title="">node list</var>.

      <li>Continue from the beginning of this loop.

      <div class=XXX>
      <p>This does the wrong thing for input like

      <ul>
        <li>foo</li>
        <li>[bar</li>
        <ul><li>baz</ul>
        <li>quz]</li>
      </ul>

      <p>which becomes

      <ul><li>foo</ul>
      <ol><li>[bar</ol>
      <ul><ol><li>baz</ol></ul>
      <ol><li>quz]</ol>

      <p>when we want

      <ul><li>foo</ul>
      <ol>
        <li>[bar</li>
        <ol><li>baz</ol>
        <li>quz]</li>
      </ol>
      </div>
    </ol>

    <li>If <var title="">node</var> is a <code class=external data-anolis-spec=html title="the p element"><a href=http://www.whatwg.org/html/#the-p-element>p</a></code> or <code class=external data-anolis-spec=html title="the div element"><a href=http://www.whatwg.org/html/#the-div-element>div</a></code>, <a href=#set-the-tag-name>set the tag name</a>
    of <var title="">node</var> to "li", and let <var title="">node</var> be the result.

    <li>If <var title="">node</var> is the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> of an <a href=#html-element>HTML element</a>
    with <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-element-local-name title=concept-element-local-name>local name</a> <var title="">other tag name</var>:

    <ol>
      <li><a href=#split-the-parent>Split the parent</a> of the one-<a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>node</a> list consisting of
      <var title="">node</var>.

      <li><a href=#wrap>Wrap</a> the one-<a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>node</a> list consisting of
      <var title="">node</var>, with <a href=#sibling-criteria>sibling criteria</a> matching any
      <a href=#html-element>HTML element</a> with <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-element-local-name title=concept-element-local-name>local name</a> <var title="">tag name</var>,
      and with <a href=#new-parent-instructions>new parent instructions</a> returning the result of
      calling <code class=external data-anolis-spec=domcore title=dom-Document-createElement><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-document-createelement>createElement(<var title="">tag
      name</var>)</a></code> on the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#context-object>context object</a>.

      <li>Prepend the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-descendant title=concept-tree-descendant>descendants</a> of <var title="">node</var> that are <a href=#html-element title="HTML element">HTML elements</a> with <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-element-local-name title=concept-element-local-name>local name</a> <var title="">other
      tag name</var> (if any) to <var title="">node list</var>.

      <li>Continue from the beginning of this loop.
    </ol>

    <li>If <var title="">node</var> is equal to or the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> of an <a href=#html-element>HTML
    element</a> with <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-element-local-name title=concept-element-local-name>local name</a> <var title="">tag name</var>, prepend the
    <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-descendant title=concept-tree-descendant>descendants</a> of <var title="">node</var> that are <a href=#html-element title="HTML element">HTML
    elements</a> with <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-element-local-name title=concept-element-local-name>local name</a> <var title="">other tag name</var> (if any) to
    <var title="">node list</var> and continue from the beginning of this loop.

    <li>If <var title="">node</var> is not an <code class=external data-anolis-spec=html title="the li element"><a href=http://www.whatwg.org/html/#the-li-element>li</a></code>, <a href=#wrap>wrap</a> the one-<a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>node</a>
    list consisting of <var title="">node</var>, with <a href=#sibling-criteria>sibling criteria</a>
    matching nothing and <a href=#new-parent-instructions>new parent instructions</a> returning
    the result of calling <code class=external data-anolis-spec=domcore title=dom-Document-createElement><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-document-createelement>createElement("li")</a></code> on the
    <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#context-object>context object</a>.  Set <var title="">node</var> to the result.

    <li><a href=#wrap>Wrap</a> the one-<a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>node</a> list consisting of <var title="">node</var>,
    with the <a href=#sibling-criteria>sibling criteria</a> matching any <a href=#html-element>HTML
    element</a> with <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-element-local-name title=concept-element-local-name>local name</a> <var title="">tag name</var>, and the <a href=#new-parent-instructions>new
    parent instructions</a> being the following:

    <ol>
      <li>If the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> of <var title="">node</var> is not an <a href=#editable>editable</a>
      <a href=#indentation-element>indentation element</a>, or the <code class=external data-anolis-spec=domcore title=dom-Node-previousSibling><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-previoussibling>previousSibling</a></code> of the
      <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> of <var title="">node</var> is not an <a href=#editable>editable</a> <a href=#html-element>HTML
      element</a> with <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-element-local-name title=concept-element-local-name>local name</a> <var title="">tag name</var>, call <code class=external data-anolis-spec=domcore title=dom-Document-createElement><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-document-createelement>createElement(<var title="">tag
      name</var>)</a></code> on the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#context-object>context object</a> and return the result.
      Otherwise:

      <li>Let <var title="">list</var> be the <code class=external data-anolis-spec=domcore title=dom-Node-previousSibling><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-previoussibling>previousSibling</a></code> of the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> of
      <var title="">node</var>.

      <li><a href=#normalize-sublists>Normalize sublists</a> of <var title="">list</var>'s last <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a>.

      <li>If <var title="">list</var>'s last <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> is not an <a href=#editable>editable</a>
      <a href=#html-element>HTML element</a> with <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-element-local-name title=concept-element-local-name>local name</a> <var title="">tag name</var>, call
      <code class=external data-anolis-spec=domcore title=dom-Document-createElement><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-document-createelement>createElement(<var title="">tag
      name</var>)</a></code> on the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#context-object>context object</a>, and append the result as the
      last <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> of <var title="">list</var>.

      <li>Return the last <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> of <var title="">list</var>.
    </ol>

    <li><a href=#fix-disallowed-ancestors>Fix disallowed ancestors</a> of the previous step's result.
  </ol>
</ol>


<h3 id=justifying-the-selection><span class=secno>7.8 </span>Justifying the selection</h3>

<!--
There are two basic ways it works: using the align attribute, and using CSS
text-align.  IE9 and Opera 11.11 use only the align attribute, Chrome 13 dev
uses only text-align, and Firefox 5.0a2 varies based on styleWithCSS.  The two
ways produce entirely different results, which is a real problem, so I don't
think Firefox's approach is tenable.  text-align is more valid, and for typical
contenteditable cases it works the same.  But for cases where you have
fixed-width blocks, like tables or just divs with a width set, it behaves
differently, and in those cases the align attribute is more useful.
-->

<p>To <dfn id=justify-the-selection>justify the selection</dfn> to a string <var title="">alignment</var> (either
"center", "justify", "left", or "right"):

<p class=XXX>text-align doesn't behave as expected if there are descendant
blocks with non-100% width, like tables.  The align attribute behaves a lot
more nicely in such cases, but it's not valid.  Not clear what to do.  For now
I've stuck with text-align, just because the cases where it misbehaves can't be
created by any sequence of stock execCommand()s that I know of, but this needs
more careful consideration.  Gecko in CSS mode seems to special-case tables,
adding auto margins to the table element to get it to align correctly.

<p class=XXX>Need to do something along the lines of pushing down values here
(although no browser does).  In fact, it's very likely this can be rewritten in
terms of the inline formatting command primitives, but it's not clear if it
would be worth the added complexity.

<ol>
  <li><a href=#block-extend>Block-extend</a> the <a href=#active-range>active range</a>, and let <var title="">new
  range</var> be the result.

  <li>Let <var title="">element list</var> be a list of all <a href=#editable>editable</a>
  <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element>Element</a></code>s <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#contained>contained</a> in <var title="">new range</var> that either has an
  attribute in the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#html-namespace>HTML namespace</a> whose <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-attr-local-name title=concept-attr-local-name>local name</a> is "align", or has
  a <code class=external data-anolis-spec=html title="the style attribute"><a href=http://www.whatwg.org/html/#the-style-attribute>style</a></code> attribute that sets "text-align", or is a <code class=external data-anolis-spec=html><a href=http://www.whatwg.org/html/#center>center</a></code>.
  <!-- No browser actually removes center, but it makes sense to do so. -->

  <li>For each <var title="">element</var> in <var title="">element list</var>:

  <ol>
    <li>If <var title="">element</var> has an attribute in the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#html-namespace>HTML namespace</a> whose
    <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-attr-local-name title=concept-attr-local-name>local name</a> is "align", remove that attribute.

    <li>Unset the CSS property "text-align" on <var title="">element</var>, if it's set
    by a <code class=external data-anolis-spec=html title="the style attribute"><a href=http://www.whatwg.org/html/#the-style-attribute>style</a></code> attribute.

    <li>If <var title="">element</var> is a <code class=external data-anolis-spec=html title="the div element"><a href=http://www.whatwg.org/html/#the-div-element>div</a></code> or <code class=external data-anolis-spec=html><a href=http://www.whatwg.org/html/#center>center</a></code> with no attributes, remove it,
    <a href=#preserving-its-descendants>preserving its descendants</a>.

    <li>If <var title="">element</var> is a <code class=external data-anolis-spec=html><a href=http://www.whatwg.org/html/#center>center</a></code>
    with one or more attributes, <a href=#set-the-tag-name>set the tag name</a> of
    <var title="">element</var> to "div".
  </ol>

  <li><a href=#block-extend>Block-extend</a> the <a href=#active-range>active range</a>, and let <var title="">new
  range</var> be the result.
  <!-- This could theoretically be necessary, like if it converted "<div
  align=right>foo</div>bar" to "foo<br>bar".  Now we need to select "foo<br>",
  nor just "foo". -->

  <li>Let <var title="">node list</var> be a list of <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>nodes</a>, initially empty.

  <li>For each <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>node</a> <var title="">node</var> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#contained>contained</a> in <var title="">new range</var>,
  append <var title="">node</var> to <var title="">node list</var> if the last member of
  <var title="">node list</var> (if any) is not an <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-ancestor title=concept-tree-ancestor>ancestor</a> of <var title="">node</var>;
  <var title="">node</var> is <a href=#editable>editable</a>; and either <var title="">node</var> is an
  <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element>Element</a></code> and the CSS property "text-align" does not compute to
  <var title="">alignment</var> on it, or it is not an <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element>Element</a></code>, but its <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a>
  is an <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element>Element</a></code>, and the CSS property "text-align" does not compute to
  <var title="">alignment</var> on its <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a>.
  <!-- Of tested browsers, only Chrome 13 dev seems to not apply the alignment
  to nodes that are already aligned.  Even then, it does apply it if the
  alignment is just inherited from the root. -->

  <p class=XXX>What does this imply when text-align is "start" or "end"?  As
  with lots of CSS stuff in this spec, needs to be clarified.

  <li>While <var title="">node list</var> is not empty:

  <ol>
    <li>Let <var title="">sublist</var> be a list of <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>nodes</a>, initially empty.

    <li>Remove the first member of <var title="">node list</var> and append it to
    <var title="">sublist</var>.

    <li>While <var title="">node list</var> is not empty, and the first member of
    <var title="">node list</var> is the <code class=external data-anolis-spec=domcore title=dom-Node-nextSibling><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-nextsibling>nextSibling</a></code> of the last member of
    <var title="">sublist</var>, remove the first member of <var title="">node list</var> and
    append it to <var title="">sublist</var>.

    <li><a href=#wrap>Wrap</a> <var title="">sublist</var>.  <a href=#sibling-criteria>Sibling criteria</a>
    match any <code class=external data-anolis-spec=html title="the div element"><a href=http://www.whatwg.org/html/#the-div-element>div</a></code> that has one or both of the following two attributes, and
    no other attributes:

    <ul>
      <li>An <code class=external data-anolis-spec=html title=attr-div-align><a href=http://www.whatwg.org/html/#attr-div-align>align</a></code>
      attribute whose <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-attr-value title=concept-attr-value>value</a> is an <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#ascii-case-insensitive>ASCII
      case-insensitive</a> match for <var title="">alignment</var>.

      <li>A <code class=external data-anolis-spec=html title="the style attribute"><a href=http://www.whatwg.org/html/#the-style-attribute>style</a></code> attribute which sets exactly one CSS property (including
      unrecognized or invalid attributes), which is "text-align", which is set
      to <var title="">alignment</var>.
    </ul>

    <a href=#new-parent-instructions>New parent instructions</a> are to call <code class=external data-anolis-spec=domcore title=dom-Document-createElement><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-document-createelement>createElement("div")</a></code> on
    the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#context-object>context object</a>, then set its CSS property "text-align" to
    <var title="">alignment</var>, and return the result.
    <!-- As for inline formatting, I only ever create new elements, and don't
    ever modify existing ones.  This doesn't match how any browser behaves
    in this case, but for inline formatting it matches everyone but Gecko's CSS
    mode. -->
  </ol>
</ol>


<h3 id=the-delete-command><span class=secno>7.9 </span><dfn>The <code title="">delete</code> command</dfn></h3>

<p><a href=#action>Action</a>:

<ol>
  <li>If the <a href=#active-range>active range</a> is not <code class=external data-anolis-spec=domrange title=dom-Range-collapsed><a href=http://html5.org/specs/dom-range.html#dom-range-collapsed>collapsed</a></code>, <a href=#delete-the-contents>delete the contents</a>
  of the <a href=#active-range>active range</a> and abort these steps.

  <p class=XXX>Maybe we sometimes want to do the following even if it isn't
  collapsed?  WebKit seems to do some normalization on the range before
  deciding whether it's collapsed, and that sounds like a good idea.

  <li>Let <var title="">node</var> and <var title="">offset</var> be the <a href=#active-range>active
  range</a>'s <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a> and <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-offset title=concept-boundary-point-offset>offset</a>.

  <!-- First go up as high as possible within the current block, then drill
  down to the lowest possible level, in the hopes that we'll wind up at the end
  of a text node, or maybe in a br or hr. -->
  <li>Repeat the following steps:

  <ol>
    <!--
    If there's an invisible node somewhere, Firefox 5.0a2 removes that node and
    then stops, so each backspace removes one invisible node.  All others
    remove the invisible node and then continue on looking for something
    visible to remove.  The spec follows the latter behavior, since it makes
    more sense to the user.  Of course, the definition of "invisible node" is
    not necessarily anything like the spec's.
    -->
    <li>If <var title="">offset</var> is zero and <var title="">node</var>'s <code class=external data-anolis-spec=domcore title=dom-Node-previousSibling><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-previoussibling>previousSibling</a></code>
    is an <a href=#editable>editable</a> <a href=#invisible-node>invisible node</a>, remove
    <var title="">node</var>'s <code class=external data-anolis-spec=domcore title=dom-Node-previousSibling><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-previoussibling>previousSibling</a></code> from its <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a>.

    <li>Otherwise, if <var title="">node</var> has a <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> with <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-indexof title=concept-indexof>index</a>
    <var title="">offset</var> &minus; 1 and that <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> is an <a href=#editable>editable</a>
    <a href=#invisible-node>invisible node</a>, remove that <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> from <var title="">node</var>,
    then subtract one from <var title="">offset</var>.

    <li>Otherwise, if <var title="">offset</var> is zero and <var title="">node</var> is not a
    <a href=#prohibited-paragraph-child>prohibited paragraph child</a>, or if <var title="">node</var> is an
    <a href=#invisible-node>invisible node</a>, set <var title="">offset</var> to the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-indexof title=concept-indexof>index</a> of
    <var title="">node</var>, then set <var title="">node</var> to its <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a>.

    <li>Otherwise, if <var title="">node</var> has a <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> with <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-indexof title=concept-indexof>index</a>
    <var title="">offset</var> &minus; 1 and that <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> is not a <a href=#prohibited-paragraph-child>prohibited
    paragraph child</a> or a <code class=external data-anolis-spec=html title="the br element"><a href=http://www.whatwg.org/html/#the-br-element>br</a></code> or an <code class=external data-anolis-spec=html title="the img element"><a href=http://www.whatwg.org/html/#the-img-element>img</a></code>, set <var title="">node</var> to
    that <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a>, then set <var title="">offset</var> to the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-node-length title=concept-node-length>length</a> of
    <var title="">node</var>.

    <li>Otherwise, break from this loop.
  </ol>

  <!--
  At this point, node cannot be an invisible node.  There are three cases:

  1) offset is zero and node is a prohibited paragraph child.  Then we'll
  usually merge with the previous block if one exists.

  2) offset is not zero, node is not a prohibited paragraph child, and node
  does not have a child with index offset - 1.  The only way this is possible
  is if node has a length greater than zero but no children, which implies it's
  a text or comment or PI.  Comments and PIs are invisible nodes, so it must be
  a text node.  We delete the previous character.

  3) offset is not zero, and the child of node with index offset - 1 is a
  prohibited paragraph child or a br or an img.  Then we'll usually merge the
  offsetth child of node with the last descendant of the offset - 1st.
  -->

  <li>If <var title="">node</var> is a <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#text>Text</a></code> node and <var title="">offset</var> is not zero,
  call <code class=external data-anolis-spec=domrange title=dom-Selection-collapse><a href=http://html5.org/specs/dom-range.html#dom-selection-collapse>collapse(<var title="">node</var>, <var title="">offset</var>)</a></code> on the <code class=external data-anolis-spec=domrange><a href=http://html5.org/specs/dom-range.html#selection>Selection</a></code>.
  Then <a href=#delete-the-contents>delete the contents</a> of the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range title=concept-range>range</a> with <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a>
  (<var title="">node</var>, <var title="">offset</var> &minus; 1) and <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-end title=concept-range-end>end</a>
  (<var title="">node</var>, <var title="">offset</var>) and abort these steps.

  <!-- At the time of this writing, this should be impossible. -->
  <li>If <var title="">node</var> is not a <a href=#prohibited-paragraph-child>prohibited paragraph child</a>,
  abort these steps.

  <li>If <var title="">node</var> has a <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> with <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-indexof title=concept-indexof>index</a> <var title="">offset</var>
  &minus; 1 and that <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> is a <code class=external data-anolis-spec=html title="the br element"><a href=http://www.whatwg.org/html/#the-br-element>br</a></code> or <code class=external data-anolis-spec=html title="the hr element"><a href=http://www.whatwg.org/html/#the-hr-element>hr</a></code> or <code class=external data-anolis-spec=html title="the img element"><a href=http://www.whatwg.org/html/#the-img-element>img</a></code>, call
  <code class=external data-anolis-spec=domrange title=dom-Selection-collapse><a href=http://html5.org/specs/dom-range.html#dom-selection-collapse>collapse(<var title="">node</var>, <var title="">offset</var>)</a></code> on the <code class=external data-anolis-spec=domrange><a href=http://html5.org/specs/dom-range.html#selection>Selection</a></code>.
  Then <a href=#delete-the-contents>delete the contents</a> of the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range title=concept-range>range</a> with <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a>
  (<var title="">node</var>, <var title="">offset</var> &minus; 1) and <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-end title=concept-range-end>end</a>
  (<var title="">node</var>, <var title="">offset</var>) and abort these steps.

  <!--
  If we're at the beginning of a list, we want to outdent the first list item.
  This doesn't actually match anyone or anything.  Word 2007 and OpenOffice.org
  3.2.1 Ubuntu just remove the list marker, which is weird and doesn't map well
  to HTML.  Browsers tend to just merge with the preceding block, which isn't
  expected.
  -->
  <li>If <var title="">node</var> is an <code class=external data-anolis-spec=html title="the li element"><a href=http://www.whatwg.org/html/#the-li-element>li</a></code> or <code class=external data-anolis-spec=html title="the dt element"><a href=http://www.whatwg.org/html/#the-dt-element>dt</a></code> or <code class=external data-anolis-spec=html title="the dd element"><a href=http://www.whatwg.org/html/#the-dd-element>dd</a></code> and is the first
  <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> of its <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a>:

  <ol>
    <li>Let <var title="">items</var> be a list of all <code class=external data-anolis-spec=html title="the li element"><a href=http://www.whatwg.org/html/#the-li-element>li</a></code>s that are
    <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-ancestor title=concept-tree-ancestor>ancestors</a> of <var title="">node</var>.

    <li><a href=#normalize-sublists>Normalize sublists</a> of each <var title="">item</var> in
    <var title="">items</var>.

    <li><a href=#split-the-parent>Split the parent</a> of the one-<a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>node</a> list consisting of
    <var title="">node</var>.

    <li><a href=#fix-disallowed-ancestors>Fix disallowed ancestors</a> of <var title="">node</var>.

    <li>Abort these steps.
  </ol>

  <!-- By this point, we're almost certainly going to merge something, and the
  only question is what. -->
  <li>Let <var title="">start node</var> equal <var title="">node</var> and let <var title="">start
  offset</var> equal <var title="">offset</var>.

  <li>While <var title="">start offset</var> is zero, set <var title="">start offset</var> to the
  <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-indexof title=concept-indexof>index</a> of <var title="">start node</var> and then set <var title="">start node</var> to its
  <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a>.

  <p class=XXX>The node at index start offset &minus; 1 might be an invisible
  node.

  <!--
  At the beginning of an indented block, outdent it, similar to a list item.
  Browsers don't do this, word processors do.
  -->
  <li>If <var title="">offset</var> is zero, and <var title="">node</var> has an
  <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#ancestor-container title="ancestor container">ancestor container</a> that is both a <a href=#potential-indentation-element>potential indentation
  element</a> and a <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-descendant title=concept-tree-descendant>descendant</a> of <var title="">start node</var>:

  <p class=XXX>This copy-pastes from the outdent command action.  I'm also not
  totally sure it's correct.

  <ol>
    <li><a href=#block-extend>Block-extend</a> the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range title=concept-range>range</a> whose <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> and
    <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-end title=concept-range-end>end</a> are both (<var title="">node</var>, 0), and let <var title="">new range</var> be
    the result.

    <li>Let <var title="">node list</var> be a list of <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>nodes</a>, initially empty.

    <li>For each <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>node</a> <var title="">current node</var> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#contained>contained</a> in <var title="">new
    range</var>, append <var title="">current node</var> to <var title="">node list</var> if the
    last member of <var title="">node list</var> (if any) is not an <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-ancestor title=concept-tree-ancestor>ancestor</a> of
    <var title="">current node</var>, and <var title="">current node</var> is
    <a href=#editable>editable</a> but has no <a href=#editable>editable</a> <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-descendant title=concept-tree-descendant>descendants</a>.

    <li><a href=#outdent>Outdent</a> each <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>node</a> in <var title="">node list</var>.

    <li>Abort these steps.
  </ol>

  <!--
  This is to avoid stripping a line break from

    foo<br><br><table><tr><td>[]bar</table>

  and similarly for <hr>.  We should just do nothing here.
  -->
  <li>If the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> of <var title="">start node</var> with <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-indexof title=concept-indexof>index</a> <var title="">start
  offset</var> is a <code class=external data-anolis-spec=html title="the table element"><a href=http://www.whatwg.org/html/#the-table-element>table</a></code>, abort these steps.

  <!--
  If you try backspacing into a table, select it.  This doesn't match any
  browser; it matches the recommendation of the "behavior when typing in
  contentEditable elements" document.  The idea is that then you can delete it
  with a second backspace.
  -->
  <li>If <var title="">start node</var> has a <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> with <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-indexof title=concept-indexof>index</a> <var title="">start
  offset</var> &minus; 1, and that <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> is a <code class=external data-anolis-spec=html title="the table element"><a href=http://www.whatwg.org/html/#the-table-element>table</a></code>:

  <ol>
    <li>Call <code class=external data-anolis-spec=domrange title=dom-Selection-collapse><a href=http://html5.org/specs/dom-range.html#dom-selection-collapse>collapse(<var title="">start node</var>, <var title="">start offset</var>
    &minus; 1)</a></code> on the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#context-object>context object</a>'s <code class=external data-anolis-spec=domrange><a href=http://html5.org/specs/dom-range.html#selection>Selection</a></code>.

    <li>Call <code class=external data-anolis-spec=domrange title=dom-Selection-extend><a href=http://html5.org/specs/dom-range.html#dom-selection-extend>extend(<var title="">start node</var>, <var title="">start offset</var>)</a></code> on the
    <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#context-object>context object</a>'s <code class=external data-anolis-spec=domrange><a href=http://html5.org/specs/dom-range.html#selection>Selection</a></code>.

    <li>Abort these steps.
  </ol>

  <!--
  Special case:

    <p>foo</p><br><p>[]bar</p>
    -> <p>foo</p><p>[]bar</p>

  and likewise for <hr>.  But with <img> we merge like in other cases:

    <p>foo</p><img><p>[]bar</p>
    -> <p>foo</p><img>[]bar.

  Browsers don't do this consistently.  Firefox 5.0a2 doesn't seem to do it at
  all.
  -->
  <li>If <var title="">offset</var> is zero; and either the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> of <var title="">start
  node</var> with <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-indexof title=concept-indexof>index</a> <var title="">start offset</var> minus one is an <code class=external data-anolis-spec=html title="the hr element"><a href=http://www.whatwg.org/html/#the-hr-element>hr</a></code>, or
  the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> is a <code class=external data-anolis-spec=html title="the br element"><a href=http://www.whatwg.org/html/#the-br-element>br</a></code> whose <code class=external data-anolis-spec=domcore title=dom-Node-previousSibling><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-previoussibling>previousSibling</a></code> is either a <code class=external data-anolis-spec=html title="the br element"><a href=http://www.whatwg.org/html/#the-br-element>br</a></code> or not
  an <a href=#inline-node>inline node</a>:

  <ol>
    <li>Call <code class=external data-anolis-spec=domrange title=dom-Selection-collapse><a href=http://html5.org/specs/dom-range.html#dom-selection-collapse>collapse(<var title="">node</var>, <var title="">offset</var>)</a></code> on the
    <code class=external data-anolis-spec=domrange><a href=http://html5.org/specs/dom-range.html#selection>Selection</a></code>.

    <li><a href=#delete-the-contents>Delete the contents</a> of the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range title=concept-range>range</a> with <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a>
    (<var title="">start node</var>, <var title="">start offset</var> &minus; 1) and <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-end title=concept-range-end>end</a>
    (<var title="">start node</var>, <var title="">start offset</var>).

    <li>Abort these steps.
  </ol>

  <!--
  If you try backspacing out of a list item, merge it with the previous item,
  but add a line break.  Then you have to backspace again if you really want
  them to be on the same line.  This matches Word 2007 and OpenOffice.org 3.2.1
  Ubuntu, and also matches "behavior when typing in contentEditable elements",
  but does not match any browser.

  Note that this behavior is quite different from what happens if you actually
  select the linebreak in between the two lines.  In that case, the blocks are
  merged as normal.

  Also note that hitting backspace twice will merge with the previous item.
  This matches OO.org, but Word will outdent the item on subsequent backspaces.
  Word's behavior doesn't fit well with the way lists work in HTML, and we
  probably don't want it.
  -->
  <li>If the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> of <var title="">start node</var> with <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-indexof title=concept-indexof>index</a> <var title="">start
  offset</var> is an <code class=external data-anolis-spec=html title="the li element"><a href=http://www.whatwg.org/html/#the-li-element>li</a></code> or <code class=external data-anolis-spec=html title="the dt element"><a href=http://www.whatwg.org/html/#the-dt-element>dt</a></code> or <code class=external data-anolis-spec=html title="the dd element"><a href=http://www.whatwg.org/html/#the-dd-element>dd</a></code>, and that <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a>'s
  <code class=external data-anolis-spec=domcore title=dom-Node-firstChild><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-firstchild>firstChild</a></code> is an <a href=#inline-node>inline node</a>, and <var title="">start offset</var> is
  not zero:

  <ol>
    <li>Let <var title="">previous item</var> be the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> of <var title="">start node</var>
    with <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-indexof title=concept-indexof>index</a> <var title="">start offset</var> minus one.

    <!-- If the last child is already a br, we only need to append one extra
    br.  Otherwise we need to append two, since the first will do nothing. -->
    <li>If <var title="">previous item</var>'s <code class=external data-anolis-spec=domcore title=dom-Node-lastChild><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-lastchild>lastChild</a></code> is an <a href=#inline-node>inline
    node</a> other than a <code class=external data-anolis-spec=html title="the br element"><a href=http://www.whatwg.org/html/#the-br-element>br</a></code>, call <code class=external data-anolis-spec=domcore title=dom-Document-createElement><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-document-createelement>createElement("br")</a></code> on the
    <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#context-object>context object</a> and append the result as the last <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> of
    <var title="">previous item</var>.

    <li>If <var title="">previous item</var>'s <code class=external data-anolis-spec=domcore title=dom-Node-lastChild><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-lastchild>lastChild</a></code> is an <a href=#inline-node>inline
    node</a>, call <code class=external data-anolis-spec=domcore title=dom-Document-createElement><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-document-createelement>createElement("br")</a></code> on the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#context-object>context object</a> and
    append the result as the last <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> of <var title="">previous item</var>.
  </ol>

  <!--
  When merging adjacent list items, make sure we only merge the items
  themselves, not any block children.  We want <li><p>foo<li><p>bar to become
  <li><p>foo<p>bar, not <li><p>foo<br>bar or <li><p>foobar.
  -->
  <li>If the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> of <var title="">start node</var> with <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-indexof title=concept-indexof>index</a> <var title="">start
  offset</var> is an <code class=external data-anolis-spec=html title="the li element"><a href=http://www.whatwg.org/html/#the-li-element>li</a></code> or <code class=external data-anolis-spec=html title="the dt element"><a href=http://www.whatwg.org/html/#the-dt-element>dt</a></code> or <code class=external data-anolis-spec=html title="the dd element"><a href=http://www.whatwg.org/html/#the-dd-element>dd</a></code>, and its <code class=external data-anolis-spec=domcore title=dom-Node-previousSibling><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-previoussibling>previousSibling</a></code> is
  also an <code class=external data-anolis-spec=html title="the li element"><a href=http://www.whatwg.org/html/#the-li-element>li</a></code> or <code class=external data-anolis-spec=html title="the dt element"><a href=http://www.whatwg.org/html/#the-dt-element>dt</a></code> or <code class=external data-anolis-spec=html title="the dd element"><a href=http://www.whatwg.org/html/#the-dd-element>dd</a></code>, set <var title="">start node</var> to its
  <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> with <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-indexof title=concept-indexof>index</a> <var title="">start offset</var> &minus; 1, then set
  <var title="">start offset</var> to <var title="">start node</var>'s <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-node-length title=concept-node-length>length</a>, then set
  <var title="">node</var> to <var title="">start node</var>'s <code class=external data-anolis-spec=domcore title=dom-Node-nextSibling><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-nextsibling>nextSibling</a></code>, then set
  <var title="">offset</var> to 0.

  <!-- General block-merging case. -->
  <li>Otherwise, while <var title="">start node</var> has a <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> with <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-indexof title=concept-indexof>index</a>
  <var title="">start offset</var> minus one, set <var title="">start node</var> to that
  <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a>, then set <var title="">start offset</var> to the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-node-length title=concept-node-length>length</a> of
  <var title="">start node</var>.

  <li><a href=#delete-the-contents>Delete the contents</a> of the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range title=concept-range>range</a> with <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a>
  (<var title="">start node</var>, <var title="">start offset</var>) and <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-end title=concept-range-end>end</a>
  (<var title="">node</var>, <var title="">offset</var>).
</ol>


<h3 id=the-formatblock-command><span class=secno>7.10 </span><dfn>The <code title="">formatBlock</code> command</dfn></h3>

<!--
Tested browser versions: IE9, Firefox 4.0, Chrome 13 dev, Opera 11.10.

Firefox and Chrome will replace a <blockquote> by a <p> or other given tag.  IE
and Opera will nest the <p> inside instead.  The latter makes more sense, given
that a) we don't support formatBlock with <blockquote> and b) <blockquote>s are
logically different, since they can contain many lines.

Firefox will not convert other tags like <p> to <div>, it will only wrap
unwrapped lines in a <div>.  Firefox also won't replace <div> by things like
<p>, it will nest the <p> inside.  The spec follows other browsers.

If you try to convert a <dt> to a <div> or <p> or such, Firefox breaks out of
the <dl> entirely, leaving ...<dt><br></dt></dl>.  Chrome will convert a <dt>
or <dd> to the given element, leaving a <div> or <p> or such as the child of a
<dl>.  I follow IE/Opera, which only affect the contents of <dt>/<dd> (Firefox
behaves this way for <dd> as well, just not <dt>).  This means you can get
invalid DOMs like <dt><p>foo<p></dt>, but they can be serialized as text/html,
so I'm not too fussy.

When it comes to <li>, IE/Opera behave like with <dt>/<dd>, which is how I
behave too.  Firefox apparently refuses to do anything.  Chrome tries to wrap
the parent list element, breaking it up if only some of the children are
selected; this produces unserializable DOMs if you're wrapping with <p>.

When you're converting multiple blocks at once, Chrome replaces them all by one
block with <br> stuck in, like <p>foo</p><p>bar</p> -> <div>foo<br>bar</div>.
It wipes out intervening block containers too in some cases.  This might make
sense for <address>/<h*>/<pre>, but other browsers don't do it.
-->

<p><a href=#action>Action</a>:

<ol>
  <li>If <var title="">value</var> begins with a "&lt;" character and ends with a "&gt;"
  character, remove the first and last characters from it.
  <!-- IE9 requires the brackets.  If they're not provided, it does nothing.
  -->

  <li>Let <var title="">value</var> be <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#converted-to-lowercase>converted to
  lowercase</a>.

  <li>If <var title="">value</var> is not "address", "div", "h1", "h2", "h3", "h4",
  "h5", "h6", "p", or "pre", then do nothing and abort these steps.

  <p class=XXX>We should support dt and dd here, since they make sense here and
  there's no other way to create them.
  <!--
  Opera 11.10 throws NOT_SUPPORTED_ERR for bad elements, all other tested
  browsers ignore the input.  Testing in IE9, Firefox 4.0, Chrome 13 dev, and
  Opera 11.10, supported elements seem to be:

  Everyone: address, div, h*, p, pre
  Everyone but IE: blockquote
  Everyone but Opera: dd, dt
  IE only: ol, ul
  Firefox and Chrome only: dl
  Chrome only: article, aside, footer, header, hgroup, nav, section

  HTML5 as of May 2011 supports: address, article, aside, blockquote, div,
  footer, h*, header, hgroup, nav, p, pre, section, which exactly matches
  Chrome except minus dd/dt/dl.

  See mailing list discussion on the subject:
  http://lists.whatwg.org/htdig.cgi/whatwg-whatwg.org/2011-May/031765.html
  -->

  <li><a href=#block-extend>Block-extend</a> the <a href=#active-range>active range</a>, and let <var title="">new
  range</var> be the result.

  <li>Let <var title="">original node list</var> be an empty list of <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>nodes</a>.

  <li>For each <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>node</a> <var title="">node</var> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#contained>contained</a> in <var title="">new range</var>,
  append <var title="">node</var> to <var title="">original node list</var> if it is
  <a href=#editable>editable</a>, the last member of <var title="">original node list</var> (if
  any) is not an <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-ancestor title=concept-tree-ancestor>ancestor</a> of <var title="">node</var>, and <var title="">node</var> is either
  a <a href=#non-list-single-line-container>non-list single-line container</a> or an <a href=#allowed-child>allowed
  child</a> of "p".

  <li>For each <var title="">node</var> in <var title="">original node list</var>, while either
  <var title="">node</var> is a <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-descendant title=concept-tree-descendant>descendant</a> of an <a href=#editable>editable</a> <a href=#html-element>HTML
  element</a> <a href=#in-the-same-editing-host>in the same editing host</a> with <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-element-local-name title=concept-element-local-name>local name</a>
  "address", "h1", "h2", "h3", "h4", "h5", "h6", "p", or "pre"; or
  <var title="">node</var>'s <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> is not null, and "p" is not an <a href=#allowed-child>allowed
  child</a> of <var title="">node</var>'s <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a>: <a href=#split-the-parent>split the parent</a>
  of the one-<a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>node</a> list consisting of <var title="">node</var>.

  <div class=XXX>
  <p>This is needed so we don't get things like p nested inside address, and
  instead convert part of the multi-line address into a p.  But div can contain
  any of these things, so we don't break that apart ever, which is bad.  It
  means if you have

  </p><xmp><div>foo<br>bar</div></xmp>

  <p>then formatBlocking "foo" then "bar" as p has different results from doing
  both at once.  Maybe we should split divs as well, but only if they're the
  parent of the node we're dealing with?  Or just split divs always, and hope
  the "in the same editing host" thing handles it?
  </div>

  <li>Let <var title="">node list</var> be a list of <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>nodes</a>, initially empty.

  <li>For each <var title="">node</var> in <var title="">original node list</var>, <a href=#fix-prohibited-paragraph-descendants>fix
  prohibited paragraph descendants</a> of <var title="">node</var>, and append the
  resulting <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>nodes</a> to <var title="">node list</var>.

  <!--
  We have two different behaviors, one for div and p and one for everything
  else.  The basic difference is that for div and p, we assume that it should
  be one line per element, while for other elements, we put in multiple lines
  separated by <br>.  So if you do formatBlock to p on

    <div>foo</div><div>bar</div> or
    foo<br>bar

  you get

    <p>foo</p><p>bar</p>

  but formatBlock to h1 will get you

    <h1>foo<br>bar</h1>.

  IE9 will just change the elements as they are, so it gives
  <p>foo</p><p>bar</p> and <h1>foo</h1><h1>bar</h1> for
  <div>foo</div><div>bar</div>, but <p>foo<br>bar</p> and <h1>foo<br>bar</h1>
  for foo<br>bar.  This is unreasonable, but the two possible inputs here look
  identical to the user and might have been produced by identical user input.

  Firefox 5.0a2 will give results like <p>foo</p><p>bar</p> or
  <h1>foo</h1><h1>bar</h1> no matter what (modulo oddities in its handling of
  divs).  Opera 11.10 is similar, except it leaves a trailing <br> in the first
  element.

  Chrome 13 dev will give results like <p>foo<br>bar</p> or <h1>foo<br>bar</h1>
  no matter what.

  The specced behavior is a compromise between the existing behaviors,
  predicated on the fact that <h1>foo</h1><h1>bar</h1> almost never makes
  sense, and <p>foo<br>bar</p> isn't usually what's wanted either.
  -->
  <li>If <var title="">value</var> is "div" or "p", then while <var title="">node list</var> is
  not empty:

  <ol>
    <li>If the first member of <var title="">node list</var> is a <a href=#non-list-single-line-container>non-list
    single-line container</a>, <a href=#set-the-tag-name>set the tag name</a> of the first
    member of <var title="">node list</var> to <var title="">value</var>, then remove the first
    member from <var title="">node list</var> and continue this loop from the beginning.

    <li>Let <var title="">sublist</var> be an empty list of <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>nodes</a>.

    <li>Remove the first member of <var title="">node list</var> and append it to
    <var title="">sublist</var>.

    <li>While <var title="">node list</var> is not empty, and the first member of
    <var title="">node list</var> is the <code class=external data-anolis-spec=domcore title=dom-Node-nextSibling><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-nextsibling>nextSibling</a></code> of the last member of
    <var title="">sublist</var>, and the first member of <var title="">node list</var> is not a
    <a href=#non-list-single-line-container>non-list single-line container</a>, and the last member of
    <var title="">sublist</var> is not a <code class=external data-anolis-spec=html title="the br element"><a href=http://www.whatwg.org/html/#the-br-element>br</a></code>, remove the first member of <var title="">node
    list</var> and append it to <var title="">sublist</var>.

    <li><a href=#wrap>Wrap</a> <var title="">sublist</var>, with <a href=#sibling-criteria>sibling
    criteria</a> matching nothing and <a href=#new-parent-instructions>new parent instructions</a>
    returning the result of running <code class=external data-anolis-spec=domcore title=dom-Document-createElement><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-document-createelement>createElement(<var title="">value</var>)</a></code> on the
    <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#context-object>context object</a>.
  </ol>

  <li>Otherwise, while <var title="">node list</var> is not empty:

  <ol>
    <li>If the first member of <var title="">node list</var> is a <a href=#non-list-single-line-container>non-list
    single-line container</a>:

    <ol>
      <li>Let <var title="">sublist</var> be the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>children</a> of the first member of
      <var title="">node list</var>.

      <li>Remove the first member of <var title="">node list</var> from its <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a>,
      <a href=#preserving-its-descendants>preserving its descendants</a>.

      <li>Remove the first member from <var title="">node list</var>.
    </ol>

    <li>Otherwise:

    <ol>
      <li>Let <var title="">sublist</var> be an empty list of <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>nodes</a>.

      <li>Remove the first member of <var title="">node list</var> and append it to
      <var title="">sublist</var>.

      <li>While <var title="">node list</var> is not empty, and the first member of
      <var title="">node list</var> is the <code class=external data-anolis-spec=domcore title=dom-Node-nextSibling><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-nextsibling>nextSibling</a></code> of the last member of
      <var title="">sublist</var>, and the first member of <var title="">node list</var> is not a
      <a href=#non-list-single-line-container>non-list single-line container</a>, and the last member of
      <var title="">sublist</var> is not a <code class=external data-anolis-spec=html title="the br element"><a href=http://www.whatwg.org/html/#the-br-element>br</a></code>, remove the first member of <var title="">node
      list</var> and append it to <var title="">sublist</var>.
    </ol>

    <li><a href=#wrap>Wrap</a> <var title="">sublist</var>, with <a href=#sibling-criteria>sibling
    criteria</a> matching any <a href=#html-element>HTML element</a> with <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-element-local-name title=concept-element-local-name>local name</a>
    <var title="">value</var> and no attributes, and <a href=#new-parent-instructions>new parent
    instructions</a> returning the result of running
    <code class=external data-anolis-spec=domcore title=dom-Document-createElement><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-document-createelement>createElement(<var title="">value</var>)</a></code> on the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#context-object>context object</a>.
  </ol>
</ol>


<h3 id=the-forwarddelete-command><span class=secno>7.11 </span><dfn>The <code title="">forwardDelete</code> command</dfn></h3>

<p><a href=#action>Action</a>:
<!-- Copy-pasted from delete, see there for comments. -->

<ol>
  <li>If the <a href=#active-range>active range</a> is not <code class=external data-anolis-spec=domrange title=dom-Range-collapsed><a href=http://html5.org/specs/dom-range.html#dom-range-collapsed>collapsed</a></code>, <a href=#delete-the-contents>delete the contents</a>
  of the <a href=#active-range>active range</a> and abort these steps.

  <p class=XXX>Maybe we sometimes want to do the following even if it isn't
  collapsed?  WebKit seems to do some normalization on the range before
  deciding whether it's collapsed, and that sounds like a good idea.

  <li>Let <var title="">node</var> and <var title="">offset</var> be the <a href=#active-range>active
  range</a>'s <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a> and <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-offset title=concept-boundary-point-offset>offset</a>.

  <li>Repeat the following steps:

  <ol>
    <li>If <var title="">offset</var> is the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-node-length title=concept-node-length>length</a> of <var title="">node</var> and
    <var title="">node</var>'s <code class=external data-anolis-spec=domcore title=dom-Node-nextSibling><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-nextsibling>nextSibling</a></code> is an <a href=#editable>editable</a>
    <a href=#invisible-node>invisible node</a>, remove <var title="">node</var>'s <code class=external data-anolis-spec=domcore title=dom-Node-nextSibling><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-nextsibling>nextSibling</a></code> from
    its <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a>.

    <li>Otherwise, if <var title="">node</var> has a <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> with <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-indexof title=concept-indexof>index</a>
    <var title="">offset</var> and that <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> is an <a href=#editable>editable</a>
    <a href=#invisible-node>invisible node</a>, remove that <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> from <var title="">node</var>.

    <!-- We need these extra two steps in forwardDelete, relative to delete, to
    skip over line breaks at the end of blocks. -->
    <li>Otherwise, if <var title="">offset</var> is one less than <var title="">node</var>'s
    <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-node-length title=concept-node-length>length</a>, and <var title="">node</var> is a <a href=#prohibited-paragraph-child>prohibited paragraph
    child</a> whose last <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> is a <code class=external data-anolis-spec=html title="the br element"><a href=http://www.whatwg.org/html/#the-br-element>br</a></code>, add one to
    <var title="">offset</var>.

    <li>Otherwise, if <var title="">node</var> has a <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> with <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-indexof title=concept-indexof>index</a>
    <var title="">offset</var> + 1, and its <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> of <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-indexof title=concept-indexof>index</a> <var title="">offset</var> is
    a <code class=external data-anolis-spec=html title="the br element"><a href=http://www.whatwg.org/html/#the-br-element>br</a></code>, and its <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> of <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-indexof title=concept-indexof>index</a> <var title="">offset</var> + 1 is a
    <a href=#prohibited-paragraph-child>prohibited paragraph child</a>, add one to <var title="">offset</var>.

    <div class=XXX>
    <p>These two steps don't correctly handle things like

    </p><xmp><p>foo<span><br></span></p></xmp>

    <p>For that matter, nor do most cases where we deal with line breaks like
    this.  Should add a bunch of tests for this and change stuff so we pass.
    </div>

    <li>Otherwise, if <var title="">offset</var> is the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-node-length title=concept-node-length>length</a> of
    <var title="">node</var> and <var title="">node</var> is not a <a href=#prohibited-paragraph-child>prohibited paragraph
    child</a>, or if <var title="">node</var> is an <a href=#invisible-node>invisible node</a>, set
    <var title="">offset</var> to one plus the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-indexof title=concept-indexof>index</a> of <var title="">node</var>, then set
    <var title="">node</var> to its <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a>.

    <li>Otherwise, if <var title="">node</var> has a <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> with <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-indexof title=concept-indexof>index</a>
    <var title="">offset</var> and that <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> is not a <a href=#prohibited-paragraph-child>prohibited paragraph
    child</a> or a <code class=external data-anolis-spec=html title="the br element"><a href=http://www.whatwg.org/html/#the-br-element>br</a></code> or an <code class=external data-anolis-spec=html title="the img element"><a href=http://www.whatwg.org/html/#the-img-element>img</a></code>, set <var title="">node</var> to that
    <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a>, then set <var title="">offset</var> to zero.

    <li>Otherwise, break from this loop.
  </ol>

  <li>If <var title="">node</var> is a <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#text>Text</a></code> node and <var title="">offset</var> is not
  <var title="">node</var>'s <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-node-length title=concept-node-length>length</a>, call <code class=external data-anolis-spec=domrange title=dom-Selection-collapse><a href=http://html5.org/specs/dom-range.html#dom-selection-collapse>collapse(<var title="">node</var>,
  <var title="">offset</var>)</a></code> on the <code class=external data-anolis-spec=domrange><a href=http://html5.org/specs/dom-range.html#selection>Selection</a></code>.  Then <a href=#delete-the-contents>delete the
  contents</a> of the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range title=concept-range>range</a> with <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> (<var title="">node</var>,
  <var title="">offset</var>) and <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-end title=concept-range-end>end</a> (<var title="">node</var>, <var title="">offset</var> + 1)
  and abort these steps.

  <p class=XXX>This is wrong for combining diacritics.  It can result in a
  diacritic on the next letter being added to the previous one when the letter
  is deleted.  Worse, it places the cursor between a letter and its diacritic.

  <li>If <var title="">node</var> is not a <a href=#prohibited-paragraph-child>prohibited paragraph child</a>,
  abort these steps.

  <li>If <var title="">node</var> has a <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> with <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-indexof title=concept-indexof>index</a> <var title="">offset</var> and
  that <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> is a <code class=external data-anolis-spec=html title="the br element"><a href=http://www.whatwg.org/html/#the-br-element>br</a></code> or <code class=external data-anolis-spec=html title="the hr element"><a href=http://www.whatwg.org/html/#the-hr-element>hr</a></code> or <code class=external data-anolis-spec=html title="the img element"><a href=http://www.whatwg.org/html/#the-img-element>img</a></code>, call
  <code class=external data-anolis-spec=domrange title=dom-Selection-collapse><a href=http://html5.org/specs/dom-range.html#dom-selection-collapse>collapse(<var title="">node</var>, <var title="">offset</var>)</a></code> on the <code class=external data-anolis-spec=domrange><a href=http://html5.org/specs/dom-range.html#selection>Selection</a></code>.
  Then <a href=#delete-the-contents>delete the contents</a> of the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range title=concept-range>range</a> with <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a>
  (<var title="">node</var>, <var title="">offset</var>) and <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-end title=concept-range-end>end</a> (<var title="">node</var>,
  <var title="">offset</var> + 1) and abort these steps.

  <!-- No special list-item behavior for forwardDelete. -->

  <li>Let <var title="">end node</var> equal <var title="">node</var> and let <var title="">end
  offset</var> equal <var title="">offset</var>.

  <li>While <var title="">end offset</var> is the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-node-length title=concept-node-length>length</a> of <var title="">end node</var>, set
  <var title="">end offset</var> to one plus the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-indexof title=concept-indexof>index</a> of <var title="">end node</var> and
  then set <var title="">end node</var> to its <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a>.

  <p class=XXX>The node at index end offset might be an invisible node.

  <!-- No special indentation element behavior for forwardDelete. -->

  <li>If the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> of <var title="">end node</var> with <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-indexof title=concept-indexof>index</a> <var title="">end
  offset</var> minus one is a <code class=external data-anolis-spec=html title="the table element"><a href=http://www.whatwg.org/html/#the-table-element>table</a></code>, abort these steps.

  <li>If the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> of <var title="">end node</var> with <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-indexof title=concept-indexof>index</a> <var title="">end
  offset</var> is a <code class=external data-anolis-spec=html title="the table element"><a href=http://www.whatwg.org/html/#the-table-element>table</a></code>:

  <ol>
    <li>Call <code class=external data-anolis-spec=domrange title=dom-Selection-collapse><a href=http://html5.org/specs/dom-range.html#dom-selection-collapse>collapse(<var title="">end node</var>, <var title="">end offset</var>)</a></code> on the
    <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#context-object>context object</a>'s <code class=external data-anolis-spec=domrange><a href=http://html5.org/specs/dom-range.html#selection>Selection</a></code>.

    <li>Call <code class=external data-anolis-spec=domrange title=dom-Selection-extend><a href=http://html5.org/specs/dom-range.html#dom-selection-extend>extend(<var title="">end node</var>, <var title="">end offset</var> + 1)</a></code> on the
    <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#context-object>context object</a>'s <code class=external data-anolis-spec=domrange><a href=http://html5.org/specs/dom-range.html#selection>Selection</a></code>.

    <li>Abort these steps.
  </ol>

  <li>If <var title="">offset</var> is the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-node-length title=concept-node-length>length</a> of <var title="">node</var>, and the
  <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> of <var title="">end node</var> with <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-indexof title=concept-indexof>index</a> <var title="">end offset</var> is an
  <code class=external data-anolis-spec=html title="the hr element"><a href=http://www.whatwg.org/html/#the-hr-element>hr</a></code> or <code class=external data-anolis-spec=html title="the br element"><a href=http://www.whatwg.org/html/#the-br-element>br</a></code>:
  <!-- Note, any br will do here: a br immediately after a block is always
  significant. -->

  <ol>
    <li>Call <code class=external data-anolis-spec=domrange title=dom-Selection-collapse><a href=http://html5.org/specs/dom-range.html#dom-selection-collapse>collapse(<var title="">node</var>, <var title="">offset</var>)</a></code> on the
    <code class=external data-anolis-spec=domrange><a href=http://html5.org/specs/dom-range.html#selection>Selection</a></code>.

    <li><a href=#delete-the-contents>Delete the contents</a> of the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range title=concept-range>range</a> with <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-end title=concept-range-end>end</a>
    (<var title="">end node</var>, <var title="">end offset</var>) and <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-end title=concept-range-end>end</a> (<var title="">end
    node</var>, <var title="">end offset</var> + 1).

    <li>Abort these steps.
  </ol>

  <!-- No special list-item behavior for forwardDelete. -->

  <li>While <var title="">end node</var> has a <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> with <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-indexof title=concept-indexof>index</a> <var title="">end
  offset</var>, set <var title="">end node</var> to that <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> and set <var title="">end
  offset</var> to zero.

  <li><a href=#delete-the-contents>Delete the contents</a> of the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range title=concept-range>range</a> with <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a>
  (<var title="">node</var>, <var title="">offset</var>) and <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-end title=concept-range-end>end</a> (<var title="">end node</var>,
  <var title="">end offset</var>).
</ol>


<h3 id=the-indent-command><span class=secno>7.12 </span><dfn>The <code title="">indent</code> command</dfn></h3>

<!--
IE9: Outputs <blockquote style="margin-right: 0px" dir="ltr">, or when
  surrounding RTL blocks, <blockquote style="margin-left: 0px" dir="rtl">.  The
  direction seems to go by the end of the selection.  The presence of the dir
  attribute means that any contents that were inheriting a different dir from
  an ancestor get their direction changed as a side effect, but if they
  actually have the opposite dir specified, they won't appear to be indented.
  It doesn't reset top or bottom margins on the blockquote, so it adds them.
  If it's not wrapping a block element, like if it's only wrapping up until a
  <br>, it adds a <p>.
Firefox 4.0: In styleWithCSS mode, adds style="margin-left: 40px" to the
  appropriate block container (or margin-right if it's RTL).  If there's no
  appropriate block container, adds a div.  If multiple blocks are affected, it
  goes by the direction of the block whose style it's changing, which winds up
  being wrong for descendants with different direction.  In non-styleWithCSS
  mode, uses <blockquote>, so it indents on both sides and also adds top/bottom
  margins.
Chrome 12 dev: Outputs <blockquote class="webkit-indent-blockquote"
  style="margin: 0 0 0 40px; border: none; padding: 0px"> in both modes for
  both LTR and RTL (which is broken for RTL, since it indents only on the
  left).
Opera 11.00: Outputs <blockquote>, so it indents on both sides and on the
  top/bottom.

For repeated indentation, everyone except Opera that outputs <blockquote>s just
puts them at the outermost possible location, which works well.  Opera puts
them in the innermost position, which is broken, because it will even put them
inside <p> (which will not round-trip through text/html serialization).

Gecko in CSS mode messes up by adding margins even to things like <blockquote>
that already have margins from CSS rules, instead of nesting a div, so it
doesn't actually increase the indentation.  However, if an element has an
explicit left margin (assuming LTR), it will increase the margin to 80px, so it
works with WebKit's blockquotes.


We have two strategies for handling directionality: always indent on both sides
(Firefox non-CSS, Opera) or try to figure out heuristically which side we want
(IE, Firefox CSS).  The latter approach is only possible by adding extra markup
and complexity, so for now we'll take the easy way out and go with just
indenting on both sides.


This reasoning doesn't discuss lists.  For research on lists, see the comment
for insertOrderedList.  List handling is more complicated and I wound up
differing from all browsers in lots of ways.
-->

<p><a href=#action>Action</a>:

<p class=XXX>Handle corner cases: endpoints are detached, documents, document
fragments, html/body, head or things in head . . .

<p class=XXX>Does not handle cases where block-extending the selection leaves
it collapsed, like <code title="">&lt;p&gt;foo&lt;/p&gt;{}&lt;p&gt;bar&lt;/p&gt;</code>.
However, it's not clear if any such selection can be generated by the user:
browsers don't normally let you put the cursor in weird places like that.

<ol>
  <li>Let <var title="">items</var> be a list of all <code class=external data-anolis-spec=html title="the li element"><a href=http://www.whatwg.org/html/#the-li-element>li</a></code>s that are
  <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#ancestor-container title="ancestor container">ancestor containers</a> of the <a href=#active-range>active range</a>'s <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a>
  and/or <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-end title=concept-range-end>end</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a>.

  <li>For each <var title="">item</var> in <var title="">items</var>, <a href=#normalize-sublists>normalize
  sublists</a> of <var title="">item</var>.
  <!-- This overnormalizes, but it seems like the simplest solution for now.
  -->

  <li><a href=#block-extend>Block-extend</a> the <a href=#active-range>active range</a>, and let <var title="">new
  range</var> be the result.

  <li>Let <var title="">node list</var> be a list of <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>nodes</a>, initially empty.

  <li>For each <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>node</a> <var title="">node</var> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#contained>contained</a> in <var title="">new range</var>,
  if <var title="">node</var> is <a href=#editable>editable</a> and is an <a href=#allowed-child>allowed
  child</a> of "div" or "ol" and if the last member of <var title="">node list</var>
  (if any) is not an <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-ancestor title=concept-tree-ancestor>ancestor</a> of <var title="">node</var>, append <var title="">node</var> to
  <var title="">node list</var>.

  <li>If the first member of <var title="">node list</var> is an <code class=external data-anolis-spec=html title="the li element"><a href=http://www.whatwg.org/html/#the-li-element>li</a></code> whose <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a>
  is an <code class=external data-anolis-spec=html title="the ol element"><a href=http://www.whatwg.org/html/#the-ol-element>ol</a></code> or <code class=external data-anolis-spec=html title="the ul element"><a href=http://www.whatwg.org/html/#the-ul-element>ul</a></code>, and its <code class=external data-anolis-spec=domcore title=dom-Node-previousSibling><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-previoussibling>previousSibling</a></code> is an <code class=external data-anolis-spec=html title="the li element"><a href=http://www.whatwg.org/html/#the-li-element>li</a></code> as well,
  <a href=#normalize-sublists>normalize sublists</a> of its <code class=external data-anolis-spec=domcore title=dom-Node-previousSibling><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-previoussibling>previousSibling</a></code>.
  <!-- Otherwise the last child of the previous sibling might be a list, which
  the li wouldn't get appended to. -->

  <li>While <var title="">node list</var> is not empty:

  <ol>
    <li>Let <var title="">sublist</var> be a list of <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>nodes</a>, initially empty.

    <li>Remove the first member of <var title="">node list</var> and append it to
    <var title="">sublist</var>.

    <li>While the first member of <var title="">node list</var> is the <code class=external data-anolis-spec=domcore title=dom-Node-nextSibling><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-nextsibling>nextSibling</a></code>
    of the last member of <var title="">sublist</var>, remove the first member of
    <var title="">node list</var> and append it to <var title="">sublist</var>.

    <li><a href=#indent>Indent</a> <var title="">sublist</var>.
  </ol>
</ol>


<h3 id=the-inserthtml-command><span class=secno>7.13 </span><dfn>The <code title="">insertHTML</code> command</dfn></h3>

<!--
Not supported by IE9.  Handling of disallowed children is interesting:

Firefox 5.0a2: Will allow <dt> inside <dt> (doesn't serialize).  If you try
inserting dir/ol/ul inside an existing dir/ol/ul, it will strip the list
element and leave only the li's, so inserting <ul><li>abc</ul> into
<ol><li>f[o]o</ol> creates <ol><li>f<li>abc<li>o</ol>.  <dt>/<dd>/<li> that
don't descend from a list will be left alone, not converted to <p>.  Empty
elements seem not to be inserted.  <li> will get put inside <p>, which breaks
serialization.  Nothing is allowed inside <xmp>, not even text.

Chrome 13 dev: Inserting a <p> into a <p> or <li> or such will remove the child
<p>, adding its contents to the parent instead.  Adding an <li> or <hr> as the
child of a <p> works, as does an <a> inside an <a>, <h2> inside <h1>, <li>
inside <li>, <nobr> inside <nobr>, <b> inside <xmp>, etc. (all unserializable).
But <dt> and <dd> seem to get converted to their contents like <p>.
<ol><li>abc</ol> inside <ol><li>f[o]o</ol> becomes
<ol><li>f<li>abc<li><li>o</ol>, interestingly (note the empty <li>).  I don't
understand how it works, but it doesn't seem to make much sense.

Opera 11.11: Seems to do almost no validity or serialization checks, except
that it prevents <a> inside <a>, <nobr> inside <nobr>, and block elements
inside inline elements.  Interestingly, most of the places where it's
non-serializable per HTML parsing are actually serializable in Opera's own
parser.
-->

<p class=XXX>What happens to unpaired surrogates in the value?  They could make
round-tripping through a character encoding change impossible.

<p><a href=#action>Action</a>:

<ol>
  <li><a href=#delete-the-contents>Delete the contents</a> of the <a href=#active-range>active range</a>.
  <!-- Chrome 14 dev and Opera 11.11 do this even if the value is empty.
  Firefox 5.0a2 throws an exception. -->

  <li>Let <var title="">frag</var> be the result of calling <code class=external data-anolis-spec=domps title=dom-Range-createContextualFragment><a href=http://html5.org/specs/dom-parsing.html#dom-range-createcontextualfragment>createContextualFragment(<var title="">value</var>)</a></code>
  on the <a href=#active-range>active range</a>.

  <p class=XXX>This has some interesting consequences.  For instance, table
  cells and similar will just vanish if they're not in an appropriate place;
  and inside a script or style or xmp or such, the argument will effectively be
  HTML-escaped before use.  Some of these consequences might be undesirable.

  <li>Let <var title="">last child</var> be the <code class=external data-anolis-spec=domcore title=dom-Node-lastChild><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-lastchild>lastChild</a></code> of <var title="">frag</var>.

  <li>If <var title="">last child</var> is null, abort these steps.
  <!-- Firefox 5.0a2 also seems to not add empty elements like <b></b>, but
  Chrome 13 dev and Opera 11.11 do. -->

  <li>Let <var title="">descendants</var> be all <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-descendant title=concept-tree-descendant>descendants</a> of <var title="">frag</var>.

  <li>If the <a href=#active-range>active range</a>'s <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a> is a <a href=#prohibited-paragraph-child>prohibited
  paragraph child</a> whose sole <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> is a <code class=external data-anolis-spec=html title="the br element"><a href=http://www.whatwg.org/html/#the-br-element>br</a></code>, and its
  <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-offset title=concept-boundary-point-offset>offset</a> is 0, remove its <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a>'s <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> from it.
  <!--
  This is so we don't get something like
    <div>[foo]</div>
    -> <div>{}<br></div>
    -> <div><p>Some HTML{}</p><br></div>
  with an extra bogus line break at the end.
  -->

  <li>Call <code class=external data-anolis-spec=domrange title=dom-Range-insertNode><a href=http://html5.org/specs/dom-range.html#dom-range-insertnode>insertNode(<var title="">frag</var>)</a></code> on the <a href=#active-range>active range</a>.

  <li>Set the <a href=#active-range>active range</a>'s <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> and <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-end title=concept-range-end>end</a> to
  (<var title="">last child</var>, <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-node-length title=concept-node-length>length</a> of <var title="">last child</var>).
  <!-- Need to do this before fixing disallowed ancestors, since otherwise the
  last child might have been removed (e.g., it's an li). -->

  <li><a href=#fix-disallowed-ancestors>Fix disallowed ancestors</a> of each member of
  <var title="">descendants</var>.
  <!-- We want to fix all descendants, not just children.  Consider
  <div><li>foo</li></div>, for example. -->
</ol>


<h3 id=the-insertimage-command><span class=secno>7.14 </span><dfn>The <code title="">insertImage</code> command</dfn></h3>

<p><a href=#action>Action</a>:

<ol>
  <li>If <var title="">value</var> is the empty string, abort these steps and do
  nothing.
  <!-- Similar logic to createLink, except even more compelling, since an HTML
  document linking to itself as an image is just silly.  In fact, the current
  HTML spec instructs UAs to not even try displaying the image, and just fail
  immediately if the URL is empty.  Firefox 4b11 bails out on an empty string,
  but the other three browsers I tested stick in the <img> anyway. -->

  <li>Let <var title="">range</var> be the <a href=#active-range>active range</a>.

  <li><a href=#delete-the-contents>Delete the contents</a> of <var title="">range</var>.

  <li>If <var title="">range</var>'s <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a> is a <a href=#prohibited-paragraph-child>prohibited paragraph
  child</a> whose sole <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> is a <code class=external data-anolis-spec=html title="the br element"><a href=http://www.whatwg.org/html/#the-br-element>br</a></code>, and its <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-offset title=concept-boundary-point-offset>offset</a> is 0,
  remove its <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a>'s <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> from it.
  <!-- Same logic as with insertHTML. -->

  <li>Let <var title="">img</var> be the result of calling <code class=external data-anolis-spec=domcore title=dom-Document-createElement><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-document-createelement>createElement("img")</a></code> on
  the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#context-object>context object</a>.

  <li>Run <code class=external data-anolis-spec=domcore title=dom-Element-setAttribute><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-element-setattribute>setAttribute("src", <var title="">value</var>)</a></code> on <var title="">img</var>.
  <!-- No alt text, so it's probably invalid.  This matches all browsers. -->

  <li>Run <code class=external data-anolis-spec=domrange title=dom-Range-insertNode><a href=http://html5.org/specs/dom-range.html#dom-range-insertnode>insertNode(<var title="">img</var>)</a></code> on <var title="">range</var>.
  <!--
  This winds up putting it at the original start point of the active range, as
  currently specced.  This matches IE9 and Firefox 5.0a2.  Chrome 13 dev puts
  it at the end point, and Opera 11.11 puts it in between (where the range
  would collapse if you called deleteContents()).
  -->

  <li>Let <var title="">selection</var> be the result of calling <code class=external data-anolis-spec=domrange title=dom-Document-getSelection><a href=http://html5.org/specs/dom-range.html#dom-document-getselection>getSelection()</a></code> on the
  <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#context-object>context object</a>.

  <li>Run <code class=external data-anolis-spec=domrange title=dom-Selection-collapse><a href=http://html5.org/specs/dom-range.html#dom-selection-collapse>collapse()</a></code> on <var title="">selection</var>, with first argument equal
  to the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> of <var title="">img</var> and the second argument equal to one plus
  the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-indexof title=concept-indexof>index</a> of <var title="">img</var>.
</ol>


<h3 id=the-inserthorizontalrule-command><span class=secno>7.15 </span><dfn>The <code title="">insertHorizontalRule</code> command</dfn></h3>

<p><a href=#action>Action</a>:

<!-- You'd think interop here would be simple, right?  Nope: we have three
different behaviors across four browsers.  Opera 11.00 is the only one that
acts more or less like the spec.  IE9 and Chrome 12 dev treat the value as an
id, which is weird and probably useless, so I don't do it.  Firefox 4.0
produces <hr size=2 width=100%> instead of <hr>, which is also weird and almost
definitely useless, so I don't do it.  Then you have the varying behavior in
splitting up parents to ensure validity . . . -->
<ol>
  <li>Let <var title="">range</var> be the <a href=#active-range>active range</a>.

  <li>While <var title="">range</var>'s <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-offset title=concept-boundary-point-offset>offset</a> is 0 and its <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a>'s
  <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> is not null, set <var title="">range</var>'s <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> to (<a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a>
  of <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a>, <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-indexof title=concept-indexof>index</a> of <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a>).

  <li>While <var title="">range</var>'s <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-end title=concept-range-end>end</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-offset title=concept-boundary-point-offset>offset</a> is the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-node-length title=concept-node-length>length</a> of its
  <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-end title=concept-range-end>end</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a>, and its <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-end title=concept-range-end>end</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a>'s <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> is not null, set
  <var title="">range</var>'s <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-end title=concept-range-end>end</a> to (<a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> of <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-end title=concept-range-end>end</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a>, 1 + <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-indexof title=concept-indexof>index</a>
  of <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a>).

  <li>Run <code class=external data-anolis-spec=domrange title=dom-Range-deleteContents><a href=http://html5.org/specs/dom-range.html#dom-range-deletecontents>deleteContents()</a></code> on <var title="">range</var>.

  <p class=XXX>This might blow up non-contenteditable stuff.

  <li>Let <var title="">hr</var> be the result of calling <code class=external data-anolis-spec=domcore title=dom-Document-createElement><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-document-createelement>createElement("hr")</a></code> on the
  <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#context-object>context object</a>.

  <li>Run <code class=external data-anolis-spec=domrange title=dom-Range-insertNode><a href=http://html5.org/specs/dom-range.html#dom-range-insertnode>insertNode(<var title="">hr</var>)</a></code> on
  <var title="">range</var>.

  <li><a href=#fix-disallowed-ancestors>Fix disallowed ancestors</a> of <var title="">hr</var>.
  <!--
  IE9 and Chrome 13 dev seem to never break up any ancestors, which can lead to
  unserializable DOMs like <hr> inside <p>.  Opera 11.11 seems to always break
  up parents going all the way up to the contenteditable root, even ones like
  <div> that can contain <hr>.  Firefox 5.0a2 acts the most sensibly: it only
  breaks up things like <p> or <b> that shouldn't contain <hr>.  The spec goes
  with Firefox here (although the list of what to break up isn't precisely
  identical).
  -->

  <li>Let <var title="">selection</var> be the result of running <code class=external data-anolis-spec=domrange title=dom-Document-getSelection><a href=http://html5.org/specs/dom-range.html#dom-document-getselection>getSelection()</a></code> on the
  <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#context-object>context object</a>.

  <li>Run <code class=external data-anolis-spec=domrange title=dom-Selection-collapse><a href=http://html5.org/specs/dom-range.html#dom-selection-collapse>collapse()</a></code> on <var title="">selection</var>, with
  first argument equal to the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> of <var title="">hr</var> and the second
  argument equal to one plus the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-indexof title=concept-indexof>index</a> of <var title="">hr</var>.
</ol>


<h3 id=the-insertlinebreak-command><span class=secno>7.16 </span><dfn>The <code title="">insertLineBreak</code> command</dfn></h3>

<p><a href=#action>Action</a>:

<!--
Only implemented in WebKit (Chrome 14 dev).  Other tests are entirely manual.
There's a surprisingly large amount of interop.

IE9 is tripped up by <xmp>, and also often doesn't add an extra <br> when the
one it just inserted is extraneous.

Firefox 6.0a2 doesn't notice if you're trying to put the <br> in a bad place,
which can result in unserializable DOMs.

Chrome 14 dev inserts a literal linebreak for pre and xmp and maybe other
similar elements.  This doesn't seem very useful, so I don't bother.

Opera 11.11 isn't heedful of <xmp>, and treats <pre> somewhat oddly.
-->

<ol>
  <li><a href=#delete-the-contents>Delete the contents</a> of the <a href=#active-range>active range</a>.

  <li>If the <a href=#active-range>active range</a>'s <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a> is an <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element>Element</a></code>, and
  "br" is not an <a href=#allowed-child>allowed child</a> of it, abort these steps.
  <!-- script, xmp, table, . . . -->

  <li>If the <a href=#active-range>active range</a>'s <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a> is not an <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element>Element</a></code>,
  and "br" is not an <a href=#allowed-child>allowed child</a> of the <a href=#active-range>active
  range</a>'s <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a>'s <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a>, abort these steps.

  <!-- We don't want to call insertNode at the start or end of a text node,
  because that will leave an empty text node. -->
  <li>If the <a href=#active-range>active range</a>'s <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a> is a <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#text>Text</a></code> node and
  its <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-offset title=concept-boundary-point-offset>offset</a> is zero, set the <a href=#active-range>active range</a>'s
  <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> and <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-end title=concept-range-end>end</a> to (<a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> of <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a>, <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-indexof title=concept-indexof>index</a> of
  <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a>).

  <li>If the <a href=#active-range>active range</a>'s <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a> is a <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#text>Text</a></code> node and
  its <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-offset title=concept-boundary-point-offset>offset</a> is the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-node-length title=concept-node-length>length</a> of its <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a>, set the
  <a href=#active-range>active range</a>'s <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> and <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-end title=concept-range-end>end</a> to (<a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> of
  <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a>, 1 + <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-indexof title=concept-indexof>index</a> of <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a>).

  <li>Let <var title="">br</var> be the result of calling <code class=external data-anolis-spec=domcore title=dom-Document-createElement><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-document-createelement>createElement("br")</a></code> on the
  <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#context-object>context object</a>.

  <li>Call <code class=external data-anolis-spec=domrange title=dom-Range-insertNode><a href=http://html5.org/specs/dom-range.html#dom-range-insertnode>insertNode(<var title="">br</var>)</a></code> on the <a href=#active-range>active range</a>.

  <li>Call <code class=external data-anolis-spec=domrange title=dom-Selection-collapse><a href=http://html5.org/specs/dom-range.html#dom-selection-collapse>collapse()</a></code> on the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#context-object>context object</a>'s <code class=external data-anolis-spec=domrange><a href=http://html5.org/specs/dom-range.html#selection>Selection</a></code>, with
  <var title="">br</var>'s <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> as the first argument and one plus <var title="">br</var>'s
  <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-indexof title=concept-indexof>index</a> as the second argument.

  <li>If <var title="">br</var>'s <code class=external data-anolis-spec=domcore title=dom-Node-nextSibling><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-nextsibling>nextSibling</a></code> is null and <var title="">br</var>'s <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a>
  is not an <a href=#inline-node>inline node</a>, or if <var title="">br</var>'s <code class=external data-anolis-spec=domcore title=dom-Node-nextSibling><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-nextsibling>nextSibling</a></code> is
  not null and not an <a href=#inline-node>inline node</a>, call <code class=external data-anolis-spec=domcore title=dom-Document-createElement><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-document-createelement>createElement("br")</a></code> on
  the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#context-object>context object</a> and let <var title="">extra br</var> be the result, then call
  <code class=external data-anolis-spec=domrange title=dom-Range-insertNode><a href=http://html5.org/specs/dom-range.html#dom-range-insertnode>insertNode(<var title="">extra br</var>)</a></code> on the <a href=#active-range>active range</a>.
</ol>


<h3 id=the-insertorderedlist-command><span class=secno>7.17 </span><dfn>The <code title="">insertOrderedList</code> command</dfn></h3>

<p><a href=#action>Action</a>: <a href=#toggle-lists>Toggle lists</a> with <var title="">tag name</var>
"ol".


<h3 id=the-insertparagraph-command><span class=secno>7.18 </span><dfn>The <code title="">insertParagraph</code> command</dfn></h3>

<!--
There are three major behaviors here.  Firefox 5.0a2 behaves identically to
execCommand("formatBlock", false, "p"), which is not really useful.  IE9
actually just overwrites the selection with an empty paragraph element, which
seems not very useful either.  Chrome 13 dev and Opera 11.10 behave basically
the same as if the user hit the Return key.  This latter behavior seems much
more useful, even though it's horribly misnamed, so it's what I'll spec.

(Actually, Opera doesn't behave quite the same for insertParagraph and line
breaks.  But it's pretty close, and I expect the differences are bugs.)

Then, of course, we have several flavors of line-breaking behavior to choose
from.  Firefox prefers <br>s, unless it's in the middle of a <p> or something.
Opera and IE like <p>.  Chrome prefers <div>.  And there are lots of subtleties
besides.  I go with IE/Opera-style behavior, as discussed in this thread:

http://lists.whatwg.org/htdig.cgi/whatwg-whatwg.org/2011-May/031577.html
-->

<p><a href=#action>Action</a>:

<ol>
  <li><a href=#delete-the-contents>Delete the contents</a> of the <a href=#active-range>active range</a>.

  <li>Let <var title="">range</var> be the <a href=#active-range>active range</a>.

  <li>Let <var title="">node</var> and <var title="">offset</var> be <var title="">range</var>'s
  <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a> and <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-offset title=concept-boundary-point-offset>offset</a>.

  <li>If <var title="">node</var> is a <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#text>Text</a></code> node, and <var title="">offset</var> is neither 0
  nor the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-node-length title=concept-node-length>length</a> of <var title="">node</var>, call <code class=external data-anolis-spec=domcore title=dom-Text-splitText><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-text-splittext>splitText(<var title="">offset</var>)</a></code> on
  <var title="">node</var>.

  <li>If <var title="">node</var> is a <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#text>Text</a></code> node and <var title="">offset</var> is its
  <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-node-length title=concept-node-length>length</a>, set <var title="">offset</var> to one plus the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-indexof title=concept-indexof>index</a> of
  <var title="">node</var>, then set <var title="">node</var> to its <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a>.

  <li>If <var title="">node</var> is a <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#text>Text</a></code> or <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#comment>Comment</a></code> node, set
  <var title="">offset</var> to the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-indexof title=concept-indexof>index</a> of <var title="">node</var>, then set
  <var title="">node</var> to its <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a>.

  <li>Set <var title="">range</var>'s <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> and <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-end title=concept-range-end>end</a> to
  (<var title="">node</var>, <var title="">offset</var>).

  <li>Let <var title="">container</var> equal <var title="">node</var>.

  <li>While <var title="">container</var> is not a <a href=#single-line-container>single-line container</a>,
  and <var title="">container</var>'s <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> is <a href=#editable>editable</a> and <a href=#in-the-same-editing-host>in
  the same editing host</a> as <var title="">node</var>, set <var title="">container</var> to
  its <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a>.

  <li>If <var title="">container</var> is not <a href=#editable>editable</a> or not <a href=#in-the-same-editing-host>in the
  same editing host</a> as <var title="">node</var> or is not a <a href=#single-line-container>single-line
  container</a>:
  <!-- Add the default wrapper. -->

  <ol>
    <li>Let <var title="">tag</var> be the <a href=#default-single-line-container-name>default single-line container
    name</a>.

    <li><a href=#block-extend>Block-extend</a> <var title="">range</var>, and let <var title="">new
    range</var> be the result.

    <li>Let <var title="">node list</var> be a list of <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>nodes</a>, initially empty.

    <li>Append to <var title="">node list</var> the first <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>node</a> in <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#tree-order>tree order</a> that
    is <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#contained>contained</a> in <var title="">new range</var> and is an <a href=#allowed-child>allowed
    child</a> of "p", if any.

    <li>If <var title="">node list</var> is empty:

    <ol>
      <!-- Ideally, we should normalize things so that the cursor is never in a
      weird place after deletion, but let's be safe and bail out if we do hit
      this scenario.  It's not clear if we need this line in the long term, but
      at the time of this writing there's at least one corner case where
      deleting can leave the cursor inside a <tr>. -->
      <li>If <var title="">tag</var> is not an <a href=#allowed-child>allowed child</a> of
      <var title="">range</var>'s <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a>, abort these steps.

      <li>Set <var title="">container</var> to the result of calling
      <code class=external data-anolis-spec=domcore title=dom-Document-createElement><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-document-createelement>createElement(<var title="">tag</var>)</a></code> on the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#context-object>context object</a>.

      <li>Call <code class=external data-anolis-spec=domrange title=dom-Range-insertNode><a href=http://html5.org/specs/dom-range.html#dom-range-insertnode>insertNode(<var title="">container</var>)</a></code> on <var title="">range</var>.

      <li>Call <code class=external data-anolis-spec=domcore title=dom-Document-createElement><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-document-createelement>createElement("br")</a></code> on the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#context-object>context object</a>, and append the
      result as the last <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> of <var title="">container</var>.

      <li>Set <var title="">range</var>'s <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> and <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-end title=concept-range-end>end</a> to
      (<var title="">container</var>, 0).

      <li>Abort these steps.
    </ol>

    <li>While the <code class=external data-anolis-spec=domcore title=dom-Node-nextSibling><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-nextsibling>nextSibling</a></code> of the last member of <var title="">node list</var> is
    not null and is an <a href=#allowed-child>allowed child</a> of "p", append it to
    <var title="">node list</var>.

    <p class=XXX>It is not at all obvious that this is the correct list of
    nodes in all cases.  It should probably work because of how the
    block-extend algorithm works, but further thought would be good.

    <li><a href=#wrap>Wrap</a> <var title="">node list</var>, with <a href=#sibling-criteria>sibling
    criteria</a> matching nothing and <a href=#new-parent-instructions>new parent instructions</a>
    returning the result of calling <code class=external data-anolis-spec=domcore title=dom-Document-createElement><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-document-createelement>createElement(<var title="">tag</var>)</a></code> on the
    <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#context-object>context object</a>.  Set <var title="">container</var> to the result.
  </ol>

  <li>If <var title="">container</var>'s <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-element-local-name title=concept-element-local-name>local name</a> is "address" or "pre":
  <!--
  IE9 and Chrome 13 dev just break <pre> up into multiple <pre>s.  Firefox
  5.0a2 and Opera 11.10 insert a <br> instead, treating it differently from
  <p>.  The latter makes more sense.  What might make the most sense is to just
  insert an actual newline character, though, since this is a pre after all
  . . .

  IE9 and Chrome 13 dev also break <address> up into multiple <address>es.
  Firefox 5.0a2 inserts <br> instead.  Opera 11.10 nests <p>s inside.  I don't
  like Opera's behavior, because it means we nest formatBlock candidates inside
  one another, so I'll go with Firefox.
  -->

  <p class=XXX>Why don't we just insert a newline character if it's a pre?  We
  don't really need to use br in that case.  Need to test: what do browsers do
  if a pre element has newlines in it, do they convert to line breaks when you
  make it no longer a pre?

  <p class=XXX>In cases where hitting enter in a header doesn't break out of
  the header, we should probably follow this code path too, instead of creating
  an adjoining header.  No browser does this, though.

  <ol>
    <li>Let <var title="">br</var> be the result of calling <code class=external data-anolis-spec=domcore title=dom-Document-createElement><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-document-createelement>createElement("br")</a></code> on
    the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#context-object>context object</a>.

    <li>Call <code class=external data-anolis-spec=domrange title=dom-Range-insertNode><a href=http://html5.org/specs/dom-range.html#dom-range-insertnode>insertNode(<var title="">br</var>)</a></code> on <var title="">range</var>.

    <li>Increment <var title="">range</var>'s <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> and <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-end title=concept-range-end>end</a>
    <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-offset title=concept-boundary-point-offset>offsets</a>.

    <li>If <var title="">br</var> is the last <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-descendant title=concept-tree-descendant>descendant</a> of <var title="">container</var>,
    let <var title="">br</var> be the result of calling <code class=external data-anolis-spec=domcore title=dom-Document-createElement><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-document-createelement>createElement("br")</a></code> on the
    <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#context-object>context object</a>, then call <code class=external data-anolis-spec=domrange title=dom-Range-insertNode><a href=http://html5.org/specs/dom-range.html#dom-range-insertnode>insertNode(<var title="">br</var>)</a></code> on
    <var title="">range</var>.
    <!-- Necessary because adding a br to the end of a block element does
    nothing if there wasn't one there already.  A single newline immediately
    preceding a block boundary does nothing. -->

    <li>Abort these steps.
  </ol>

  <li>If <var title="">container</var>'s <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-element-local-name title=concept-element-local-name>local name</a> is "li", "dt", or "dd"; and
  either it has no <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>children</a> or it has a single <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> and that <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a>
  is a <code class=external data-anolis-spec=html title="the br element"><a href=http://www.whatwg.org/html/#the-br-element>br</a></code>:
  <!-- Including dt/dd here follows Firefox 5.0a2, as with the special dt/dd
  handling below. -->

  <ol>
    <li><a href=#split-the-parent>Split the parent</a> of the one-<a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>node</a> list consisting of
    <var title="">container</var>.

    <li><a href=#fix-disallowed-ancestors>Fix disallowed ancestors</a> of <var title="">container</var>.

    <li>Abort these steps.
  </ol>

  <li>Let <var title="">new line range</var> be a new <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range title=concept-range>range</a> whose <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> is
  the same as <var title="">range</var>'s, and whose <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-end title=concept-range-end>end</a> is
  (<var title="">container</var>, <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-node-length title=concept-node-length>length</a> of <var title="">container</var>).

  <!-- We don't want the start to be just inside a node, because if it is,
  we'll leave behind an empty element either in the new or old container.
  Clearly we don't want the start point to get any higher than the container
  itself, though. -->
  <li>While <var title="">new line range</var>'s <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-offset title=concept-boundary-point-offset>offset</a> is zero and its
  <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a> is not <var title="">container</var>, set its <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> to
  (<a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> of <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a>, <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-indexof title=concept-indexof>index</a> of <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a>).

  <li>While <var title="">new line range</var>'s <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-offset title=concept-boundary-point-offset>offset</a> is the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-node-length title=concept-node-length>length</a>
  of its <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a> and its <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a> is not <var title="">container</var>, set
  its <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> to (<a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> of <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a>, 1 + <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-indexof title=concept-indexof>index</a> of
  <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a>).

  <li>Let <var title="">end of line</var> be true if <var title="">new line range</var> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#contained title=contained>contains</a> either nothing or a
  single <code class=external data-anolis-spec=html title="the br element"><a href=http://www.whatwg.org/html/#the-br-element>br</a></code>, and false otherwise.

  <li>If the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-element-local-name title=concept-element-local-name>local name</a> of <var title="">container</var> is "h1", "h2", "h3", "h4",
  "h5", or "h6", and <var title="">end of line</var> is true, let <var title="">new container
  name</var> be the <a href=#default-single-line-container-name>default single-line container name</a>.
  <!-- IE9 makes a new header if there's a trailing <br>.  Firefox 5.0a2,
  Chrome 13 dev, and Opera 11.10 do not, and I follow them, since it makes more
  sense (such a <br> is invisible). -->

  <li>Otherwise, if the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-element-local-name title=concept-element-local-name>local name</a> of <var title="">container</var> is "dt" and
  <var title="">end of line</var> is true, let <var title="">new container name</var> be "dd".

  <li>Otherwise, if the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-element-local-name title=concept-element-local-name>local name</a> of <var title="">container</var> is "dd" and
  <var title="">end of line</var> is true, let <var title="">new container name</var> be "dt".
  <!-- These two follow Firefox 5.0a2.  IE9 and Chrome 13 dev act as though
  these two lines were not present (they clone the existing element).  Opera
  11.10 nests a <p> inside.  Firefox is the most useful, assuming a definition
  list somehow winds up inside the content. -->

  <li>Otherwise, let <var title="">new container name</var> be the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-element-local-name title=concept-element-local-name>local name</a> of
  <var title="">container</var>.

  <li>Let <var title="">new container</var> be the result of calling
  <code class=external data-anolis-spec=domcore title=dom-Document-createElement><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-document-createelement>createElement(<var title="">new container name</var>)</a></code> on the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#context-object>context object</a>.

  <li>Copy all attributes of <var title="">container</var> to <var title="">new container</var>.

  <p class=XXX>Copies id's.

  <li>Insert <var title="">new container</var> into the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> of
  <var title="">container</var> immediately after <var title="">container</var>.

  <li>Let <var title="">frag</var> be the result of calling <code class=external data-anolis-spec=domrange title=dom-Range-extractContents><a href=http://html5.org/specs/dom-range.html#dom-range-extractcontents>extractContents()</a></code> on <var title="">new line
  range</var>.

  <p class=XXX>This blows up any ranges (other than the selection, which we
  reset), duplicates id's, and other bad stuff.  May or may not be the best
  solution.  The intermediate fragment is also probably black-box detectable by
  DOM mutation events, but I like to pretend those don't exist.

  <li>Call <code class=external data-anolis-spec=domcore title=dom-Node-appendChild><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-appendchild>appendChild(<var title="">frag</var>)</a></code> on <var title="">new
  container</var>.

  <li>If <var title="">container</var> has no <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>children</a>, call <code class=external data-anolis-spec=domcore title=dom-Document-createElement><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-document-createelement>createElement("br")</a></code>
  on the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#context-object>context object</a>, and append the result as the last <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> of
  <var title="">container</var>.

  <li>If <var title="">new container</var> has no <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>children</a>, call
  <code class=external data-anolis-spec=domcore title=dom-Document-createElement><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-document-createelement>createElement("br")</a></code> on the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#context-object>context object</a>, and append the result as the
  last <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> of <var title="">new container</var>.
  <!-- These two steps follow Firefox 5.0a2, Chrome 13 dev, and Opera 11.10.
  IE9 instead inserts an &nbsp; which magically does not appear in innerHTML.
  In all cases, the reason is that an empty block box in CSS will have zero
  height, so the user won't be able to put the selection cursor inside it. -->

  <p class=XXX>Needs to also happen if there are only comments/whitespace/etc.
  Also, this can leave stray useless br's lying around.  Probably when the user
  starts typing, we want to remove the br.  On the flip side, if the user
  deletes all the contents of a paragraph, we likely need to add a br.

  <li>Set the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> of <var title="">range</var> to (<var title="">new container</var>,
  0).
</ol>


<h3 id=the-inserttext-command><span class=secno>7.19 </span><dfn>The <code title="">insertText</code> command</dfn></h3>

<!--
Supported only by WebKit.  Tests in other browsers were manual.  In the manual
tests, where the value was always "a", IE9 and Firefox 5.0a2 match the spec
exactly as far as I can tell; Chrome 14 dev and Opera 11.11 might match it in
theory, but normalize the selection first, so they don't match it in practice.
-->

<p><a href=#action>Action</a>:

<ol>
  <li><a href=#delete-the-contents>Delete the contents</a> of the <a href=#active-range>active range</a>.
  <!-- Chrome 14 dev does this even if passed the empty string. -->

  <li>While <var title="">value</var> contains a newline (U+0010):

  <ol>
    <li>Let <var title="">subvalue</var> be the empty string.

    <li>While the first 16-bit element of <var title="">value</var> is not a newline
    (0x0010), remove the first 16-bit element from <var title="">value</var> and append
    it to <var title="">subvalue</var>.

    <li>Take the <a href=#action>action</a> for <a href=#the-inserttext-command>the <code title="">insertText</code> command</a>, with <var title="">value</var> set to
    <var title="">subvalue</var>.

    <li>Remove the first 16-bit element from <var title="">value</var>.

    <li>Take the <a href=#action>action</a> for <a href=#the-insertparagraph-command>the <code title="">insertParagraph</code> command</a>.
  </ol>

  <li>If <var title="">value</var> is the empty string, abort these steps.

  <p class=XXX>WebKit does magic for tabs, wrapping them in a
  whitespace-preserving span.

  <p class=XXX>This doesn't work well if the input contains things that aren't
  supposed to appear in HTML, like carriage returns or nulls.  Nor is it going
  to work well if the current cursor position is in between two halves of a
  non-BMP character.  This will result in unserializability.  The current spec
  disregards this, as Chrome 14 dev does.

  <li>Let <var title="">node</var> and <var title="">offset</var> be the <a href=#active-range>active
  range</a>'s <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a> and <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-offset title=concept-boundary-point-offset>offset</a>.

  <!--
  Just to be tidy, add to an existing text node if there is one.  Firefox 5.0a2
  only adds to an existing one if the range is in a text node.  IE9, Chrome 14
  dev, and Opera 11.11 also add to an existing text node if the range is in an
  element adjacent to a text node.  If there are two text nodes and it's in
  between, like foo{}bar, IE and Opera add to the first, Chrome adds to the
  second, although it probably doesn't matter in practice exactly which we
  choose.
  -->
  <li>If <var title="">node</var> has a <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> whose <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-indexof title=concept-indexof>index</a> is <var title="">offset</var>
  &minus; 1, and that <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> is a <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#text>Text</a></code> node, set <var title="">node</var> to that
  <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a>, then set <var title="">offset</var> to <var title="">node</var>'s <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-node-length title=concept-node-length>length</a>.

  <li>If <var title="">node</var> has a <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> whose <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-indexof title=concept-indexof>index</a> is <var title="">offset</var>,
  and that <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> is a <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#text>Text</a></code> node, set <var title="">node</var> to that <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a>,
  then set <var title="">offset</var> to zero.

  <li>If <var title="">node</var> is a <code class=external data-anolis-spec=domcore><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#text>Text</a></code> node:

  <ol>
    <li>Call <code class=external data-anolis-spec=domcore title=dom-CharacterData-insertData><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-characterdata-insertdata>insertData(<var title="">offset</var>, <var title="">value</var>)</a></code> on
    <var title="">node</var>.

    <li>Add the <a href=http://es5.github.com/#x15.5.5.1>length</a> of
    <var title="">value</var> to <var title="">offset</var>.

    <li>Call <code class=external data-anolis-spec=domrange title=dom-Selection-collapse><a href=http://html5.org/specs/dom-range.html#dom-selection-collapse>collapse(<var title="">node</var>, <var title="">offset</var>)</a></code> on the
    <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#context-object>context object</a>'s <code class=external data-anolis-spec=domrange><a href=http://html5.org/specs/dom-range.html#selection>Selection</a></code>.

    <li>Abort these steps.
  </ol>

  <li>Let <var title="">text</var> be the result of calling <code class=external data-anolis-spec=domcore title=dom-Document-createTextNode><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-document-createtextnode>createTextNode(<var title="">value</var>)</a></code> on
  the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#context-object>context object</a>.

  <li>Call <code class=external data-anolis-spec=domrange title=dom-Range-insertNode><a href=http://html5.org/specs/dom-range.html#dom-range-insertnode>insertNode(<var title="">text</var>)</a></code> on the <a href=#active-range>active range</a>.

  <li>Call <code class=external data-anolis-spec=domrange title=dom-Selection-collapse><a href=http://html5.org/specs/dom-range.html#dom-selection-collapse>collapse(<var title="">text</var>, <var title="">length</var>)</a></code> on the
  <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#context-object>context object</a>'s <code class=external data-anolis-spec=domrange><a href=http://html5.org/specs/dom-range.html#selection>Selection</a></code>, where <var title="">length</var> is the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-node-length title=concept-node-length>length</a>
  of <var title="">text</var>.
</ol>


<h3 id=the-insertunorderedlist-command><span class=secno>7.20 </span><dfn>The <code title="">insertUnorderedList</code> command</dfn></h3>

<p><a href=#action>Action</a>: <a href=#toggle-lists>Toggle lists</a> with <var title="">tag name</var>
"ul".


<h3 id=the-justifycenter-command><span class=secno>7.21 </span><dfn>The <code title="">justifyCenter</code> command</dfn></h3>

<p><a href=#action>Action</a>: <a href=#justify-the-selection>Justify the selection</a> with
<var title="">alignment</var> "center".


<h3 id=the-justifyfull-command><span class=secno>7.22 </span><dfn>The <code title="">justifyFull</code> command</dfn></h3>

<p><a href=#action>Action</a>: <a href=#justify-the-selection>Justify the selection</a> with
<var title="">alignment</var> "justify".


<h3 id=the-justifyleft-command><span class=secno>7.23 </span><dfn>The <code title="">justifyLeft</code> command</dfn></h3>

<p><a href=#action>Action</a>: <a href=#justify-the-selection>Justify the selection</a> with
<var title="">alignment</var> "left".


<h3 id=the-justifyright-command><span class=secno>7.24 </span><dfn>The <code title="">justifyRight</code> command</dfn></h3>

<p><a href=#action>Action</a>: <a href=#justify-the-selection>Justify the selection</a> with
<var title="">alignment</var> "right".


<h3 id=the-outdent-command><span class=secno>7.25 </span><dfn>The <code title="">outdent</code> command</dfn></h3>

<p><a href=#action>Action</a>:

<ol>
  <li>Let <var title="">items</var> be a list of all <code class=external data-anolis-spec=html title="the li element"><a href=http://www.whatwg.org/html/#the-li-element>li</a></code>s that are
  <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#ancestor-container title="ancestor container">ancestor containers</a> of the <a href=#active-range>active range</a>'s <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a>
  and/or <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-end title=concept-range-end>end</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a>.

  <li>For each <var title="">item</var> in <var title="">items</var>, <a href=#normalize-sublists>normalize
  sublists</a> of <var title="">item</var>.
  <!-- This overnormalizes, but it seems like the simplest solution for now.
  -->

  <li><a href=#block-extend>Block-extend</a> the <a href=#active-range>active range</a>, and let <var title="">new
  range</var> be the result.

  <li>Let <var title="">node list</var> be a list of <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>nodes</a>, initially empty.

  <li>For each <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>node</a> <var title="">node</var> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#contained>contained</a> in <var title="">new range</var>:

  <ol>
    <li>If the last member of <var title="">node list</var> (if any) is an <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-ancestor title=concept-tree-ancestor>ancestor</a>
    of <var title="">node</var>, or if <var title="">node</var> is not <a href=#editable>editable</a>,
    continue with the next <var title="">node</var>.

    <!--
    This step is kind of weird.  For regular outdenting, we start at the inside
    and outdent going out, so that we remove the innermost indentation, on the
    theory that that will produce the cleanest markup (remove the most nodes).
    For lists, we remove the outermost indentation, because it makes a
    difference whether we remove inner or outer indentation, and logically we
    want to remove outer.  E.g.,

      <ol><li>foo</li><ul><li>bar</li></ul></ol>

    should become

      foo<ul><li>bar</li></ul>

    not

      foo<ol><li>bar</li></ol>.

    But this is a bit weird and I'm wondering if it's really correct.
    -->
    <li>If <var title="">node</var> has no <a href=#editable>editable</a> <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-descendant title=concept-tree-descendant>descendants</a>, or is
    an <code class=external data-anolis-spec=html title="the ol element"><a href=http://www.whatwg.org/html/#the-ol-element>ol</a></code> or <code class=external data-anolis-spec=html title="the ul element"><a href=http://www.whatwg.org/html/#the-ul-element>ul</a></code>, or is an <code class=external data-anolis-spec=html title="the li element"><a href=http://www.whatwg.org/html/#the-li-element>li</a></code> whose <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> is an <code class=external data-anolis-spec=html title="the ol element"><a href=http://www.whatwg.org/html/#the-ol-element>ol</a></code> or
    <code class=external data-anolis-spec=html title="the ul element"><a href=http://www.whatwg.org/html/#the-ul-element>ul</a></code>, append it to <var title="">node list</var>.
  </ol>

  <li>While <var title="">node list</var> is not empty:

  <ol>
    <li>While the first member of <var title="">node list</var> is an <code class=external data-anolis-spec=html title="the ol element"><a href=http://www.whatwg.org/html/#the-ol-element>ol</a></code> or <code class=external data-anolis-spec=html title="the ul element"><a href=http://www.whatwg.org/html/#the-ul-element>ul</a></code>
    or is not the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> of an <code class=external data-anolis-spec=html title="the ol element"><a href=http://www.whatwg.org/html/#the-ol-element>ol</a></code> or <code class=external data-anolis-spec=html title="the ul element"><a href=http://www.whatwg.org/html/#the-ul-element>ul</a></code>, <a href=#outdent>outdent</a> it and
    remove it from <var title="">node list</var>.

    <li>If <var title="">node list</var> is empty, break from these substeps.

    <li>Let <var title="">sublist</var> be a list of <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>nodes</a>, initially empty.

    <li>Remove the first member of <var title="">node list</var> and append it to
    <var title="">sublist</var>.

    <li>While the first member of <var title="">node list</var> is the <code class=external data-anolis-spec=domcore title=dom-Node-nextSibling><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-nextsibling>nextSibling</a></code>
    of the last member of <var title="">sublist</var>, and the first member of <var title="">node
    list</var> is not an <code class=external data-anolis-spec=html title="the ol element"><a href=http://www.whatwg.org/html/#the-ol-element>ol</a></code> or <code class=external data-anolis-spec=html title="the ul element"><a href=http://www.whatwg.org/html/#the-ul-element>ul</a></code>, remove the first member of <var title="">node
    list</var> and append it to <var title="">sublist</var>.

    <li><a href=#split-the-parent>Split the parent</a> of <var title="">sublist</var>.

    <li><a href=#fix-disallowed-ancestors>Fix disallowed ancestors</a> of each member of
    <var title="">sublist</var>.
  </ol>
</ol>


<h2 id=miscellaneous-commands><span class=secno>8 </span>Miscellaneous commands</h2>

<h3 id=the-selectall-command><span class=secno>8.1 </span><dfn>The <code title="">selectAll</code> command</dfn></h3>

<!--
Tested using roughly this:

http://software.hixie.ch/utilities/js/live-dom-viewer/saved/1018

IE9: A bit confusing.  The gist seems to be that it does selectAllChildren() on
the body, except sometimes it doesn't.

Firefox 5.0a2: Throws an exception if nothing in the document is editable,
which apparently it always does for execCommand().  If there's a body, it does
selectAllChildren() on that, and otherwise it does selectAllChildren() on the
root element.  If there's no root element, throws an exception.

Chrome 13 dev: If there's no root element, removes the selection.  If there's
a root element but no body, collapses the selection at (document, 0).  If
there's a body, it selects all the contents of the body, although that doesn't
mean the resulting anchor or focus actually are the body node (they're usually
text nodes).  But it seems to *avoid* selecting contenteditable stuff: if all
the visible things in the body are contenteditable, it removes all ranges from
the selection, and if some are, it freaks out and behaves oddly.  But
designMode doesn't trouble it.

Opera 11.11: Was characteristically uncooperative in my tests, and I didn't try
to investigate further.

The behavior here is relatively simple and largely matches implementations.
-->

<p><a href=#action>Action</a>:

<ol>
  <li>Let <var title="">target</var> be <a class=external data-anolis-spec=html href=http://www.whatwg.org/html/#the-body-element-0 title=the-body-element-0>the body element</a> of the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#context-object>context object</a>.

  <p class=XXX>Is this right even for framesets?

  <li>If <var title="">target</var> is null, let <var title="">target</var> be the
  <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#context-object>context object</a>'s <code class=external data-anolis-spec=domcore title=dom-Document-documentElement><a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-document-documentelement>documentElement</a></code>.

  <p class=XXX>Is this right even for documents whose root element is not an
  HTML element?

  <li>If <var title="">target</var> is null, let <var title="">target</var> be the
  <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#context-object>context object</a>.

  <li>Call <code class=external data-anolis-spec=domrange title=dom-Document-getSelection><a href=http://html5.org/specs/dom-range.html#dom-document-getselection>getSelection()</a></code> on the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#context-object>context object</a>, and call <code class=external data-anolis-spec=domrange title=dom-Selection-selectAllChildren><a href=http://html5.org/specs/dom-range.html#dom-selection-selectallchildren>selectAllChildren(<var title="">target</var>)</a></code>
  on the result.
</ol>


<h3 id=the-stylewithcss-command><span class=secno>8.2 </span><dfn>The <code title="">styleWithCSS</code> command</dfn></h3>

<!-- IE9 and Opera 11.00 don't support this command.  By and large, they act
the way Gecko and WebKit do when styleWithCSS is off.  Gecko invented it, and
WebKit also supports it:

https://bugs.webkit.org/show_bug.cgi?id=13490

The default in Firefox 4.0 is off, while all other browsers behave like the
default is on (and IE/Opera give no way to turn it off), so I default it to on.
-->

<p><a href=#action>Action</a>: If <var title="">value</var> is an <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#ascii-case-insensitive>ASCII case-insensitive</a> match for the string
"false", set the <a href=#css-styling-flag>CSS styling flag</a> to false.  Otherwise, set the
<a href=#css-styling-flag>CSS styling flag</a> to true.
<!-- This matches Firefox 5.0a2.  Chrome 13 dev treats the case-sensitive
string "true" as true, the case-sensitive string "false" as false, and does
nothing for any other string.  I went with Gecko because this way there are
only two possible effects, not three, which makes it easier to reason about and
debug.  Also, Gecko made up the command and has larger market share, so this is
probably more web-compatible.  Cursory searches of Google Code and GitHub
suggest that authors almost always pass a boolean as the third argument when
using styleWithCSS, in which case the two behaviors work the same. -->

<p><a href=#state>State</a>: True if the <a href=#css-styling-flag>CSS styling flag</a> is true,
otherwise false.
<!-- This follows Chrome 13 dev.  Firefox 5.0a2 doesn't support
queryCommandState() for styleWithCSS. -->


<h3 id=the-usecss-command><span class=secno>8.3 </span><dfn>The <code title="">useCSS</code> command</dfn></h3>

<!-- Supported by Firefox 4.0, but not IE9 or Opera 11.00 (which don't support
styleWithCSS either), nor by Chrome 12 dev (which does support styleWithCSS.
useCSS was the original feature in Mozilla 1.3, but the meaning is backward, so
Gecko added styleWithCSS as a replacement. -->

<p><a href=#action>Action</a>: If <var title="">value</var> is an <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#ascii-case-insensitive>ASCII case-insensitive</a> match for the string
"false", set the <a href=#css-styling-flag>CSS styling flag</a> to true.  Otherwise, set the
<a href=#css-styling-flag>CSS styling flag</a> to false.

<p>Since the effect of this command is the opposite of what one would expect,
user agents are encouraged to point authors to <code title="the stylewithcss
command"><a href=#the-stylewithcss-command>styleWithCSS</a></code> when <code title="the usecss
command"><a href=#the-usecss-command>useCSS</a></code> is used, such as by logging a warning to an error
console.

<p class=XXX>The meaning of this command is backwards, and only Gecko supports
it.  It would be great if Gecko would agree to drop support, so that we could
get rid of it.


<h2 id=additional-requirements><span class=secno>9 </span>Additional requirements</h2>

<p class=XXX>It has been <a href=http://lists.whatwg.org/htdig.cgi/whatwg-whatwg.org/2009-December/024628.html>suggested</a>
that some things here need to be platform-dependent, not fully standardized.
For now I'm standardizing them anyway, because the large majority of behavior
should be platform-agnostic.  If anyone has suggestions as to particular things
that should be left up to platform behavior, please say so.

<p>When the user instructs the user agent to insert a line break inside an
<a href=#editing-host>editing host</a>, such as by pressing the Return key while the cursor
is in an <a href=#editable>editable</a> <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>node</a>, the user agent must take the
<a href=#action>action</a> for <a href=#the-insertparagraph-command>the <code title="">insertParagraph</code>
command</a>.

<p>When the user instructs the user agent to delete the previous character
inside an <a href=#editing-host>editing host</a>, such as by pressing the Backspace key
while the cursor is in an <a href=#editable>editable</a> <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>node</a>, the user agent must
take the <a href=#action>action</a> for <a href=#the-delete-command>the <code title="">delete</code>
command</a>.

<p>When the user instructs the user agent to delete the next character inside
an <a href=#editing-host>editing host</a>, such as by pressing the Delete key while the
cursor is in an <a href=#editable>editable</a> <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>node</a>, the user agent must take the
<a href=#action>action</a> for <a href=#the-forwarddelete-command>the <code title="">forwardDelete</code>
command</a>.

<p>When the user instructs the user agent to insert text inside an
<a href=#editing-host>editing host</a>, such as by typing on the keyboard while the cursor
is in an <a href=#editable>editable</a> <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-node title=concept-node>node</a>, the user agent must take the
<a href=#action>action</a> for <a href=#the-inserttext-command>the <code title="">insertText</code> command</a>,
with <var title="">value</var> equal to the text the user provided.  If the user inserts
multiple characters at once or in quick succession, this specification does not
define whether it is treated as one insertion or several consecutive
insertions.


<h2 class=no-num id=acknowledgements>Acknowledgements</h2>
<p>Thanks to:

<ul>
  <li>Google, for funding this work
  <li>Ian Hickson, for overseeing it
  <li>Julie Parent, Ojan Vafai, Alex Russel, and Eric Seidel for their <a href=http://lists.whatwg.org/htdig.cgi/whatwg-whatwg.org/2009-December/024627.html>research</a>
  on how browsers and other rich text editors behave in many common scenarios
  <li>Ehsan Akhgari, Tim Down, Ryosuke Niwa, Julie Parent, and Roland Steiner
  for their feedback on drafts of this document
  <li>Tab Atkins, Ian Hickson, Glenn Maynard, Ms2ger, Simon Pieters, and most
  of the rest of the <a href=irc://irc.freenode.net/whatwg>#whatwg</a> crowd
  for giving quick online feedback when I have questions or need to solicit
  opinions.
</ul>

<script src=http://www.whatwg.org/specs/web-apps/current-work/dfn.js></script>

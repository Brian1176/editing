<!DOCTYPE html><meta charset=utf-8>
<title>HTML Editing Commands</title>
<link href=http://www.whatwg.org/style/specification rel=stylesheet>
<style>
 pre, code, xmp { font-family:monospace, sans-serif; }
 h2 code, h3 code, h4 code,
 h2 :link, h3 :link, h4 :link,
 h2 :visited, h3 :visited, h4 :visited
 { font:inherit; color:inherit; font-style:italic; }
 @media print {
   :not([data-anolis-spec]) > [data-anolis-spec]::after {
     content: "[" attr(data-anolis-spec) "]";
     font-size: 0.6em;
     vertical-align: super;
     text-transform: uppercase;
   }
 }
 xmp {
   font-size: inherit;
   font-variant: normal;
   margin-left: 2em;
   white-space: pre-wrap;
 }
 div.note > p:first-child::before { content: 'Note: '; }
 div + * > li { margin: 1em 0 }
</style>
<body class=draft>
<div class=head id=head>
<h1>HTML Editing Commands</h1>
<h2 class="no-num no-toc" id=work-in-progress-&mdash;-last-update-17-march-2011>Work in Progress &mdash; Last Update 17 March 2011</h2>
<dl>
 <dt>Editor
 <dd>Aryeh Gregor &lt;ayg+spec@aryeh.name&gt;

 <dt>Version history
 <dd><a href="http://aryeh.name/gitweb.cgi?p=editcommands">http://aryeh.name/gitweb.cgi?p=editcommands</a>
</dl>
</div>


<h2 class=no-num id=status-of-this-document>Status of this Document</h2>
<p>This document is an early draft of a specification for HTML editing APIs,
defining <a href=#execcommand()><code>execCommand()</code></a> and related functions.  It will eventually
be merged into the main <a href=http://www.whatwg.org/html>HTML</a>
specification, replacing the <a href=http://www.whatwg.org/specs/web-apps/current-work/multipage/dnd.html#editing-apis>Editing
APIs</a> section.  Although this spec is still very incomplete and will likely
be changed heavily before it's finished, feedback to <a href=http://lists.whatwg.org/listinfo.cgi/whatwg-whatwg.org>the WHATWG list</a>
is encouraged, particularly from implementers.


<h2 class=no-num id=table-of-contents>Table of contents</h2>

<!--begin-toc-->
<ol class=toc>
 <li><a class=no-num href=#status-of-this-document>Status of this Document</a></li>
 <li><a class=no-num href=#table-of-contents>Table of contents</a></li>
 <li><a href=#introduction><span class=secno>1 </span>Introduction</a></li>
 <li><a href=#issues><span class=secno>2 </span>Issues</a></li>
 <li><a href=#definitions><span class=secno>3 </span>Definitions</a></li>
 <li><a href=#decomposing-a-range-into-nodes><span class=secno>4 </span>Decomposing a range into nodes</a></li>
 <li><a href="#clearing-an-element's-styles"><span class=secno>5 </span>Clearing an element's styles</a></li>
 <li><a href=#pushing-down-styles><span class=secno>6 </span>Pushing down styles</a></li>
 <li><a href=#forcing-the-style-of-a-node><span class=secno>7 </span>Forcing the style of a node</a></li>
 <li><a href=#styling-a-node><span class=secno>8 </span>Styling a node</a></li>
 <li><a href=#commands><span class=secno>9 </span>Commands</a></li>
 <li><a class=no-num href=#references>References</a></li>
 <li><a class=no-num href=#acknowledgements>Acknowledgements</a></ol>
<!--end-toc-->


<h2 id=introduction><span class=secno>1 </span>Introduction</h2>
<p>This specification defines commands to edit HTML documents programmatically.
The APIs specified here were originally introduced in Microsoft's Internet
Explorer, but have subsequently been copied by other browsers in a haphazard
and imprecise fashion.  Although the behavior specified here does not exactly
match any browser at the time of writing, it can serve as a target to converge
to in the future.

<p>Where the reasoning behind the specification is of interest, such as when
major preexisting rendering engines are known not to match it, the reasoning is
included in HTML comments so as not to distract the reader.

<p>The principles I've used for writing this specification so far are:

<ul>
  <li>If all browsers that implement a particular feature agree on some detail
  of how it works, match them unless there's very good reason not to.  When
  it's not clear what behavior is best, try to follow the implementations with
  the most market share.  But if one browser's behavior is clearly better than
  the others', go with the better behavior.

  <li>If a command is issued to format some text in a particular way, we will
  format the text that way no matter what.  If the user clicks the "bold"
  button, they don't care that the text didn't become bold because of an
  external CSS rule or for any other reason, they only care that it didn't
  work.  The only exception (beyond where it's simply impossible, like
  propagated text-decorations we can't remove) is that we don't try to override
  !important rules from external stylesheets, although we also don't go out of
  our way to respect them.

  <li>When we're given a presentational command like "bold", don't modify
  anything other than presentational markup related to that command.  If an
  element has non-presentational attributes like id or class, don't split it up
  or remove it or anything.  At most convert it to a span, if it's some type of
  presentational element (where "presentational" here really means "browsers
  produce it in response to execCommand() so we need to treat it as
  presentational", so it includes things like <a href=http://www.whatwg.org/html/#the-strong-element><code class=external data-anolis-spec=html title="the strong element">strong</code></a> and <a href=http://www.whatwg.org/html/#the-em-element><code class=external data-anolis-spec=html title="the em element">em</code></a>).

  <li>Don't interfere with more markup than necessary.  If the user modifies
  only a small run of text, don't go around simplifying ancestors or siblings
  or whatever unless it's necessary to produce simpler markup in the place that
  was actually modified.

  <li>But if we are already changing around something's style, convert existing
  styles to the preferred format.  For instance, we use <a href=http://www.whatwg.org/html/#the-b-element><code class=external data-anolis-spec=html title="the b element">b</code></a> for bold, and
  convert <a href=http://www.whatwg.org/html/#the-strong-element><code class=external data-anolis-spec=html title="the strong element">strong</code></a> and &lt;<a href=http://www.whatwg.org/html/#the-span-element><code class=external data-anolis-spec=html title="the span element">span</code></a> <a href=http://www.whatwg.org/html/#the-style-attribute><code class=external data-anolis-spec=html title="the style attribute">style</code></a>="font-weight: bold"&gt; if we
  happen to be modifying that node anyway.

  <li>Don't make the document less conforming than it originally was.  If we
  happen to make it more conforming, good, although we don't have to go out of
  our way to do that.  (In the future, I'll add a mode that supports using
  obsolete presentational elements instead of CSS for the sake of e-mail
  clients and such, and this rule will be bent in that mode.)

  <li>Keep the markup as concise as possible.  (I've received feedback that
  this is very important to authors.)  Ideally, the markup should look as
  simple and neat as what a human would have produced by hand-editing.  We do
  complicated manipulation to pull styles down from ancestors rather than
  having to use inline CSS, and make sure to tidy up any styles on elements
  that we happen to be modifying anyway.  Previous principles take precedence
  over this one, however.
</ul>


<h2 id=issues><span class=secno>2 </span>Issues</h2>

<ul>
  <li>Need to make CSS terminology more precise, about setting/unsetting CSS
  properties.  The intent is to modify the style attribute, CSSOM-style.
  Likewise, CSS value comparisons need to be done after serializing both
  values, so "bold" == "700" and "red" == "#f00" and so on.

  <li>Also not sure about computed style.  There are differences between
  "computed" and "used" and things like that, what do we actually want here?

  <li>The wording I use for DOM stuff is a bit of a mess, often either
  imprecise or unreasonably verbose.  I'm not quite sure how to fix it.

  <li>I haven't put any thought yet into collapsed ranges or selections.
  Currently my algorithms mostly do nothing if the selection is collapsed,
  which is of course wrong.  E.g., bold with collapsed selection should put
  &lt;b&gt;&lt;/b&gt; at the cursor, generally.

  <li>I also don't pay attention to what happens to the selection when you
  mutate the DOM.  This is essential.

  <li>JavaScript can modify the DOM synchronously in some cases, such as DOM
  mutation events and onunload when moving around iframes and objects.  This
  has to be dealt with somehow.  (Pointed out by Ryosuke Niwa of WebKit: <a href=http://lists.whatwg.org/pipermail/whatwg-whatwg.org/2011-March/030730.html>1</a>
  <a href=http://lists.whatwg.org/pipermail/whatwg-whatwg.org/2011-March/030751.html>2</a>)

  <li>I'm sloppy about handling things like nodes that don't descend from a
  Document, comments that are children of a Document, that sort of thing.  Not
  essential for prototyping, but needs to be cleaned up eventually.

  <li>I don't pay attention to whether designMode/contenteditable is actually
  set.  I should be doing things like not doing anything if the selection isn't
  editable, making sure not to break out of contenteditable regions, etc.
</ul>


<h2 id=definitions><span class=secno>3 </span>Definitions</h2>

<p>A <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#node><code class=external data-anolis-spec=domcore>Node</code></a> is an <dfn id=html-element>HTML element</dfn> if it is an <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element><code class=external data-anolis-spec=domcore>Element</code></a> whose
<a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-element-namespace title=concept-element-namespace>namespace</a> is the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#html-namespace>HTML namespace</a>.  An <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#attr><code class=external data-anolis-spec=domcore>Attr</code></a> is an <dfn id=html-attribute>HTML attribute</dfn> if its
<a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-attr-namespace title=concept-attr-namespace>namespace</a> is
the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#html-namespace>HTML namespace</a>.

<p>A <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#node><code class=external data-anolis-spec=domcore>Node</code></a> is <dfn id=effectively-contained>effectively contained</dfn> in a <a href=http://html5.org/specs/dom-range.html#range><code class=external data-anolis-spec=domrange>Range</code></a> if either it
is <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#contained>contained</a> in the <a href=http://html5.org/specs/dom-range.html#range><code class=external data-anolis-spec=domrange>Range</code></a>; or it is the <a href=http://html5.org/specs/dom-range.html#range><code class=external data-anolis-spec=domrange>Range</code></a>'s <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a>
<a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a>, it is a <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#text><code class=external data-anolis-spec=domcore>Text</code></a> node, and its <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-node-length title=concept-node-length>length</a> is different from the
<a href=http://html5.org/specs/dom-range.html#range><code class=external data-anolis-spec=domrange>Range</code></a>'s <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-offset title=concept-boundary-point-offset>offset</a>; or it is the <a href=http://html5.org/specs/dom-range.html#range><code class=external data-anolis-spec=domrange>Range</code></a>'s <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-end title=concept-range-end>end</a>
<a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a>, it is a <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#text><code class=external data-anolis-spec=domcore>Text</code></a> node, and the <a href=http://html5.org/specs/dom-range.html#range><code class=external data-anolis-spec=domrange>Range</code></a>'s <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-end title=concept-range-end>end</a>
<a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-offset title=concept-boundary-point-offset>offset</a> is not 0.

<p class=note>A node is <a href=#effectively-contained>effectively contained</a> in a range if and
only if it would be <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#contained>contained</a> after the range is <a href=#decompose title=decompose>decomposed</a>.

<p>The <dfn id=active-range>active range</dfn> of a <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#document><code class=external data-anolis-spec=domcore>Document</code></a> is the value returned by the
following algorithm:

<ol>
  <li>Let <var title="">selection</var> be the result of calling <a href=http://html5.org/specs/dom-range.html#dom-document-getselection><code class=external data-anolis-spec=domrange title=dom-Document-getSelection>getSelection()</code></a> on
  the <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#document><code class=external data-anolis-spec=domcore>Document</code></a>.

  <li>If there are no <a href=http://html5.org/specs/dom-range.html#range><code class=external data-anolis-spec=domrange>Range</code></a>s associated with <var title="">selection</var>,
  return null.

  <li>Let <var title="">start</var> be the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point title=concept-boundary-point>boundary point</a> with the earliest
  <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-bp-position title=concept-bp-position>position</a> among all of <var title="">selection</var>'s <a href=http://html5.org/specs/dom-range.html#range><code class=external data-anolis-spec=domrange>Range</code></a>s'
  <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>starts</a>.

  <li>Return the last <a href=http://html5.org/specs/dom-range.html#range><code class=external data-anolis-spec=domrange>Range</code></a> in <var title="">selection</var> whose <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a>
  is <var title="">start</var>.
  <!-- This is what Firefox seems to do, no reason to change it . . . -->

  <p class=note>In user agents that support only one <a href=http://html5.org/specs/dom-range.html#range><code class=external data-anolis-spec=domrange>Range</code></a> per
  <a href=http://html5.org/specs/dom-range.html#selection><code class=external data-anolis-spec=domrange>Selection</code></a>, the active range is simply the only one in the selection.
</ol>

<p>An <dfn id=unwrappable-element>unwrappable element</dfn> is an <a href=#html-element>HTML element</a> which may
not be used where only <a class=external data-anolis-spec=html href=http://www.whatwg.org/html/#phrasing-content>phrasing content</a> is expected (not counting unknown or
obsolete elements, which cannot be used at all).

<p>The <dfn id=specified-style>specified style</dfn> of an <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element><code class=external data-anolis-spec=domcore>Element</code></a> for a given
<var title="">property</var> is returned by the following algorithm, which will return
either a CSS value or null:

<ol>
  <li>If the <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element><code class=external data-anolis-spec=domcore>Element</code></a> has a <a href=http://www.whatwg.org/html/#the-style-attribute><code class=external data-anolis-spec=html title="the style attribute">style</code></a> attribute set, and that attribute has
  the effect of setting <var title="">property</var>, return the value that it sets
  <var title="">property</var> to.

  <li>If the <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element><code class=external data-anolis-spec=domcore>Element</code></a> is a <a href=http://www.whatwg.org/html/#font><code class=external data-anolis-spec=html>font</code></a> element
  that has an attribute whose effect is to create a <a class=external data-anolis-spec=html href=http://www.whatwg.org/html/#presentational-hints title="presentational hints">presentational hint</a> for
  <var title="">property</var>, return the value that the hint sets <var title="">property</var>
  to.

  <li>If the <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element><code class=external data-anolis-spec=domcore>Element</code></a> is in the following list, and <var title="">property</var> is
  equal to the CSS property name listed for it, return the string listed for
  it.

  <dl class=switch>
    <dt><a href=http://www.whatwg.org/html/#the-b-element><code class=external data-anolis-spec=html title="the b element">b</code></a>
    <dt><a href=http://www.whatwg.org/html/#the-strong-element><code class=external data-anolis-spec=html title="the strong element">strong</code></a>
    <dd>font-weight: "bold"

    <dt><a href=http://www.whatwg.org/html/#the-i-element><code class=external data-anolis-spec=html title="the i element">i</code></a>
    <dt><a href=http://www.whatwg.org/html/#the-em-element><code class=external data-anolis-spec=html title="the em element">em</code></a>
    <dd>font-style: "italic"

    <dt><a href=http://www.whatwg.org/html/#the-u-element><code class=external data-anolis-spec=html title="the u element">u</code></a>
    <dd>text-decoration: "underline"
  </dl>

  <li>Return null.
</ol>

<p>A <dfn id=simple-styling-element>simple styling element</dfn> is an <a href=#html-element>HTML element</a> for
which at least one of the following holds:

<ol>
  <li>It is a <a href=http://www.whatwg.org/html/#the-b-element><code class=external data-anolis-spec=html title="the b element">b</code></a>, <a href=http://www.whatwg.org/html/#the-em-element><code class=external data-anolis-spec=html title="the em element">em</code></a>, <a href=http://www.whatwg.org/html/#font><code class=external data-anolis-spec=html title=font>font</code></a>, <a href=http://www.whatwg.org/html/#the-i-element><code class=external data-anolis-spec=html title="the i element">i</code></a>, <a href=http://www.whatwg.org/html/#the-span-element><code class=external data-anolis-spec=html title="the span element">span</code></a>, <a href=http://www.whatwg.org/html/#the-strong-element><code class=external data-anolis-spec=html title="the strong element">strong</code></a>, or <a href=http://www.whatwg.org/html/#the-u-element><code class=external data-anolis-spec=html title="the u element">u</code></a>
  element with no attributes.

  <li>It is a <a href=http://www.whatwg.org/html/#the-b-element><code class=external data-anolis-spec=html title="the b element">b</code></a>, <a href=http://www.whatwg.org/html/#the-em-element><code class=external data-anolis-spec=html title="the em element">em</code></a>, <a href=http://www.whatwg.org/html/#font><code class=external data-anolis-spec=html title=font>font</code></a>, <a href=http://www.whatwg.org/html/#the-i-element><code class=external data-anolis-spec=html title="the i element">i</code></a>, <a href=http://www.whatwg.org/html/#the-span-element><code class=external data-anolis-spec=html title="the span element">span</code></a>, <a href=http://www.whatwg.org/html/#the-strong-element><code class=external data-anolis-spec=html title="the strong element">strong</code></a>, or <a href=http://www.whatwg.org/html/#the-u-element><code class=external data-anolis-spec=html title="the u element">u</code></a>
  element with exactly one attribute, which is <a href=http://www.whatwg.org/html/#the-style-attribute><code class=external data-anolis-spec=html title="the style attribute">style</code></a>, which sets no CSS
  properties (including invalid or unrecognized properties).

  <li>It is a <a href=http://www.whatwg.org/html/#font><code class=external data-anolis-spec=html title=font>font</code></a> element with one attribute, which is either
  <a href=http://www.whatwg.org/html/#dom-font-color><code class=external data-anolis-spec=html title=dom-font-color>color</code></a>, <a href=http://www.whatwg.org/html/#dom-font-face><code class=external data-anolis-spec=html title=dom-font-face>face</code></a>, or <a href=http://www.whatwg.org/html/#dom-font-size><code class=external data-anolis-spec=html title=dom-font-size>size</code></a>.

  <li>It is a <a href=http://www.whatwg.org/html/#the-b-element><code class=external data-anolis-spec=html title="the b element">b</code></a> or <a href=http://www.whatwg.org/html/#the-strong-element><code class=external data-anolis-spec=html title="the strong element">strong</code></a> element with one attribute, which is
  <a href=http://www.whatwg.org/html/#the-style-attribute><code class=external data-anolis-spec=html title="the style attribute">style</code></a>, and the only CSS property set by the <a href=http://www.whatwg.org/html/#the-style-attribute><code class=external data-anolis-spec=html title="the style attribute">style</code></a> attribute
  (including invalid or unrecognized properties) is "font-weight".

  <li>It is an <a href=http://www.whatwg.org/html/#the-i-element><code class=external data-anolis-spec=html title="the i element">i</code></a> or <a href=http://www.whatwg.org/html/#the-em-element><code class=external data-anolis-spec=html title="the em element">em</code></a> element with one attribute, which is <a href=http://www.whatwg.org/html/#the-style-attribute><code class=external data-anolis-spec=html title="the style attribute">style</code></a>,
  and the only CSS property set by the <a href=http://www.whatwg.org/html/#the-style-attribute><code class=external data-anolis-spec=html title="the style attribute">style</code></a> attribute (including invalid
  or unrecognized properties) is "font-style".

  <li>It is a <a href=http://www.whatwg.org/html/#the-u-element><code class=external data-anolis-spec=html title="the u element">u</code></a> element with one attribute, which is <a href=http://www.whatwg.org/html/#the-style-attribute><code class=external data-anolis-spec=html title="the style attribute">style</code></a>, and the
  only CSS property set by the <a href=http://www.whatwg.org/html/#the-style-attribute><code class=external data-anolis-spec=html title="the style attribute">style</code></a> attribute (including invalid or
  unrecognized properties) is "text-decoration", which is set to "underline" or
  "none".

  <li>It is a <a href=http://www.whatwg.org/html/#font><code class=external data-anolis-spec=html title=font>font</code></a> or <a href=http://www.whatwg.org/html/#the-span-element><code class=external data-anolis-spec=html title="the span element">span</code></a> element with exactly one attribute, which is
  <a href=http://www.whatwg.org/html/#the-style-attribute><code class=external data-anolis-spec=html title="the style attribute">style</code></a>, and the <a href=http://www.whatwg.org/html/#the-style-attribute><code class=external data-anolis-spec=html title="the style attribute">style</code></a> attribute sets exactly one CSS property
  (including invalid or unrecognized properties).
</ol>

<p>When the user agent is instructed to run a particular method, it must follow
the steps defined for that method in the appropriate specification, not act as
though the method had actually been called from JavaScript.  In particular,
if the author has overridden the method with a custom method, the standard
method must be run rather than the custom one.

<p>When a list or set of <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#node><code class=external data-anolis-spec=domcore>Node</code></a>s is assigned to a variable without specifying
the order, they must be initially in <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#tree-order>tree order</a>, if they share a root.
(If they don't share a root, the order will be specified.)  When the user agent
is instructed to run particular steps for each member of a list, it must do so
sequentially in the list's order.


<h2 id=decomposing-a-range-into-nodes><span class=secno>4 </span>Decomposing a range into nodes</h2>
<p>When a user agent is to <dfn id=decompose>decompose</dfn> a <a href=http://html5.org/specs/dom-range.html#range><code class=external data-anolis-spec=domrange>Range</code></a> <var title="">range</var>,
it must run the following steps.

<ol>
  <li>If <var title="">range</var>'s <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> and <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-end title=concept-range-end>end</a> are the same,
  return an empty list.

  <li>Let <var title="">start node</var>, <var title="">start offset</var>, <var title="">end node</var>,
  and <var title="">end offset</var> be <var title="">range</var>'s <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> and
  <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-end title=concept-range-end>end</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>nodes</a> and <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-offset title=concept-boundary-point-offset>offsets</a>, respectively.

  <li>If <var title="">start node</var> is a <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#text><code class=external data-anolis-spec=domcore>Text</code></a> node and is the same as <var title="">end
  node</var>, and <var title="">start offset</var> is neither 0 nor the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-node-length title=concept-node-length>length</a>
  of <var title="">start node</var>:
  
  <ol>
    <li>Set <var title="">start node</var> to the result of running <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-text-splittext><code class=external data-anolis-spec=domcore title=dom-Text-splitText>splitText(<var title="">start
    offset</var>)</code></a> on <var title="">start node</var>.

    <li>Set <var title="">end node</var> to <var title="">start node</var>.

    <li>Set <var title="">end offset</var> to <var title="">end offset</var> &minus; <var title="">start
    offset</var>.

    <li>Set <var title="">start offset</var> to 0.
  </ol>

  <li>Otherwise, if <var title="">start node</var> is a <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#text><code class=external data-anolis-spec=domcore>Text</code></a> node and <var title="">start
  offset</var> is neither 0 nor the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-node-length title=concept-node-length>length</a> of <var title="">start node</var>:

  <ol>
    <li>Set <var title="">start node</var> to the result of running <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-text-splittext><code class=external data-anolis-spec=domcore title=dom-Text-splitText>splitText(<var title="">start
    offset</var>)</code></a> on <var title="">start node</var>.

    <li>Set <var title="">start offset</var> to 0.
  </ol>

  <li>If <var title="">end node</var> is a <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#text><code class=external data-anolis-spec=domcore>Text</code></a> node and <var title="">end offset</var> is
  neither 0 nor the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-node-length title=concept-node-length>length</a> of <var title="">end node</var>, run <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-text-splittext><code class=external data-anolis-spec=domcore title=dom-Text-splitText>splitText(<var title="">end
  offset</var>)</code></a> on <var title="">end node</var>.

  <!-- The next two steps ensure that our fragmented text nodes are contained
  in the range. -->
  <li>If <var title="">start node</var> is a <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#text><code class=external data-anolis-spec=domcore>Text</code></a> node and <var title="">start offset</var>
  is 0, set <var title="">start offset</var> to the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-indexof title=concept-indexof>index</a> of <var title="">start node</var>,
  then set <var title="">start node</var> to its <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a>.

  <li>If <var title="">end node</var> is a <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#text><code class=external data-anolis-spec=domcore>Text</code></a> node and <var title="">end offset</var> is
  its <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-node-length title=concept-node-length>length</a>, set <var title="">end offset</var> to one plus the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-indexof title=concept-indexof>index</a> of
  <var title="">end node</var>, then set <var title="">end node</var> to its parent.

  <li>Set <var title="">range</var>'s <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> to (<var title="">start node</var>,
  <var title="">start offset</var>) and its <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-end title=concept-range-end>end</a> to (<var title="">end node</var>,
  <var title="">end offset</var>).

  <!-- Now we want to make sure our range contains as many nodes as possible,
  such as by changing <tag>[foo]</tag> to {<tag>foo</tag>}. -->
  <li>Let <var title="">cloned range</var> be the result of calling <a href=http://html5.org/specs/dom-range.html#dom-range-clonerange><code class=external data-anolis-spec=domrange title=dom-Range-cloneRange>cloneRange()</code></a> on
  <var title="">range</var>.

  <li>While the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-offset title=concept-boundary-point-offset>offset</a> of <var title="">cloned range</var> is 0,
  and the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> of <var title="">cloned range</var>'s <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a> is
  not null, set the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> of <var title="">cloned range</var> to (<a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> of
  <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a>, <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-indexof title=concept-indexof>index</a> of <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a>).

  <li>While the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-end title=concept-range-end>end</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-offset title=concept-boundary-point-offset>offset</a> of <var title="">cloned range</var> equals the
  <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-node-length title=concept-node-length>length</a> of its <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-end title=concept-range-end>end</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a>, and the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> of
  <var title="">clone range</var>'s <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-end title=concept-range-end>end</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a> is not null, set the
  <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-end title=concept-range-end>end</a> of <var title="">cloned range</var> to (<a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> of <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-end title=concept-range-end>end</a>
  <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a>, 1 + <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-indexof title=concept-indexof>index</a> of <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-end title=concept-range-end>end</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a>).

  <li>Return a list consisting of every <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#node><code class=external data-anolis-spec=domcore>Node</code></a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#contained>contained</a> in <var title="">cloned
  range</var> in <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#tree-order>tree order</a>, omitting any whose <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> is also
  <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#contained>contained</a> in <var title="">cloned range</var>.
</ol>


<h2 id="clearing-an-element's-styles"><span class=secno>5 </span>Clearing an element's styles</h2>
<p>When a user agent is to <dfn id=clear-styles>clear styles</dfn> on an element, it must run
the following steps:

<p class=note>Clearing styles can remove it from its parent and put other nodes
in its place.  When implementations do something like clear style on all
children of an element, they should take care not to assume that the set of
children won't change as they're unstyled.  If the element is removed, the
algorithm will return the list of nodes inserted in its place.

<p class=XXX>This should probably convert, e.g., &lt;font color=red id=foo&gt;
into &lt;span id=foo&gt; instead of &lt;font id=foo&gt;.

<ol>
  <li>Let <var title="">element</var> be the <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element><code class=external data-anolis-spec=domcore>Element</code></a> to be unstyled.

  <li>Let <var title="">property</var> be as in the invoking algorithm.

  <li>If <var title="">element</var> is a <a href=#simple-styling-element>simple styling element</a> and its
  <a href=#specified-style>specified style</a> for <var title="">property</var> is not null:

  <ol>
    <li>Let <var title="">children</var> be an empty list of <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#node><code class=external data-anolis-spec=domcore>Node</code></a>s.

    <li>While <var title="">element</var> has children:

    <ol>
      <li>Let <var title="">child</var> be the first child of <var title="">element</var>.

      <li>Append <var title="">child</var> to <var title="">children</var>.

      <li>Insert <var title="">child</var> as the previous sibling of
      <var title="">element</var>.
    </ol>

    <li>Remove <var title="">element</var> from its <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a>.

    <li>Return <var title="">children</var>.
  </ol>

  <li>Unset the CSS property <var title="">property</var> of <var title="">element</var>.

  <li>If <var title="">element</var> is a <a href=http://www.whatwg.org/html/#font><code class=external data-anolis-spec=html>font</code></a>
  element:

  <ol>
    <li>If <var title="">property</var> is "color", unset <var title="">element</var>'s
    <a href=http://www.whatwg.org/html/#dom-font-color><code class=external data-anolis-spec=html title=dom-font-color>color</code></a> attribute, if
    set.

    <li>If <var title="">property</var> is "font-family", unset
    <var title="">element</var>'s <a href=http://www.whatwg.org/html/#dom-font-face><code class=external data-anolis-spec=html title=dom-font-face>face</code></a> attribute, if set.

    <li>If <var title="">property</var> is "font-size", unset <var title="">element</var>'s
    <a href=http://www.whatwg.org/html/#dom-font-size><code class=external data-anolis-spec=html title=dom-font-size>size</code></a> attribute, if
    set.
  </ol>

  <li>If <var title="">element</var>'s <var title="">specified style</var> for
  <var title="">property</var> is null, return the empty list.
  <!-- If we get past this step, we're something like <b class=foo> where we
  want to keep the extra attributes, so we stick them on a span. -->

  <li>Let <var title="">new element</var> be a new <a href=#html-element>HTML element</a> with
  <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-element-local-name title=concept-element-local-name>local name</a> "span", with the same attributes and <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-ownerdocument><code class=external data-anolis-spec=domcore title=dom-Node-ownerDocument>ownerDocument</code></a> as
  <var title="">element</var>.

  <li>Append <var title="">new element</var> to <var title="">element</var>'s
  parent as the previous sibling of <var title="">element</var>.

  <li>While <var title="">element</var> has children, append its first child
  as the last child of <var title="">new element</var>.

  <li>Remove <var title="">element</var> from its <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a>.

  <li>Return the one-<a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#node><code class=external data-anolis-spec=domcore>Node</code></a> list consisting of <var title="">new element</var>.
</ol>


<h2 id=pushing-down-styles><span class=secno>6 </span>Pushing down styles</h2>
<p>When a user agent is to <dfn id=push-down-styles>push down styles</dfn> to a <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#node><code class=external data-anolis-spec=domcore>Node</code></a>
<var title="">node</var>, given a CSS property name <var title="">property</var> and a new value
<var title="">new value</var>, it must run the following steps:

<ol>
  <li>If <var title="">node</var>'s <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> is not an <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element><code class=external data-anolis-spec=domcore>Element</code></a>, abort this
  algorithm. <!-- E.g., a text node child of a document fragment. -->

  <li>If <var title="">node</var> is an <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element><code class=external data-anolis-spec=domcore>Element</code></a> and <var title="">property</var> computes to
  <var title="">new value</var> on <var title="">node</var>, abort this algorithm.

  <li>If <var title="">node</var> is not an <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element><code class=external data-anolis-spec=domcore>Element</code></a> and <var title="">property</var> computes
  to <var title="">new value</var> on <var title="">node</var>'s <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a>, abort this
  algorithm.

  <li>Let <var title="">current ancestor</var> be <var title="">node</var>'s <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a>.

  <li>Let <var title="">ancestor list</var> be a list of <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#node><code class=external data-anolis-spec=domcore>Node</code></a>s, initially empty.

  <li>While <var title="">current ancestor</var> is an <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element><code class=external data-anolis-spec=domcore>Element</code></a> and
  <var title="">property</var> does not compute to <var title="">new value</var> on it, append
  <var title="">current ancestor</var> to <var title="">ancestor list</var>, then set
  <var title="">current ancestor</var> to its <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a>.

  <!-- We can only remove specified styles, so if the style isn't specified,
  give up. -->
  <li>If <var title="">ancestor list</var> is not empty, and the <a href=#specified-style>specified
  style</a> of <var title="">property</var> on the last member of <var title="">ancestor
  list</var> is null, abort this algorithm.

  <!-- If we go all the way up to the root and still don't have the desired
  style, pushing down styles is pointless.  It will create extra markup for no
  purpose. -->
  <li>If <var title="">ancestor list</var> is not empty, and the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> of the last
  member of <var title="">ancestor list</var> is not an <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element><code class=external data-anolis-spec=domcore>Element</code></a>, abort this
  algorithm.

  <li>While <var title="">ancestor list</var> is not empty:

  <ol>
    <li>Let <var title="">current ancestor</var> be the last member of <var title="">ancestor
    list</var>.

    <li>Remove the last member from <var title="">ancestor list</var>.

    <li>Let <var title="">propagated value</var> be the <a href=#specified-style>specified style</a> of
    <var title="">current ancestor</var> for <var title="">property</var>.

    <li>If <var title="">propagated value</var> is null, continue this loop from the
    beginning.

    <li>Let <var title="">children</var> be the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>children</a> of <var title="">current
    ancestor</var>.

    <li><a href=#clear-styles>Clear styles</a> on <var title="">current ancestor</var>.

    <li>For every <var title="">child</var> in <var title="">children</var>:

    <ol>
      <li>If <var title="">child</var> is <var title="">node</var>, continue with the next
      <var title="">child</var>.

      <li>If <var title="">child</var> is an <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element><code class=external data-anolis-spec=domcore>Element</code></a> whose <a href=#specified-style>specified
      style</a> for <var title="">property</var> is neither null nor equal to
      <var title="">propagated value</var>, continue with the next <var title="">child</var>.

      <li>If <var title="">child</var> is the last member of <var title="">ancestor list</var>,
      set <var title="">child</var>'s CSS property <var title="">property</var> to
      <var title="">propagated value</var> and continue with the next <var title="">child</var>.

      <p class=note>This style will be removed on the next loop iteration and
      distributed to its children.

      <li><a href=#force-the-style>Force the style</a> of <var title="">child</var>, with
      <var title="">property</var> as in this algorithm and <var title="">new value</var> equal
      to <var title="">propagated value</var>.
    </ol>
  </ol>
</ol>


<h2 id=forcing-the-style-of-a-node><span class=secno>7 </span>Forcing the style of a node</h2>
<p>When a user agent is to <dfn id=force-the-style>force the style</dfn> of a <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#node><code class=external data-anolis-spec=domcore>Node</code></a>
<var title="">node</var>, given a CSS property name <var title="">property</var> and a new value
<var title="">new value</var>, it must run the following steps.

<p class=note>This algorithm checks if the node has the desired style, and if
not, it wraps the node (or, if that's not possible, its descendants) in a
<a href=#simple-styling-element>simple styling element</a>.  This is only used as a last resort after
<a href=#clear-styles title="clear styles">clearing styles</a> and <a href=#push-down-styles title="push down
styles">pushing down styles</a> don't work to achieve the desired style.
After forcing the style, descendants might still have different style.

<ol>
  <li>If <var title="">node</var> is an <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element><code class=external data-anolis-spec=domcore>Element</code></a> and <var title="">property</var> computes to
  <var title="">new value</var> on <var title="">node</var>, abort this algorithm.

  <li>If <var title="">node</var> is not an <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element><code class=external data-anolis-spec=domcore>Element</code></a>, <var title="">node</var>'s <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> is
  an <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element><code class=external data-anolis-spec=domcore>Element</code></a>, and <var title="">property</var> computes to <var title="">new value</var> on
  <var title="">node</var>'s <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a>, abort this algorithm.

  <li>If <var title="">node</var> is an <a href=#unwrappable-element>unwrappable element</a>:

  <ol>
    <li>Let <var title="">children</var> be all <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>children</a> of <var title="">node</var>,
    omitting any that are <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element><code class=external data-anolis-spec=domcore>Element</code></a>s whose <a href=#specified-style>specified style</a> for
    <var title="">property</var> is neither null nor equal to <var title="">new value</var>.

    <li><a href=#force-the-style>Force the style</a> of each <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#node><code class=external data-anolis-spec=domcore>Node</code></a> in <var title="">children</var>,
    with <var title="">property</var> and <var title="">new value</var> as in this invocation of
    the algorithm.

    <li>Abort this algorithm.
  </ol>

  <li>If <var title="">node</var>'s <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-previoussibling><code class=external data-anolis-spec=domcore title=dom-Node-previousSibling>previousSibling</code></a> is a <a href=#simple-styling-element>simple styling
  element</a> whose <a href=#specified-style>specified style</a> and computed style for
  <var title="">property</var> are both <var title="">new value</var>, append <var title="">node</var> as
  the last <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> of its <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-previoussibling><code class=external data-anolis-spec=domcore title=dom-Node-previousSibling>previousSibling</code></a> and abort this algorithm.

  <li>If <var title="">node</var>'s <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-nextsibling><code class=external data-anolis-spec=domcore title=dom-Node-nextSibling>nextSibling</code></a> is a <a href=#simple-styling-element>simple styling
  element</a> whose <a href=#specified-style>specified style</a> and computed style for
  <var title="">property</var> are both <var title="">new value</var>, insert <var title="">node</var> as
  the first <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> of its <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-nextsibling><code class=external data-anolis-spec=domcore title=dom-Node-nextSibling>nextSibling</code></a> and abort this algorithm.

  <!-- At this point we have to make a new element as a wrapper.  This isn't
  worth the effort for comments or PIs, so abort in that case. -->
  <li>If <var title="">node</var> is a <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#comment><code class=external data-anolis-spec=domcore>Comment</code></a> or <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#processinginstruction><code class=external data-anolis-spec=domcore>ProcessingInstruction</code></a>, abort
  this algorithm.

  <li>If <var title="">node</var> is an <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element><code class=external data-anolis-spec=domcore>Element</code></a> and <var title="">property</var> computes to
  <var title="">new value</var> on <var title="">node</var>, abort this algorithm.

  <li>If <var title="">node</var> is not an <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element><code class=external data-anolis-spec=domcore>Element</code></a>, <var title="">node</var>'s <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> is
  an <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element><code class=external data-anolis-spec=domcore>Element</code></a>, and <var title="">property</var> computes to <var title="">new value</var> on
  <var title="">node</var>'s <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a>, abort this algorithm.

  <li>If <var title="">property</var> is "font-weight" and <var title="">new value</var> is
  "bold", let <var title="">tag</var> be "b".

  <li>If <var title="">property</var> is "font-style" and <var title="">new value</var> is
  "italic", let <var title="">tag</var> be "i".

  <li>If <var title="">property</var> is "text-decoration" and <var title="">new value</var> is
  "underline", let <var title="">tag</var> be "u".

  <li>If <var title="">tag</var> is not set, let <var title="">tag</var> be "span".

  <li>Let <var title="">new parent</var> be the result of calling <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-document-createelement><code class=external data-anolis-spec=domcore title=dom-Document-createElement>createElement(<var title="">tag</var>)</code></a> on the
  <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-ownerdocument><code class=external data-anolis-spec=domcore title=dom-Node-ownerDocument>ownerDocument</code></a> of <var title="">node</var>.

  <li>Insert <var title="">new parent</var> in <var title="">node</var>'s <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> before
  <var title="">node</var>.

  <li>If the computed value of <var title="">property</var> for <var title="">new parent</var> is
  not <var title="">new value</var>, set the CSS property <var title="">property</var> of
  <var title="">new parent</var> to <var title="">new value</var>.

  <li>Append <var title="">node</var> to <var title="">new parent</var> as its last <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a>.

  <li>If <var title="">node</var> is an <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element><code class=external data-anolis-spec=domcore>Element</code></a> and the computed value of
  <var title="">property</var> for <var title="">node</var> is not <var title="">new value</var>, set the
  CSS property <var title="">property</var> of <var title="">node</var> to <var title="">new value</var>.
</ol>


<h2 id=styling-a-node><span class=secno>8 </span>Styling a node</h2>
<p>When a user agent is to <dfn id=style>style</dfn> a <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#node><code class=external data-anolis-spec=domcore>Node</code></a> <var title="">node</var>, it must
run the following steps.  There are two inputs: a CSS property name
<var title="">property</var> and a new value <var title="">new value</var>.

<div class=note>
<p>The effect of this algorithm is to ensure that the node and all its
descendants have the style requested, no matter what, producing the simplest
markup possible to achieve that effect.  It's inspired by the approach WebKit
takes.  The only places where the algorithm should fail are when there's an
!important CSS rule that conflicts with the requested style (which we don't try
to override because we assume it's !important for a reason), or when it's
literally impossible to succeed (such as when a text-decoration is propagated
from an ancestor we can't reach).  Any other failures are bugs.

<p>First, if the node is an element with an inline style rule for this
property, we unset it ("clearing styles").  This step also removes <a href=#simple-styling-element title="simple styling element">simple styling elements</a> entirely, and
replaces elements like <a href=http://www.whatwg.org/html/#the-b-element><code class=external data-anolis-spec=html title="the b element">b</code></a> or <a href=http://www.whatwg.org/html/#font><code class=external data-anolis-spec=html title=font>font</code></a> with <a href=http://www.whatwg.org/html/#the-span-element><code class=external data-anolis-spec=html title="the span element">span</code></a>s if they aren't simple
styling elements.  This will be sufficient if the desired style is inherited
from an ancestor, or if it's the default (like font-style: normal) and no
conflicting style is inherited from an ancestor.  Even if clearing styles
doesn't actually fix the style of the node we're dealing with, we do it anyway
to simplify the generated markup.

<p>If clearing styles didn't work, and it looks like an ancestor has inline
style that we're inheriting, we push the style down from that ancestor.  Thus
if we're unbolding the letter "r" in

</p><xmp><b>foo <i>bar</i> baz</b>,</xmp>

<p>we get

</p><xmp><b>foo </b><i><b>ba</b>r</i><b> baz</b>.</xmp>

<p>If we didn't push down styles, the final step (forcing styles) would instead
give us

</p><xmp><b>foo <i>ba<span style="font-weight: normal">r</span></i> baz</b>,</xmp>

<p>which is much longer and uglier.  We take care not to disturb the style or
semantics of anything but the node we're dealing with.

<p>We'll only push down styles if some ancestor actually has the style we want,
so we can inherit it.  Otherwise, it will just create useless markup.

<p>Finally, if neither of the above strategies worked, we have to add new
markup to get the desired style ("forcing styles").  First we try just sticking
it into its previous or next sibling, if that's a <a href=#simple-styling-element>simple styling
element</a> (so it won't add any styles or semantics we don't want).
Otherwise, we create a new simple styling element and wrap it in that.  It's
common that a previous sibling is the simple styling element we want, because
often we'll style several consecutive siblings in succession.  In that case,
the element created for the first can be reused for the later ones.

<p>This last step works a bit differently if the node is an <a href=#unwrappable-element>unwrappable
element</a>.  In that case, wrapping it in a simple styling element would
make the document less conforming than it already was.  Instead, we recursively
force style on its children.  The recursion will terminate when we hit a node
that's wrappable, or when there are no further descendants.

<p>After all this, the node is guaranteed to have the style we want, barring
bugs in the algorithm or the two exceptions noted earlier (!important style
rules, and impossible cases).  We then re-run the algorithm on each child
recursively.  Typically this means just clearing the style of each descendant,
because it should then inherit the style we just set on its ancestor.  In the
unusual case that a descendant's style is wrong even after we clear style on
it, such as because of a non-inline style rule (like trying to unbold a
heading), we'll repeat the above steps to ensure that the style really gets set
as desired.
</div>

<ol>
  <li>If <var title="">node</var> is a <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#document><code class=external data-anolis-spec=domcore>Document</code></a>, <a href=#style>style</a> its <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element><code class=external data-anolis-spec=domcore>Element</code></a>
  <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>child</a> (if it has one) and abort this algorithm.

  <li>If <var title="">node</var> is a <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#documentfragment><code class=external data-anolis-spec=domcore>DocumentFragment</code></a>, let <var title="">children</var> be
  a list of its <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>children</a>.  <a href=#style>Style</a> each member of <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>children</a>,
  then abort this algorithm.

  <li>If <var title="">node</var>'s <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> is null, or if <var title="">node</var> is a <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#documenttype><code class=external data-anolis-spec=domcore>DocumentType</code></a>, abort this algorithm.

  <p class=XXX>We could style detached elements, but maybe it's not worth the
  effort.  Is execCommand() even supposed to work on things that don't descend
  from a document?  Needs investigation.

  <li>If <var title="">node</var> is an <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element><code class=external data-anolis-spec=domcore>Element</code></a>:

  <ol>
    <li><a href=#clear-styles>Clear styles</a> on <var title="">node</var>, and let <var title="">new
    nodes</var> be the result.

    <li>For each <var title="">new node</var> in <var title="">new nodes</var>,
    <a href=#style>style</a> <var title="">new node</var>, with the same inputs as this
    invocation of the algorithm.

    <li>If <var title="">node</var>'s <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> is null, abort this algorithm.
  </ol>

  <li><a href=#push-down-styles>Push down styles</a> on <var title="">node</var>.

  <li><a href=#force-the-style>Force the style</a> of <var title="">node</var>.

  <li>Let <var title="">children</var> be the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>children</a> of <var title="">node</var>.

  <li><a href=#style>Style</a> each member of <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-child title=concept-tree-child>children</a>.

  <p class=note>Styling a node involves clearing its styles, which can remove
  it from the tree.  Implementers should be careful to compute the list of
  children in full before they begin styling.
</ol>


<h2 id=commands><span class=secno>9 </span>Commands</h2>
<p>The <dfn id=execcommand() title=execCommand()><code>execCommand(<var title="">commandId</var>,
<var title="">showUI</var>, <var title="">value</var>)</code></dfn> method on the
<a href=http://www.whatwg.org/html/#htmldocument><code class=external data-anolis-spec=html>HTMLDocument</code></a> interface allows scripts to
perform actions on the current selection or at the current caret position.
Generally, these commands would be used to implement editor UI, for example
having a "delete" button on a toolbar.

<p>There are three variants to this method, with one, two, and three arguments
respectively. The <var title="">showUI</var> and <var title="">value</var>
parameters, even if specified, are ignored except where otherwise stated.

<p>When <a href=#execcommand()><code>execCommand()</code></a> is invoked, the user agent must take the
action from the list below given by <var title="">commandId</var> on the
<a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#context-object>context object</a>'s <a href=#active-range>active range</a>.  If no action is given or if
there is no <a href=#active-range>active range</a>, do nothing.

<p>The <dfn id=querycommandstate() title=queryCommandState()><code>queryCommandState(<var title="">commandId</var>)</code></dfn>
method on the <a href=http://www.whatwg.org/html/#htmldocument><code class=external data-anolis-spec=html>HTMLDocument</code></a> interface must
return the state of <var title="">commandId</var> on the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#context-object>context object</a>'s
<a href=#active-range>active range</a>, as given by the list below.  If there is no
<a href=#active-range>active range</a>, or if <var title="">commandId</var> is not on the list,
return false.
<!-- Gecko throws an exception if there are no ranges in the selection, but
other engines seem to just return false, which seems like nicer behavior
anyway.

Requesting the state of an unknown command throws an exception in IE 9 RC
and Firefox 4b11, and returns boolean false in Chrome 10 and Opera 11. -->

<p>The <dfn id=querycommandvalue() title=queryCommandValue()><code>queryCommandValue(<var title="">commandId</var>)</code></dfn>
method on the <a href=http://www.whatwg.org/html/#htmldocument><code class=external data-anolis-spec=html>HTMLDocument</code></a> interface must
return the value of <var title="">commandId</var> on the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#context-object>context object</a>'s
<a href=#active-range>active range</a>, as given by the list below.  If there is no
<a href=#active-range>active range</a>, or if <var title="">commandId</var> is not on the list,
return the empty string.
<!-- Requesting the value of an unknown command throws an exception in
IE 9 RC and in Firefox 4b11.  It returns boolean false in Chrome 10, and the
empty string in Opera 11. -->

<p class=XXX>Querying the value or state of an unrecognized command throws an
exception in IE and Firefox.  Need to consider changing to that behavior.

<p>The possible values for <var title="">commandId</var>, and their corresponding
meanings, are as follows.  These values must be compared to the argument in an
<a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#ascii-case-insensitive>ASCII case-insensitive</a> manner.

<dl>
<dt><code title=""><dfn id=command-backcolor title=command-backColor>backColor</dfn></code>

<dd><p><strong>Action</strong>: If <var title="">value</var> is not a valid CSS color,
the user agent must do nothing and abort these steps.  Otherwise, it must
<a href=#decompose>decompose</a> the <a href=http://html5.org/specs/dom-range.html#range><code class=external data-anolis-spec=domrange>Range</code></a>, then <a href=#style>style</a> each returned
<a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#node><code class=external data-anolis-spec=domcore>Node</code></a> with <var title="">property</var> equal to "background-color" and <var title="">new
value</var> equal to <var title="">value</var>.
<!-- Firefox documentation says it normally sets the background color of the
document, but I can't get it to work at all in brief testing in 4b11.  (It says
it behaves differently in styleWithCss mode.)  Opera 11 appears to set the
background color of the nearest block container of the cursor, or something.
IE 9 RC and Chrome 10 behave as I'd expect, namely, they set the background of
the selection, just like all the other styling features.  I go with IE/WebKit.

Invalid colors are probably the same craziness as with foreColor.

Chrome 10 dev actually sets background, not background-color, so it resets all
the other background stuff.  I go with IE 9 RC and Opera 11, which only set
background-color. -->

<p class=XXX>Firefox and Opera use backColor to set the background color of the
whole document.  The hiliteColor command can then be used to set the background
of the selection (supported in all my test browsers except IE).  This
terminology is inconsistent with foreColor, but the model I've specced leaves
no way to change the document's overall background color.  I'm not sure how
important this is, but maybe I should switch, since hiliteColor is more
interoperably implemented than backColor.

<dd><p><strong>State</strong>: Always false.

<dd><p><strong>Value</strong>: The value is given by the following algorithm:

<ol>
  <li class=XXX>...

  <li>While the computed style of "background-color" on <var title="">element</var>
  is any fully transparent value, set <var title="">element</var> to its parent.

  <p class=XXX>It's intended that for these purposes, the root element will
  have a white background.  Should that be specified somewhere?  I don't think
  all UAs actually do it.

  <li>Return the computed style of "background-color" for
  <var title="">element</var>.
</ol>
<!-- Chrome 10 returns rgba(0, 0, 0, 0) if there's no background defined
anywhere.  Opera 11 returns rgb(255, 255, 255) as I'd like.  Firefox 4b11 just
throws an exception for some reason.  IE 9 RC seems to return the number 0
across the board, as with foreColor. -->


<dt><code title=""><dfn id=command-bold title=command-bold>bold</dfn></code>

<dd><p><strong>Action</strong>: <a href=#decompose>Decompose</a> the <a href=http://html5.org/specs/dom-range.html#range><code class=external data-anolis-spec=domrange>Range</code></a>.  If the
state of the <a href=http://html5.org/specs/dom-range.html#range><code class=external data-anolis-spec=domrange>Range</code></a> for this command is then true, <a href=#style>style</a> each
returned <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#node><code class=external data-anolis-spec=domcore>Node</code></a> with <var title="">property</var> "font-weight" and <var title="">new
value</var> "bold".  Otherwise, <a href=#style>style</a> them with <var title="">new
value</var> "normal".

<dd><p><strong>State</strong>: True if every <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element><code class=external data-anolis-spec=domcore>Element</code></a> that is
<a href=#effectively-contained>effectively contained</a> in the <a href=http://html5.org/specs/dom-range.html#range><code class=external data-anolis-spec=domrange>Range</code></a> has computed font-weight at
least 700, and the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> of every <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#text><code class=external data-anolis-spec=domcore>Text</code></a> node that is <a href=#effectively-contained>effectively
contained</a> in the <a href=http://html5.org/specs/dom-range.html#range><code class=external data-anolis-spec=domrange>Range</code></a> has computed font-weight at least 700.
Otherwise false.

<dd><p><strong>Value</strong>: Always the empty string.
<!-- We have lots of options here (and presumably for all the others where
value is meaningless).  IE 9 RC returns the boolean false, Firefox 4b11 and
Opera 11 both return the empty string, Chrome 10 returns the string "false".
The HTML5 spec as of February 2011 mandates WebKit's behavior.  It makes sense
to always return a string, a majority of string-returners return the empty
string, and three out of the four return something that evaluates to false as a
boolean, so I'll go with Firefox and Opera. -->


<dt><code title=""><dfn id=command-createlink title=command-createlink>createLink</dfn></code>

<dd><p><strong>Action</strong>: The user agent must run the following steps:

<ol>
  <li>If <var title="">value</var> is the empty string, abort these steps and do
  nothing.
  <!-- This matches Firefox 4b11 and Chrome 11 dev.  IE 9 RC and Opera 11 both
  treat the request literally.  Gecko and WebKit probably have it right here:
  users who enter no URL are very unlikely to want to link to a relative URL
  resolving to the current document.  If they really want to, they can always
  specify "#" for the value, or the author can rewrite it, so it's not like
  this makes the API less useful. -->

  <li>Let <var title="">node list</var> be the result of <a href=#decompose title=decompose>decomposing</a> the <a href=http://html5.org/specs/dom-range.html#range><code class=external data-anolis-spec=domrange>Range</code></a>.

  <li>For each <var title="">node</var> in <var title="">node list</var>, in order:

  <ol>
    <li>Let <var title="">text nodes</var> be a list of all <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#text><code class=external data-anolis-spec=domcore>Text</code></a> node
    <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-descendant title=concept-tree-descendant>descendants</a> of <var title="">node</var>, or <var title="">node</var> itself if it's a
    <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#text><code class=external data-anolis-spec=domcore>Text</code></a> node.

    <li>For each <var title="">text node</var> in <var title="">text nodes</var>, in
    <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#tree-order>tree order</a>:

    <ol>
      <li>Let <var title="">ancestor link</var> be the parent of <var title="">text
      node</var>.

      <li>While <var title="">ancestor link</var> is not an <a href=#html-element>HTML
      element</a>, or its <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-element-local-name title=concept-element-local-name>local name</a> is not "a", or it has no <a href=#html-attribute>HTML
      attribute</a> with <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-attr-local-name title=concept-attr-local-name>local name</a> "href":

      <ol>
        <li>If the parent of <var title="">ancestor link</var> is not an <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element><code class=external data-anolis-spec=domcore>Element</code></a>,
        set <var title="">ancestor link</var> to null and break from this loop.

        <li>Otherwise, set <var title="">ancestor link</var> to its parent.
      </ol>

      <li>If <var title="">ancestor link</var> is not null, set its "href" attribute
      to <var title="">value</var> and continue with the next <var title="">text node</var>.
      <!-- There are three approaches here.  For instance, if you ask browsers
      to create a link to "http://example.org" on the "b" here:

        <a href=http://example.com><b>Abc</b></a>

      Chrome 10 dev produces:

        <b><a href=http://example.com>A</a><a href=http://example.org>b</a>
        <a href=http://example.com>c</a></b>

      Firefox 4b11 produces (roughly):

        <a href=http://example.com><b>A<a href=http://example.org>b</a>c</b></a>

      IE 9 RC and Opera 11 produce simply:

        <a href=http://example.org><b>Abc</b></a>

      The last behavior produces valid markup (unlike Gecko), is simple (unlike
      WebKit), and probably best matches user expectations.  If you happen to
      miss out a character when selecting the link you want to change, do you
      really intend to only change the link of part of it? -->

      <li>Let <var title="">new parent</var> be the result of calling <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-document-createelement><code class=external data-anolis-spec=domcore title=dom-Document-createElement>createElement("a")</code></a> on the
      <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-ownerdocument><code class=external data-anolis-spec=domcore title=dom-Node-ownerDocument>ownerDocument</code></a> of <var title="">text node</var>.

      <li>Call <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-element-setattribute><code class=external data-anolis-spec=domcore title=dom-Element-setAttribute>setAttribute("href",
      <var title="">value</var>)</code></a> on <var title="">new parent</var>.

      <li>Insert <var title="">new parent</var> into <var title="">text node</var>'s parent as
      the previous sibling of <var title="">text node</var>.

      <li>Append <var title="">text node</var> to <var title="">new parent</var> as its last
      child.
    </ol>
  </ol>
</ol>

<dd><p><strong>State</strong>: Always false.

<dd><p><strong>Value</strong>: Always the empty string.
<!-- I'd have expected the value to be the URL, but guess not. -->


<dt><code title=""><dfn id=command-fontname title=command-fontname>fontName</dfn></code>

<dd><p><strong>Action</strong>: <a href=#decompose>Decompose</a> the <a href=http://html5.org/specs/dom-range.html#range><code class=external data-anolis-spec=domrange>Range</code></a>, then
<a href=#style>style</a> each returned <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#node><code class=external data-anolis-spec=domcore>Node</code></a> with <var title="">property</var> equal to
"font-family" and <var title="">new value</var> equal to <var title="">value</var>.
<!-- UAs differ a bit in the details here:

IE 9 RC: Empty string sets <font face="">
Firefox 4b11: Empty string does nothing
Chrome 11 dev: Empty string does nothing, '"monospace"' same as 'monospace'
  (i.e., cannot escape font-family keywords because quotes are stripped,
  clearly wrong)
Opera 11: Empty string sets <font face="">

Setting an empty font-family has the effect of inheriting the font from the
parent (although I don't see where the February 24, 2011 CSS 3 Fonts draft says
that).  Thus it makes sense that if we special-case this, it should be to unset
the font somehow.

Special-casing the empty string to do nothing doesn't make sense to me.  With
createLink we'd expect the user to enter the URL themselves, so it makes sense
to special-case clicking OK without entering anything.  But here it's very
likely that the font list will be fixed by the author (how many users will
understand CSS font-family syntax?), so I don't think such usability concerns
apply. -->

<dd><p><strong>State</strong>: Always false.

<dd><p><strong>Value</strong>: The computed value of the CSS property
"font-family" for . . .
<!-- Complicated.

IE 9 RC: Always the empty string.  Not very useful.
Firefox 4b11: Confusing.  Sometimes it returns generic family names, like
  "sans-serif".  Sometimes it gives specific font names, like "tt" when the
  font is specified as "monospace".  Sometimes it gives the literal font-family
  string.  Not sure what it's doing here.
Chrome 11 dev: Gives the literal value of font-family, except if it's inherited
  from default values (no explicit style declarations anywhere), when it seems
  to return the exact font name.
Opera 11: Returns the literal value of font-family, except if it's inherited
  from default values, when it returns the empty string.

I'm just going to punt on this and say it should be the computed value of
font-family.  I'll leave CSSOM to decide what that means if there are no
applicable style rules. -->


<dt><code title=""><dfn id=command-forecolor title=command-forecolor>foreColor</dfn></code>

<dd><p><strong>Action</strong>: If <var title="">value</var> is not a valid CSS color,
the user agent must do nothing and abort these steps.
<!-- Browsers are all over the place here.  IE 9 RC seems to treat unrecognized
colors as black, but everyone else ignores them.  There are also special rules
for certain things that aren't valid CSS colors, in some browsers, like:

IE 9 RC: "ffe" -> "#ffe", "123" -> "#123"
Firefox 4b11: "ffe" -> no style, "123" -> no style
Chrome 10 dev: "ffe" -> "#FFFFEE", "123" -> "#000123"
Opera 11: "ffe" -> "#0f0f0e", "123" -> "#010203"

Firefox seems to stick to just CSS colors, so with any luck that works.
"limegreen" works as expected in all browsers.  rgb(255, 255, 255) does too,
except in Opera, which tries to parse it in some crazy way and winds up with
"#00b025".  rgba() colors don't work as uniformly, but I don't see any reason
to prohibit them.  Best to just match CSS. -->
Otherwise, it must <a href=#decompose>decompose</a> the <a href=http://html5.org/specs/dom-range.html#range><code class=external data-anolis-spec=domrange>Range</code></a>, then
<a href=#style>style</a> each returned <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#node><code class=external data-anolis-spec=domcore>Node</code></a> with <var title="">property</var> equal to
"color" and <var title="">new value</var> equal to <var title="">value</var>.

<dd><p><strong>State</strong>: Always false.
<!-- This matches IE 9 RC and Chrome 10.  Opera 11 seems to return true if
there's some color style applied, false otherwise, which seems fairly useless;
authors want to use value here, not state.  Firefox 4b11 throws an exception,
which is an interesting approach, but I'll go with IE/WebKit, which makes at
least as much sense. -->

<dd><p><strong>Value</strong>: The computed value of the CSS property "color"
for . . .
<!-- IE 9 RC returns the number 0 always, which makes no sense at all.  This
matches the other browsers. -->


<dt><code title=""><dfn id=command-insertimage title=command-insertimage>insertImage</dfn></code>

<dd><p><strong>Action</strong>: The user agent must run the following steps:

<ol>
  <li>If <var title="">value</var> is the empty string, abort these steps and do
  nothing.
  <!-- Similar logic to createLink, except even more compelling, since an HTML
  document linking to itself as an image is just silly.  In fact, the current
  HTML spec instructs UAs to not even try displaying the image, and just fail
  immediately if the URL is empty.  Firefox 4b11 bails out on an empty string,
  but the other three browsers I tested stick in the <img> anyway. -->

  <li>Run <a href=http://html5.org/specs/dom-range.html#dom-range-deletecontents><code class=external data-anolis-spec=domrange title=dom-Range-deleteContents>deleteContents()</code></a> on the <a href=http://html5.org/specs/dom-range.html#range><code class=external data-anolis-spec=domrange>Range</code></a>.

  <li>Let (<var title="">node</var>, <var title="">offset</var>) be the <a href=http://html5.org/specs/dom-range.html#range><code class=external data-anolis-spec=domrange>Range</code></a>'s
  <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a>.

  <li>Let <var title="">img</var> be a new <a href=#html-element>HTML element</a> with
  <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-element-local-name title=concept-element-local-name>local name</a> "img", the same <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-ownerdocument><code class=external data-anolis-spec=domcore title=dom-Node-ownerDocument>ownerDocument</code></a> as <var title="">node</var>, and a
  single <a href=#html-attribute>HTML attribute</a> with <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-attr-local-name title=concept-attr-local-name>local name</a> "src" and with
  <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-attr-value title=concept-attr-value>value</a> <var title="">value</var>.
  <!-- No alt text, so it's invalid.  This matches all browsers. -->

  <li>If <var title="">node</var> is a <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#text><code class=external data-anolis-spec=domcore>Text</code></a> node, and <var title="">offset</var> is not
  equal to 0 or the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-node-length title=concept-node-length>length</a> of <var title="">node</var>, run <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-text-splittext><code class=external data-anolis-spec=domcore title=dom-Text-splitText>splitText(<var title="">offset</var>)</code></a> on
  <var title="">node</var>.

  <li>If <var title="">node</var> is a <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#text><code class=external data-anolis-spec=domcore>Text</code></a>, <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#comment><code class=external data-anolis-spec=domcore>Comment</code></a>, or
  <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#processinginstruction><code class=external data-anolis-spec=domcore>ProcessingInstruction</code></a> node, run <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-insertbefore><code class=external data-anolis-spec=domcore title=dom-Node-insertBefore>insertBefore(<var title="">img</var>,
  <var title="">node</var>)</code></a> on the parent of <var title="">node</var>.

  <li>Otherwise, let <var title="">child</var> be the <var title="">offset</var>th child of
  <var title="">node</var> (or null if there is no such child), and run <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-insertbefore><code class=external data-anolis-spec=domcore title=dom-Node-insertBefore>insertBefore(<var title="">img</var>,
  <var title="">child</var>)</code></a> on <var title="">node</var>.
</ol>

<dd><p><strong>State</strong>:

<dd><p><strong>Value</strong>:


<dt><code title=""><dfn id=command-italic title=command-italic>italic</dfn></code>

<dd><p><strong>Action</strong>: <a href=#decompose>Decompose</a> the <a href=http://html5.org/specs/dom-range.html#range><code class=external data-anolis-spec=domrange>Range</code></a>.  If the
state of the <a href=http://html5.org/specs/dom-range.html#range><code class=external data-anolis-spec=domrange>Range</code></a> for this command is then true, <a href=#style>style</a> each
returned <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#node><code class=external data-anolis-spec=domcore>Node</code></a> with <var title="">property</var> "font-style" and <var title="">new
value</var> "italic".  Otherwise, <a href=#style>style</a> them with <var title="">new
value</var> "normal".

<dd><p><strong>State</strong>: True if every <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element><code class=external data-anolis-spec=domcore>Element</code></a> that is
<a href=#effectively-contained>effectively contained</a> in the <a href=http://html5.org/specs/dom-range.html#range><code class=external data-anolis-spec=domrange>Range</code></a> has computed font-style
"italic" or "oblique", and the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-parent title=concept-tree-parent>parent</a> of every <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#text><code class=external data-anolis-spec=domcore>Text</code></a> node that is
<a href=#effectively-contained>effectively contained</a> in the <a href=http://html5.org/specs/dom-range.html#range><code class=external data-anolis-spec=domrange>Range</code></a> has computed font-style
"italic" or "oblique".  Otherwise false.

<dd><p><strong>Value</strong>: Always the empty string.


<dt><code title=""><dfn id=command-unlink title=command-unlink>unlink</dfn></code>

<dd><p><strong>Action</strong>: The user agent must execute the following
steps:
<!-- IE 9 RC unlinks the whole link you're pointing at.  Others just unlink
your selection, which does nothing if you have nothing selected.
Unfortunately, everyone but IE winds up doing some DOM surgery here in some
cases, creating and splitting elements in some cases. -->

<p class=XXX>This is based on what IE does.  Other browsers only unlink the
selected portion, which might be more user-friendly but involves chopping up
and reorganizing the DOM.  Revisit this later to see if it's reasonable to spec
what the other browsers do instead.

<ol>
  <li>Let <var title="">links</var> be a <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-collection title=concept-collection>collection</a> rooted at the <a href=http://html5.org/specs/dom-range.html#range><code class=external data-anolis-spec=domrange>Range</code></a>'s
  <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-root title=concept-range-root>root</a>, whose filter matches only <a href=#html-element title="HTML element">HTML
  elements</a> with <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-element-local-name title=concept-element-local-name>local name</a> "a", that have an <a href=#html-attribute>HTML
  attribute</a> with <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-attr-local-name title=concept-attr-local-name>local name</a> "href".

  <li>Let <var title="">selected</var> be a <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-collection title=concept-collection>collection</a> rooted at the <a href=http://html5.org/specs/dom-range.html#range><code class=external data-anolis-spec=domrange>Range</code></a>'s
  <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-root title=concept-range-root>root</a>, whose filter matches only <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#node><code class=external data-anolis-spec=domcore>Node</code></a>s that are <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#contained>contained</a> in
  the <a href=http://html5.org/specs/dom-range.html#range><code class=external data-anolis-spec=domrange>Range</code></a> and <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#text><code class=external data-anolis-spec=domcore>Text</code></a> nodes that are <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#partially-contained>partially contained</a> in the
  <a href=http://html5.org/specs/dom-range.html#range><code class=external data-anolis-spec=domrange>Range</code></a>.

  <li>For each <var title="">link</var> in <var title="">links</var>, in <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#tree-order>tree order</a>:

  <ol>
    <li>If <var title="">link</var> is not in <var title="">selected</var> and is not an
    <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-tree-ancestor title=concept-tree-ancestor>ancestor</a> of any <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#node><code class=external data-anolis-spec=domcore>Node</code></a> in <var title="">selected</var>, continue with the next
    <var title="">link</var>.

    <li>While <var title="">link</var> has children, insert <var title="">link</var>'s first
    child into its parent as <var title="">link</var>'s previous sibling.

    <li>Remove <var title="">link</var>.

    <p class=XXX>This means it disappears even if it had an id, class, etc.
    Maybe not what we want?
  </ol>
</ol>

<dd><p><strong>State</strong>: Always false.

<dd><p><strong>Value</strong>: Always the empty string.


<dt><code title=""><dfn id=command-underline title=command-underline>underline</dfn></code>

<dd class=XXX><p><strong>Action</strong>: ???  This is totally unreasonable,
because CSS text-decoration is a nightmare.  Styling is easy, unstyling is only
possible through massive hacks.

<dd class=XXX><p><strong>State</strong>: ...

<dd><p><strong>Value</strong>: Always the empty string.
</dl>


<h2 class=no-num id=references>References</h2><!--REFS-->
<p>All references are normative unless marked "Non-normative".</p>
<div id=anolis-references><dl></dl></div>


<h2 class=no-num id=acknowledgements>Acknowledgements</h2>
<p>Thanks to:

<ul>
  <li>Google, for funding this work
  <li>Ian Hickson, for overseeing it
  <li>Julie Parent, Ojan Vafai, Alex Russel, and Eric Seidel for their <a href=http://lists.whatwg.org/htdig.cgi/whatwg-whatwg.org/2009-December/024627.html>research</a>
  on how browsers and other rich text editors behave in many common scenarios
  <li>Ryosuke Niwa, Julie Parent, and Roland Steiner for their feedback on
  drafts of this document
</ul>

<script src=http://www.whatwg.org/specs/web-apps/current-work/dfn.js></script>
<!-- vim: set expandtab shiftwidth=2 tabstop=2: -->

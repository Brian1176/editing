<!DOCTYPE html><meta charset=utf-8>
<title>HTML Editing Commands</title>
<link href=http://www.whatwg.org/style/specification rel=stylesheet>
<style>
 pre, code { font-family:monospace, sans-serif; }
 h2 code, h3 code, h4 code,
 h2 :link, h3 :link, h4 :link,
 h2 :visited, h3 :visited, h4 :visited
 { font:inherit; color:inherit; font-style:italic; }
 @media print {
   :not([data-anolis-spec]) > [data-anolis-spec]::after {
     content: "[" attr(data-anolis-spec) "]";
     font-size: 0.6em;
     vertical-align: super;
     text-transform: uppercase;
   }
 }
</style>
<body class=draft>
<div class=head id=head>
<h1>HTML Editing Commands</h1>
<h2 class="no-num no-toc" id=work-in-progress-&mdash;-last-update-22-february-2011>Work in Progress &mdash; Last Update 22 February 2011</h2>
<dl>
 <dt>Editor
 <dd>Aryeh Gregor &lt;ayg+spec@aryeh.name&gt;

 <dt>Version history
 <dd><a href="http://aryeh.name/gitweb.cgi?p=editcommands">http://aryeh.name/gitweb.cgi?p=editcommands</a>
</dl>
</div>


<h2 class=no-num id=table-of-contents>Table of contents</h2>

<!--begin-toc-->
<ol class=toc>
 <li><a class=no-num href=#table-of-contents>Table of contents</a></li>
 <li><a href=#introduction><span class=secno>1 </span>Introduction</a></li>
 <li><a href=#issues><span class=secno>2 </span>Issues</a></li>
 <li><a href=#definitions><span class=secno>3 </span>Definitions</a></li>
 <li><a href=#decomposing-a-range-into-nodes><span class=secno>4 </span>Decomposing a Range into Nodes</a></li>
 <li><a href=#unstyling-an-element><span class=secno>5 </span>Unstyling an element</a></li>
 <li><a href=#styling-a-range><span class=secno>6 </span>Styling a Range</a></li>
 <li><a href=#unstyling-a-range><span class=secno>7 </span>Unstyling a Range</a></li>
 <li><a href=#commands><span class=secno>8 </span>Commands</a></li>
 <li><a class=no-num href=#references>References</a></ol>
<!--end-toc-->


<h2 id=introduction><span class=secno>1 </span>Introduction</h2>
<p>This specification defines commands to edit HTML documents programmatically.
The APIs specified here were originally introduced in Microsoft's Internet
Explorer, but have subsequently been copied by other browsers in a haphazard
and imprecise fashion.  Although the behavior specified here does not exactly
match any browser at the time of writing, it can serve as a target to converge
to in the future.

<p>Where the reasoning behind the specification is of interest, such as when
major preexisting rendering engines are known not to match it, the reasoning is
included in HTML comments so as not to distract the reader.


<h2 id=issues><span class=secno>2 </span>Issues</h2>

<ul>
  <li><p>Need to make CSS terminology more precise, about setting/unsetting CSS
  properties.  The intent is to modify the style attribute, CSSOM-style.

  <li><p>Also not sure about computed style.  There are differences between
  "computed" and "used" and things like that, what do we actually want here?

  <li><p>Some of the DOM stuff might benefit from more precision.  E.g., is
  there a precise algorithm for what it means to append a node someplace, if
  that node is already somewhere in the DOM?  What does that do if it's
  selected, it has state (like a video or animated image), etc.?
</ul>


<h2 id=definitions><span class=secno>3 </span>Definitions</h2>

<p>A <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#node><code class=external data-anolis-spec=domcore>Node</code></a> is an <dfn id=html-element>HTML element</dfn> if it is an <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element><code class=external data-anolis-spec=domcore>Element</code></a> whose
<a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-element-namespace title=concept-element-namespace>namespace</a> is the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#html-namespace>HTML namespace</a>.

<p>The <dfn id=first-node>first node</dfn> of a <a href=http://html5.org/specs/dom-range.html#range><code class=external data-anolis-spec=domrange>Range</code></a> is the <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#node><code class=external data-anolis-spec=domcore>Node</code></a> returned by the
following algorithm:

<ol>
  <li><p>Let <var title="">range</var> be the <a href=http://html5.org/specs/dom-range.html#range><code class=external data-anolis-spec=domrange>Range</code></a> under discussion.

  <li><p>If <var title="">range</var>'s <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-offset title=concept-boundary-point-offset>offset</a> is equal to
  the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-node-length title=concept-node-length>length</a> of its <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a>, return the first
  <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#node><code class=external data-anolis-spec=domcore>Node</code></a> that is after the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a> and all its
  <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-descendant-node title=concept-descendant-node>descendants</a> (if any) in <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#tree-order>tree order</a>.  If there is no such <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#node><code class=external data-anolis-spec=domcore>Node</code></a>,
  return the last <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#node><code class=external data-anolis-spec=domcore>Node</code></a> in the document.

  <li><p>If <var title="">range</var>'s <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a> is a <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#text><code class=external data-anolis-spec=domcore>Text</code></a>,
  <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#comment><code class=external data-anolis-spec=domcore>Comment</code></a>, or <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#processinginstruction><code class=external data-anolis-spec=domcore>ProcessingInstruction</code></a> node, return that.

  <li><p>If <var title="">range</var>'s <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a> has children,
  return the child with <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-indexof title=concept-indexof>index</a> equal to the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-offset title=concept-boundary-point-offset>offset</a>.

  <li><p>Return <var title="">range</var>'s <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a>.
</ol>

<p>The <dfn id=beginning-element>beginning element</dfn> of a <a href=http://html5.org/specs/dom-range.html#range><code class=external data-anolis-spec=domrange>Range</code></a> is its <a href=#first-node>first
node</a> if that is an <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element><code class=external data-anolis-spec=domcore>Element</code></a>; or the parent of its <a href=#first-node>first
node</a>, if <em>that</em> is an <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element><code class=external data-anolis-spec=domcore>Element</code></a>; or else null.

<p class=XXX>(It will be null only in weird cases, like selecting a comment
whose parent is a document, or the child of a document fragment, or whatever.
I'm ignoring those cases for now.)

<p>The <dfn id=active-range>active range</dfn> of a <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#document><code class=external data-anolis-spec=domcore>Document</code></a> is the value returned by the
following algorithm:

<ol>
  <li><p>Let <var title="">selection</var> be the result of calling <a href=http://html5.org/specs/dom-range.html#dom-document-getselection><code class=external data-anolis-spec=domrange title=dom-Document-getSelection>getSelection()</code></a> on
  the <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#document><code class=external data-anolis-spec=domcore>Document</code></a>.

  <li><p>If there are no <a href=http://html5.org/specs/dom-range.html#range><code class=external data-anolis-spec=domrange>Range</code></a>s associated with <var title="">selection</var>,
  return null.

  <li><p>Let <var title="">start</var> be the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point title=concept-boundary-point>boundary point</a> with the earliest
  <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-bp-position title=concept-bp-position>position</a> among all of <var title="">selection</var>'s <a href=http://html5.org/specs/dom-range.html#range><code class=external data-anolis-spec=domrange>Range</code></a>s'
  <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>starts</a>.

  <li><p>Return the last <a href=http://html5.org/specs/dom-range.html#range><code class=external data-anolis-spec=domrange>Range</code></a> in <var title="">selection</var> whose <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a>
  is <var title="">start</var>.
  <!-- This is what Firefox seems to do, no reason to change it . . . -->

  <p class=note>In user agents that support only one <a href=http://html5.org/specs/dom-range.html#range><code class=external data-anolis-spec=domrange>Range</code></a> per
  <a href=http://html5.org/specs/dom-range.html#selection><code class=external data-anolis-spec=domrange>Selection</code></a>, <var title="">range</var> will simply be the only <a href=http://html5.org/specs/dom-range.html#range><code class=external data-anolis-spec=domrange>Range</code></a> associated
  to <var title="">selection</var>.
</ol>


<h2 id=decomposing-a-range-into-nodes><span class=secno>4 </span>Decomposing a Range into Nodes</h2>
<p>When a user agent is to <dfn id=decompose-a-range>decompose a <code class=external data-anolis-spec=domrange>Range</code></dfn> <var title="">range</var>, it must run the following steps.

<p class=note>The algorithm returns a list of <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#node><code class=external data-anolis-spec=domcore>Node</code></a>s in the <a href=http://html5.org/specs/dom-range.html#range><code class=external data-anolis-spec=domrange>Range</code></a> that
are not contained in any other <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#node><code class=external data-anolis-spec=domcore>Node</code></a> in the <a href=http://html5.org/specs/dom-range.html#range><code class=external data-anolis-spec=domrange>Range</code></a>.  It splits <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#text><code class=external data-anolis-spec=domcore>Text</code></a>
nodes if necessary, but isn't picky about <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#comment><code class=external data-anolis-spec=domcore>Comment</code></a>s or
<a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#processinginstruction><code class=external data-anolis-spec=domcore>ProcessingInstruction</code></a>s.

<ol>
  <li><p>Let <var title="">start node</var>, <var title="">start offset</var>, <var title="">end node</var>, and <var title="">end offset</var> be the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a>
  and <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-end title=concept-range-end>end</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>nodes</a> and <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-offset title=concept-boundary-point-offset>offsets</a> of <var title="">range</var>,
  respectively.

  <li><p>If <var title="">start node</var> or <var title="">end node</var> is not an
  <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element><code class=external data-anolis-spec=domcore>Element</code></a>, <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#text><code class=external data-anolis-spec=domcore>Text</code></a>, <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#processinginstruction><code class=external data-anolis-spec=domcore>ProcessingInstruction</code></a>, or <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#comment><code class=external data-anolis-spec=domcore>Comment</code></a> node, or is
  not an <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element><code class=external data-anolis-spec=domcore>Element</code></a> and has no parent, abort these steps.

  <p class=XXX>Figure out something sensible here.

  <li><p>If <var title="">start node</var> and <var title="">end node</var> are both
  <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#text><code class=external data-anolis-spec=domcore>Text</code></a> nodes, and <var title="">start node</var> is the same as <var title="">end
  node</var>, and neither <var title="">start offset</var> nor <var title="">end
  offset</var> is equal to 0 or the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-node-length title=concept-node-length>length</a> of <var title="">start
  node</var>:

  <ol>
    <li><p>Run <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-text-splittext><code class=external data-anolis-spec=domcore title=dom-Text-splitText>splitText(<var title="">start offset</var>)</code></a> on
    <var title="">start node</var> and set <var title="">start node</var> to the
    result.

    <li><p>Run <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-text-splittext><code class=external data-anolis-spec=domcore title=dom-Text-splitText>splitText(<var title="">end offset</var> &minus; <var title="">start offset</var>)</code></a> on <var title="">start node</var> and set
    <var title="">start node</var> to the previous sibling of the result.

    <li><p>Return the list consisting of the single <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#node><code class=external data-anolis-spec=domcore>Node</code></a> <var title="">start
    node</var>, and abort these steps.
  </ol>

  <li><p>If <var title="">start node</var> is a <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#text><code class=external data-anolis-spec=domcore>Text</code></a> node and <var title="">start
  offset</var> is neither 0 nor the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-node-length title=concept-node-length>length</a> of <var title="">start
  node</var>, run <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-text-splittext><code class=external data-anolis-spec=domcore title=dom-Text-splitText>splitText(<var title="">start offset</var>)</code></a> on
  <var title="">start node</var> and set <var title="">start node</var> to the
  returned node.  Set <var title="">start offset</var> to 0.

  <li><p>If <var title="">end node</var> is a <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#text><code class=external data-anolis-spec=domcore>Text</code></a> node and <var title="">end
  offset</var> is neither 0 nor the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-node-length title=concept-node-length>length</a> of <var title="">end
  node</var>, run <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-text-splittext><code class=external data-anolis-spec=domcore title=dom-Text-splitText>splitText(<var title="">end offset</var>)</code></a> on
  <var title="">end node</var> and set <var title="">end node</var> to the previous
  sibling of the returned node.  Set <var title="">end offset</var> to the
  <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-node-length title=concept-node-length>length</a> of the new <var title="">end node</var>.

  <li><p>If <var title="">start node</var> is an <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element><code class=external data-anolis-spec=domcore>Element</code></a> with at least one
  child, let <var title="">node</var> be the child of <var title="">start node</var>
  with <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-indexof title=concept-indexof>index</a> <var title="">start offset</var>.

  <li><p>Otherwise, if <var title="">start node</var> is a <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#text><code class=external data-anolis-spec=domcore>Text</code></a> node and <var title="">start offset</var> is its <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-node-length title=concept-node-length>length</a>, let <var title="">node</var> be
  the first <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#node><code class=external data-anolis-spec=domcore>Node</code></a> after <var title="">start node</var> in <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#tree-order>tree order</a>.

  <li><p>Otherwise, let <var title="">node</var> be <var title="">start node</var>.

  <li><p>If <var title="">end node</var> is an <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element><code class=external data-anolis-spec=domcore>Element</code></a> and <var title="">end
  offset</var> is not 0, let <var title="">end</var> be the child of <var title="">end node</var> with <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-indexof title=concept-indexof>index</a> <var title="">end offset</var> &minus; 1.

  <li><p>Otherwise, if <var title="">end offset</var> is 0, let <var title="">end</var> be the first <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#node><code class=external data-anolis-spec=domcore>Node</code></a> before <var title="">end node</var> in
  <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#tree-order>tree order</a>.

  <li><p>Otherwise, let <var title="">end</var> be <var title="">end node</var>.

  <!-- We try to include a node's parent instead of that node if possible,
  because this generally reduces the number of nodes we're handling.  So if the
  string "oo bar" was selected in <b>Foo <i>bar</i></b>, we'd add the <i> to
  the selection, even if the browser registered the end as the text node "bar".
  -->
  <li><p>While <var title="">node</var> is the first child of its parent and <var title="">end</var> is not a <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-descendant-node title=concept-descendant-node>descendant</a> of <var title="">node</var>'s parent,
  set <var title="">node</var> to its parent.

  <li><p>While <var title="">end</var> is the last child of its parent and <var title="">node</var> is not a <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-descendant-node title=concept-descendant-node>descendant</a> of <var title="">end</var>'s parent,
  set <var title="">end</var> to its parent.

  <li><p>Let <var title="">node list</var> be an empty list of <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#node><code class=external data-anolis-spec=domcore>Node</code></a>s.

  <li><p>While <var title="">node</var> is not after <var title="">end</var> in
  <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#tree-order>tree order</a>:

  <ol>
    <li><p>Append <var title="">node</var> to <var title="">node list</var>.

    <li><p>Set <var title="">node</var> to the first <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#node><code class=external data-anolis-spec=domcore>Node</code></a> in <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#tree-order>tree order</a>
    that is after <var title="">node</var> and (if applicable) all its
    <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-descendant-node title=concept-descendant-node>descendants</a>.  If no such <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#node><code class=external data-anolis-spec=domcore>Node</code></a> exists, break out of these substeps.

    <li><p>While <var title="">node</var> is an <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-ancestor-node title=concept-ancestor-node>ancestor</a> of <var title="">end</var>, set <var title="">node</var> to its first child.
  </ol>

  <li><p>Return <var title="">node list</var>.
</ol>


<h2 id=unstyling-an-element><span class=secno>5 </span>Unstyling an element</h2>
<p>When a user agent is to <dfn id=unstyle-an-element>unstyle an element</dfn>, it must run the
following steps.  This algorithm might remove the element from the DOM and
insert other elements in its place, in which case it will return an ordered
list of the element's former children.

<ol>
  <li><p>Let <var title="">element</var> be the <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element><code class=external data-anolis-spec=domcore>Element</code></a> to be unstyled.

  <li><p>Let <var title="">property name</var> and <var title="">tag list</var> be as
  in the invoking algorithm.

  <li><p>Let <var title="">element children</var> be the <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element><code class=external data-anolis-spec=domcore>Element</code></a> children of
  <var title="">element</var>.

  <li><p><a href=#unstyle-an-element title="unstyle an element">Unstyle</a> each <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element><code class=external data-anolis-spec=domcore>Element</code></a> in
  <var title="">element children</var>, in order.

  <p class=note>Unstyling an element can change the number of children its
  parent has, so the list of children to unstyle needs to be computed
  beforehand.

  <li><p>Let <var title="">children</var> be an empty list of <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#node><code class=external data-anolis-spec=domcore>Node</code></a>s.

  <li><p>If either

  <ul>
    <li><p><var title="">element</var> is an <a href=#html-element>HTML element</a> with
    <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-element-local-name title=concept-element-local-name>local name</a> either "span" or in <var title="">tag list</var>, and it has
    only a single attribute, and that attribute is named "style", and
    that style attribute sets only the CSS property <var title="">property
    name</var>; or

    <li><p><var title="">element</var> is an <a href=#html-element>HTML element</a> with
    <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-element-local-name title=concept-element-local-name>local name</a> in <var title="">tag list</var> and it has no attributes,
  </ul>

  <p>then:

  <ol>
    <li><p>While <var title="">element</var> has children:

    <ol>
      <li><p>Let <var title="">child</var> be the first child of <var title="">element</var>.

      <li><p>Append <var title="">child</var> to <var title="">children</var>.

      <li><p>Insert <var title="">child</var> as the previous sibling of <var title="">element</var>.
    </ol>

    <li><p>Remove <var title="">element</var>.

    <li><p>Return <var title="">children</var> and abort this algorithm.
  </ol>

  <li><p>Unset the CSS property <var title="">property name</var> of <var title="">element</var>.

  <li><p>If <var title="">element</var> is an <a href=#html-element>HTML element</a> with
  <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-element-local-name title=concept-element-local-name>local name</a> in <var title="">tag list</var>:

  <ol>
    <li><p>Let <var title="">new element</var> be a new <a href=#html-element>HTML element</a> with
    <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-element-local-name title=concept-element-local-name>local name</a> "span", with the same attributes and <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-ownerdocument><code class=external data-anolis-spec=domcore title=dom-Node-ownerDocument>ownerDocument</code></a>
    as <var title="">element</var>.

    <li><p>Append <var title="">new element</var> to <var title="">element</var>'s
    parent as the previous sibling of <var title="">element</var>.

    <li><p>While <var title="">element</var> has children:

    <ol>
      <li><p>Let <var title="">child</var> be the first child of <var title="">element</var>.

      <li><p>Append <var title="">child</var> to <var title="">children</var>.

      <li><p>Append <var title="">child</var> as the last child of <var title="">new
      element</var>.
    </ol>

    <li><p>Remove <var title="">element</var>.
  </ol>

  <li><p>Return <var title="">children</var>.
</ol>


<h2 id=styling-a-range><span class=secno>6 </span>Styling a Range</h2>
<p>When a user agent is to <dfn id=style-a-range>style a <code class=external data-anolis-spec=domrange>Range</code></dfn> <var title="">range</var>, it must
run the following steps.  There are four inputs: a CSS property name <var title="">property name</var>, a new value <var title="">property value</var>, a
nonempty list of strings <var title="">tag list</var>, and a string
<var title="">commandId</var>.

<div class=XXX>
<p>This description tries to keep the algorithm as simple as possible at the
expense of producing much more complicated markup in some cases than a slightly
more sophisticated algorithm.  It's similar to what Gecko does in spirit,
although the details differ.  The basic cause of most of the ugly markup is
that we don't bake in any element nesting restrictions, so <code title="">&lt;em&gt;Abc&lt;/em&gt; &lt;em&gt;def&lt;/em&gt;</code> becomes <code title="">&lt;em
style=font-weight:bold&gt;Abc&lt;/em&gt;&lt;b&gt; &lt;/b&gt;&lt;em
style=font-weight:bold&gt;def&lt;/em&gt;</code> instead of just <code title="">&lt;b&gt;&lt;em&gt;Abc&lt;/em&gt; &lt;em&gt;def&lt;/em&gt;&lt;/b&gt;</code>.  Otherwise
we'd have to add content model checks.  Maybe this is worth it?  IE and WebKit
seem to do it, Gecko and Opera seem not to (they only wrap text nodes AFAICT).

<p>I did add some complication by saying conflicting inline style needs to be
removed.  This is what WebKit does.  Gecko and IE9 leave it alone, which leads
to stuff like <code title="">&lt;b&gt;&lt;span
style=font-weight:100&gt;Foo&lt;/span&gt;&lt;/b&gt;</code> that doesn't actually work.
Opera avoids the problem by producing code like <code title="">&lt;span
style=font-weight:100&gt;&lt;b&gt;Foo&lt;/b&gt;&lt;/span&gt;</code>, but that doesn't work
with the CSS-based strategy.
</div>

<ol>
  <li><p>Let <var title="">node list</var> be the result of <a href=#decompose-a-range title="decompose
  a range">decomposing</a> <var title="">range</var>.

  <li><p>For each <var title="">node</var> in <var title="">node list</var>, in <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#tree-order>tree order</a>:

  <ol>
    <li><p>If <var title="">node</var> is an <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element><code class=external data-anolis-spec=domcore>Element</code></a>:

    <ol>
      <li><p>If <var title="">node</var> is an <a href=#html-element>HTML element</a> with <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-element-local-name title=concept-element-local-name>local name</a>
      in <var title="">tag list</var>, unset the CSS property <var title="">property
      name</var> of <var title="">node</var>.  Otherwise, set the CSS property
      <var title="">property name</var> of <var title="">node</var> to <var title="">property value</var>.

      <li><p>If the <a href=#state>state</a> of <var title="">commandId</var> on
      <var title="">node</var> is false, set the CSS property <var title="">property name</var>
      of <var title="">node</var> to <var title="">property value</var>.
      <!-- This fixes cases where the element won't actually create the desired
      style.  E.g., <span style=font-weight:lighter><b>Foo</b></span> will not
      actually bold "Foo" (because the default style for <b> is font-weight:
      bolder), so we do <b style=font-weight:bold> instead.  Likewise when we
      do similarly a bit later on in this algorithm. -->

      <li><p>Let <var title="">element children</var> be the <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element><code class=external data-anolis-spec=domcore>Element</code></a> children
      of <var title="">node</var>.

      <li><p><a href=#unstyle-an-element title="unstyle an element">Unstyle</a> each <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element><code class=external data-anolis-spec=domcore>Element</code></a>
      in <var title="">element children</var>, in order.

      <p class=note>Unstyling an element can change the number of children its
      parent has, so the list of children to unstyle needs to be computed
      beforehand.
    </ol>

    <li><p>Otherwise, if <var title="">node</var> is a <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#text><code class=external data-anolis-spec=domcore>Text</code></a> node:

    <ol>
      <!-- This next step is not strictly necessary from a user point of view,
      since there's no visible difference.  We could just always insert a new
      element.  But that can drastically complicate the DOM if there are lots
      of text nodes, which happens easily when the algorithms here are invoked
      a lot: you get splitText() called when decomposing ranges, and unstyling
      elements can also dump their text node children into the DOM next to
      other text nodes. -->
      <li><p>If the previous sibling of <var title="">node</var> is an <a href=#html-element>HTML
      element</a> with <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-element-local-name title=concept-element-local-name>local name</a> in <var title="">tag list</var> with no
      attributes, and the <a href=#state>state</a> of <var title="">commandId</var> on
      <var title="">node</var> is true, let <var title="">new parent</var> equal the previous
      sibling of <var title="">node</var>.

      <li><p>Otherwise, let <var title="">new parent</var> be a new <a href=#html-element>HTML
      element</a> with <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-element-local-name title=concept-element-local-name>local name</a> equal to the first string in <var title="">tag
      list</var>, with no attributes, and <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-ownerdocument><code class=external data-anolis-spec=domcore title=dom-Node-ownerDocument>ownerDocument</code></a> the same as
      <var title="">node</var>.  Append <var title="">new parent</var> to <var title="">node</var>'s
      parent as the previous sibling of <var title="">node</var>.

      <li><p>If the <a href=#state>state</a> of <var title="">commandId</var> on <var title="">new
      parent</var> is false, set the CSS property <var title="">property name</var> of
      <var title="">new parent</var> to <var title="">property value</var>.

      <li><p>Append <var title="">node</var> to <var title="">new parent</var> as
      its last child.
    </ol>

    <li><p>Otherwise, do nothing.
  </ol>
</ol>

<!-- Out of IE9, Gecko, WebKit, and Opera, when asked to (e.g.) bold an
element, IE9 and WebKit and Opera wrap various descendants in <b> or <strong>;
Gecko just adds a style attribute.  The latter is simpler, particularly because
you then don't have to worry about making sure you only insert your tags in a
valid place (which you have to so that text/html serialization is possible, if
nothing else).  I originally specced the former approach, available in git
history. -->


<h2 id=unstyling-a-range><span class=secno>7 </span>Unstyling a Range</h2>
<p>When a user agent is to <dfn id=unstyle-a-range>unstyle a <code class=external data-anolis-spec=domrange>Range</code></dfn> <var title="">range</var>, it must
run the following steps.  There are four inputs: a CSS property name <var title="">property name</var>, a new value <var title="">property value</var>, a
possibly empty list of strings <var title="">tag list</var>, and a string
<var title="">commandId</var>.

<ol>
  <li><p>Let <var title="">node list</var> be the result of <a href=#decompose-a-range title="decompose
  a range">decomposing</a> <var title="">range</var>.

  <li><p>For each <var title="">node</var> in <var title="">node list</var>, in
  order:

  <ol>
    <li><p>If <var title="">node</var> is an <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element><code class=external data-anolis-spec=domcore>Element</code></a>:

    <ol>
      <li><p>Let <var title="">children</var> be the result of <a href=#unstyle-an-element title="unstyle an element">unstyling</a> <var title="">node</var>.

      <li><p>If <var title="">node</var> no longer has a parent:

      <ol>
        <li><p>Insert all the <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#node><code class=external data-anolis-spec=domcore>Node</code></a>s in <var title="">children</var> into <var title="">node list</var> immediately after <var title="">node</var>, in
        order.

        <li><p>Continue with the next <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#node><code class=external data-anolis-spec=domcore>Node</code></a> in <var title="">node list</var>,
        if any.

        <p class=note>The next <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#node><code class=external data-anolis-spec=domcore>Node</code></a> will be the first former child of <var title="">node</var>, if <var title="">node</var> had children.
      </ol>

      <li><p>If the computed value of <var title="">property name</var> for <var title="">node</var> is not <var title="">property value</var>, set the CSS
      property <var title="">property name</var> of <var title="">node</var> to <var title="">property value</var>.

      <li><p>Let <var title="">element children</var> be the <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element><code class=external data-anolis-spec=domcore>Element</code></a> children
      of <var title="">node</var>.

      <li><p><a href=#unstyle-an-element title="unstyle an element">Unstyle</a> each <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element><code class=external data-anolis-spec=domcore>Element</code></a>
      in <var title="">element children</var>, in order.

      <p class=note>Unstyling an element can change the number of children its
      parent has, so the list of children to unstyle needs to be computed
      beforehand.
    </ol>

    <li><p>Otherwise, if <var title="">node</var> is a <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#text><code class=external data-anolis-spec=domcore>Text</code></a> node and the computed value of <var title="">property name</var> for <var title="">node</var>'s parent is not <var title="">property value</var>:

    <ol>
      <li><p>Let <var title="">new parent</var> be a new <a href=#html-element>HTML element</a> with
      <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-element-local-name title=concept-element-local-name>local name</a> "span", with no attributes, and with <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-ownerdocument><code class=external data-anolis-spec=domcore title=dom-Node-ownerDocument>ownerDocument</code></a> equal to <var title="">node</var>'s.

      <li><p>Set the CSS property <var title="">property name</var> of <var title="">new parent</var> to <var title="">property value</var>.

      <li><p>Insert <var title="">new parent</var> as <var title="">node</var>'s
      previous sibling.

      <li><p>Append <var title="">node</var> to <var title="">new parent</var> as its
      child.
    </ol>

    <li><p>Otherwise, do nothing.
  </ol>
</ol>


<h2 id=commands><span class=secno>8 </span>Commands</h2>
<p>The <dfn id=execcommand() title=execCommand()><code>execCommand(<var title="">commandId</var>,
<var title="">showUI</var>, <var title="">value</var>)</code></dfn> method on the
<a href=http://www.whatwg.org/html/#htmldocument><code class=external data-anolis-spec=html>HTMLDocument</code></a> interface allows scripts to
perform actions on the current selection or at the current caret position.
Generally, these commands would be used to implement editor UI, for example
having a "delete" button on a toolbar.

<p>There are three variants to this method, with one, two, and three arguments
respectively. The <var title="">showUI</var> and <var title="">value</var>
parameters, even if specified, are ignored except where otherwise stated.

<p>When <a href=#execcommand()><code>execCommand()</code></a> is invoked, the user agent must take the
action from the list below given by <var title="">commandId</var> on the
<a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#context-object>context object</a>'s <a href=#active-range>active range</a>.  If no action is given or if
there is no <a href=#active-range>active range</a>, do nothing.

<p>The <dfn id=querycommandstate() title=queryCommandState()><code>queryCommandState(<var title="">commandId</var>)</code></dfn>
method on the <a href=http://www.whatwg.org/html/#htmldocument><code class=external data-anolis-spec=html>HTMLDocument</code></a> interface must
return the <a href=#state>state</a> of <var title="">commandId</var> on the
<a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#context-object>context object</a>'s <a href=#active-range>active range</a>.  If there is no <a href=#active-range>active
range</a>, return false.
<!-- Gecko throws an exception if there are no ranges in the selection, but
other engines seem to just return false, which seems like nicer behavior
anyway. -->

<p>The <dfn id=state>state</dfn> of a command <var title="">commandId</var> on a <a href=http://html5.org/specs/dom-range.html#range><code class=external data-anolis-spec=domrange>Range</code></a> is
given by the list below.  If <var title="">commandId</var> is not on the list, its
<a href=#state>state</a> is false on any <a href=http://html5.org/specs/dom-range.html#range><code class=external data-anolis-spec=domrange>Range</code></a>.  The <a href=#state>state</a> of a
command on a <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#node><code class=external data-anolis-spec=domcore>Node</code></a> <var title="">node</var> is the <a href=#state>state</a> of that command
on the <a href=http://html5.org/specs/dom-range.html#range><code class=external data-anolis-spec=domrange>Range</code></a> with <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> (<var title="">node</var>, 0), <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-end title=concept-range-end>end</a>
(<var title="">node</var>, <var title="">node</var>'s <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-node-length title=concept-node-length>length</a>), and <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-root title=concept-range-root>root</a> equal to
<var title="">node</var>'s <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-ownerdocument><code class=external data-anolis-spec=domcore title=dom-Node-ownerDocument>ownerDocument</code></a>.

<dl>
<dt><code title=""><dfn id=command-bold title=command-bold>bold</dfn></code>

<dd><p><strong>Action</strong>: If the state of the <a href=http://html5.org/specs/dom-range.html#range><code class=external data-anolis-spec=domrange>Range</code></a> for this command
is false, the user agent must <a href=#style-a-range title="style a range">style the
<code class=external data-anolis-spec=domrange>Range</code></a> with <var title="">property name</var> "font-weight", <var title="">property
value</var> "bold", and <var title="">tag list</var> ["b", "strong"].  Otherwise, it
must <a href=#unstyle-a-range title="unstyle a range">unstyle it</a> with <var title="">property
name</var> "font-weight", <var title="">property value</var> "normal", and <var title="">tag
list</var> ["b", "strong"].

<dd><p><strong>State</strong>: True if the <a href=#beginning-element>beginning element</a> of the
<a href=http://html5.org/specs/dom-range.html#range><code class=external data-anolis-spec=domrange>Range</code></a> has font-weight with computed value less than 700, otherwise false.


<dt><code title=""><dfn id=command-italic title=command-italic>italic</dfn></code>

<dd><p><strong>Action</strong>: If the of the <a href=http://html5.org/specs/dom-range.html#range><code class=external data-anolis-spec=domrange>Range</code></a> for this command is
false, the user agent must <a href=#style-a-range title="style a range">style the
<code class=external data-anolis-spec=domrange>Range</code></a> with <var title="">property name</var> "font-style", <var title="">property
value</var> "italic", and <var title="">tag list</var> ["i", "em"].  Otherwise, it must
<a href=#unstyle-a-range title="unstyle a range">unstyle it</a> with <var title="">property name</var>
"font-style", <var title="">property value</var> "normal", and <var title="">tag list</var> ["i",
"em"].

<dd><p><strong>State</strong>: True if the <a href=#beginning-element>beginning element</a> of the
<a href=http://html5.org/specs/dom-range.html#range><code class=external data-anolis-spec=domrange>Range</code></a> has font-style with computed value "italic" or "oblique", otherwise
false.


<dt><code title=""><dfn id=command-underline title=command-underline>underline</dfn></code>

<dd class=XXX><p><strong>Action</strong>: ???  This is totally unreasonable,
because CSS text-decoration is a nightmare.  Styling is easy, unstyling is only
possible through massive hacks.

<dd class=XXX><p><strong>State</strong>: ...

<p class=XXX>This is wrong, it will clear strikethrough and overline.  Also,
computed style isn't useful, because text-decoration doesn't inherit.
</dl>


<h2 class=no-num id=references>References</h2><!--REFS-->
<p>All references are normative unless marked "Non-normative".</p>
<div id=anolis-references><dl></dl></div>


<!--
<h2 class=no-num>Acknowledgements</h2>
<p>...
-->
<script src=http://www.whatwg.org/specs/web-apps/current-work/dfn.js></script>

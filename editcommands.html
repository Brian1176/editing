<!DOCTYPE html><meta charset=utf-8>
<title>HTML Editing Commands</title>
<link href=http://www.whatwg.org/style/specification rel=stylesheet>
<style>
 pre, code { font-family:monospace, sans-serif; }
 h2 code, h3 code, h4 code,
 h2 :link, h3 :link, h4 :link,
 h2 :visited, h3 :visited, h4 :visited
 { font:inherit; color:inherit; font-style:italic; }
 @media print {
   :not([data-anolis-spec]) > [data-anolis-spec]::after {
     content: "[" attr(data-anolis-spec) "]";
     font-size: 0.6em;
     vertical-align: super;
     text-transform: uppercase;
   }
 }
</style>
<body class=draft>
<div class=head id=head>
<h1>HTML Editing Commands</h1>
<h2 class="no-num no-toc" id=work-in-progress-&mdash;-last-update-24-february-2011>Work in Progress &mdash; Last Update 24 February 2011</h2>
<dl>
 <dt>Editor
 <dd>Aryeh Gregor &lt;ayg+spec@aryeh.name&gt;

 <dt>Version history
 <dd><a href="http://aryeh.name/gitweb.cgi?p=editcommands">http://aryeh.name/gitweb.cgi?p=editcommands</a>
</dl>
</div>


<h2 class=no-num id=table-of-contents>Table of contents</h2>

<!--begin-toc-->
<ol class=toc>
 <li><a class=no-num href=#table-of-contents>Table of contents</a></li>
 <li><a href=#introduction><span class=secno>1 </span>Introduction</a></li>
 <li><a href=#issues><span class=secno>2 </span>Issues</a></li>
 <li><a href=#definitions><span class=secno>3 </span>Definitions</a></li>
 <li><a href=#decomposing-a-range-into-nodes><span class=secno>4 </span>Decomposing a Range into Nodes</a></li>
 <li><a href=#unstyling-an-element><span class=secno>5 </span>Unstyling an element</a></li>
 <li><a href=#styling-a-range><span class=secno>6 </span>Styling a Range</a></li>
 <li><a href=#unstyling-a-range><span class=secno>7 </span>Unstyling a Range</a></li>
 <li><a href=#commands><span class=secno>8 </span>Commands</a></li>
 <li><a class=no-num href=#references>References</a></ol>
<!--end-toc-->


<h2 id=introduction><span class=secno>1 </span>Introduction</h2>
<p>This specification defines commands to edit HTML documents programmatically.
The APIs specified here were originally introduced in Microsoft's Internet
Explorer, but have subsequently been copied by other browsers in a haphazard
and imprecise fashion.  Although the behavior specified here does not exactly
match any browser at the time of writing, it can serve as a target to converge
to in the future.

<p>Where the reasoning behind the specification is of interest, such as when
major preexisting rendering engines are known not to match it, the reasoning is
included in HTML comments so as not to distract the reader.


<h2 id=issues><span class=secno>2 </span>Issues</h2>

<p>I'm not sure if my priorities in writing the algorithms here are correct.
My goals were 1) make the algorithms as simple as possible, and 2) minimize
surprising user-visible behavior (e.g., "I clicked B but it didn't turn
bold!").  I didn't try to optimize the niceness of the resulting DOM at all, so
for instance, when bolding <code title="">abc &lt;i&gt;def&lt;/i&gt; &lt;br&gt; ghi</code>
you get <code title="">&lt;b&gt;abc &lt;/b&gt;&lt;i style="font-weight:
bold"&gt;def&lt;/i&gt;&lt;b&gt; &lt;/b&gt;&lt;br style="font-weight: bold"&gt;&lt;b&gt;
ghi&lt;/b&gt;</code> instead of wrapping the whole thing in a single <code title="">&lt;b&gt;</code>.  This is to avoid making the algorithm understand content
models, but maybe it's worth revisiting later.  Likewise, unbolding the middle
word of <code title="">&lt;b&gt;Foo bar baz&lt;/b&gt;</code> produces <code title="">&lt;b&gt;Foo &lt;span style="font-weight: normal"&gt;bar&lt;/span&gt;
baz&lt;/b&gt;</code> instead of the simpler <code title="">&lt;b&gt;Foo &lt;/b&gt;bar&lt;b&gt;
baz&lt;/b&gt;</code>.  For now, the algorithm works, even if it produces messy
DOMs.

<p>Other issues:

<ul>
  <li><p>Need to make CSS terminology more precise, about setting/unsetting CSS
  properties.  The intent is to modify the style attribute, CSSOM-style.
  Likewise, CSS value comparisons need to be done after serializing both
  values, so "bold" == "700" and "red" == "#f00" and so on.

  <li><p>Also not sure about computed style.  There are differences between
  "computed" and "used" and things like that, what do we actually want here?

  <li><p>The wording I use for DOM stuff is a bit of a mess, often either
  imprecise or unreasonably verbose.  I'm not quite sure how to fix it.

  <li><p>I haven't put any thought yet into collapsed ranges or selections.
  Currently my algorithms mostly do nothing if the selection is collapsed,
  which is of course wrong.  E.g., bold with collapsed selection should put
  &lt;b&gt;&lt;/b&gt; at the cursor, generally.

  <li><p>I also don't pay attention to what happens to the selection when you
  mutate the DOM.  This is essential.
</ul>


<h2 id=definitions><span class=secno>3 </span>Definitions</h2>

<p>A <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#node><code class=external data-anolis-spec=domcore>Node</code></a> is an <dfn id=html-element>HTML element</dfn> if it is an <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element><code class=external data-anolis-spec=domcore>Element</code></a> whose
<a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-element-namespace title=concept-element-namespace>namespace</a> is the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#html-namespace>HTML namespace</a>.  An <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#attr><code class=external data-anolis-spec=domcore>Attr</code></a> is an <dfn id=html-attribute>HTML attribute</dfn> if its
<a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-attr-namespace title=concept-attr-namespace>namespace</a> is
the <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#html-namespace>HTML namespace</a>.

<p>The <dfn id=first-node>first node</dfn> of a <a href=http://html5.org/specs/dom-range.html#range><code class=external data-anolis-spec=domrange>Range</code></a> is the <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#node><code class=external data-anolis-spec=domcore>Node</code></a> returned by the
following algorithm:

<ol>
  <li><p>Let <var title="">range</var> be the <a href=http://html5.org/specs/dom-range.html#range><code class=external data-anolis-spec=domrange>Range</code></a> under discussion.

  <li><p>If <var title="">range</var>'s <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-offset title=concept-boundary-point-offset>offset</a> is equal to
  the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-node-length title=concept-node-length>length</a> of its <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a>, return the first
  <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#node><code class=external data-anolis-spec=domcore>Node</code></a> that is after the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a> and all its
  <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-descendant-node title=concept-descendant-node>descendants</a> (if any) in <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#tree-order>tree order</a>.  If there is no such <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#node><code class=external data-anolis-spec=domcore>Node</code></a>,
  return the last <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#node><code class=external data-anolis-spec=domcore>Node</code></a> in the document.

  <li><p>If <var title="">range</var>'s <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a> is a <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#text><code class=external data-anolis-spec=domcore>Text</code></a>,
  <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#comment><code class=external data-anolis-spec=domcore>Comment</code></a>, or <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#processinginstruction><code class=external data-anolis-spec=domcore>ProcessingInstruction</code></a> node, return that.

  <li><p>If <var title="">range</var>'s <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a> has children,
  return the child whose <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-indexof title=concept-indexof>index</a> is equal to <var title="">range</var>'s
  <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-offset title=concept-boundary-point-offset>offset</a>.

  <li><p>Return <var title="">range</var>'s <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>node</a>.
</ol>

<p>The <dfn id=beginning-element>beginning element</dfn> of a <a href=http://html5.org/specs/dom-range.html#range><code class=external data-anolis-spec=domrange>Range</code></a> is its <a href=#first-node>first
node</a> if that is an <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element><code class=external data-anolis-spec=domcore>Element</code></a>; or the parent of its <a href=#first-node>first
node</a>, if <em>that</em> is an <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element><code class=external data-anolis-spec=domcore>Element</code></a>; or else null.

<p class=XXX>(It will be null only in weird cases, like selecting a comment
whose parent is a document, or the child of a document fragment, or whatever.
I'm ignoring those cases for now.)

<p>The <dfn id=active-range>active range</dfn> of a <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#document><code class=external data-anolis-spec=domcore>Document</code></a> is the value returned by the
following algorithm:

<ol>
  <li><p>Let <var title="">selection</var> be the result of calling <a href=http://html5.org/specs/dom-range.html#dom-document-getselection><code class=external data-anolis-spec=domrange title=dom-Document-getSelection>getSelection()</code></a> on
  the <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#document><code class=external data-anolis-spec=domcore>Document</code></a>.

  <li><p>If there are no <a href=http://html5.org/specs/dom-range.html#range><code class=external data-anolis-spec=domrange>Range</code></a>s associated with <var title="">selection</var>,
  return null.

  <li><p>Let <var title="">start</var> be the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point title=concept-boundary-point>boundary point</a> with the earliest
  <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-bp-position title=concept-bp-position>position</a> among all of <var title="">selection</var>'s <a href=http://html5.org/specs/dom-range.html#range><code class=external data-anolis-spec=domrange>Range</code></a>s'
  <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>starts</a>.

  <li><p>Return the last <a href=http://html5.org/specs/dom-range.html#range><code class=external data-anolis-spec=domrange>Range</code></a> in <var title="">selection</var> whose <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a>
  is <var title="">start</var>.
  <!-- This is what Firefox seems to do, no reason to change it . . . -->

  <p class=note>In user agents that support only one <a href=http://html5.org/specs/dom-range.html#range><code class=external data-anolis-spec=domrange>Range</code></a> per
  <a href=http://html5.org/specs/dom-range.html#selection><code class=external data-anolis-spec=domrange>Selection</code></a>, the active range is simply the only one in the selection.
</ol>

<p>When the user agent is instructed to run a particular method, it must follow
the steps defined for that method in the appropriate specification, not act as
though the method had actually been called from JavaScript.  In particular,
if the author has overridden the method with a custom method, the standard
method must be run rather than the custom one.


<h2 id=decomposing-a-range-into-nodes><span class=secno>4 </span>Decomposing a Range into Nodes</h2>
<p>When a user agent is to <dfn id=decompose-a-range>decompose a <code class=external data-anolis-spec=domrange>Range</code></dfn> <var title="">range</var>, it must run the following steps.

<p class=note>The algorithm returns a list of <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#node><code class=external data-anolis-spec=domcore>Node</code></a>s in the <a href=http://html5.org/specs/dom-range.html#range><code class=external data-anolis-spec=domrange>Range</code></a> that
are not contained in any other <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#node><code class=external data-anolis-spec=domcore>Node</code></a> in the <a href=http://html5.org/specs/dom-range.html#range><code class=external data-anolis-spec=domrange>Range</code></a>.  It splits <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#text><code class=external data-anolis-spec=domcore>Text</code></a>
nodes if necessary, but isn't picky about <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#comment><code class=external data-anolis-spec=domcore>Comment</code></a>s or
<a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#processinginstruction><code class=external data-anolis-spec=domcore>ProcessingInstruction</code></a>s.

<ol>
  <li><p>Let <var title="">start node</var>, <var title="">start offset</var>, <var title="">end node</var>, and <var title="">end offset</var> be the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a>
  and <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-end title=concept-range-end>end</a> <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-node title=concept-boundary-point-node>nodes</a> and <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-boundary-point-offset title=concept-boundary-point-offset>offsets</a> of <var title="">range</var>,
  respectively.

  <li><p>If <var title="">start node</var> or <var title="">end node</var> is not an
  <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element><code class=external data-anolis-spec=domcore>Element</code></a>, <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#text><code class=external data-anolis-spec=domcore>Text</code></a>, <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#processinginstruction><code class=external data-anolis-spec=domcore>ProcessingInstruction</code></a>, or <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#comment><code class=external data-anolis-spec=domcore>Comment</code></a> node, or is
  not an <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element><code class=external data-anolis-spec=domcore>Element</code></a> and has no parent, abort these steps.

  <p class=XXX>Figure out something sensible here.

  <li><p>If <var title="">start node</var> and <var title="">end node</var> are both
  <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#text><code class=external data-anolis-spec=domcore>Text</code></a> nodes, and <var title="">start node</var> is the same as <var title="">end
  node</var>, and neither <var title="">start offset</var> nor <var title="">end
  offset</var> is equal to 0 or the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-node-length title=concept-node-length>length</a> of <var title="">start
  node</var>:

  <ol>
    <li><p>Run <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-text-splittext><code class=external data-anolis-spec=domcore title=dom-Text-splitText>splitText(<var title="">start offset</var>)</code></a> on
    <var title="">start node</var> and set <var title="">start node</var> to the
    result.

    <li><p>Run <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-text-splittext><code class=external data-anolis-spec=domcore title=dom-Text-splitText>splitText(<var title="">end offset</var> &minus; <var title="">start offset</var>)</code></a> on <var title="">start node</var>.

    <li><p>Return the list consisting of the single <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#node><code class=external data-anolis-spec=domcore>Node</code></a> <var title="">start
    node</var>, and abort these steps.
  </ol>

  <li><p>If <var title="">start node</var> is a <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#text><code class=external data-anolis-spec=domcore>Text</code></a> node and <var title="">start
  offset</var> is neither 0 nor the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-node-length title=concept-node-length>length</a> of <var title="">start
  node</var>, run <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-text-splittext><code class=external data-anolis-spec=domcore title=dom-Text-splitText>splitText(<var title="">start offset</var>)</code></a> on
  <var title="">start node</var> and set <var title="">start node</var> to the
  returned node.  Set <var title="">start offset</var> to 0.

  <li><p>If <var title="">end node</var> is a <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#text><code class=external data-anolis-spec=domcore>Text</code></a> node and <var title="">end
  offset</var> is neither 0 nor the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-node-length title=concept-node-length>length</a> of <var title="">end
  node</var>, run <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-text-splittext><code class=external data-anolis-spec=domcore title=dom-Text-splitText>splitText(<var title="">end offset</var>)</code></a> on
  <var title="">end node</var>.

  <li><p>If <var title="">start offset</var> is nonzero and equals the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-node-length title=concept-node-length>length</a> of
  <var title="">start node</var>, let <var title="">node</var> be the first <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#node><code class=external data-anolis-spec=domcore>Node</code></a> after
  <var title="">start node</var> in <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#tree-order>tree order</a>.  If there is no such <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#node><code class=external data-anolis-spec=domcore>Node</code></a>, return
  the empty list.

  <li><p>Otherwise, if <var title="">start node</var> is an <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element><code class=external data-anolis-spec=domcore>Element</code></a> with at least
  one child, let <var title="">node</var> be the <var title="">start offset</var>th child of
  <var title="">start node</var>.

  <li><p>Otherwise, let <var title="">node</var> be <var title="">start node</var>.

  <li><p>If <var title="">end node</var> is an <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element><code class=external data-anolis-spec=domcore>Element</code></a> and <var title="">end
  offset</var> is not 0, let <var title="">end</var> be the child of <var title="">end node</var> with <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-indexof title=concept-indexof>index</a> <var title="">end offset</var> &minus; 1.

  <li><p>Otherwise, if <var title="">end offset</var> is 0, let <var title="">end</var> be the first <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#node><code class=external data-anolis-spec=domcore>Node</code></a> before <var title="">end node</var> in
  <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#tree-order>tree order</a>.  If there is no such <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#node><code class=external data-anolis-spec=domcore>Node</code></a>, return the empty list.

  <li><p>Otherwise, let <var title="">end</var> be <var title="">end node</var>.

  <!-- We try to include a node's parent instead of that node if possible,
  because this generally reduces the number of nodes we're handling.  So if the
  string "oo bar" was selected in <b>Foo <i>bar</i></b>, we'd add the <i> to
  the selection, even if the browser registered the end as the text node "bar".
  -->
  <li><p>While <var title="">node</var> is the first child of its parent and <var title="">end</var> is not a <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-descendant-node title=concept-descendant-node>descendant</a> of <var title="">node</var>'s parent,
  set <var title="">node</var> to <var title="">node</var>'s parent.

  <li><p>While <var title="">end</var> is the last child of its parent and <var title="">node</var> is not a <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-descendant-node title=concept-descendant-node>descendant</a> of <var title="">end</var>'s parent,
  set <var title="">end</var> to <var title="">node</var>'s parent.

  <li><p>Let <var title="">node list</var> be an empty list of <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#node><code class=external data-anolis-spec=domcore>Node</code></a>s.

  <li><p>While <var title="">node</var> is not after <var title="">end</var> in
  <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#tree-order>tree order</a>:

  <ol>
    <li><p>Append <var title="">node</var> to <var title="">node list</var>.

    <li><p>Set <var title="">node</var> to the first <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#node><code class=external data-anolis-spec=domcore>Node</code></a> in <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#tree-order>tree order</a> that is
    after <var title="">node</var> and all its <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-descendant-node title=concept-descendant-node>descendants</a> (if any).  If no such
    <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#node><code class=external data-anolis-spec=domcore>Node</code></a> exists, break out of these substeps.

    <li><p>While <var title="">node</var> is an <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-ancestor-node title=concept-ancestor-node>ancestor</a> of <var title="">end</var>, set <var title="">node</var> to <var title="">node</var>'s first child.
  </ol>

  <li><p>Return <var title="">node list</var>.
</ol>


<h2 id=unstyling-an-element><span class=secno>5 </span>Unstyling an element</h2>
<p>When a user agent is to <dfn id=unstyle-an-element>unstyle an element</dfn>, it must run the
following steps.

<ol>
  <li><p>Let <var title="">element</var> be the <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element><code class=external data-anolis-spec=domcore>Element</code></a> to be unstyled.

  <li><p>Let <var title="">property name</var> and <var title="">tag list</var> be as
  in the invoking algorithm.

  <li><p>Let <var title="">element children</var> be the <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element><code class=external data-anolis-spec=domcore>Element</code></a> children of
  <var title="">element</var>.

  <li><p><a href=#unstyle-an-element title="unstyle an element">Unstyle</a> each <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element><code class=external data-anolis-spec=domcore>Element</code></a> in
  <var title="">element children</var>, in order.

  <p class=note>Unstyling an element can change the number of children its
  parent has, so the list of children to unstyle needs to be computed
  beforehand.

  <li><p>If either

  <ul>
    <li><p><var title="">element</var> is an <a href=#html-element>HTML element</a> with
    <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-element-local-name title=concept-element-local-name>local name</a> either "span" or in <var title="">tag list</var>, and it has
    only a single attribute, and that attribute is named "style", and
    that style attribute sets only the CSS property <var title="">property
    name</var>; or

    <li><p><var title="">element</var> is an <a href=#html-element>HTML element</a> with
    <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-element-local-name title=concept-element-local-name>local name</a> in <var title="">tag list</var> and it has no attributes,
  </ul>

  <p>then:

  <ol>
    <li><p>Let <var title="">children</var> be an empty list of <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#node><code class=external data-anolis-spec=domcore>Node</code></a>s.

    <li><p>While <var title="">element</var> has children:

    <ol>
      <li><p>Let <var title="">child</var> be the first child of <var title="">element</var>.

      <li><p>Append <var title="">child</var> to <var title="">children</var>.

      <li><p>Insert <var title="">child</var> as the previous sibling of
      <var title="">element</var>.
    </ol>

    <li><p>Remove <var title="">element</var>.

    <li><p>Return <var title="">children</var>.
  </ol>

  <li><p>Unset the CSS property <var title="">property name</var> of <var title="">element</var>.

  <li><p>If <var title="">element</var> is not an <a href=#html-element>HTML element</a> or its
  <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-element-local-name title=concept-element-local-name>local name</a> is not in <var title="">tag list</var>, return the empty list.

  <li><p>Let <var title="">new element</var> be a new <a href=#html-element>HTML element</a> with
  <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-element-local-name title=concept-element-local-name>local name</a> "span", with the same attributes and <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-ownerdocument><code class=external data-anolis-spec=domcore title=dom-Node-ownerDocument>ownerDocument</code></a> as
  <var title="">element</var>.

  <li><p>Append <var title="">new element</var> to <var title="">element</var>'s
  parent as the previous sibling of <var title="">element</var>.

  <li><p>While <var title="">element</var> has children, append its first child
  as the last child of <var title="">new element</var>.

  <li><p>Remove <var title="">element</var>.

  <li><p>Return the one-<a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#node><code class=external data-anolis-spec=domcore>Node</code></a> list consisting of <var title="">new element</var>.
</ol>


<h2 id=styling-a-range><span class=secno>6 </span>Styling a Range</h2>
<p>When a user agent is to <dfn id=style-a-range>style a <code class=external data-anolis-spec=domrange>Range</code></dfn> <var title="">range</var>, it
must run the following steps.  There are three inputs: a CSS property name
<var title="">property name</var>, a new value <var title="">property value</var>, and a possibly
empty list of strings <var title="">tag list</var>.

<ol>
  <li><p>Let <var title="">node list</var> be the result of <a href=#decompose-a-range title="decompose
  a range">decomposing</a> <var title="">range</var>.

  <li><p>For each <var title="">node</var> in <var title="">node list</var>, in order:

  <ol>
    <li><p>If <var title="">node</var> is an <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element><code class=external data-anolis-spec=domcore>Element</code></a>:

    <ol>
      <li><p>Unset the CSS property <var title="">property name</var> of <var title="">node</var>.

      <li><p>If the computed value of <var title="">property name</var> for
      <var title="">node</var> is not <var title="">property value</var>, set the CSS property
      <var title="">property name</var> of <var title="">node</var> to <var title="">property value</var>.
      <!-- This means we don't bother applying the property if the style is
      already present, e.g., from an ancestor.  But we do apply it if the
      element is the expected sort of element but the style is wrong anyway,
      e.g., <span style=font-weight:100><b>Foo</b></span> where b's style is
      font-weight: bold. -->

      <li><p>Let <var title="">element children</var> be the <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element><code class=external data-anolis-spec=domcore>Element</code></a> children
      of <var title="">node</var>.

      <li><p><a href=#unstyle-an-element title="unstyle an element">Unstyle</a> each <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element><code class=external data-anolis-spec=domcore>Element</code></a>
      in <var title="">element children</var>, in order.

      <p class=note>Unstyling an element can change the number of children its
      parent has, so the list of children to unstyle needs to be computed
      beforehand.
    </ol>

    <li><p>Otherwise, if <var title="">node</var> is a <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#text><code class=external data-anolis-spec=domcore>Text</code></a> node:

    <ol>
      <li><p>Let <var title="">tag</var> be the first string in <var title="">tag list</var>, or
      "span" if <var title="">tag list</var> is empty.

      <li><p>Let <var title="">new parent</var> be the result of calling <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-document-createelement><code class=external data-anolis-spec=domcore title=dom-Document-createElement>createElement(<var title="">tag</var>)</code></a> on
      the <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-ownerdocument><code class=external data-anolis-spec=domcore title=dom-Node-ownerDocument>ownerDocument</code></a> of <var title="">node</var>.

      <li><p>Append <var title="">new parent</var> to <var title="">node</var>'s parent as the
      previous sibling of <var title="">node</var>.

      <li><p>If the computed value of <var title="">property name</var> on <var title="">new
      parent</var> is not equal to <var title="">property value</var>, set the CSS
      property <var title="">property name</var> of <var title="">new parent</var> to
      <var title="">property value</var>.
      <!-- This is needed if tag list is empty, but also if the correct style
      is being suppressed for some reason, like <span
      style=font-weight:100><b>Foo</b></span> where b is font-weight: bolder.
      -->

      <li><p>Append <var title="">node</var> to <var title="">new parent</var> as
      its last child.
    </ol>

    <li><p>Otherwise, do nothing.
  </ol>
</ol>
<!-- Out of IE9, Gecko, WebKit, and Opera, when asked to (e.g.) bold an
element, IE9 and WebKit and Opera wrap various descendants in <b> or <strong>;
Gecko just adds a style attribute.  The latter is simpler, particularly because
you then don't have to worry about making sure you only insert your tags in a
valid place (which you have to so that text/html serialization is possible, if
nothing else).  I originally specced the former approach, available in git
history. -->


<h2 id=unstyling-a-range><span class=secno>7 </span>Unstyling a Range</h2>
<p>When a user agent is to <dfn id=unstyle-a-range>unstyle a <code class=external data-anolis-spec=domrange>Range</code></dfn> <var title="">range</var>, it
must run the following steps.  There are three inputs: a CSS property name
<var title="">property name</var>, a new value <var title="">property value</var>, and a possibly
empty list of strings <var title="">tag list</var>.

<ol>
  <li><p>Let <var title="">node list</var> be the result of <a href=#decompose-a-range title="decompose
  a range">decomposing</a> <var title="">range</var>.

  <li><p>For each <var title="">node</var> in <var title="">node list</var>, in order:

  <ol>
    <li><p>If <var title="">node</var> is an <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element><code class=external data-anolis-spec=domcore>Element</code></a>:

    <ol>
      <li><p>Let <var title="">extra nodes</var> be the result of <a href=#unstyle-an-element title="unstyle an element">unstyling</a> <var title="">node</var>.

      <li><p>If <var title="">node</var> no longer has a parent:

      <ol>
        <li><p>Insert all the <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#node><code class=external data-anolis-spec=domcore>Node</code></a>s in <var title="">extra nodes</var> into
        <var title="">node list</var> immediately after <var title="">node</var>, in order.

        <li><p>Continue with the next <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#node><code class=external data-anolis-spec=domcore>Node</code></a> in <var title="">node list</var>, if any.

        <p class=note>The next <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#node><code class=external data-anolis-spec=domcore>Node</code></a> will be the first in <var title="">extra
        nodes</var>, unless <var title="">extra nodes</var> is empty.
      </ol>

      <li><p>If the computed value of <var title="">property name</var> for <var title="">node</var> is not <var title="">property value</var>, set the CSS
      property <var title="">property name</var> of <var title="">node</var> to <var title="">property value</var>.

      <li><p>Let <var title="">element children</var> be the <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element><code class=external data-anolis-spec=domcore>Element</code></a> children
      of <var title="">node</var>.

      <li><p><a href=#unstyle-an-element title="unstyle an element">Unstyle</a> each <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element><code class=external data-anolis-spec=domcore>Element</code></a>
      in <var title="">element children</var>, in order.

      <p class=note>Unstyling an element can change the number of children its
      parent has, so the list of children to unstyle needs to be computed
      beforehand.
    </ol>

    <li><p>Otherwise, if <var title="">node</var> is a <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#text><code class=external data-anolis-spec=domcore>Text</code></a> node and the computed value of <var title="">property name</var> for <var title="">node</var>'s parent is not <var title="">property value</var>:

    <ol>
      <li><p>Let <var title="">new parent</var> be the result of calling <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-document-createelement><code class=external data-anolis-spec=domcore title=dom-Document-createElement>createElement("span")</code></a> on the
      <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-ownerdocument><code class=external data-anolis-spec=domcore title=dom-Node-ownerDocument>ownerDocument</code></a> of <var title="">node</var>.

      <li><p>Set the CSS property <var title="">property name</var> of <var title="">new
      parent</var> to <var title="">property value</var>.

      <li><p>Insert <var title="">new parent</var> as <var title="">node</var>'s
      previous sibling.

      <li><p>Append <var title="">node</var> to <var title="">new parent</var> as its
      child.
    </ol>

    <li><p>Otherwise, do nothing.
  </ol>
</ol>


<h2 id=commands><span class=secno>8 </span>Commands</h2>
<p>The <dfn id=execcommand() title=execCommand()><code>execCommand(<var title="">commandId</var>,
<var title="">showUI</var>, <var title="">value</var>)</code></dfn> method on the
<a href=http://www.whatwg.org/html/#htmldocument><code class=external data-anolis-spec=html>HTMLDocument</code></a> interface allows scripts to
perform actions on the current selection or at the current caret position.
Generally, these commands would be used to implement editor UI, for example
having a "delete" button on a toolbar.

<p>There are three variants to this method, with one, two, and three arguments
respectively. The <var title="">showUI</var> and <var title="">value</var>
parameters, even if specified, are ignored except where otherwise stated.

<p>When <a href=#execcommand()><code>execCommand()</code></a> is invoked, the user agent must take the
action from the list below given by <var title="">commandId</var> on the
<a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#context-object>context object</a>'s <a href=#active-range>active range</a>.  If no action is given or if
there is no <a href=#active-range>active range</a>, do nothing.

<p>The <dfn id=querycommandstate() title=queryCommandState()><code>queryCommandState(<var title="">commandId</var>)</code></dfn>
method on the <a href=http://www.whatwg.org/html/#htmldocument><code class=external data-anolis-spec=html>HTMLDocument</code></a> interface must
return the state of <var title="">commandId</var> on the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#context-object>context object</a>'s
<a href=#active-range>active range</a>, as given by the list below.  If there is no
<a href=#active-range>active range</a>, or if <var title="">commandId</var> is not on the list,
return false.
<!-- Gecko throws an exception if there are no ranges in the selection, but
other engines seem to just return false, which seems like nicer behavior
anyway.

Requesting the state of an unknown command throws an exception in IE 9 RC
and Firefox 4b11, and returns boolean false in Chrome 10 and Opera 11. -->

<p>The <dfn id=querycommandvalue() title=queryCommandValue()><code>queryCommandValue(<var title="">commandId</var>)</code></dfn>
method on the <a href=http://www.whatwg.org/html/#htmldocument><code class=external data-anolis-spec=html>HTMLDocument</code></a> interface must
return the value of <var title="">commandId</var> on the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#context-object>context object</a>'s
<a href=#active-range>active range</a>, as given by the list below.  If there is no
<a href=#active-range>active range</a>, or if <var title="">commandId</var> is not on the list,
return the empty string.
<!-- Requesting the value of an unknown command throws an exception in
IE 9 RC and in Firefox 4b11.  It returns boolean false in Chrome 10, and the
empty string in Opera 11. -->

<p class=XXX>Querying the value or state of an unrecognized command throws an
exception in IE and Firefox.  Need to consider changing to that behavior.

<p>The possible values for <var title="">commandId</var>, and their corresponding
meanings, are as follows.  These values must be compared to the argument in an
<a class=external data-anolis-spec=html href=http://www.whatwg.org/html/#ascii-case-insensitive>ASCII case-insensitive</a> manner.

<dl>
<dt><code title=""><dfn id=command-backcolor title=command-backColor>backColor</dfn></code>

<dd><p><strong>Action</strong>: If <var title="">value</var> is not a valid CSS color,
the user agent must do nothing and abort these steps.  Otherwise, it must <a href=#style-a-range title="style a range">style the <code class=external data-anolis-spec=domrange>Range</code></a> with <var title="">property name</var>
equal to "background-color", <var title="">property value</var> equal to
<var title="">value</var>, and <var title="">tag list</var> equal to the empty list.
<!-- Firefox documentation says it normally sets the background color of the
document, but I can't get it to work at all in brief testing in 4b11.  (It says
it behaves differently in styleWithCss mode.)  Opera 11 appears to set the
background color of the nearest block container of the cursor, or something.
IE 9 RC and Chrome 10 behave as I'd expect, namely, they set the background of
the selection, just like all the other styling features.  I go with IE/WebKit.

Invalid colors are probably the same craziness as with foreColor.

Chrome 10 dev actually sets background, not background-color, so it resets all
the other background stuff.  I go with IE 9 RC and Opera 11, which only set
background-color. -->

<p class=XXX>Firefox and Opera use backColor to set the background color of the
whole document.  The hiliteColor command can then be used to set the background
of the selection (supported in all my test browsers except IE).  This
terminology is inconsistent with foreColor, but the model I've specced leaves
no way to change the document's overall background color.  I'm not sure how
important this is, but maybe I should switch, since hiliteColor is more
interoperably implemented than backColor.

<dd><p><strong>State</strong>: Always false.

<dd><p><strong>Value</strong>: The value is given by the following algorithm:

<ol>
  <li><p>Let <var title="">element</var> be the <a href=#beginning-element>beginning element</a> of the
  <a href=http://html5.org/specs/dom-range.html#range><code class=external data-anolis-spec=domrange>Range</code></a>.

  <li><p>While the computed style of "background-color" on <var title="">element</var>
  is any fully transparent value, set <var title="">element</var> to its parent.

  <p class=XXX>It's intended that for these purposes, the root element will
  have a white background.  Should that be specified somewhere?  I don't think
  all UAs actually do it.

  <li><p>Return the computed style of "background-color" for
  <var title="">element</var>.
</ol>
<!-- Chrome 10 returns rgba(0, 0, 0, 0) if there's no background defined
anywhere.  Opera 11 returns rgb(255, 255, 255) as I'd like.  Firefox 4b11 just
throws an exception for some reason.  IE 9 RC seems to return the number 0
across the board, as with foreColor. -->


<dt><code title=""><dfn id=command-bold title=command-bold>bold</dfn></code>

<dd><p><strong>Action</strong>: If the state of the <a href=http://html5.org/specs/dom-range.html#range><code class=external data-anolis-spec=domrange>Range</code></a> for this command
is false, the user agent must <a href=#style-a-range title="style a range">style the
<code class=external data-anolis-spec=domrange>Range</code></a> with <var title="">property name</var> "font-weight", <var title="">property
value</var> "bold", and <var title="">tag list</var> ["b", "strong"].  Otherwise, it
must <a href=#unstyle-a-range title="unstyle a range">unstyle it</a> with <var title="">property
name</var> "font-weight", <var title="">property value</var> "normal", and <var title="">tag
list</var> ["b", "strong"].

<dd><p><strong>State</strong>: True if the <a href=#beginning-element>beginning element</a> of the
<a href=http://html5.org/specs/dom-range.html#range><code class=external data-anolis-spec=domrange>Range</code></a> has font-weight with computed value less than 700, otherwise false.

<dd><p><strong>Value</strong>: Always the empty string.
<!-- We have lots of options here (and presumably for all the others where
value is meaningless).  IE 9 RC returns the boolean false, Firefox 4b11 and
Opera 11 both return the empty string, Chrome 10 returns the string "false".
The HTML5 spec as of February 2011 mandates WebKit's behavior.  It makes sense
to always return a string, a majority of string-returners return the empty
string, and three out of the four return something that evaluates to false as a
boolean, so I'll go with Firefox and Opera. -->


<dt><code title=""><dfn id=command-createlink title=command-createlink>createLink</dfn></code>

<dd><p><strong>Action</strong>: The user agent must run the following steps:

<ol>
  <li><p>If <var title="">value</var> is the empty string, abort these steps and do
  nothing.
  <!-- This matches Firefox 4b11 and Chrome 11 dev.  IE 9 RC and Opera 11 both
  treat the request literally.  Gecko and WebKit probably have it right here:
  users who enter no URL are very unlikely to want to link to a relative URL
  resolving to the current document.  If they really want to, they can always
  specify "#" for the value, or the author can rewrite it, so it's not like
  this makes the API less useful. -->

  <li><p>Let <var title="">node list</var> be the result of <a href=#decompose-a-range title="decompose a
  range">decomposing</a> the <a href=http://html5.org/specs/dom-range.html#range><code class=external data-anolis-spec=domrange>Range</code></a>.

  <li><p>For each <var title="">node</var> in <var title="">node list</var>, in order:

  <ol>
    <li><p>Let <var title="">text nodes</var> be a list of all <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#text><code class=external data-anolis-spec=domcore>Text</code></a> node
    <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-descendant-node title=concept-descendant-node>descendants</a> of <var title="">node</var>, or <var title="">node</var> itself if it's a
    <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#text><code class=external data-anolis-spec=domcore>Text</code></a> node.

    <li><p>For each <var title="">text node</var> in <var title="">text nodes</var>, in
    <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#tree-order>tree order</a>:

    <ol>
      <li><p>Let <var title="">ancestor link</var> be the parent of <var title="">text
      node</var>.

      <li><p>While <var title="">ancestor link</var> is not an <a href=#html-element>HTML
      element</a>, or its <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-element-local-name title=concept-element-local-name>local name</a> is not "a", or it has no <a href=#html-attribute>HTML
      attribute</a> with <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-attr-local-name title=concept-attr-local-name>local name</a> "href":

      <ol>
        <li><p>If the parent of <var title="">ancestor link</var> is not an <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#element><code class=external data-anolis-spec=domcore>Element</code></a>,
        set <var title="">ancestor link</var> to null and break from this loop.

        <li><p>Otherwise, set <var title="">ancestor link</var> to its parent.
      </ol>

      <li><p>If <var title="">ancestor link</var> is not null, set its "href" attribute
      to <var title="">value</var> and continue with the next <var title="">text node</var>.
      <!-- There are three approaches here.  For instance, if you ask browsers
      to create a link to "http://example.org" on the "b" here:

        <a href=http://example.com><b>Abc</b></a>

      Chrome 10 dev produces:

        <b><a href=http://example.com>A</a><a href=http://example.org>b</a>
        <a href=http://example.com>c</a></b>

      Firefox 4b11 produces (roughly):

        <a href=http://example.com><b>A<a href=http://example.org>b</a>c</b></a>

      IE 9 RC and Opera 11 produce simply:

        <a href=http://example.org><b>Abc</b></a>

      The last behavior produces valid markup (unlike Gecko), is simple (unlike
      WebKit), and probably best matches user expectations.  If you happen to
      miss out a character when selecting the link you want to change, do you
      really intend to only change the link of part of it? -->

      <li><p>Let <var title="">new parent</var> be the result of calling <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-document-createelement><code class=external data-anolis-spec=domcore title=dom-Document-createElement>createElement("a")</code></a> on the
      <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-ownerdocument><code class=external data-anolis-spec=domcore title=dom-Node-ownerDocument>ownerDocument</code></a> of <var title="">text node</var>.

      <li><p>Call <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-element-setattribute><code class=external data-anolis-spec=domcore title=dom-Element-setAttribute>setAttribute("href",
      <var title="">value</var>)</code></a> on <var title="">new parent</var>.

      <li><p>Insert <var title="">new parent</var> into <var title="">text node</var>'s parent as
      the previous sibling of <var title="">text node</var>.

      <li><p>Append <var title="">text node</var> to <var title="">new parent</var> as its last
      child.
    </ol>
  </ol>
</ol>

<dd><p><strong>State</strong>: Always false.

<dd><p><strong>Value</strong>: Always the empty string.
<!-- I'd have expected the value to be the URL, but guess not. -->


<dt><code title=""><dfn id=command-fontname title=command-fontname>fontName</dfn></code>

<dd><p><strong>Action</strong>: The user agent must <a href=#style-a-range title="style a
range">style the <code class=external data-anolis-spec=domrange>Range</code></a> with <var title="">property name</var> equal to
"font-family", <var title="">property value</var> equal to <var title="">value</var>, and
<var title="">tag list</var> equal to the empty list.
<!-- UAs differ a bit in the details here:

IE 9 RC: Empty string sets <font face="">
Firefox 4b11: Empty string does nothing
Chrome 11 dev: Empty string does nothing, '"monospace"' same as 'monospace'
  (i.e., cannot escape font-family keywords because quotes are stripped,
  clearly wrong)
Opera 11: Empty string sets <font face="">

Setting an empty font-family has the effect of inheriting the font from the
parent (although I don't see where the February 24, 2011 CSS 3 Fonts draft says
that).  Thus it makes sense that if we special-case this, it should be to unset
the font somehow.

Special-casing the empty string to do nothing doesn't make sense to me.  With
createLink we'd expect the user to enter the URL themselves, so it makes sense
to special-case clicking OK without entering anything.  But here it's very
likely that the font list will be fixed by the author (how many users will
understand CSS font-family syntax?), so I don't think such usability concerns
apply. -->

<dd><p><strong>State</strong>: Always false.

<dd><p><strong>Value</strong>: The computed value of the CSS property
"font-family" for the <a href=#beginning-element>beginning element</a> of the <a href=http://html5.org/specs/dom-range.html#range><code class=external data-anolis-spec=domrange>Range</code></a>.
<!-- Complicated.

IE 9 RC: Always the empty string.  Not very useful.
Firefox 4b11: Confusing.  Sometimes it returns generic family names, like
  "sans-serif".  Sometimes it gives specific font names, like "tt" when the
  font is specified as "monospace".  Sometimes it gives the literal font-family
  string.  Not sure what it's doing here.
Chrome 11 dev: Gives the literal value of font-family, except if it's inherited
  from default values (no explicit style declarations anywhere), when it seems
  to return the exact font name.
Opera 11: Returns the literal value of font-family, except if it's inherited
  from default values, when it returns the empty string.

I'm just going to punt on this and say it should be the computed value of
font-family.  I'll leave CSSOM to decide what that means if there are no
applicable style rules. -->


<dt><code title=""><dfn id=command-forecolor title=command-forecolor>foreColor</dfn></code>

<dd><p><strong>Action</strong>: If <var title="">value</var> is not a valid CSS color,
the user agent must do nothing and abort these steps.
<!-- Browsers are all over the place here.  IE 9 RC seems to treat unrecognized
colors as black, but everyone else ignores them.  There are also special rules
for certain things that aren't valid CSS colors, in some browsers, like:

IE 9 RC: "ffe" -> "#ffe", "123" -> "#123"
Firefox 4b11: "ffe" -> no style, "123" -> no style
Chrome 10 dev: "ffe" -> "#FFFFEE", "123" -> "#000123"
Opera 11: "ffe" -> "#0f0f0e", "123" -> "#010203"

Firefox seems to stick to just CSS colors, so with any luck that works.
"limegreen" works as expected in all browsers.  rgb(255, 255, 255) does too,
except in Opera, which tries to parse it in some crazy way and winds up with
"#00b025".  rgba() colors don't work as uniformly, but I don't see any reason
to prohibit them.  Best to just match CSS. -->
Otherwise, it must <a href=#style-a-range title="style a range">style the <code class=external data-anolis-spec=domrange>Range</code></a> with
<var title="">property name</var> equal to "color", <var title="">property value</var> equal to
<var title="">value</var>, and <var title="">tag list</var> equal to the empty list.

<dd><p><strong>State</strong>: Always false.
<!-- This matches IE 9 RC and Chrome 10.  Opera 11 seems to return true if
there's some color style applied, false otherwise, which seems fairly useless;
authors want to use value here, not state.  Firefox 4b11 throws an exception,
which is an interesting approach, but I'll go with IE/WebKit, which makes at
least as much sense. -->

<dd><p><strong>Value</strong>: The computed value of the CSS property "color"
for the <a href=#beginning-element>beginning element</a> of the <a href=http://html5.org/specs/dom-range.html#range><code class=external data-anolis-spec=domrange>Range</code></a>.
<!-- IE 9 RC returns the number 0 always, which makes no sense at all.  This
matches the other browsers. -->


<dt><code title=""><dfn id=command-insertimage title=command-insertimage>insertImage</dfn></code>

<dd><p><strong>Action</strong>: The user agent must run the following steps:

<p class=XXX>We need to delete the selection if it's not collapsed.

<ol>
  <li><p>If <var title="">value</var> is the empty string, abort these steps and do
  nothing.
  <!-- Similar logic to createLink, except even more compelling, since an HTML
  document linking to itself as an image is just silly.  In fact, the current
  HTML spec instructs UAs to not even try displaying the image, and just fail
  immediately if the URL is empty.  Firefox 4b11 bails out on an empty string,
  but the other three browsers I tested stick in the <img> anyway. -->

  <li><p>Let (<var title="">node</var>, <var title="">offset</var>) be the <a href=http://html5.org/specs/dom-range.html#range><code class=external data-anolis-spec=domrange>Range</code></a>'s
  <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-range-start title=concept-range-start>start</a>.

  <li><p>Let <var title="">img</var> be a new <a href=#html-element>HTML element</a> with
  <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-element-local-name title=concept-element-local-name>local name</a> "img", the same <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-ownerdocument><code class=external data-anolis-spec=domcore title=dom-Node-ownerDocument>ownerDocument</code></a> as <var title="">node</var>, and a
  single <a href=#html-attribute>HTML attribute</a> with <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-attr-local-name title=concept-attr-local-name>local name</a> "src" and with
  <a class=external data-anolis-spec=domcore href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#concept-attr-value title=concept-attr-value>value</a> <var title="">value</var>.
  <!-- No alt text, so it's invalid.  This matches all browsers. -->

  <li><p>If <var title="">node</var> is a <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#text><code class=external data-anolis-spec=domcore>Text</code></a> node, and <var title="">offset</var> is not
  equal to 0 or the <a class=external data-anolis-spec=domrange href=http://html5.org/specs/dom-range.html#concept-node-length title=concept-node-length>length</a> of <var title="">node</var>, run <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-text-splittext><code class=external data-anolis-spec=domcore title=dom-Text-splitText>splitText(<var title="">offset</var>)</code></a> on
  <var title="">node</var>.

  <li><p>If <var title="">node</var> is a <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#text><code class=external data-anolis-spec=domcore>Text</code></a>, <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#comment><code class=external data-anolis-spec=domcore>Comment</code></a>, or
  <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#processinginstruction><code class=external data-anolis-spec=domcore>ProcessingInstruction</code></a> node, run <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-insertbefore><code class=external data-anolis-spec=domcore title=dom-Node-insertBefore>insertBefore(<var title="">img</var>,
  <var title="">node</var>)</code></a> on the parent of <var title="">node</var>.

  <li><p>Otherwise, let <var title="">child</var> be the <var title="">offset</var>th child of
  <var title="">node</var> (or null if there is no such child), and run <a href=http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#dom-node-insertbefore><code class=external data-anolis-spec=domcore title=dom-Node-insertBefore>insertBefore(<var title="">img</var>,
  <var title="">child</var>)</code></a> on <var title="">node</var>.
</ol>

<dd><p><strong>State</strong>:

<dd><p><strong>Value</strong>:


<dt><code title=""><dfn id=command-italic title=command-italic>italic</dfn></code>

<dd><p><strong>Action</strong>: If the of the <a href=http://html5.org/specs/dom-range.html#range><code class=external data-anolis-spec=domrange>Range</code></a> for this command is
false, the user agent must <a href=#style-a-range title="style a range">style the
<code class=external data-anolis-spec=domrange>Range</code></a> with <var title="">property name</var> "font-style", <var title="">property
value</var> "italic", <var title="">tag list</var> ["i", "em"].  Otherwise, it must
<a href=#unstyle-a-range title="unstyle a range">unstyle it</a> with <var title="">property name</var>
"font-style", <var title="">property value</var> "normal", and <var title="">tag list</var> ["i",
"em"].

<dd><p><strong>State</strong>: True if the <a href=#beginning-element>beginning element</a> of the
<a href=http://html5.org/specs/dom-range.html#range><code class=external data-anolis-spec=domrange>Range</code></a> has font-style with computed value "italic" or "oblique", otherwise
false.

<dd><p><strong>Value</strong>: Always the empty string.


<dt><code title=""><dfn id=command-unlink title=command-unlink>unlink</dfn></code>

<dd><p><strong>Action</strong>:
<!-- IE 9 RC unlinks the whole link you're pointing at.  Others just unlink
your selection, which does nothing if you have nothing selected.
Unfortunately, everyone but IE winds up doing some DOM surgery here in some
cases, creating and splitting elements in some cases. -->

<dd><p><strong>State</strong>:

<dd><p><strong>Value</strong>:


<dt><code title=""><dfn id=command-underline title=command-underline>underline</dfn></code>

<dd class=XXX><p><strong>Action</strong>: ???  This is totally unreasonable,
because CSS text-decoration is a nightmare.  Styling is easy, unstyling is only
possible through massive hacks.

<dd class=XXX><p><strong>State</strong>: ...

<dd><p><strong>Value</strong>: Always the empty string.
</dl>


<h2 class=no-num id=references>References</h2><!--REFS-->
<p>All references are normative unless marked "Non-normative".</p>
<div id=anolis-references><dl></dl></div>


<!--
<h2 class=no-num>Acknowledgements</h2>
<p>...
-->
<script src=http://www.whatwg.org/specs/web-apps/current-work/dfn.js></script>

<!doctype html>
<title>Auto-running execCommand() tests</title>
<style>
body { font-family: serif }
.yes { color: green }
.no { color: red }
b, strong { font-weight: bold }
.bold { font-weight: bold }
.notbold { font-weight: normal }
#purple { color: purple }
td > div:first-child {
	padding-bottom: 0.2em;
	border-bottom: 1px solid black;
}
td > div:last-child {
	padding-top: 0.2em;
}
/* https://bugs.webkit.org/show_bug.cgi?id=56670 */
dfn { font-style: italic }
/* We don't want test cells to not wrap */
listing, plaintext, pre, xmp { white-space: pre-wrap }
</style>
<p>Legend: {[ are the selection anchor, }] are the selection focus, {}
represent an element boundary point, [] represent a text node boundary point.
Syntax and some of the tests taken from <a
href=http://www.browserscope.org/richtext2/test>Browserscope</a>.  data-start
and data-end attributes also represent element boundary points, with the node
being the element with the attribute and the offset given as the attribute
value, for cases where HTML parsing doesn't allow text nodes.  Currently we
don't really pay attention to reversed selections at all, so they might get
displayed as forwards or such.

<p>Where two tables are given for a single command, the first is with
styleWithCSS false and the second is with it true.  (The second table is left
blank in IE and Opera, which don't support styleWithCSS.)

<h1>Table of Contents</h1>
<ul>
	<li><a href=#backcolor>backcolor</a>
	<li><a href=#bold>bold</a>
	<li><a href=#createlink>createlink</a>
	<li><a href=#fontname>fontname</a>
	<li><a href=#forecolor>forecolor</a>
	<li><a href=#hilitecolor>hilitecolor</a>
	<li><a href=#italic>italic</a>
	<li><a href=#subscript>subscript</a>
	<li><a href=#superscript>superscript</a>
	<li><a href=#underline>underline</a>
	<li><a href=#unlink>unlink</a>
</ul>

<button onclick="for (var command in tests) runTests(command)">Run all tests</button>

<div id=backcolor>
<h1>backcolor</h1>

<button onclick="runTests('backcolor')">Run tests</button>

<p>Tests set the color to "#FF8888".  <strong>Note:</strong> No spec has yet
been written, so the spec column does nothing.

<table border=1><tr><th>Input <th>Spec <th>Browser <th>Same?</table>
<table border=1><tr><th>Input <th>Spec <th>Browser <th>Same?</table>

<p><label>Enter new test here: <input></label>
<button onclick="addTest('backcolor', document.querySelector('#backcolor input').value)">Add test</button>
</div>

<div id=bold>
<h1>bold</h1>

<button onclick="runTests('bold')">Run tests</button>

<table border=1><tr><th>Input <th>Spec <th>Browser <th>Same?</table>
<table border=1><tr><th>Input <th>Spec <th>Browser <th>Same?</table>

<p><label>Enter new test here: <input></label>
<button onclick="addTest('bold', document.querySelector('#bold input').value)">Add test</button>
</div>

<div id=createlink>
<h1>createlink</h1>

<button onclick="runTests('createlink')">Run tests</button>

<p>Tests set the href to "http://www.google.com/".

<table border=1><tr><th>Input <th>Spec <th>Browser <th>Same?</table>

<p><label>Enter new test here: <input></label>
<button onclick="addTest('createlink', document.querySelector('#createlink input').value)">Add test</button>
</div>

<div id=fontname>
<h1>fontname</h1>

<button onclick="runTests('fontname')">Run tests</button>

<p>Tests set the font-family to "sans-serif".  Note that the body's font-family is "serif".

<table border=1><tr><th>Input <th>Spec <th>Browser <th>Same?</table>
<table border=1><tr><th>Input <th>Spec <th>Browser <th>Same?</table>

<p><label>Enter new test here: <input></label>
<button onclick="addTest('fontname', document.querySelector('#fontname input').value)">Add test</button>
</div>

<div id=forecolor>
<h1>forecolor</h1>

<button onclick="runTests('forecolor')">Run tests</button>

<p>Tests set the color to "#FF0000".

<table border=1><tr><th>Input <th>Spec <th>Browser <th>Same?</table>
<table border=1><tr><th>Input <th>Spec <th>Browser <th>Same?</table>

<p><label>Enter new test here: <input></label>
<button onclick="addTest('forecolor', document.querySelector('#forecolor input').value)">Add test</button>
</div>

<div id=hilitecolor>
<h1>hilitecolor</h1>

<button onclick="runTests('hilitecolor')">Run tests</button>

<p>Tests set the color to "#FF8888".  In IE we run backColor instead of hiliteColor.

<table border=1><tr><th>Input <th>Spec <th>Browser <th>Same?</table>

<p><label>Enter new test here: <input></label>
<button onclick="addTest('hilitecolor', document.querySelector('#hilitecolor input').value)">Add test</button>
</div>

<div id=italic>
<h1>italic</h1>

<button onclick="runTests('italic')">Run tests</button>

<table border=1><tr><th>Input <th>Spec <th>Browser <th>Same?</table>
<table border=1><tr><th>Input <th>Spec <th>Browser <th>Same?</table>

<p><label>Enter new test here: <input></label>
<button onclick="addTest('italic', document.querySelector('#italic input').value)">Add test</button>
</div>

<div id=subscript>
<h1>subscript</h1>

<button onclick="runTests('subscript')">Run tests</button>

<table border=1><tr><th>Input <th>Spec <th>Browser <th>Same?</table>
<table border=1><tr><th>Input <th>Spec <th>Browser <th>Same?</table>

<p><label>Enter new test here: <input></label>
<button onclick="addTest('subscript', document.querySelector('#subscript input').value)">Add test</button>
</div>

<div id=superscript>
<h1>superscript</h1>

<button onclick="runTests('superscript')">Run tests</button>

<table border=1><tr><th>Input <th>Spec <th>Browser <th>Same?</table>
<table border=1><tr><th>Input <th>Spec <th>Browser <th>Same?</table>

<p><label>Enter new test here: <input></label>
<button onclick="addTest('superscript', document.querySelector('#superscript input').value)">Add test</button>
</div>

<div id=underline>
<h1>underline</h1>

<button onclick="runTests('underline')">Run tests</button>

<table border=1><tr><th>Input <th>Spec <th>Browser <th>Same?</table>
<table border=1><tr><th>Input <th>Spec <th>Browser <th>Same?</table>

<p><label>Enter new test here: <input></label>
<button onclick="addTest('underline', document.querySelector('#underline input').value)">Add test</button>
</div>

<div id=unlink>
<h1>unlink</h1>

<button onclick="runTests('unlink')">Run tests</button>

<p><strong>Note:</strong> No spec has yet been written, so the spec column does
nothing.

<table border=1><tr><th>Input <th>Spec <th>Browser <th>Same?</table>

<p><label>Enter new test here: <input></label>
<button onclick="addTest('unlink', document.querySelector('#unlink input').value)">Add test</button>
</div>

<script src=implementation.js></script>
<script>
var values = {
	backcolor: "#FF8888",
	bold: null,
	createlink: "http://www.google.com/",
	fontname: "sans-serif",
	forecolor: "#FF0000",
	hilitecolor: "#FF8888",
	italic: null,
	subscript: null,
	superscript: null,
	underline: null,
	unlink: null,
};

var tests = {
	backcolor: [
		'<p>foo[bar]baz',
		'<p>foo]bar[baz',
		'<div><p>foo[bar]baz</p></div>',

		'<table><tbody><tr><td>foo<td>b[a]r<td>baz</table>',
		'<table><tbody><tr data-start=1 data-end=2><td>foo<td>bar<td>baz</table>',
		'<table><tbody><tr data-start=0 data-end=2><td>foo<td>bar<td>baz</table>',
		'<table><tbody data-start=0 data-end=1><tr><td>foo<td>bar<td>baz</table>',
		'<table data-start=0 data-end=1><tbody><tr><td>foo<td>bar<td>baz</table>',
		'{<table><tr><td>foo<td>bar<td>baz</table>}',

		'{<p><p> <p>foo</p>}',
		'{<p>foo</p><p>bar</p>}',
		'<p>[foo</p><p>bar]</p>',
		'<p>foo[bar<i>baz]qoz</i>quz',
	],
	bold: [
		'foo[bar]baz',
		'foo]bar[baz',
		'{<p><p> <p>foo</p>}',
		'foo[bar<i>baz]qoz</i>quz',

		'<table><tbody><tr><td>foo<td>b[a]r<td>baz</table>',
		'<table><tbody><tr data-start=1 data-end=2><td>foo<td>bar<td>baz</table>',
		'<table><tbody><tr data-start=0 data-end=2><td>foo<td>bar<td>baz</table>',
		'<table><tbody data-start=0 data-end=1><tr><td>foo<td>bar<td>baz</table>',
		'<table data-start=0 data-end=1><tbody><tr><td>foo<td>bar<td>baz</table>',
		'{<table><tr><td>foo<td>bar<td>baz</table>}',

		'foo<span style="font-weight: bold">[bar]</span>baz',
		'foo<b>[bar]</b>baz',
		'foo<b>bar</b>[baz]',
		'[foo]<b>bar</b>baz',
		'<b>foo</b>[bar]<b>baz</b>',
		'foo<strong>bar</strong>[baz]',
		'[foo]<strong>bar</strong>baz',
		'<strong>foo</strong>[bar]<strong>baz</strong>',
		'<b>foo</b>[bar]<strong>baz</strong>',
		'<strong>foo</strong>[bar]<b>baz</b>',
		'foo[<b>bar</b>]baz',
		'foo[<b>bar]</b>baz',
		'foo<b>[bar</b>]baz',

		'foo{<b></b>}baz',
		'foo{<i></i>}baz',
		'foo{<b><i></i></b>}baz',
		'foo{<i><b></b></i>}baz',

		'foo<strong>[bar]</strong>baz',
		'foo[<strong>bar</strong>]baz',
		'foo[<strong>bar]</strong>baz',
		'foo<strong>[bar</strong>]baz',
		'foo<span style="font-weight: bold">[bar]</span>baz',
		'foo[<span style="font-weight: bold">bar</span>]baz',
		'foo[<span style="font-weight: bold">bar]</span>baz',
		'foo<span style="font-weight: bold">[bar</span>]baz',

		'<b>{<p>foo</p><p>bar</p>}<p>baz</p></b>',
		'<b><p>foo[<i>bar</i>}</p><p>baz</p></b>',

		'foo [bar <b>baz] qoz</b> quz sic',
		'foo bar <b>baz [qoz</b> quz] sic',

		'<b id=purple>bar [baz] qoz</b>',

		'foo<span style="font-weight: 100">[bar]</span>baz',
		'foo<span style="font-weight: 400">[bar]</span>baz',
		'foo<span style="font-weight: 700">[bar]</span>baz',
		'foo<span style="font-weight: 900">[bar]</span>baz',
		'foo<span style="font-weight: 400">[bar</span>]baz',
		'foo<span style="font-weight: 700">[bar</span>]baz',
		'foo[<span style="font-weight: 400">bar]</span>baz',
		'foo[<span style="font-weight: 700">bar]</span>baz',
		'foo[<span style="font-weight: 400">bar</span>]baz',
		'foo[<span style="font-weight: 700">bar</span>]baz',
		'<span style="font-weight: 100">foo[bar]baz</span>',
		'<span style="font-weight: 400">foo[bar]baz</span>',
		'<span style="font-weight: 700">foo[bar]baz</span>',
		'<span style="font-weight: 900">foo[bar]baz</span>',
		'{<span style="font-weight: 100">foobar]baz</span>',
		'{<span style="font-weight: 400">foobar]baz</span>',
		'{<span style="font-weight: 700">foobar]baz</span>',
		'{<span style="font-weight: 900">foobar]baz</span>',
		'<span style="font-weight: 100">foo[barbaz</span>}',
		'<span style="font-weight: 400">foo[barbaz</span>}',
		'<span style="font-weight: 700">foo[barbaz</span>}',
		'<span style="font-weight: 900">foo[barbaz</span>}',

		'<h3>foo[bar]baz</h3>',
		'{<h3>foobar]baz</h3>',
		'<h3>foo[barbaz</h3>}',
		'<h3>[foobarbaz]</h3>',
		'{<h3>foobarbaz]</h3>',
		'<h3>[foobarbaz</h3>}',
		'{<h3>foobarbaz</h3>}',

		'<b>foo<span style="font-weight: normal">bar<b>[baz]</b>quz</span>qoz</b>',
		'<b>foo<span style="font-weight: normal">[bar]</span>baz</b>',

		'{<b>foo</b> <b>bar</b>}',
		'{<h3>foo</h3><b>bar</b>}',

		'<i><b>foo</b></i>[bar]<i><b>baz</b></i>',
		'<i><b>foo</b></i>[bar]<b>baz</b>',
		'<b>foo</b>[bar]<i><b>baz</b></i>',
		'<font color=red face=monospace><b>foo</b></font>[bar]',

		'foo<span style="font-weight: normal"><b>{bar}</b></span>baz',
		'[foo<span class=notbold>bar</span>baz]',
		'<b><span class=notbold>[foo]</span></b>',
		'<b><span class=notbold>foo[bar]baz</span></b>',

		'<p style="font-weight: bold">foo[bar]baz</p>',
	],
	createlink: [
		'foo[bar]baz',
		'foo]bar[baz',
		'{<p><p> <p>foo</p>}',

		'<table><tbody><tr><td>foo<td>b[a]r<td>baz</table>',
		'<table><tbody><tr data-start=1 data-end=2><td>foo<td>bar<td>baz</table>',
		'<table><tbody><tr data-start=0 data-end=2><td>foo<td>bar<td>baz</table>',
		'<table><tbody data-start=0 data-end=1><tr><td>foo<td>bar<td>baz</table>',
		'<table data-start=0 data-end=1><tbody><tr><td>foo<td>bar<td>baz</table>',
		'{<table><tr><td>foo<td>bar<td>baz</table>}',

		'<a href=http://www.google.com/>foo[bar]baz</a>',
		'<a href=http://www.google.com/>foo[barbaz</a>}',
		'{<a href=http://www.google.com/>foobar]baz</a>',
		'{<a href=http://www.google.com/>foobarbaz</a>}',
		'<a href=http://www.google.com/>[foobarbaz]</a>',

		'foo<a href=http://www.google.com/>[bar]</a>baz',
		'[foo]<a href=http://www.google.com/>bar</a>baz',
		'foo<a href=http://www.google.com/>bar</a>[baz]',
		'foo[<a href=http://www.google.com/>bar</a>]baz',
		'foo<a href=http://www.google.com/>[bar</a>baz]',
		'[foo<a href=http://www.google.com/>bar]</a>baz',
		'[foo<a href=http://www.google.com/>bar</a>baz]',

		'<a href=otherurl>foo[bar]baz</a>',
		'<a href=otherurl>foo[barbaz</a>}',
		'{<a href=otherurl>foobar]baz</a>',
		'{<a href=otherurl>foobarbaz</a>}',
		'<a href=otherurl>[foobarbaz]</a>',

		'foo<a href=otherurl>[bar]</a>baz',
		'foo[<a href=otherurl>bar</a>]baz',
		'foo<a href=otherurl>[bar</a>baz]',
		'[foo<a href=otherurl>bar]</a>baz',
		'[foo<a href=otherurl>bar</a>baz]',
	],
	fontname: [
		'foo[bar]baz',
		'foo]bar[baz',
		'{<p><p> <p>foo</p>}',

		'<table><tbody><tr><td>foo<td>b[a]r<td>baz</table>',
		'<table><tbody><tr data-start=1 data-end=2><td>foo<td>bar<td>baz</table>',
		'<table><tbody><tr data-start=0 data-end=2><td>foo<td>bar<td>baz</table>',
		'<table><tbody data-start=0 data-end=1><tr><td>foo<td>bar<td>baz</table>',
		'<table data-start=0 data-end=1><tbody><tr><td>foo<td>bar<td>baz</table>',
		'{<table><tr><td>foo<td>bar<td>baz</table>}',

		'foo<code>[bar]</code>baz',
		'foo<kbd>[bar]</kbd>baz',
		'foo<listing>[bar]</listing>baz',
		'foo<pre>[bar]</pre>baz',
		'foo<samp>[bar]</samp>baz',
		'foo<tt>[bar]</tt>baz',

		'foo<code>b[a]r</code>baz',
		'foo<kbd>b[a]r</kbd>baz',
		'foo<listing>b[a]r</listing>baz',
		'foo<pre>b[a]r</pre>baz',
		'foo<samp>b[a]r</samp>baz',
		'foo<tt>b[a]r</tt>baz',

		'[foo<code>bar</code>baz]',
		'[foo<kbd>bar</kbd>baz]',
		'[foo<listing>bar</listing>baz]',
		'[foo<pre>bar</pre>baz]',
		'[foo<samp>bar</samp>baz]',
		'[foo<tt>bar</tt>baz]',

		'[foo<code>ba]r</code>baz',
		'[foo<kbd>ba]r</kbd>baz',
		'[foo<listing>ba]r</listing>baz',
		'[foo<pre>ba]r</pre>baz',
		'[foo<samp>ba]r</samp>baz',
		'[foo<tt>ba]r</tt>baz',

		'foo<code>b[ar</code>baz]',
		'foo<kbd>b[ar</kbd>baz]',
		'foo<listing>b[ar</listing>baz]',
		'foo<pre>b[ar</pre>baz]',
		'foo<samp>b[ar</samp>baz]',
		'foo<tt>b[ar</tt>baz]',

		'foo<span style="font-family: sans-serif">[bar]</span>baz',
		'foo<span style="font-family: sans-serif">b[a]r</span>baz',
		'foo<span style="font-family: monospace">[bar]</span>baz',
		'foo<span style="font-family: monospace">b[a]r</span>baz',
	],
	forecolor: [
		'foo[bar]baz',
		'foo]bar[baz',
		'{<p><p> <p>foo</p>}',
		'foo[bar<i>baz]qoz</i>quz',

		'<table><tbody><tr><td>foo<td>b[a]r<td>baz</table>',
		'<table><tbody><tr data-start=1 data-end=2><td>foo<td>bar<td>baz</table>',
		'<table><tbody><tr data-start=0 data-end=2><td>foo<td>bar<td>baz</table>',
		'<table><tbody data-start=0 data-end=1><tr><td>foo<td>bar<td>baz</table>',
		'<table data-start=0 data-end=1><tbody><tr><td>foo<td>bar<td>baz</table>',
		'{<table><tr><td>foo<td>bar<td>baz</table>}',

		'foo<font color=red>[bar]</font>baz',
		'foo{<font color=red>bar</font>}baz',
		'<span style="color: red">foo<span style="color: blue">[bar]</span>baz</span>',
		'<span style="color: #f00">foo<span style="color: blue">[bar]</span>baz</span>',
		'<span style="color: #ff0000">foo<span style="color: blue">[bar]</span>baz</span>',
		'<span style="color: rgb(255, 0, 0)">foo<span style="color: blue">[bar]</span>baz</span>',
		'<font color=red>foo<font color=blue>[bar]</font>baz</font>',
		'<span style="color: rgb(255, 0, 0)">foo<span style="color: blue">b[ar]</span>baz</span>',
		'foo<span id=purple>ba[r</span>ba]z',
		'<span style="color: rgb(255, 0, 0)">foo<span id=purple>b[a]r</span>baz</span>',
	],
	hilitecolor: [
		'foo[bar]baz',
		'foo]bar[baz',
		'{<p><p> <p>foo</p>}',
		'foo[bar<i>baz]qoz</i>quz',

		'<table><tbody><tr><td>foo<td>b[a]r<td>baz</table>',
		'<table><tbody><tr data-start=1 data-end=2><td>foo<td>bar<td>baz</table>',
		'<table><tbody><tr data-start=0 data-end=2><td>foo<td>bar<td>baz</table>',
		'<table><tbody data-start=0 data-end=1><tr><td>foo<td>bar<td>baz</table>',
		'<table data-start=0 data-end=1><tbody><tr><td>foo<td>bar<td>baz</table>',
		'{<table><tr><td>foo<td>bar<td>baz</table>}',

		'<p style="background-color: rgb(255, 136, 136)">foo[bar]baz</p>',
		'<p style="background-color: #ff8888">foo[bar]baz</p>',
		'<p style="background-color: aqua">foo[bar]baz</p>',
		'{<p style="background-color: aqua">foo</p><p>bar</p>}',
		'<span style="background-color: #ff8888">foo<span style="background-color: aqua">[bar]</span>baz</span>',
		'<span style="background-color: #f88">foo<span style="background-color: aqua">[bar]</span>baz</span>',
		'<span style="background-color: rgb(255, 136, 136)">foo<span style="background-color: aqua">[bar]</span>baz</span>',
		'<span style="background-color: #ff8888">foo<span style="background-color: aqua">b[ar]</span>baz</span>',
		'<p style="background-color: #ff8888">foo<span style="background-color: aqua">b[ar]</span>baz</p>',
		'<div style="background-color: #ff8888"><p style="background-color: aqua">b[ar]</p></div>',
		'<span style="display: block; background-color: #ff8888"><span style="display: block; background-color: aqua">b[ar]</span></span>',
	],
	italic: [
		'foo[bar]baz',
		'foo]bar[baz',
		'{<p><p> <p>foo</p>}',
		'foo[bar<b>baz]qoz</b>quz',

		'<table><tbody><tr><td>foo<td>b[a]r<td>baz</table>',
		'<table><tbody><tr data-start=1 data-end=2><td>foo<td>bar<td>baz</table>',
		'<table><tbody><tr data-start=0 data-end=2><td>foo<td>bar<td>baz</table>',
		'<table><tbody data-start=0 data-end=1><tr><td>foo<td>bar<td>baz</table>',
		'<table data-start=0 data-end=1><tbody><tr><td>foo<td>bar<td>baz</table>',
		'{<table><tr><td>foo<td>bar<td>baz</table>}',

		'foo<span style="font-style: italic">[bar]</span>baz',
		'foo<address>[bar]</address>baz',
		'foo<cite>[bar]</cite>baz',
		'foo<dfn>[bar]</dfn>baz',
		'foo<em>[bar]</em>baz',
		'foo<i>[bar]</i>baz',
		'foo<var>[bar]</var>baz',

		'foo{<address>bar</address>}baz',
		'foo{<cite>bar</cite>}baz',
		'foo{<dfn>bar</dfn>}baz',
		'foo{<em>bar</em>}baz',
		'foo{<i>bar</i>}baz',
		'foo{<var>bar</var>}baz',

		'foo<address>b[a]r</address>baz',
		'foo<cite>b[a]r</cite>baz',
		'foo<dfn>b[a]r</dfn>baz',
		'foo<em>b[a]r</em>baz',
		'foo<i>b[a]r</i>baz',
		'foo<var>b[a]r</var>baz',

		'fo[o<address>bar</address>b]az',
		'fo[o<cite>bar</cite>b]az',
		'fo[o<dfn>bar</dfn>b]az',
		'fo[o<em>bar</em>b]az',
		'fo[o<i>bar</i>b]az',
		'fo[o<var>bar</var>b]az',

		'foo[<address>bar</address>baz]',
		'foo[<cite>bar</cite>baz]',
		'foo[<dfn>bar</dfn>baz]',
		'foo[<em>bar</em>baz]',
		'foo[<i>bar</i>baz]',
		'foo[<var>bar</var>baz]',

		'[foo<address>bar</address>]baz',
		'[foo<cite>bar</cite>]baz',
		'[foo<dfn>bar</dfn>]baz',
		'[foo<em>bar</em>]baz',
		'[foo<i>bar</i>]baz',
		'[foo<var>bar</var>]baz',

		'foo<span style="font-style: italic">[bar]</span>baz',
		'foo<span style="font-style: oblique">[bar]</span>baz',
		'foo<span style="font-style: oblique">b[a]r</span>baz',

		'<i>{<p>foo</p><p>bar</p>}<p>baz</p></i>',
		'<i><p>foo[<b>bar</b>}</p><p>baz</p></i>',
		'foo [bar <b>baz] qoz</b> quz sic',
		'foo bar <b>baz [qoz</b> quz] sic',
		'foo [bar <i>baz] qoz</i> quz sic',
		'foo bar <i>baz [qoz</i> quz] sic',
	],
	subscript: [
		'foo[bar]baz',
		'foo]bar[baz',
		'{<p><p> <p>foo</p>}',
		'foo[bar<b>baz]qoz</b>quz',

		'<table><tbody><tr><td>foo<td>b[a]r<td>baz</table>',
		'<table><tbody><tr data-start=1 data-end=2><td>foo<td>bar<td>baz</table>',
		'<table><tbody><tr data-start=0 data-end=2><td>foo<td>bar<td>baz</table>',
		'<table><tbody data-start=0 data-end=1><tr><td>foo<td>bar<td>baz</table>',
		'<table data-start=0 data-end=1><tbody><tr><td>foo<td>bar<td>baz</table>',
		'{<table><tr><td>foo<td>bar<td>baz</table>}',

		'foo<sub>[bar]</sub>baz',
		'foo<sub>b[a]r</sub>baz',
		'foo<sup>[bar]</sup>baz',
		'foo<sup>b[a]r</sup>baz',

		'foo<sub><sub>[bar]</sub></sub>baz',
		'foo<sub><sub>b[a]r</sub></sub>baz',
		'foo<sub>b<sub>[a]</sub>r</sub>baz',
		'foo<sup><sup>[bar]</sup></sup>baz',
		'foo<sup><sup>b[a]r</sup></sup>baz',
		'foo<sup>b<sup>[a]</sup>r</sup>baz',
		'foo<sub><sup>[bar]</sup></sub>baz',
		'foo<sub><sup>b[a]r</sup></sub>baz',
		'foo<sub>b<sup>[a]</sup>r</sub>baz',
		'foo<sup><sub>[bar]</sub></sup>baz',
		'foo<sup><sub>b[a]r</sub></sup>baz',
		'foo<sup>b<sub>[a]</sub>r</sup>baz',
	],
	superscript: [
		'foo[bar]baz',
		'foo]bar[baz',
		'{<p><p> <p>foo</p>}',
		'foo[bar<b>baz]qoz</b>quz',

		'<table><tbody><tr><td>foo<td>b[a]r<td>baz</table>',
		'<table><tbody><tr data-start=1 data-end=2><td>foo<td>bar<td>baz</table>',
		'<table><tbody><tr data-start=0 data-end=2><td>foo<td>bar<td>baz</table>',
		'<table><tbody data-start=0 data-end=1><tr><td>foo<td>bar<td>baz</table>',
		'<table data-start=0 data-end=1><tbody><tr><td>foo<td>bar<td>baz</table>',
		'{<table><tr><td>foo<td>bar<td>baz</table>}',

		'foo<sub>[bar]</sub>baz',
		'foo<sub>b[a]r</sub>baz',
		'foo<sup>[bar]</sup>baz',
		'foo<sup>b[a]r</sup>baz',

		'foo<sub><sub>[bar]</sub></sub>baz',
		'foo<sub><sub>b[a]r</sub></sub>baz',
		'foo<sub>b<sub>[a]</sub>r</sub>baz',
		'foo<sup><sup>[bar]</sup></sup>baz',
		'foo<sup><sup>b[a]r</sup></sup>baz',
		'foo<sup>b<sup>[a]</sup>r</sup>baz',
		'foo<sub><sup>[bar]</sup></sub>baz',
		'foo<sub><sup>b[a]r</sup></sub>baz',
		'foo<sub>b<sup>[a]</sup>r</sub>baz',
		'foo<sup><sub>[bar]</sub></sup>baz',
		'foo<sup><sub>b[a]r</sub></sup>baz',
		'foo<sup>b<sub>[a]</sub>r</sup>baz',
	],
	underline: [
		'foo[bar]baz',
		'foo]bar[baz',
		'{<p><p> <p>foo</p>}',
		'foo[bar<b>baz]qoz</b>quz',

		'<table><tbody><tr><td>foo<td>b[a]r<td>baz</table>',
		'<table><tbody><tr data-start=1 data-end=2><td>foo<td>bar<td>baz</table>',
		'<table><tbody><tr data-start=0 data-end=2><td>foo<td>bar<td>baz</table>',
		'<table><tbody data-start=0 data-end=1><tr><td>foo<td>bar<td>baz</table>',
		'<table data-start=0 data-end=1><tbody><tr><td>foo<td>bar<td>baz</table>',
		'{<table><tr><td>foo<td>bar<td>baz</table>}',

		'foo<u>[bar]</u>baz',
		'foo<span style="text-decoration: underline">[bar]</span>baz',
		'<u>foo[bar]baz</u>',
		'<u>foo[b<span style="color:red">ar]ba</span>z</u>',
		'<u>foo[b<span style="color:red" id=foo>ar]ba</span>z</u>',
		'<u>foo[b<span style="font-size:3em">ar]ba</span>z</u>',
		'<u>foo[b<i>ar]ba</i>z</u>',
		'<p style="text-decoration: underline">foo[bar]baz</p>',
	],
	unlink: [
		'foo[bar]baz',
		'foo]bar[baz',
		'{<p><p> <p>foo</p>}',

		'<table><tbody><tr><td>foo<td>b[a]r<td>baz</table>',
		'<table><tbody><tr data-start=1 data-end=2><td>foo<td>bar<td>baz</table>',
		'<table><tbody><tr data-start=0 data-end=2><td>foo<td>bar<td>baz</table>',
		'<table><tbody data-start=0 data-end=1><tr><td>foo<td>bar<td>baz</table>',
		'<table data-start=0 data-end=1><tbody><tr><td>foo<td>bar<td>baz</table>',
		'{<table><tr><td>foo<td>bar<td>baz</table>}',

		'<a href=http://www.google.com/>foo[bar]baz</a>',
		'<a href=http://www.google.com/>foo[barbaz</a>}',
		'{<a href=http://www.google.com/>foobar]baz</a>',
		'{<a href=http://www.google.com/>foobarbaz</a>}',
		'<a href=http://www.google.com/>[foobarbaz]</a>',

		'foo<a href=http://www.google.com/>[bar]</a>baz',
		'foo[<a href=http://www.google.com/>bar</a>]baz',
		'foo<a href=http://www.google.com/>[bar</a>baz]',
		'[foo<a href=http://www.google.com/>bar]</a>baz',
		'[foo<a href=http://www.google.com/>bar</a>baz]',

		'<a id=foo href=http://www.google.com/>foo[bar]baz</a>',
		'<a id=foo href=http://www.google.com/>[foobarbaz]</a>',
		'foo<a id=foo href=http://www.google.com/>[bar]</a>baz',
		'foo[<a id=foo href=http://www.google.com/>bar</a>]baz',
		'[foo<a id=foo href=http://www.google.com/>bar</a>baz]',

		'<a name=foo>foo[bar]baz</a>',
		'<a name=foo>[foobarbaz]</a>',
		'foo<a name=foo>[bar]</a>baz',
		'foo[<a name=foo>bar</a>]baz',
		'[foo<a name=foo>bar</a>baz]',
	],
};

function runTests(command) {
	var runTestsButton = document.querySelector("#" + command + " button");
	runTestsButton.parentNode.removeChild(runTestsButton);

	var addTestButton = document.querySelector("#" + command + " button");
	var input = document.querySelector("#" + command + " input");
	for (var i = 0; i < tests[command].length; i++) {
		// The following code should logically be equivalent to:
		//   addTest(command, tests[command][i]);
		// But that only works to set one cell, in IE9.  All the other tests
		// fail.  So, um, WTF, but it works.
		input.value = tests[command][i];
		input.focus();
		addTestButton.click();
	}
	input.value = "";
}

function addTest(command, test) {
	var doubleTesting = ["backcolor", "bold", "italic", "underline",
	"forecolor", "fontname", "fontsize", "subscript",
	"superscript"].indexOf(command) != -1;

	// I tried to feature-detect styleWithCSS, but it was too much of a pain,
	// with Firefox randomly throwing exceptions all over the place.  So I'm
	// just browser-sniffing here.
	if (navigator.userAgent.indexOf("Opera") != -1
	|| navigator.userAgent.indexOf("MSIE") != -1) {
		doubleTesting = false;
	}

	var tr = doSetup(command, 0);

	doInputCell(tr, test);
	doSpecCell(tr, test, command, false);
	doBrowserCell(tr, test, command, false);
	doSameCell(tr);

	if (doubleTesting) {
		var tr = doSetup(command, 1);

		doInputCell(tr, test);
		doSpecCell(tr, test, command, true);
		doBrowserCell(tr, test, command, true);
		doSameCell(tr);
	}

	doTearDown(command);
}

function doSetup(command, idx) {
	document.getElementById(command).contentEditable = "true";
	document.getElementById(command).spellcheck = false;
	var table = document.querySelectorAll("#" + command + " > table")[idx];

	var tr = document.createElement("tr");
	// Insert at the top, because Chrome debugger doesn't let you scroll down
	// while you're stopped at a breakpoint . . .
	//if (table.childNodes.length == 1) {
		table.appendChild(tr);
	//} else {
	//	table.insertBefore(tr, table.childNodes[1]);
	//}

	return tr;
}

function doInputCell(tr, test) {
	var inputCell = document.createElement("td");
	inputCell.innerHTML = "<div></div><div></div>";
	inputCell.firstChild.innerHTML = test;
	inputCell.lastChild.textContent = inputCell.firstChild.innerHTML;
	tr.appendChild(inputCell);
}

function doSpecCell(tr, test, command, styleWithCss) {
	var value = values[command];

	var specCell = document.createElement("td");
	tr.appendChild(specCell);
	try {
		var points = setupCell(specCell, test);
		var range = document.createRange();
		range.setStart(points[0], points[1]);
		range.setEnd(points[2], points[3]);
		// The points might be backwards
		if (range.collapsed) {
			range.setEnd(points[0], points[1]);
		}
		myExecCommand("styleWithCSS", false, styleWithCss);
		myExecCommand(command, false, value, range);
		addBrackets(range);
		specCell.lastChild.textContent = specCell.firstChild.innerHTML;
	} catch (e) {
		specCell.lastChild.style.color = "red";
		specCell.lastChild.style.fontWeight = "bold";
		specCell.lastChild.textContent = "Note, exception: " + e;
	}

	var key = "execcommand-" + command
		+ "-" + Number(myQueryCommandState("styleWithCSS"))
		+ "-" + test;

	var oldValue = localStorage[key];
	localStorage[key] = specCell.lastChild.textContent;

	if (oldValue !== null && oldValue !== undefined && oldValue != specCell.lastChild.textContent) {
		specCell.appendChild(document.createElement("div"));
		specCell.lastChild.style.color = "red";
		specCell.lastChild.style.fontWeight = "bold";
		specCell.lastChild.textContent = "Note, last run produced different markup: " + oldValue;
	}
}

function doBrowserCell(tr, test, command, styleWithCss) {
	var value = values[command];

	if (command == "hilitecolor" && navigator.userAgent.indexOf("MSIE") != -1) {
		// IE behaves differently, and I want to see how it works.
		command = "backcolor";
	}

	if (command == "hilitecolor") {
		// Firefox refuses to do anything unless styleWithCSS is true.
		styleWithCss = true;
	}

	var browserCell = document.createElement("td");
	tr.appendChild(browserCell);
	try {
		var points = setupCell(browserCell, test);
		setSelection(points[0], points[1], points[2], points[3]);
		try {
			document.execCommand("styleWithCSS", false, styleWithCss);
		} catch (e) {}
		document.execCommand(command, false, value);
		if (getSelection().rangeCount) {
			addBrackets(getSelection().getRangeAt(0));
		}
		browserCell.lastChild.textContent = browserCell.firstChild.innerHTML;
	} catch (e) {
		browserCell.textContent = "Exception: " + e;
	}
}

function doSameCell(tr) {
	var sameCell = document.createElement("td");
	var exception = false;
	try {
		// Ad hoc normalization to avoid basically spurious mismatches.  For
		// now this includes ignoring where the selection goes.
		var normalizedSpecCell = tr.childNodes[1].childNodes[1].textContent
			.replace(/[[\]{}]/g, "")
			.replace(/;? ?"/g, '"')
			.replace(/<(\/?)strong/g, '<$1b')
			.replace(/<(\/?)em/g, '<$1i')
			.replace(/#[0-9a-fA-F]{6}/g, function(match) { return match.toUpperCase(); });
		var normalizedBrowserCell = tr.childNodes[2].childNodes[1].textContent
			.replace(/[[\]{}]/g, "")
			.replace(/;? ?"/g, '"')
			.replace(/<(\/?)strong/g, '<$1b')
			.replace(/<(\/?)em/g, '<$1i')
			.replace(/#[0-9a-fA-F]{6}/g, function(match) { return match.toUpperCase(); })
			.replace(/ class="Apple-style-span"/g, "");
		if (navigator.userAgent.indexOf("MSIE") != -1) {
			// IE produces <font style> instead of <span style>, so let's
			// translate all <span>s to <font>s.
			normalizedSpecCell = normalizedSpecCell
				.replace(/<(\/?)span/g, '<$1font');
			normalizedBrowserCell = normalizedBrowserCell
				.replace(/<(\/?)span/g, '<$1font');
		}
	} catch (e) {
		exception = true;
	}
	if (!exception && normalizedSpecCell == normalizedBrowserCell) {
		sameCell.className = "yes";
		sameCell.textContent = "\u2713";
	} else {
		sameCell.className = "no";
		sameCell.textContent = "\u2717";
	}
	tr.appendChild(sameCell);

	// Insert zero-width spaces so IE doesn't stretch the screen
	try {
		tr.childNodes[2].childNodes[1].textContent =
			tr.childNodes[2].childNodes[1].textContent
			.replace(/</g, "\u200B<")
			.replace(/>/g, ">\u200B");
		tr.childNodes[1].childNodes[1].textContent =
			tr.childNodes[1].childNodes[1].textContent
			.replace(/</g, "\u200B<")
			.replace(/>/g, ">\u200B");
	} catch (e) {};
}

function doTearDown(command) {
	getSelection().removeAllRanges();
	document.getElementById(command).contentEditable = "inherit";
	document.getElementById(command).removeAttribute("spellcheck");
}

function setupCell(cell, test) {
	// A variety of checks to avoid simple errors.  Not foolproof, of course.
	var startMarkers = /\{|\[|data-start/.exec(test);
	if (!startMarkers) {
		startMarkers = [];
	}
	if (startMarkers.length != 1) {
		throw "Need exactly one start marker ([ or { or data-start), found " + startMarkers.length;
	}

	var endMarkers = /\}|\]|data-end/.exec(test);
	if (!endMarkers) {
		endMarkers = [];
	}
	if (endMarkers.length != 1) {
		throw "Need exactly one end marker (] or } or data-end), found " + endMarkers.length;
	}

	cell.innerHTML = "<div></div><div></div>";
	node = cell.firstChild;
	node.innerHTML = test;

	var startNode, startOffset, endNode, endOffset;

	// For braces that don't lie inside text nodes, we can't just set
	// innerHTML, because that might disturb the DOM.  For instance, if the
	// brace is right before a <tr>, it could get moved outside the table
	// entirely, which messes everything up pretty badly.  So we instead
	// allow using data attributes: data-start and data-end on the start and
	// end nodes, with a numeric value indicating the offset.  This format
	// doesn't allow the parent div to be a start or end node, but in that case
	// you can always use the curly braces.
	if (node.querySelector("[data-start]")) {
		startNode = node.querySelector("[data-start]");
		startOffset = startNode.getAttribute("data-start");
		startNode.removeAttribute("data-start");
	}
	if (node.querySelector("[data-end]")) {
		endNode = node.querySelector("[data-end]");
		endOffset = endNode.getAttribute("data-end");
		endNode.removeAttribute("data-end");
	}

	var cur = node;
	while (true) {
		if (!cur || (cur != node && !(cur.compareDocumentPosition(node) & Node.DOCUMENT_POSITION_CONTAINS))) {
			break;
		}

		if (cur.nodeType != Node.TEXT_NODE) {
			cur = nextNode(cur);
			continue;
		}

		var data = cur.data.replace(/\]/g, "");
		var startIdx = data.indexOf("[");

		data = cur.data.replace(/\[/g, "");
		var endIdx = data.indexOf("]");

		cur.data = cur.data.replace(/[\[\]]/g, "");

		if (startIdx != -1) {
			startNode = cur;
			startOffset = startIdx;
		}

		if (endIdx != -1) {
			endNode = cur;
			endOffset = endIdx;
		}

		// These are only legal as the first or last
		data = cur.data.replace(/\}/g, "");
		var elStartIdx = data.indexOf("{");

		data = cur.data.replace(/\{/g, "");
		var elEndIdx = cur.data.indexOf("}");

		if (elStartIdx == 0) {
			startNode = cur.parentNode;
			startOffset = getNodeIndex(cur);
		} else if (elStartIdx != -1) {
			startNode = cur.parentNode;
			startOffset = getNodeIndex(cur) + 1;
		}
		if (elEndIdx == 0) {
			endNode = cur.parentNode;
			endOffset = getNodeIndex(cur);
		} else if (elEndIdx != -1) {
			endNode = cur.parentNode;
			endOffset = getNodeIndex(cur) + 1;
		}

		cur.data = cur.data.replace(/[{}]/g, "");
		if (!cur.data.length) {
			if (cur == startNode || cur == endNode) {
				throw "You put a square bracket where there was no text node . . .";
			}
			var oldCur = cur;
			cur = nextNode(cur);
			oldCur.parentNode.removeChild(oldCur);
		} else {
			cur = nextNode(cur);
		}
	}

	return [startNode, startOffset, endNode, endOffset];
}

function setSelection(startNode, startOffset, endNode, endOffset) {
	if (navigator.userAgent.indexOf("Opera") != -1) {
		// Yes, browser sniffing is evil, but I can't be bothered to debug
		// Opera.
		var range = document.createRange();
		range.setStart(startNode, startOffset);
		range.setEnd(endNode, endOffset);
		if (range.collapsed) {
			range.setEnd(startNode, startOffset);
		}
		getSelection().removeAllRanges();
		getSelection().addRange(range);
	} else if ("extend" in getSelection()) {
		// WebKit behaves unreasonably for collapse(), so do that manually.
		/*
		var range = document.createRange();
		range.setStart(startNode, startOffset);
		getSelection().removeAllRanges();
		getSelection().addRange(range);
		*/
		getSelection().collapse(startNode, startOffset);
		getSelection().extend(endNode, endOffset);
	} else {
		// IE9.  Selections have no direction, so we just make the selection
		// always forwards.
		var range;
		if (getSelection().rangeCount) {
			range = getSelection().getRangeAt(0);
		} else {
			range = document.createRange();
		}
		range.setStart(startNode, startOffset);
		range.setEnd(endNode, endOffset);
		if (range.collapsed) {
			// Phooey, we got them backwards.
			range.setEnd(startNode, startOffset);
		}
		if (!getSelection().rangeCount) {
			getSelection().addRange(range);
		}
	}
}

/**
 * Add brackets at the start and end points of the given range, so that they're
 * visible.
 */
function addBrackets(range) {
	// Do the end first, so that if the range is collapsed, the start point
	// will be inserted before the end point.
	if (range.endContainer.nodeType == Node.TEXT_NODE) {
		range.endContainer.insertData(range.endOffset, "]");
	} else {
		// As everyone knows, the only node types are Text and Element.
		if (range.endOffset != range.endContainer.childNodes.length
		&& range.endContainer.childNodes[range.endOffset].nodeType == Node.TEXT_NODE) {
			range.endContainer.childNodes[range.endOffset].insertData(0, "}");
		} else if (range.endOffset != 0
		&& range.endContainer.childNodes[range.endOffset - 1].nodeType == Node.TEXT_NODE) {
			range.endContainer.childNodes[range.endOffset - 1].appendData("}");
		} else {
			// No idea how this will work for tables . . .
			range.endContainer.insertBefore(document.createTextNode("}"), range.endContainer.childNodes[range.endOffset]);
		}
	}
	if (range.startContainer.nodeType == Node.TEXT_NODE) {
		range.startContainer.insertData(range.startOffset, "[");
	} else {
		if (range.startOffset != range.startContainer.childNodes.length
		&& range.startContainer.childNodes[range.startOffset].nodeType == Node.TEXT_NODE) {
			range.startContainer.childNodes[range.startOffset].insertData(0, "{");
		} else if (range.startOffset != 0
		&& range.startContainer.childNodes[range.startOffset - 1].nodeType == Node.TEXT_NODE) {
			range.startContainer.childNodes[range.startOffset - 1].appendData("{");
		} else {
			range.startContainer.insertBefore(document.createTextNode("{"), range.startContainer.childNodes[range.startOffset]);
		}
	}
}
</script>

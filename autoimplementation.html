<!doctype html>
<meta charset=utf-8>
<title>Auto-running execCommand() tests</title>
<style>
body { font-family: serif }
.yes { color: green }
.no { color: red }
/* http://www.w3.org/Bugs/Public/show_bug.cgi?id=12154
 * https://bugzilla.mozilla.org/show_bug.cgi?id=589124
 * https://bugs.webkit.org/show_bug.cgi?id=56400 */
b, strong { font-weight: bold }
.bold { font-weight: bold }
.notbold { font-weight: normal }
.underline { text-decoration: underline }
.line-through { text-decoration: line-through }
.underline-and-line-through { text-decoration: underline line-through }
#purple { color: purple }
body > div > table > tbody > tr > td > div:first-child {
	padding-bottom: 0.2em;
}
body > div > table > tbody > tr > td > div:last-child {
	padding-top: 0.2em;
	border-top: 1px solid black;
}
/* https://bugs.webkit.org/show_bug.cgi?id=56670 */
dfn { font-style: italic }
/* Opera has weird default blockquote style */
blockquote { margin: 1em 40px }
/* Let the rendered HTML line up so it's easier to compare whitespace */
body > div > table > tbody > tr > td { vertical-align: top }
/* We don't want test cells to not wrap */
listing, plaintext, pre, xmp { white-space: pre-wrap }
img, video { width: 50px }
body > div > table {
	width: 100%;
	table-layout: fixed;
}
body > div > table > tbody > tr > td,
body > div > table > tbody > tr > th {
	width: 30%;
}
body > div > table > tbody > tr > td:last-child,
body > div > table > tbody > tr > th:last-child {
	width: 10%;
}
body > div > table > tbody > tr > td:last-child {
	text-align: center;
	vertical-align: middle;
	font-size: 3em;
}
</style>
<p>Legend: {[ are the selection anchor, }] are the selection focus, {}
represent an element boundary point, [] represent a text node boundary point.
Syntax and some of the tests taken from <a
href=http://www.browserscope.org/richtext2/test>Browserscope</a>.  data-start
and data-end attributes also represent element boundary points, with the node
being the element with the attribute and the offset given as the attribute
value, for cases where HTML parsing doesn't allow text nodes.  Currently we
don't really pay attention to reversed selections at all, so they might get
displayed as forwards or such.

<p>Where two tables are given for a single command, the first is with
styleWithCSS false and the second is with it true.  (The second table is left
blank in IE and Opera, which don't support styleWithCSS.)

<h1>Table of Contents</h1>
<ul>
</ul>

<button onclick="for (var command in tests) runTests(command)">Run all tests</button>

<script src=implementation.js></script>
<script>
"use strict";
var tests = {
	backcolor: [
		'foo[]bar',
		'<span>foo</span>{}<span>bar</span>',
		'<span>foo[</span><span>]bar</span>',
		'<p>foo[bar]baz',
		'<p>foo]bar[baz',
		'<div><p>foo[bar]baz</p></div>',

		'<table><tbody><tr><td>foo<td>b[a]r<td>baz</table>',
		'<table><tbody><tr data-start=1 data-end=2><td>foo<td>bar<td>baz</table>',
		'<table><tbody><tr data-start=0 data-end=2><td>foo<td>bar<td>baz</table>',
		'<table><tbody data-start=0 data-end=1><tr><td>foo<td>bar<td>baz</table>',
		'<table data-start=0 data-end=1><tbody><tr><td>foo<td>bar<td>baz</table>',
		'{<table><tr><td>foo<td>bar<td>baz</table>}',

		'{<p><p> <p>foo</p>}',
		'{<p>foo</p><p>bar</p>}',
		'<p>[foo</p><p>bar]</p>',
		'<p>foo[bar<i>baz]qoz</i>quz',
	],
	bold: [
		'foo[]bar',
		'<span>foo</span>{}<span>bar</span>',
		'<span>foo[</span><span>]bar</span>',
		'foo[bar]baz',
		'foo]bar[baz',
		'{<p><p> <p>foo</p>}',
		'foo[bar<i>baz]qoz</i>quz',

		'foo<span contenteditable=false>[bar]</span>baz',
		'fo[o<span contenteditable=false>bar</span>b]az',
		'fo[<b>o</b><span contenteditable=false>bar</span><b>b</b>]az',
		'<span contenteditable=false>foo<span contenteditable=true>[bar]</span>baz</span>',
		'<span contenteditable=false>fo[o<span contenteditable=true>bar</span>b]az</span>',
		'<span contenteditable=false>fo[<b>o<span contenteditable=true>bar</span>b</b>]az</span>',

		'<table><tbody><tr><td>foo<td>b[a]r<td>baz</table>',
		'<table><tbody><tr data-start=1 data-end=2><td>foo<td>bar<td>baz</table>',
		'<table><tbody><tr data-start=0 data-end=2><td>foo<td>bar<td>baz</table>',
		'<table><tbody data-start=0 data-end=1><tr><td>foo<td>bar<td>baz</table>',
		'<table data-start=0 data-end=1><tbody><tr><td>foo<td>bar<td>baz</table>',
		'{<table><tr><td>foo<td>bar<td>baz</table>}',

		'foo<span style="font-weight: bold">[bar]</span>baz',
		'foo<b>[bar]</b>baz',
		'foo<b>bar</b>[baz]',
		'[foo]<b>bar</b>baz',
		'<b>foo</b>[bar]<b>baz</b>',
		'foo<strong>bar</strong>[baz]',
		'[foo]<strong>bar</strong>baz',
		'<strong>foo</strong>[bar]<strong>baz</strong>',
		'<b>foo</b>[bar]<strong>baz</strong>',
		'<strong>foo</strong>[bar]<b>baz</b>',
		'foo[<b>bar</b>]baz',
		'foo[<b>bar]</b>baz',
		'foo<b>[bar</b>]baz',

		'foo{<b></b>}baz',
		'foo{<i></i>}baz',
		'foo{<b><i></i></b>}baz',
		'foo{<i><b></b></i>}baz',

		'foo<strong>[bar]</strong>baz',
		'foo[<strong>bar</strong>]baz',
		'foo[<strong>bar]</strong>baz',
		'foo<strong>[bar</strong>]baz',
		'foo<span style="font-weight: bold">[bar]</span>baz',
		'foo[<span style="font-weight: bold">bar</span>]baz',
		'foo[<span style="font-weight: bold">bar]</span>baz',
		'foo<span style="font-weight: bold">[bar</span>]baz',

		'<b>{<p>foo</p><p>bar</p>}<p>baz</p></b>',
		'<b><p>foo[<i>bar</i>}</p><p>baz</p></b>',

		'foo [bar <b>baz] qoz</b> quz sic',
		'foo bar <b>baz [qoz</b> quz] sic',

		'<b id=purple>bar [baz] qoz</b>',

		'foo<span style="font-weight: 100">[bar]</span>baz',
		'foo<span style="font-weight: 400">[bar]</span>baz',
		'foo<span style="font-weight: 700">[bar]</span>baz',
		'foo<span style="font-weight: 900">[bar]</span>baz',
		'foo<span style="font-weight: 400">[bar</span>]baz',
		'foo<span style="font-weight: 700">[bar</span>]baz',
		'foo[<span style="font-weight: 400">bar]</span>baz',
		'foo[<span style="font-weight: 700">bar]</span>baz',
		'foo[<span style="font-weight: 400">bar</span>]baz',
		'foo[<span style="font-weight: 700">bar</span>]baz',
		'<span style="font-weight: 100">foo[bar]baz</span>',
		'<span style="font-weight: 400">foo[bar]baz</span>',
		'<span style="font-weight: 700">foo[bar]baz</span>',
		'<span style="font-weight: 900">foo[bar]baz</span>',
		'{<span style="font-weight: 100">foobar]baz</span>',
		'{<span style="font-weight: 400">foobar]baz</span>',
		'{<span style="font-weight: 700">foobar]baz</span>',
		'{<span style="font-weight: 900">foobar]baz</span>',
		'<span style="font-weight: 100">foo[barbaz</span>}',
		'<span style="font-weight: 400">foo[barbaz</span>}',
		'<span style="font-weight: 700">foo[barbaz</span>}',
		'<span style="font-weight: 900">foo[barbaz</span>}',

		'<h3>foo[bar]baz</h3>',
		'{<h3>foobar]baz</h3>',
		'<h3>foo[barbaz</h3>}',
		'<h3>[foobarbaz]</h3>',
		'{<h3>foobarbaz]</h3>',
		'<h3>[foobarbaz</h3>}',
		'{<h3>foobarbaz</h3>}',

		'<b>foo<span style="font-weight: normal">bar<b>[baz]</b>quz</span>qoz</b>',
		'<b>foo<span style="font-weight: normal">[bar]</span>baz</b>',

		'{<b>foo</b> <b>bar</b>}',
		'{<h3>foo</h3><b>bar</b>}',

		'<i><b>foo</b></i>[bar]<i><b>baz</b></i>',
		'<i><b>foo</b></i>[bar]<b>baz</b>',
		'<b>foo</b>[bar]<i><b>baz</b></i>',
		'<font color=red face=monospace><b>foo</b></font>[bar]',

		'foo<span style="font-weight: normal"><b>{bar}</b></span>baz',
		'[foo<span class=notbold>bar</span>baz]',
		'<b><span class=notbold>[foo]</span></b>',
		'<b><span class=notbold>foo[bar]baz</span></b>',

		'<p style="font-weight: bold">foo[bar]baz</p>',
	],
	createlink: [
		'foo[]bar',
		'<span>foo</span>{}<span>bar</span>',
		'<span>foo[</span><span>]bar</span>',
		'foo[bar]baz',
		'foo]bar[baz',
		'{<p><p> <p>foo</p>}',

		'<table><tbody><tr><td>foo<td>b[a]r<td>baz</table>',
		'<table><tbody><tr data-start=1 data-end=2><td>foo<td>bar<td>baz</table>',
		'<table><tbody><tr data-start=0 data-end=2><td>foo<td>bar<td>baz</table>',
		'<table><tbody data-start=0 data-end=1><tr><td>foo<td>bar<td>baz</table>',
		'<table data-start=0 data-end=1><tbody><tr><td>foo<td>bar<td>baz</table>',
		'{<table><tr><td>foo<td>bar<td>baz</table>}',

		'<a href=http://www.google.com/>foo[bar]baz</a>',
		'<a href=http://www.google.com/>foo[barbaz</a>}',
		'{<a href=http://www.google.com/>foobar]baz</a>',
		'{<a href=http://www.google.com/>foobarbaz</a>}',
		'<a href=http://www.google.com/>[foobarbaz]</a>',

		'foo<a href=http://www.google.com/>[bar]</a>baz',
		'[foo]<a href=http://www.google.com/>bar</a>baz',
		'foo<a href=http://www.google.com/>bar</a>[baz]',
		'foo[<a href=http://www.google.com/>bar</a>]baz',
		'foo<a href=http://www.google.com/>[bar</a>baz]',
		'[foo<a href=http://www.google.com/>bar]</a>baz',
		'[foo<a href=http://www.google.com/>bar</a>baz]',

		'<a href=otherurl>foo[bar]baz</a>',
		'<a href=otherurl>foo[barbaz</a>}',
		'{<a href=otherurl>foobar]baz</a>',
		'{<a href=otherurl>foobarbaz</a>}',
		'<a href=otherurl>[foobarbaz]</a>',

		'foo<a href=otherurl>[bar]</a>baz',
		'foo[<a href=otherurl>bar</a>]baz',
		'foo<a href=otherurl>[bar</a>baz]',
		'[foo<a href=otherurl>bar]</a>baz',
		'[foo<a href=otherurl>bar</a>baz]',
	],
	fontname: [
		'foo[]bar',
		'<span>foo</span>{}<span>bar</span>',
		'<span>foo[</span><span>]bar</span>',
		'foo[bar]baz',
		'foo]bar[baz',
		'{<p><p> <p>foo</p>}',

		'<table><tbody><tr><td>foo<td>b[a]r<td>baz</table>',
		'<table><tbody><tr data-start=1 data-end=2><td>foo<td>bar<td>baz</table>',
		'<table><tbody><tr data-start=0 data-end=2><td>foo<td>bar<td>baz</table>',
		'<table><tbody data-start=0 data-end=1><tr><td>foo<td>bar<td>baz</table>',
		'<table data-start=0 data-end=1><tbody><tr><td>foo<td>bar<td>baz</table>',
		'{<table><tr><td>foo<td>bar<td>baz</table>}',

		'foo<code>[bar]</code>baz',
		'foo<kbd>[bar]</kbd>baz',
		'foo<listing>[bar]</listing>baz',
		'foo<pre>[bar]</pre>baz',
		'foo<samp>[bar]</samp>baz',
		'foo<tt>[bar]</tt>baz',

		'foo<code>b[a]r</code>baz',
		'foo<kbd>b[a]r</kbd>baz',
		'foo<listing>b[a]r</listing>baz',
		'foo<pre>b[a]r</pre>baz',
		'foo<samp>b[a]r</samp>baz',
		'foo<tt>b[a]r</tt>baz',

		'[foo<code>bar</code>baz]',
		'[foo<kbd>bar</kbd>baz]',
		'[foo<listing>bar</listing>baz]',
		'[foo<pre>bar</pre>baz]',
		'[foo<samp>bar</samp>baz]',
		'[foo<tt>bar</tt>baz]',

		'[foo<code>ba]r</code>baz',
		'[foo<kbd>ba]r</kbd>baz',
		'[foo<listing>ba]r</listing>baz',
		'[foo<pre>ba]r</pre>baz',
		'[foo<samp>ba]r</samp>baz',
		'[foo<tt>ba]r</tt>baz',

		'foo<code>b[ar</code>baz]',
		'foo<kbd>b[ar</kbd>baz]',
		'foo<listing>b[ar</listing>baz]',
		'foo<pre>b[ar</pre>baz]',
		'foo<samp>b[ar</samp>baz]',
		'foo<tt>b[ar</tt>baz]',

		'foo<span style="font-family: sans-serif">[bar]</span>baz',
		'foo<span style="font-family: sans-serif">b[a]r</span>baz',
		'foo<span style="font-family: monospace">[bar]</span>baz',
		'foo<span style="font-family: monospace">b[a]r</span>baz',
	],
	fontsize: [
		'foo[]bar',
		'<span>foo</span>{}<span>bar</span>',
		'<span>foo[</span><span>]bar</span>',
		["1", 'foo[bar]baz'],
		["0", 'foo[bar]baz'],
		["-5", 'foo[bar]baz'],
		["6", 'foo[bar]baz'],
		["7", 'foo[bar]baz'],
		["8", 'foo[bar]baz'],
		["100", 'foo[bar]baz'],
		["2em", 'foo[bar]baz'],
		["20pt", 'foo[bar]baz'],
		["xx-large", 'foo[bar]baz'],
		[" 1 ", 'foo[bar]baz'],
		["1.", 'foo[bar]baz'],
		["1.0", 'foo[bar]baz'],
		["1.0e2", 'foo[bar]baz'],
		["1.1", 'foo[bar]baz'],
		["1.9", 'foo[bar]baz'],
		["+0", 'foo[bar]baz'],
		["+1", 'foo[bar]baz'],
		["+9", 'foo[bar]baz'],
		["-0", 'foo[bar]baz'],
		["-1", 'foo[bar]baz'],
		["-9", 'foo[bar]baz'],
		["", 'foo[bar]baz'],

		'{<p><p> <p>foo</p>}',
		'foo[bar<i>baz]qoz</i>quz',

		'<table><tbody><tr><td>foo<td>b[a]r<td>baz</table>',
		'<table><tbody><tr data-start=1 data-end=2><td>foo<td>bar<td>baz</table>',
		'<table><tbody><tr data-start=0 data-end=2><td>foo<td>bar<td>baz</table>',
		'<table><tbody data-start=0 data-end=1><tr><td>foo<td>bar<td>baz</table>',
		'<table data-start=0 data-end=1><tbody><tr><td>foo<td>bar<td>baz</table>',
		'{<table><tr><td>foo<td>bar<td>baz</table>}',

		'foo<font size=1>[bar]</font>baz',
		'<font size=1>foo[bar]baz</font>',
		'foo<font size=3>[bar]</font>baz',
		'<font size=3>foo[bar]baz</font>',
		'foo<font size=4>[bar]</font>baz',
		'<font size=4>foo[bar]baz</font>',
		'foo<font size=+1>[bar]</font>baz',
		'<font size=+1>foo[bar]baz</font>',
		'<font size=4>foo<font size=1>b[a]r</font>baz</font>',

		'foo<span style="font-size: xx-small">[bar]</span>baz',
		'<span style="font-size: xx-small">foo[bar]baz</span>',
		'foo<span style="font-size: medium">[bar]</span>baz',
		'<span style="font-size: medium">foo[bar]baz</span>',
		'foo<span style="font-size: large">[bar]</span>baz',
		'<span style="font-size: large">foo[bar]baz</span>',
		'<span style="font-size: large">foo<span style="font-size: xx-small">b[a]r</span>baz</span>',

		'foo<span style="font-size: 2em">[bar]</span>baz',
		'<span style="font-size: 2em">foo[bar]baz</span>',

		'<p style="font-size: xx-small">foo[bar]baz</p>',
		'<p style="font-size: medium">foo[bar]baz</p>',
		'<p style="font-size: large">foo[bar]baz</p>',
		'<p style="font-size: 2em">foo[bar]baz</p>',

		["3", '<p style="font-size: xx-small">foo[bar]baz</p>'],
		["3", '<p style="font-size: medium">foo[bar]baz</p>'],
		["3", '<p style="font-size: large">foo[bar]baz</p>'],
		["3", '<p style="font-size: 2em">foo[bar]baz</p>'],

		// Minor algorithm bug: this changes the size of the "b" and "r" in
		// "bar" when we pull down styles
		["3", '<font size=6>foo <span style="font-size: 2em">b[a]r</span> baz</font>'],

		["3", 'foo<big>[bar]</big>baz'],
		["3", 'foo<big>b[a]r</big>baz'],
		["3", 'foo<small>[bar]</small>baz'],
		["3", 'foo<small>b[a]r</small>baz'],
	],
	forecolor: [
		'foo[]bar',
		'<span>foo</span>{}<span>bar</span>',
		'<span>foo[</span><span>]bar</span>',
		'foo[bar]baz',
		'foo]bar[baz',
		'{<p><p> <p>foo</p>}',
		'foo[bar<i>baz]qoz</i>quz',

		['red', 'foo[bar]baz'],
		['f', 'foo[bar]baz'],
		['#f', 'foo[bar]baz'],
		['f00', 'foo[bar]baz'],
		['#f00', 'foo[bar]baz'],
		['ff0000', 'foo[bar]baz'],
		['#ff0000', 'foo[bar]baz'],
		['fff000000', 'foo[bar]baz'],
		['#fff000000', 'foo[bar]baz'],
		['rgb(255, 0, 0)', 'foo[bar]baz'],
		['rgb(100%, 0, 0)', 'foo[bar]baz'],
		['rgb( 255 ,0 ,0)', 'foo[bar]baz'],
		['rgba(255, 0, 0, 0.0)', 'foo[bar]baz'],
		['rgb(375, -10, 15)', 'foo[bar]baz'],
		['rgba(0, 0, 0, 1)', 'foo[bar]baz'],
		['rgba(255, 255, 255, 1)', 'foo[bar]baz'],
		['rgba(255, 0, 0, 0.5)', 'foo[bar]baz'],
		['hsl(0%, 100%, 50%)', 'foo[bar]baz'],
		['cornsilk', 'foo[bar]baz'],
		['potato quiche', 'foo[bar]baz'],
		['transparent', 'foo[bar]baz'],
		['currentColor', 'foo[bar]baz'],

		'<table><tbody><tr><td>foo<td>b[a]r<td>baz</table>',
		'<table><tbody><tr data-start=1 data-end=2><td>foo<td>bar<td>baz</table>',
		'<table><tbody><tr data-start=0 data-end=2><td>foo<td>bar<td>baz</table>',
		'<table><tbody data-start=0 data-end=1><tr><td>foo<td>bar<td>baz</table>',
		'<table data-start=0 data-end=1><tbody><tr><td>foo<td>bar<td>baz</table>',
		'{<table><tr><td>foo<td>bar<td>baz</table>}',

		'foo<font color=red>[bar]</font>baz',
		'foo{<font color=red>bar</font>}baz',
		'<span style="color: red">foo<span style="color: blue">[bar]</span>baz</span>',
		'<span style="color: #f00">foo<span style="color: blue">[bar]</span>baz</span>',
		'<span style="color: #ff0000">foo<span style="color: blue">[bar]</span>baz</span>',
		'<span style="color: rgb(255, 0, 0)">foo<span style="color: blue">[bar]</span>baz</span>',
		'<font color=red>foo<font color=blue>[bar]</font>baz</font>',
		'<span style="color: rgb(255, 0, 0)">foo<span style="color: blue">b[ar]</span>baz</span>',
		'foo<span id=purple>ba[r</span>ba]z',
		'<span style="color: rgb(255, 0, 0)">foo<span id=purple>b[a]r</span>baz</span>',
	],
	hilitecolor: [
		'foo[]bar',
		'<span>foo</span>{}<span>bar</span>',
		'<span>foo[</span><span>]bar</span>',
		'foo[bar]baz',
		'foo]bar[baz',
		'{<p><p> <p>foo</p>}',
		'foo[bar<i>baz]qoz</i>quz',

		'<table><tbody><tr><td>foo<td>b[a]r<td>baz</table>',
		'<table><tbody><tr data-start=1 data-end=2><td>foo<td>bar<td>baz</table>',
		'<table><tbody><tr data-start=0 data-end=2><td>foo<td>bar<td>baz</table>',
		'<table><tbody data-start=0 data-end=1><tr><td>foo<td>bar<td>baz</table>',
		'<table data-start=0 data-end=1><tbody><tr><td>foo<td>bar<td>baz</table>',
		'{<table><tr><td>foo<td>bar<td>baz</table>}',

		'<p style="background-color: rgb(255, 136, 136)">foo[bar]baz</p>',
		'<p style="background-color: #ff8888">foo[bar]baz</p>',
		'<p style="background-color: aqua">foo[bar]baz</p>',
		'{<p style="background-color: aqua">foo</p><p>bar</p>}',
		'<span style="background-color: #ff8888">foo<span style="background-color: aqua">[bar]</span>baz</span>',
		'<span style="background-color: #f88">foo<span style="background-color: aqua">[bar]</span>baz</span>',
		'<span style="background-color: rgb(255, 136, 136)">foo<span style="background-color: aqua">[bar]</span>baz</span>',
		'<span style="background-color: #ff8888">foo<span style="background-color: aqua">b[ar]</span>baz</span>',
		'<p style="background-color: #ff8888">foo<span style="background-color: aqua">b[ar]</span>baz</p>',
		'<div style="background-color: #ff8888"><p style="background-color: aqua">b[ar]</p></div>',
		'<span style="display: block; background-color: #ff8888"><span style="display: block; background-color: aqua">b[ar]</span></span>',
	],
	indent: [
		// All these have a trailing unselected paragraph, because otherwise
		// Gecko is unhappy: it throws exceptions in non-CSS mode, and in CSS
		// mode it adds the indentation invisibly to the wrapper div in many
		// cases.
		'foo[]bar<p>extra',
		'<span>foo</span>{}<span>bar</span><p>extra',
		'<span>foo[</span><span>]bar</span><p>extra',
		'foo[bar]baz<p>extra',
		'<p dir=rtl>פו[בר]בז<p dir=rtl>נוםף',
		'<p dir=rtl>פו[ברבז<p>Foobar]baz<p>Extra',
		'<p>Foo[barbaz<p dir=rtl>פובר]בז<p>Extra',
		'<div><p>Foo[barbaz<p dir=rtl>פובר]בז</div><p>Extra',
		'foo]bar[baz<p>extra',
		'{<p><p> <p>foo</p>}<p>extra',
		'foo[bar<i>baz]qoz</i>quz<p>extra',

		'<table><tbody><tr><td>foo<td>b[a]r<td>baz</table><p>extra',
		'<table><tbody><tr data-start=1 data-end=2><td>foo<td>bar<td>baz</table><p>extra',
		'<table><tbody><tr data-start=0 data-end=2><td>foo<td>bar<td>baz</table><p>extra',
		'<table><tbody data-start=0 data-end=1><tr><td>foo<td>bar<td>baz</table><p>extra',
		'<table data-start=0 data-end=1><tbody><tr><td>foo<td>bar<td>baz</table><p>extra',
		'{<table><tr><td>foo<td>bar<td>baz</table>}<p>extra',

		'<p>foo[bar]</p><p>baz</p><p>extra',
		'<p>[foobar</p><p>ba]z</p><p>extra',
		'foo[bar]<br>baz<p>extra',
		'foo[bar]<br><br><br><br>baz<p>extra',
		'foobar<br>[ba]z<p>extra',
		'foobar<br><br><br><br>[ba]z<p>extra',
		'foo[bar<br>ba]z<p>extra',

		// These mimic existing indentation in various browsers, to see how
		// they cope with indenting twice.  This is Gecko non-CSS and Opera:
		'<blockquote><p>foo[bar]</p><p>baz</p></blockquote><p>extra',
		'<blockquote><p>foo[bar</p><p>b]az</p></blockquote><p>extra',
		'<blockquote><p>foo[bar]</p></blockquote><p>baz</p><p>extra',
		'<blockquote><p>foo[bar</p></blockquote><p>b]az</p><p>extra',

		// IE:
		'<blockquote style="margin-right: 0" dir="ltr"><p>foo[bar]</p><p>baz</p></blockquote><p>extra',
		'<blockquote style="margin-right: 0" dir="ltr"><p>foo[bar</p><p>b]az</p></blockquote><p>extra',
		'<blockquote style="margin-right: 0" dir="ltr"><p>foo[bar]</p></blockquote><p>baz</p><p>extra',
		'<blockquote style="margin-right: 0" dir="ltr"><p>foo[bar</p></blockquote><p>b]az</p><p>extra',

		// Firefox CSS mode:
		'<p style="margin-left: 40px">foo[bar]</p><p style="margin-left: 40px">baz</p><p>extra',
		'<p style="margin-left: 40px">foo[bar</p><p style="margin-left: 40px">b]az</p><p>extra',
		'<p style="margin-left: 40px">foo[bar]</p><p>baz</p><p>extra',
		'<p style="margin-left: 40px">foo[bar</p><p>b]az</p><p>extra',

		// WebKit:
		'<blockquote class="webkit-indent-blockquote" style="margin: 0 0 0 40px; border: none; padding: 0px"><p>foo[bar]</p><p>baz</p></blockquote><p>extra',
		'<blockquote class="webkit-indent-blockquote" style="margin: 0 0 0 40px; border: none; padding: 0px"><p>foo[bar</p><p>b]az</p></blockquote><p>extra',
		'<blockquote class="webkit-indent-blockquote" style="margin: 0 0 0 40px; border: none; padding: 0px"><p>foo[bar]</p></blockquote><p>baz</p><p>extra',
		'<blockquote class="webkit-indent-blockquote" style="margin: 0 0 0 40px; border: none; padding: 0px"><p>foo[bar</p></blockquote><p>b]az</p><p>extra',
	],
	inserthorizontalrule: [
		'foo[]bar',
		'<span>foo</span>{}<span>bar</span>',
		'<span>foo[</span><span>]bar</span>',
		'<div><b>foo</b>{}<b>bar</b></div>',
		'<div><b>foo[</b><b>]bar</b></div>',
		'<div><b>foo</b>{<b>bar</b>}<b>baz</b></div>',
		'<b>foo[]bar</b>',
		'<b id=abc>foo[]bar</b>',
		["abc", 'foo[bar]baz'],
		'foo[bar]baz',
		'foo<b>{bar}</b>baz',
	],
	insertimage: [
		'foo[]bar',
		'<span>foo</span>{}<span>bar</span>',
		'<span>foo[</span><span>]bar</span>',
		["", 'foo[bar]baz'],
		'foo[bar]baz',
		'foo<b>{bar}</b>baz',
	],
	italic: [
		'foo[]bar',
		'<span>foo</span>{}<span>bar</span>',
		'<span>foo[</span><span>]bar</span>',
		'foo[bar]baz',
		'foo]bar[baz',
		'{<p><p> <p>foo</p>}',
		'foo[bar<b>baz]qoz</b>quz',

		'<table><tbody><tr><td>foo<td>b[a]r<td>baz</table>',
		'<table><tbody><tr data-start=1 data-end=2><td>foo<td>bar<td>baz</table>',
		'<table><tbody><tr data-start=0 data-end=2><td>foo<td>bar<td>baz</table>',
		'<table><tbody data-start=0 data-end=1><tr><td>foo<td>bar<td>baz</table>',
		'<table data-start=0 data-end=1><tbody><tr><td>foo<td>bar<td>baz</table>',
		'{<table><tr><td>foo<td>bar<td>baz</table>}',

		'foo<span style="font-style: italic">[bar]</span>baz',
		'foo<address>[bar]</address>baz',
		'foo<cite>[bar]</cite>baz',
		'foo<dfn>[bar]</dfn>baz',
		'foo<em>[bar]</em>baz',
		'foo<i>[bar]</i>baz',
		'foo<var>[bar]</var>baz',

		'foo{<address>bar</address>}baz',
		'foo{<cite>bar</cite>}baz',
		'foo{<dfn>bar</dfn>}baz',
		'foo{<em>bar</em>}baz',
		'foo{<i>bar</i>}baz',
		'foo{<var>bar</var>}baz',

		'foo<address>b[a]r</address>baz',
		'foo<cite>b[a]r</cite>baz',
		'foo<dfn>b[a]r</dfn>baz',
		'foo<em>b[a]r</em>baz',
		'foo<i>b[a]r</i>baz',
		'foo<var>b[a]r</var>baz',

		'fo[o<address>bar</address>b]az',
		'fo[o<cite>bar</cite>b]az',
		'fo[o<dfn>bar</dfn>b]az',
		'fo[o<em>bar</em>b]az',
		'fo[o<i>bar</i>b]az',
		'fo[o<var>bar</var>b]az',

		'foo[<address>bar</address>baz]',
		'foo[<cite>bar</cite>baz]',
		'foo[<dfn>bar</dfn>baz]',
		'foo[<em>bar</em>baz]',
		'foo[<i>bar</i>baz]',
		'foo[<var>bar</var>baz]',

		'[foo<address>bar</address>]baz',
		'[foo<cite>bar</cite>]baz',
		'[foo<dfn>bar</dfn>]baz',
		'[foo<em>bar</em>]baz',
		'[foo<i>bar</i>]baz',
		'[foo<var>bar</var>]baz',

		'foo<span style="font-style: italic">[bar]</span>baz',
		'foo<span style="font-style: oblique">[bar]</span>baz',
		'foo<span style="font-style: oblique">b[a]r</span>baz',

		'<i>{<p>foo</p><p>bar</p>}<p>baz</p></i>',
		'<i><p>foo[<b>bar</b>}</p><p>baz</p></i>',
		'foo [bar <b>baz] qoz</b> quz sic',
		'foo bar <b>baz [qoz</b> quz] sic',
		'foo [bar <i>baz] qoz</i> quz sic',
		'foo bar <i>baz [qoz</i> quz] sic',
	],
	removeformat: [
		'foo[]bar',
		'<span>foo</span>{}<span>bar</span>',
		'<span>foo[</span><span>]bar</span>',
		'[foo<b>bar</b>baz]',
		'foo[<b>bar</b>baz]',
		'foo[<b>bar</b>]baz',
		'foo<b>[bar]</b>baz',
		'foo<b>b[a]r</b>baz',
		'[foo<strong>bar</strong>baz]',
		'[foo<span style="font-weight: bold">bar</span>baz]',
		'foo<span style="font-weight: bold">b[a]r</span>baz',
		'[foo<b id=foo>bar</b>baz]',
		'foo<b id=foo>b[a]r</b>baz',

		// HTML has lots of inline elements, doesn't it?
		'[foo<a>bar</a>baz]',
		'foo<a>b[a]r</a>baz',
		'[foo<a href=foo>bar</a>baz]',
		'foo<a href=foo>b[a]r</a>baz',
		'[foo<abbr>bar</abbr>baz]',
		'foo<abbr>b[a]r</abbr>baz',
		'[foo<acronym>bar</acronym>baz]',
		'foo<acronym>b[a]r</acronym>baz',
		'[foo<b>bar</b>baz]',
		'foo<b>b[a]r</b>baz',
		'[foo<bdi dir=rtl>bar</bdi>baz]',
		'foo<bdi dir=rtl>b[a]r</bdi>baz',
		'[foo<bdo dir=rtl>bar</bdo>baz]',
		'foo<bdo dir=rtl>b[a]r</bdo>baz',
		'[foo<big>bar</big>baz]',
		'foo<big>b[a]r</big>baz',
		'[foo<blink>bar</blink>baz]',
		'foo<blink>b[a]r</blink>baz',
		'[foo<cite>bar</cite>baz]',
		'foo<cite>b[a]r</cite>baz',
		'[foo<code>bar</code>baz]',
		'foo<code>b[a]r</code>baz',
		'[foo<del>bar</del>baz]',
		'foo<del>b[a]r</del>baz',
		'[foo<dfn>bar</dfn>baz]',
		'foo<dfn>b[a]r</dfn>baz',
		'[foo<em>bar</em>baz]',
		'foo<em>b[a]r</em>baz',
		'[foo<font>bar</font>baz]',
		'foo<font>b[a]r</font>baz',
		'[foo<font color=red>bar</font>baz]',
		'foo<font color=red>b[a]r</font>baz',
		'[foo<i>bar</i>baz]',
		'foo<i>b[a]r</i>baz',
		'[foo<ins>bar</ins>baz]',
		'foo<ins>b[a]r</ins>baz',
		'[foo<kbd>bar</kbd>baz]',
		'foo<kbd>b[a]r</kbd>baz',
		'[foo<mark>bar</mark>baz]',
		'foo<mark>b[a]r</mark>baz',
		'[foo<nobr>bar</nobr>baz]',
		'foo<nobr>b[a]r</nobr>baz',
		'[foo<q>bar</q>baz]',
		'foo<q>b[a]r</q>baz',
		'[foo<samp>bar</samp>baz]',
		'foo<samp>b[a]r</samp>baz',
		'[foo<s>bar</s>baz]',
		'foo<s>b[a]r</s>baz',
		'[foo<small>bar</small>baz]',
		'foo<small>b[a]r</small>baz',
		'[foo<span>bar</span>baz]',
		'foo<span>b[a]r</span>baz',
		'[foo<strike>bar</strike>baz]',
		'foo<strike>b[a]r</strike>baz',
		'[foo<strong>bar</strong>baz]',
		'foo<strong>b[a]r</strong>baz',
		'[foo<sub>bar</sub>baz]',
		'foo<sub>b[a]r</sub>baz',
		'[foo<sup>bar</sup>baz]',
		'foo<sup>b[a]r</sup>baz',
		'[foo<tt>bar</tt>baz]',
		'foo<tt>b[a]r</tt>baz',
		'[foo<u>bar</u>baz]',
		'foo<u>b[a]r</u>baz',
		'[foo<var>bar</var>baz]',
		'foo<var>b[a]r</var>baz',

		// Empty and replaced elements
		'[foo<br>bar]',
		'[foo<hr>bar]',
		'[foo<wbr>bar]',
		'[foo<img>bar]',
		'[foo<img src=abc>bar]',
		'[foo<video></video>bar]',
		'[foo<video src=abc></video>bar]',
		'[foo<svg><circle fill=red r=20 cx=20 cy=20 /></svg>bar]',

		// Unrecognized elements
		'[foo<nonexistentelement>bar</nonexistentelement>baz]',
		'foo<nonexistentelement>b[a]r</nonexistentelement>baz',
		'[foo<nonexistentelement style="display: block">bar</nonexistentelement>baz]',
		'foo<nonexistentelement style="display: block">b[a]r</nonexistentelement>baz',

		// Random stuff
		'[foo<span id=foo>bar</span>baz]',
		'foo<span id=foo>b[a]r</span>baz',
		'[foo<span class=foo>bar</span>baz]',
		'foo<span class=foo>b[a]r</span>baz',
		'[foo<b style="font-weight: normal">bar</b>baz]',
		'foo<b style="font-weight: normal">b[a]r</b>baz',
		'<p style="background-color: red">foo[bar]baz</p>',
		'<p><span style="background-color: red">foo[bar]baz</span></p>',
		'<p style="font-weight: bold">foo[bar]baz</p>',
		'<b><p style="font-weight: bold">foo[bar]baz</p></b>',
		'<p style="font-variant: small-caps">foo[bar]baz</p>',
		'{<p style="font-variant: small-caps">foobarbaz</p>}',
		'<p style="text-indent: 2em">foo[bar]baz</p>',
		'{<p style="text-indent: 2em">foobarbaz</p>}',
	],
	strikethrough: [
		'foo[]bar',
		'<span>foo</span>{}<span>bar</span>',
		'<span>foo[</span><span>]bar</span>',
		'foo[bar]baz',
		'foo]bar[baz',
		'{<p><p> <p>foo</p>}',
		'foo[bar<b>baz]qoz</b>quz',

		'<table><tbody><tr><td>foo<td>b[a]r<td>baz</table>',
		'<table><tbody><tr data-start=1 data-end=2><td>foo<td>bar<td>baz</table>',
		'<table><tbody><tr data-start=0 data-end=2><td>foo<td>bar<td>baz</table>',
		'<table><tbody data-start=0 data-end=1><tr><td>foo<td>bar<td>baz</table>',
		'<table data-start=0 data-end=1><tbody><tr><td>foo<td>bar<td>baz</table>',
		'{<table><tr><td>foo<td>bar<td>baz</table>}',

		'foo<u>[bar]</u>baz',
		'foo<span style="text-decoration: underline">[bar]</span>baz',
		'<u>foo[bar]baz</u>',
		'<u>foo[b<span style="color:red">ar]ba</span>z</u>',
		'<u>foo[b<span style="color:red" id=foo>ar]ba</span>z</u>',
		'<u>foo[b<span style="font-size:3em">ar]ba</span>z</u>',
		'<u>foo[b<i>ar]ba</i>z</u>',
		'<p style="text-decoration: underline">foo[bar]baz</p>',

		'foo<s>[bar]</s>baz',
		'foo<span style="text-decoration: line-through">[bar]</span>baz',
		'<s>foo[bar]baz</s>',
		'<s>foo[b<span style="color:red">ar]ba</span>z</s>',
		'<s>foo[b<span style="color:red" id=foo>ar]ba</span>z</s>',
		'<s>foo[b<span style="font-size:3em">ar]ba</span>z</s>',
		'<s>foo[b<i>ar]ba</i>z</s>',
		'<p style="text-decoration: line-through">foo[bar]baz</p>',

		'foo<strike>[bar]</strike>baz',
		'<strike>foo[bar]baz</strike>',
		'<strike>foo[b<span style="color:red">ar]ba</span>z</strike>',
		'<strike>foo[b<span style="color:red" id=foo>ar]ba</span>z</strike>',
		'<strike>foo[b<span style="font-size:3em">ar]ba</span>z</strike>',
		'<strike>foo[b<i>ar]ba</i>z</strike>',

		'foo<ins>[bar]</ins>baz',
		'<ins>foo[bar]baz</ins>',
		'<ins>foo[b<span style="color:red">ar]ba</span>z</ins>',
		'<ins>foo[b<span style="color:red" id=foo>ar]ba</span>z</ins>',
		'<ins>foo[b<span style="font-size:3em">ar]ba</span>z</ins>',
		'<ins>foo[b<i>ar]ba</i>z</ins>',

		'foo<del>[bar]</del>baz',
		'<del>foo[bar]baz</del>',
		'<del>foo[b<span style="color:red">ar]ba</span>z</del>',
		'<del>foo[b<span style="color:red" id=foo>ar]ba</span>z</del>',
		'<del>foo[b<span style="font-size:3em">ar]ba</span>z</del>',
		'<del>foo[b<i>ar]ba</i>z</del>',

		'foo<span style="text-decoration: underline line-through">[bar]</span>baz',
		'foo<span style="text-decoration: underline line-through">b[a]r</span>baz',
		'foo<s style="text-decoration: underline">[bar]</s>baz',
		'foo<s style="text-decoration: underline">b[a]r</s>baz',
		'foo<u style="text-decoration: line-through">[bar]</u>baz',
		'foo<u style="text-decoration: line-through">b[a]r</u>baz',
		'foo<s style="text-decoration: overline">[bar]</s>baz',
		'foo<s style="text-decoration: overline">b[a]r</s>baz',
		'foo<u style="text-decoration: overline">[bar]</u>baz',
		'foo<u style="text-decoration: overline">b[a]r</u>baz',

		'<p style="text-decoration: line-through">foo[bar]baz</p>',
		'<p style="text-decoration: overline">foo[bar]baz</p>',

		'foo<span class="underline">[bar]</span>baz',
		'foo<span class="underline">b[a]r</span>baz',
		'foo<span class="line-through">[bar]</span>baz',
		'foo<span class="line-through">b[a]r</span>baz',
		'foo<span class="underline-and-line-through">[bar]</span>baz',
		'foo<span class="underline-and-line-through">b[a]r</span>baz',
	],
	subscript: [
		'foo[]bar',
		'<span>foo</span>{}<span>bar</span>',
		'<span>foo[</span><span>]bar</span>',
		'foo[bar]baz',
		'foo]bar[baz',
		'{<p><p> <p>foo</p>}',
		'foo[bar<b>baz]qoz</b>quz',

		'<table><tbody><tr><td>foo<td>b[a]r<td>baz</table>',
		'<table><tbody><tr data-start=1 data-end=2><td>foo<td>bar<td>baz</table>',
		'<table><tbody><tr data-start=0 data-end=2><td>foo<td>bar<td>baz</table>',
		'<table><tbody data-start=0 data-end=1><tr><td>foo<td>bar<td>baz</table>',
		'<table data-start=0 data-end=1><tbody><tr><td>foo<td>bar<td>baz</table>',
		'{<table><tr><td>foo<td>bar<td>baz</table>}',

		'foo<sub>[bar]</sub>baz',
		'foo<sub>b[a]r</sub>baz',
		'foo<sup>[bar]</sup>baz',
		'foo<sup>b[a]r</sup>baz',

		'foo<sub><sub>[bar]</sub></sub>baz',
		'foo<sub><sub>b[a]r</sub></sub>baz',
		'foo<sub>b<sub>[a]</sub>r</sub>baz',
		'foo<sup><sup>[bar]</sup></sup>baz',
		'foo<sup><sup>b[a]r</sup></sup>baz',
		'foo<sup>b<sup>[a]</sup>r</sup>baz',
		'foo<sub><sup>[bar]</sup></sub>baz',
		'foo<sub><sup>b[a]r</sup></sub>baz',
		'foo<sub>b<sup>[a]</sup>r</sub>baz',
		'foo<sup><sub>[bar]</sub></sup>baz',
		'foo<sup><sub>b[a]r</sub></sup>baz',
		'foo<sup>b<sub>[a]</sub>r</sup>baz',
	],
	superscript: [
		'foo[]bar',
		'<span>foo</span>{}<span>bar</span>',
		'<span>foo[</span><span>]bar</span>',
		'foo[bar]baz',
		'foo]bar[baz',
		'{<p><p> <p>foo</p>}',
		'foo[bar<b>baz]qoz</b>quz',

		'<table><tbody><tr><td>foo<td>b[a]r<td>baz</table>',
		'<table><tbody><tr data-start=1 data-end=2><td>foo<td>bar<td>baz</table>',
		'<table><tbody><tr data-start=0 data-end=2><td>foo<td>bar<td>baz</table>',
		'<table><tbody data-start=0 data-end=1><tr><td>foo<td>bar<td>baz</table>',
		'<table data-start=0 data-end=1><tbody><tr><td>foo<td>bar<td>baz</table>',
		'{<table><tr><td>foo<td>bar<td>baz</table>}',

		'foo<sub>[bar]</sub>baz',
		'foo<sub>b[a]r</sub>baz',
		'foo<sup>[bar]</sup>baz',
		'foo<sup>b[a]r</sup>baz',

		'foo<sub><sub>[bar]</sub></sub>baz',
		'foo<sub><sub>b[a]r</sub></sub>baz',
		'foo<sub>b<sub>[a]</sub>r</sub>baz',
		'foo<sup><sup>[bar]</sup></sup>baz',
		'foo<sup><sup>b[a]r</sup></sup>baz',
		'foo<sup>b<sup>[a]</sup>r</sup>baz',
		'foo<sub><sup>[bar]</sup></sub>baz',
		'foo<sub><sup>b[a]r</sup></sub>baz',
		'foo<sub>b<sup>[a]</sup>r</sub>baz',
		'foo<sup><sub>[bar]</sub></sup>baz',
		'foo<sup><sub>b[a]r</sub></sup>baz',
		'foo<sup>b<sub>[a]</sub>r</sup>baz',
	],
	underline: [
		'foo[]bar',
		'<span>foo</span>{}<span>bar</span>',
		'<span>foo[</span><span>]bar</span>',
		'foo[bar]baz',
		'foo]bar[baz',
		'{<p><p> <p>foo</p>}',
		'foo[bar<b>baz]qoz</b>quz',

		'<table><tbody><tr><td>foo<td>b[a]r<td>baz</table>',
		'<table><tbody><tr data-start=1 data-end=2><td>foo<td>bar<td>baz</table>',
		'<table><tbody><tr data-start=0 data-end=2><td>foo<td>bar<td>baz</table>',
		'<table><tbody data-start=0 data-end=1><tr><td>foo<td>bar<td>baz</table>',
		'<table data-start=0 data-end=1><tbody><tr><td>foo<td>bar<td>baz</table>',
		'{<table><tr><td>foo<td>bar<td>baz</table>}',

		'foo<u>[bar]</u>baz',
		'foo<span style="text-decoration: underline">[bar]</span>baz',
		'<u>foo[bar]baz</u>',
		'<u>foo[b<span style="color:red">ar]ba</span>z</u>',
		'<u>foo[b<span style="color:red" id=foo>ar]ba</span>z</u>',
		'<u>foo[b<span style="font-size:3em">ar]ba</span>z</u>',
		'<u>foo[b<i>ar]ba</i>z</u>',
		'<p style="text-decoration: underline">foo[bar]baz</p>',

		'foo<s>[bar]</s>baz',
		'foo<span style="text-decoration: line-through">[bar]</span>baz',
		'<s>foo[bar]baz</s>',
		'<s>foo[b<span style="color:red">ar]ba</span>z</s>',
		'<s>foo[b<span style="color:red" id=foo>ar]ba</span>z</s>',
		'<s>foo[b<span style="font-size:3em">ar]ba</span>z</s>',
		'<s>foo[b<i>ar]ba</i>z</s>',
		'<p style="text-decoration: line-through">foo[bar]baz</p>',

		'foo<strike>[bar]</strike>baz',
		'<strike>foo[bar]baz</strike>',
		'<strike>foo[b<span style="color:red">ar]ba</span>z</strike>',
		'<strike>foo[b<span style="color:red" id=foo>ar]ba</span>z</strike>',
		'<strike>foo[b<span style="font-size:3em">ar]ba</span>z</strike>',
		'<strike>foo[b<i>ar]ba</i>z</strike>',

		'foo<ins>[bar]</ins>baz',
		'<ins>foo[bar]baz</ins>',
		'<ins>foo[b<span style="color:red">ar]ba</span>z</ins>',
		'<ins>foo[b<span style="color:red" id=foo>ar]ba</span>z</ins>',
		'<ins>foo[b<span style="font-size:3em">ar]ba</span>z</ins>',
		'<ins>foo[b<i>ar]ba</i>z</ins>',

		'foo<del>[bar]</del>baz',
		'<del>foo[bar]baz</del>',
		'<del>foo[b<span style="color:red">ar]ba</span>z</del>',
		'<del>foo[b<span style="color:red" id=foo>ar]ba</span>z</del>',
		'<del>foo[b<span style="font-size:3em">ar]ba</span>z</del>',
		'<del>foo[b<i>ar]ba</i>z</del>',

		'foo<span style="text-decoration: underline line-through">[bar]</span>baz',
		'foo<span style="text-decoration: underline line-through">b[a]r</span>baz',
		'foo<s style="text-decoration: underline">[bar]</s>baz',
		'foo<s style="text-decoration: underline">b[a]r</s>baz',
		'foo<u style="text-decoration: line-through">[bar]</u>baz',
		'foo<u style="text-decoration: line-through">b[a]r</u>baz',
		'foo<s style="text-decoration: overline">[bar]</s>baz',
		'foo<s style="text-decoration: overline">b[a]r</s>baz',
		'foo<u style="text-decoration: overline">[bar]</u>baz',
		'foo<u style="text-decoration: overline">b[a]r</u>baz',

		'<p style="text-decoration: line-through">foo[bar]baz</p>',
		'<p style="text-decoration: overline">foo[bar]baz</p>',

		'foo<span class="underline">[bar]</span>baz',
		'foo<span class="underline">b[a]r</span>baz',
		'foo<span class="line-through">[bar]</span>baz',
		'foo<span class="line-through">b[a]r</span>baz',
		'foo<span class="underline-and-line-through">[bar]</span>baz',
		'foo<span class="underline-and-line-through">b[a]r</span>baz',
	],
	unlink: [
		'foo[]bar',
		'<span>foo</span>{}<span>bar</span>',
		'<span>foo[</span><span>]bar</span>',
		'<a href=http://www.google.com/>foo[bar]baz</a>',
		'<a href=http://www.google.com/>foo[barbaz</a>}',
		'{<a href=http://www.google.com/>foobar]baz</a>',
		'{<a href=http://www.google.com/>foobarbaz</a>}',
		'<a href=http://www.google.com/>[foobarbaz]</a>',

		'foo<a href=http://www.google.com/>[bar]</a>baz',
		'foo[<a href=http://www.google.com/>bar</a>]baz',
		'foo<a href=http://www.google.com/>[bar</a>baz]',
		'[foo<a href=http://www.google.com/>bar]</a>baz',
		'[foo<a href=http://www.google.com/>bar</a>baz]',

		'<a id=foo href=http://www.google.com/>foo[bar]baz</a>',
		'<a id=foo href=http://www.google.com/>[foobarbaz]</a>',
		'foo<a id=foo href=http://www.google.com/>[bar]</a>baz',
		'foo[<a id=foo href=http://www.google.com/>bar</a>]baz',
		'[foo<a id=foo href=http://www.google.com/>bar</a>baz]',

		'<a name=foo>foo[bar]baz</a>',
		'<a name=foo>[foobarbaz]</a>',
		'foo<a name=foo>[bar]</a>baz',
		'foo[<a name=foo>bar</a>]baz',
		'[foo<a name=foo>bar</a>baz]',
	],
};

var defaultValues = {
	backcolor: "#FF8888",
	createlink: "http://www.google.com/",
	fontname: "sans-serif",
	fontsize: "4",
	forecolor: "#FF0000",
	hilitecolor: "#FF8888",
	inserthorizontalrule: "",
	insertimage: "/img/lion.svg",
};

var notes = {
	backcolor: '<strong>Note:</strong> No spec has yet been written, so the spec column does nothing.',
	fontname: 'Note that the body\'s font-family is "serif".',
	hilitecolor: 'In IE we run backColor instead of hiliteColor.',
};

var doubleTestingCommands = [
	"backcolor",
	"bold",
	"fontname",
	"fontsize",
	"forecolor",
	"indent",
	"italic",
	"strikethrough",
	"subscript",
	"superscript",
	"underline",
];

// Set up all the HTML automatically so I can add new commands to test without
// copy-pasting in five places
var toc = document.querySelector("ul");
for (var command in tests) {
	var li = document.createElement("li");
	li.innerHTML = "<a href=#" + command + ">" + command + "</a>";
	toc.appendChild(li);

	var div = document.createElement("div");
	div.id = command;
	div.innerHTML = "<h1>" + command + "</h1>"
		+ "<button onclick=\"runTests('" + command + "')\">Run tests</button>"
		+ (command in notes ? "<p>" + notes[command] : "")
		+ "<table border=1><tr><th>Input <th>Spec <th>Browser <th>Same?</table>"
		+ (doubleTestingCommands.indexOf(command) != -1 ? "<table border=1><tr><th>Input <th>Spec <th>Browser <th>Same?</table>" : "")
		+ "<p><label>New test input: <input></label>"
		+ (command in defaultValues ? "<label>New test value: <input></label>" : "")
		+ "<button onclick=\"addTest('" + command + "')\">Add test</button>";
	document.body.appendChild(div);
}

function runTests(command) {
	var runTestsButton = document.querySelector("#" + command + " button");
	runTestsButton.parentNode.removeChild(runTestsButton);

	var addTestButton = document.querySelector("#" + command + " button");
	var inputs = document.getElementById(command).getElementsByTagName("input");
	for (var i = 0; i < tests[command].length; i++) {
		// This code actually focuses and clicks everything because for some
		// reason, anything else doesn't work in IE9 . . .
		if (typeof tests[command][i] == "string") {
			inputs[0].value = tests[command][i];
			if (inputs.length == 2) {
				inputs[1].value = defaultValues[command];
			}
		} else {
			inputs[0].value = tests[command][i][1];
			inputs[1].value = tests[command][i][0];
		}
		inputs[0].focus();
		addTestButton.click();
	}
	for (var i = 0; i < inputs.length; i++) {
		inputs[i].value = "";
	}
}

function addTest(command) {
	var doubleTesting = doubleTestingCommands.indexOf(command) != -1;

	// I tried to feature-detect styleWithCSS, but it was too much of a pain,
	// with Firefox randomly throwing exceptions all over the place.  So I'm
	// just browser-sniffing here.
	if (navigator.userAgent.indexOf("Opera") != -1
	|| navigator.userAgent.indexOf("MSIE") != -1) {
		doubleTesting = false;
	}

	var tr = doSetup(command, 0);

	var test;
	var inputs = document.getElementById(command).getElementsByTagName("input");
	if (inputs.length == 1) {
		test = inputs[0].value;
	} else {
		test = [inputs[1].value, inputs[0].value];
	}

	doInputCell(tr, test);
	doSpecCell(tr, test, command, false);
	doBrowserCell(tr, test, command, false);
	doSameCell(tr);

	if (doubleTesting) {
		var tr = doSetup(command, 1);

		doInputCell(tr, test);
		doSpecCell(tr, test, command, true);
		doBrowserCell(tr, test, command, true);
		doSameCell(tr);
	}

	doTearDown(command);
}

function doSetup(command, idx) {
	var table = document.querySelectorAll("#" + command + " > table")[idx];

	var tr = document.createElement("tr");
	table.firstChild.appendChild(tr);

	return tr;
}

function doInputCell(tr, test) {
	var value = null;
	if (typeof test != "string") {
		value = test[0];
		test = test[1];
	}
	var inputCell = document.createElement("td");
	inputCell.innerHTML = "<div></div><div></div>";
	inputCell.firstChild.innerHTML = test;
	inputCell.lastChild.textContent = inputCell.firstChild.innerHTML;
	if (value !== null) {
		inputCell.lastChild.textContent += ' (value: "' + value + '")';
	}
	tr.appendChild(inputCell);
}

function doSpecCell(tr, test, command, styleWithCss) {
	var value;

	if (typeof test != "string") {
		value = test[0];
		test = test[1];
	}

	var specCell = document.createElement("td");
	tr.appendChild(specCell);
	try {
		var points = setupCell(specCell, test);
		var range = document.createRange();
		range.setStart(points[0], points[1]);
		range.setEnd(points[2], points[3]);
		// The points might be backwards
		if (range.collapsed) {
			range.setEnd(points[0], points[1]);
		}
		specCell.firstChild.contentEditable = "true";
		specCell.firstChild.spellcheck = false;
		myExecCommand("styleWithCSS", false, styleWithCss);
		myExecCommand(command, false, value, range);
		specCell.firstChild.contentEditable = "inherit";
		specCell.firstChild.removeAttribute("spellcheck");
		addBrackets(range);
		if (specCell.childNodes.length == 2) {
			specCell.lastChild.textContent = specCell.firstChild.innerHTML;
		} else {
			throw "The cell didn't have two children.  Did something spill outside the test div?";
		}
	} catch (e) {
		specCell.firstChild.contentEditable = "inherit";
		specCell.firstChild.removeAttribute("spellcheck");
		specCell.lastChild.style.color = "red";
		specCell.lastChild.style.fontWeight = "bold";
		specCell.lastChild.textContent = "Note, exception: " + e;
		if ("stack" in e) {
			specCell.lastChild.textContent += " (stack: " + e.stack + ")";
		}
	}

	var key = "execcommand-" + command
		+ "-" + Number(styleWithCss)
		+ "-" + tr.firstChild.lastChild.textContent;

	var oldValue = localStorage[key];
	localStorage[key] = specCell.lastChild.textContent;

	if (oldValue !== null && oldValue !== undefined && oldValue != specCell.lastChild.textContent) {
		specCell.lastChild.appendChild(document.createElement("div"));
		specCell.lastChild.lastChild.style.color = "red";
		specCell.lastChild.lastChild.style.fontWeight = "bold";
		specCell.lastChild.lastChild.textContent = "Note, last run produced different markup: " + oldValue;
	}
}

function doBrowserCell(tr, test, command, styleWithCss) {
	var value;

	if (typeof test != "string") {
		value = test[0];
		test = test[1];
	}

	if (command == "hilitecolor" && navigator.userAgent.indexOf("MSIE") != -1) {
		// IE behaves differently, and I want to see how it works.
		command = "backcolor";
	}

	if (command == "hilitecolor") {
		// Firefox refuses to do anything unless styleWithCSS is true.
		styleWithCss = true;
	}

	var browserCell = document.createElement("td");
	tr.appendChild(browserCell);
	try {
		var points = setupCell(browserCell, test);

		var testDiv = browserCell.firstChild;
		// Work around weird Firefox bug:
		// https://bugzilla.mozilla.org/show_bug.cgi?id=649138
		document.body.appendChild(testDiv);
		setSelection(points[0], points[1], points[2], points[3]);
		testDiv.contentEditable = "true";
		testDiv.spellcheck = false;

		try {
			document.execCommand("styleWithCSS", false, styleWithCss);
		} catch (e) {}
		document.execCommand(command, false, value);

		testDiv.contentEditable = "inherit";
		testDiv.removeAttribute("spellcheck");
		if (getSelection().rangeCount) {
			addBrackets(getSelection().getRangeAt(0));
		}
		browserCell.insertBefore(testDiv, browserCell.firstChild);
		if (browserCell.childNodes.length == 2) {
			browserCell.lastChild.textContent = browserCell.firstChild.innerHTML;
		} else {
			throw "The cell didn't have two children.  Did something spill outside the test div?";
		}
	} catch (e) {
		if (testDiv) {
			testDiv.contenteditable = "inherit";
			testDiv.removeAttribute("spellcheck");
		}
		browserCell.lastChild.style.color = "red";
		browserCell.lastChild.style.fontWeight = "bold";
		browserCell.lastChild.textContent = "Exception: " + e;
		if ("stack" in e) {
			specCell.lastChild.textContent += " (stack: " + e.stack + ")";
		}
		if (testDiv && testDiv.parentNode != browserCell) {
			browserCell.insertBefore(testDiv, browserCell.firstChild);
		}
	}
}

function doSameCell(tr) {
	var sameCell = document.createElement("td");
	var exception = false;
	try {
		// Ad hoc normalization to avoid basically spurious mismatches.  For
		// now this includes ignoring where the selection goes.
		var normalizedSpecCell = tr.childNodes[1].lastChild.firstChild.textContent
			.replace(/[[\]{}]/g, "")
			.replace(/ style="margin: 0 40px"/g, "")
			.replace(/: /g, ":")
			.replace(/;? ?"/g, '"')
			.replace(/<(\/?)strong/g, '<$1b')
			.replace(/<(\/?)strike/g, '<$1s')
			.replace(/<(\/?)em/g, '<$1i')
			.replace(/#[0-9a-fA-F]{6}/g, function(match) { return match.toUpperCase(); });
		var normalizedBrowserCell = tr.childNodes[2].lastChild.firstChild.textContent
			.replace(/[[\]{}]/g, "")
			.replace(/ class="webkit-indent-blockquote" style="margin: 0 0 0 40px; border: none; padding: 0px;"/g, '')
			.replace(/ style="margin-right: 0px;" dir="ltr"/g, '')
			.replace(/ style="margin-left: 0px;" dir="rtl"/g, '')
			.replace(/ style="margin-(left|right): 40px;"/g, '')
			.replace(/: /g, ":")
			.replace(/;? ?"/g, '"')
			.replace(/<(\/?)strong/g, '<$1b')
			.replace(/<(\/?)strike/g, '<$1s')
			.replace(/<(\/?)em/g, '<$1i')
			.replace(/#[0-9a-fA-F]{6}/g, function(match) { return match.toUpperCase(); })
			.replace(/ size="2" width="100%"/g, '')
			.replace(/ class="Apple-style-span"/g, "");
		if (navigator.userAgent.indexOf("MSIE") != -1) {
			// IE produces <font style> instead of <span style>, so let's
			// translate all <span>s to <font>s.
			normalizedSpecCell = normalizedSpecCell
				.replace(/<(\/?)span/g, '<$1font');
			normalizedBrowserCell = normalizedBrowserCell
				.replace(/<(\/?)span/g, '<$1font');
		}
	} catch (e) {
		exception = true;
	}
	if (!exception && normalizedSpecCell == normalizedBrowserCell) {
		sameCell.className = "yes";
		sameCell.textContent = "\u2713";
	} else {
		sameCell.className = "no";
		sameCell.textContent = "\u2717";
	}
	tr.appendChild(sameCell);

	// Insert zero-width spaces so IE doesn't stretch the screen
	for (var i = 0; i <= 2; i++) {
		try {
			tr.childNodes[i].lastChild.firstChild.textContent =
				tr.childNodes[i].lastChild.firstChild.textContent
				.replace(/</g, "\u200B<")
				.replace(/>/g, ">\u200B");
		} catch (e) {};
	}
}

function doTearDown(command) {
	getSelection().removeAllRanges();
}

function setupCell(cell, test) {
	// A variety of checks to avoid simple errors.  Not foolproof, of course.
	var startMarkers = /\{|\[|data-start/.exec(test);
	if (!startMarkers) {
		startMarkers = [];
	}
	if (startMarkers.length != 1) {
		throw "Need exactly one start marker ([ or { or data-start), found " + startMarkers.length;
	}

	var endMarkers = /\}|\]|data-end/.exec(test);
	if (!endMarkers) {
		endMarkers = [];
	}
	if (endMarkers.length != 1) {
		throw "Need exactly one end marker (] or } or data-end), found " + endMarkers.length;
	}

	cell.innerHTML = "<div></div><div></div>";
	var node = cell.firstChild;
	node.innerHTML = test;

	var startNode, startOffset, endNode, endOffset;

	// For braces that don't lie inside text nodes, we can't just set
	// innerHTML, because that might disturb the DOM.  For instance, if the
	// brace is right before a <tr>, it could get moved outside the table
	// entirely, which messes everything up pretty badly.  So we instead
	// allow using data attributes: data-start and data-end on the start and
	// end nodes, with a numeric value indicating the offset.  This format
	// doesn't allow the parent div to be a start or end node, but in that case
	// you can always use the curly braces.
	if (node.querySelector("[data-start]")) {
		startNode = node.querySelector("[data-start]");
		startOffset = startNode.getAttribute("data-start");
		startNode.removeAttribute("data-start");
	}
	if (node.querySelector("[data-end]")) {
		endNode = node.querySelector("[data-end]");
		endOffset = endNode.getAttribute("data-end");
		endNode.removeAttribute("data-end");
	}

	var cur = node;
	while (true) {
		if (!cur || (cur != node && !(cur.compareDocumentPosition(node) & Node.DOCUMENT_POSITION_CONTAINS))) {
			break;
		}

		if (cur.nodeType != Node.TEXT_NODE) {
			cur = nextNode(cur);
			continue;
		}

		var data = cur.data.replace(/\]/g, "");
		var startIdx = data.indexOf("[");

		data = cur.data.replace(/\[/g, "");
		var endIdx = data.indexOf("]");

		cur.data = cur.data.replace(/[\[\]]/g, "");

		if (startIdx != -1) {
			startNode = cur;
			startOffset = startIdx;
		}

		if (endIdx != -1) {
			endNode = cur;
			endOffset = endIdx;
		}

		// These are only legal as the first or last
		data = cur.data.replace(/\}/g, "");
		var elStartIdx = data.indexOf("{");

		data = cur.data.replace(/\{/g, "");
		var elEndIdx = data.indexOf("}");

		if (elStartIdx == 0) {
			startNode = cur.parentNode;
			startOffset = getNodeIndex(cur);
		} else if (elStartIdx != -1) {
			startNode = cur.parentNode;
			startOffset = getNodeIndex(cur) + 1;
		}
		if (elEndIdx == 0) {
			endNode = cur.parentNode;
			endOffset = getNodeIndex(cur);
		} else if (elEndIdx != -1) {
			endNode = cur.parentNode;
			endOffset = getNodeIndex(cur) + 1;
		}

		cur.data = cur.data.replace(/[{}]/g, "");
		if (!cur.data.length) {
			if (cur == startNode || cur == endNode) {
				throw "You put a square bracket where there was no text node . . .";
			}
			var oldCur = cur;
			cur = nextNode(cur);
			oldCur.parentNode.removeChild(oldCur);
		} else {
			cur = nextNode(cur);
		}
	}

	return [startNode, startOffset, endNode, endOffset];
}

function setSelection(startNode, startOffset, endNode, endOffset) {
	if (navigator.userAgent.indexOf("Opera") != -1) {
		// Yes, browser sniffing is evil, but I can't be bothered to debug
		// Opera.
		var range = document.createRange();
		range.setStart(startNode, startOffset);
		range.setEnd(endNode, endOffset);
		if (range.collapsed) {
			range.setEnd(startNode, startOffset);
		}
		getSelection().removeAllRanges();
		getSelection().addRange(range);
	} else if ("extend" in getSelection()) {
		// WebKit behaves unreasonably for collapse(), so do that manually.
		/*
		var range = document.createRange();
		range.setStart(startNode, startOffset);
		getSelection().removeAllRanges();
		getSelection().addRange(range);
		*/
		getSelection().collapse(startNode, startOffset);
		getSelection().extend(endNode, endOffset);
	} else {
		// IE9.  Selections have no direction, so we just make the selection
		// always forwards.
		var range;
		if (getSelection().rangeCount) {
			range = getSelection().getRangeAt(0);
		} else {
			range = document.createRange();
		}
		range.setStart(startNode, startOffset);
		range.setEnd(endNode, endOffset);
		if (range.collapsed) {
			// Phooey, we got them backwards.
			range.setEnd(startNode, startOffset);
		}
		if (!getSelection().rangeCount) {
			getSelection().addRange(range);
		}
	}
}

/**
 * Add brackets at the start and end points of the given range, so that they're
 * visible.
 */
function addBrackets(range) {
	// Do the end first, so that if the range is collapsed, the start point
	// will be inserted before the end point.
	if (range.endContainer.nodeType == Node.TEXT_NODE) {
		range.endContainer.insertData(range.endOffset, "]");
	} else {
		// As everyone knows, the only node types are Text and Element.
		if (range.endOffset != range.endContainer.childNodes.length
		&& range.endContainer.childNodes[range.endOffset].nodeType == Node.TEXT_NODE) {
			range.endContainer.childNodes[range.endOffset].insertData(0, "}");
		} else if (range.endOffset != 0
		&& range.endContainer.childNodes[range.endOffset - 1].nodeType == Node.TEXT_NODE) {
			range.endContainer.childNodes[range.endOffset - 1].appendData("}");
		} else {
			// Seems to serialize as I'd want even for tables . . . IE doesn't
			// allow undefined to be passed as the second argument (it throws
			// an exception), so we have to explicitly check the number of
			// children and pass null.
			range.endContainer.insertBefore(document.createTextNode("}"),
				range.endContainer.childNodes.length == range.endOffset
				? null
				: range.endContainer.childNodes[range.endOffset]);
		}
	}
	if (range.startContainer.nodeType == Node.TEXT_NODE) {
		range.startContainer.insertData(range.startOffset, "[");
	} else {
		if (range.startOffset != range.startContainer.childNodes.length
		&& range.startContainer.childNodes[range.startOffset].nodeType == Node.TEXT_NODE) {
			range.startContainer.childNodes[range.startOffset].insertData(0, "{");
		} else if (range.startOffset != 0
		&& range.startContainer.childNodes[range.startOffset - 1].nodeType == Node.TEXT_NODE) {
			range.startContainer.childNodes[range.startOffset - 1].appendData("{");
		} else {
		range.startContainer.insertBefore(document.createTextNode("{"),
			range.startContainer.childNodes.length == range.startOffset
			? null
			: range.startContainer.childNodes[range.startOffset]);
		}
	}
}
</script>
